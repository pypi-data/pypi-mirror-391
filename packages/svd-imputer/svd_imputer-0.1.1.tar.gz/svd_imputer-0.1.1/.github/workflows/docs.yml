name: Documentation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - '*.md'
      - 'svd_imputer/**'
  workflow_dispatch:

jobs:
  # Job 1: Build Documentation
  docs-build:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for version info
        
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install sphinx sphinx-rtd-theme nbsphinx jupyter ipykernel
        pip install sphinx-autodoc-typehints sphinx-copybutton
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        
    - name: Create docs directory structure
      run: |
        mkdir -p docs/{_static,_templates}
        
    - name: Generate API documentation
      run: |
        sphinx-apidoc -o docs/api svd_imputer --force --separate
        
    - name: Create Sphinx configuration
      run: |
        cat > docs/conf.py << 'EOF'
        import os
        import sys
        sys.path.insert(0, os.path.abspath('..'))
        
        project = 'SVD Imputer'
        copyright = '2025, Rui Hugman'
        author = 'Rui Hugman'
        
        extensions = [
            'sphinx.ext.autodoc',
            'sphinx.ext.viewcode',
            'sphinx.ext.napoleon',
            'sphinx.ext.intersphinx',
            'sphinx.ext.mathjax',
            'nbsphinx',
            'sphinx_autodoc_typehints',
            'sphinx_copybutton',
        ]
        
        templates_path = ['_templates']
        exclude_patterns = ['_build', 'Thumbs.db', '.DS_Store']
        
        html_theme = 'sphinx_rtd_theme'
        html_static_path = ['_static']
        
        autodoc_typehints = 'description'
        napoleon_google_docstring = True
        napoleon_numpy_docstring = True
        
        intersphinx_mapping = {
            'python': ('https://docs.python.org/3', None),
            'numpy': ('https://numpy.org/doc/stable/', None),
            'pandas': ('https://pandas.pydata.org/docs/', None),
            'sklearn': ('https://scikit-learn.org/stable/', None),
        }
        EOF
        
    - name: Create main documentation files
      run: |
        cat > docs/index.rst << 'EOF'
        SVD Imputer Documentation
        =========================
        
        SVD-based time series imputation with uncertainty estimation.
        
        .. toctree::
           :maxdepth: 2
           :caption: Contents:
        
           installation
           quickstart
           api/modules
           examples
           changelog
        
        Indices and tables
        ==================
        
        * :ref:`genindex`
        * :ref:`modindex`
        * :ref:`search`
        EOF
        
        cat > docs/installation.rst << 'EOF'
        Installation
        ============
        
        Requirements
        ------------
        
        * Python >= 3.8
        * NumPy >= 1.20.0
        * pandas >= 1.3.0
        * scikit-learn >= 1.0.0
        
        Install from PyPI
        -----------------
        
        .. code-block:: bash
        
           pip install svd-imputer
        
        Install from Source
        -------------------
        
        .. code-block:: bash
        
           git clone https://github.com/rhugman/svd_imputer.git
           cd svd_imputer
           pip install -e .
        EOF
        
        cat > docs/quickstart.rst << 'EOF'
        Quick Start Guide
        =================
        
        Basic Usage
        -----------
        
        .. code-block:: python
        
           import pandas as pd
           import numpy as np
           from svd_imputer import Imputer
           
           # Create sample time series data
           dates = pd.date_range('2020-01-01', periods=100, freq='D')
           df = pd.DataFrame({
               'sensor1': np.random.randn(100),
               'sensor2': np.random.randn(100)
           }, index=dates)
           
           # Add some missing values
           df.iloc[::10, :] = np.nan
           
           # Perform imputation
           imputer = Imputer(data=df)
           df_imputed = imputer.fit_transform()
        
        With Uncertainty Estimation
        ---------------------------
        
        .. code-block:: python
        
           # Get imputed data with uncertainty estimates
           df_imputed, uncertainty = imputer.fit_transform(
               return_uncertainty=True, 
               n_repeats=50
           )
           
           print(f"RMSE: {uncertainty['rmse']:.3f}")
           print(f"MAE: {uncertainty['mae']:.3f}")
        EOF
        
        cat > docs/examples.rst << 'EOF'
        Examples
        ========
        
        Coming soon...
        EOF
        
        cat > docs/changelog.rst << 'EOF'
        Changelog
        =========
        
        Version 1.0.0 (TBD)
        -------------------
        
        * Initial release
        * SVD-based imputation
        * Monte Carlo uncertainty estimation
        * Automatic rank optimization
        EOF
        
    - name: Build documentation with Sphinx
      run: |
        cd docs && sphinx-build -b html . _build/html -W
        
    - name: Check documentation links
      run: |
        cd docs && sphinx-build -b linkcheck . _build/linkcheck
      continue-on-error: true
        
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/
        
    - name: Create documentation archive
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        cd docs/_build/html
        tar -czf ../../../docs-html.tar.gz .
        
    - name: Upload documentation archive
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: docs-archive
        path: docs-html.tar.gz

  # Job 2: Deploy to GitHub Pages (main branch only)
  docs-deploy:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: docs-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Download documentation artifacts
      uses: actions/download-artifact@v4
      with:
        name: documentation-html
        path: ./docs
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./docs
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # Job 3: Documentation Quality Checks
  docs-quality:
    name: Documentation Quality Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install documentation tools
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install doc8 pydocstyle sphinx-lint rstcheck
        
    - name: Check RST syntax
      run: |
        find docs -name "*.rst" -exec rstcheck {} \;
      continue-on-error: true
      
    - name: Check documentation style
      run: |
        doc8 docs/
      continue-on-error: true
      
    - name: Check docstring style
      run: |
        pydocstyle svd_imputer/ --convention=numpy
      continue-on-error: true
      
    - name: Check README
      run: |
        python -c "
        import setuptools
        with open('README.md', 'r') as f:
            long_description = f.read()
        print('README.md is valid markdown')
        "
        
  # Job 4: Documentation Coverage
  docs-coverage:
    name: Documentation Coverage
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install interrogate
        
    - name: Check documentation coverage
      run: |
        interrogate svd_imputer/ --verbose --ignore-init-method --ignore-magic --ignore-private
        
    - name: Generate documentation coverage badge
      run: |
        interrogate svd_imputer/ --generate-badge docs/_static/doc-coverage.svg
      continue-on-error: true