---
name: Pages Build and Deploy

#
# This workflow for building and deploying a Jekyll site to GitHub Pages.
#
# Inspired by:
# https://github.com/actions/jekyll-build-pages
#

on:
  release:
    types: [published]

permissions: {}

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "${{ github.workflow }}"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write

    environment:
      name: github-pages

    env:
      TARGET_DIRECTORY: docs

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: pip

      - name: Build and Run
        run: |
          bash ./.github/scripts/build.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          SOURCE: ${{ vars.SOURCE }}
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          # TARGET_DIRECTORY: ${{ env.TARGET_DIRECTORY }}

      - name: Upload Release Artifact
        run: gh release upload "${{ github.event.release.tag_name }}" "${{ env.TARGET_DIRECTORY }}/bundle.json" --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ env.BASE_URL }}" --source "${{ env.TARGET_DIRECTORY }}"
        env:
          JEKYLL_ENV: production
          BASE_URL: ${{ github.event.repository.private == false && format('/{0}', github.event.repository.name) || steps.pages.outputs.base_path }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ needs.build.result == 'success' }}

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
