---
name: PR Preview

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize
      - closed

permissions: {}

concurrency:
  group: "${{ github.workflow }}: ${{ github.event.number }}"
  cancel-in-progress: true

jobs:
  open:
    name: Build PR Preview
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.pull_request.draft == false &&
        github.event.action != 'closed'
      }}

    permissions:
      contents: write
      pull-requests: write

    environment:
      name: github-preview-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get App Token
        id: my-app
        run: bash ./.github/scripts/token.sh
        env:
          APP_ID: ${{ secrets.APP_ID }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: pip

      - name: Build and Push
        id: deployment
        run: |
          if [[ "$GITHUB_HEAD_REF" =~ ^(release-please|dependabot).* ]]; then
            echo "::notice::[${BASH_REMATCH[1]}] branch detected. Skipping preview."
            exit 0
          else
            bash ./.github/scripts/preview.sh "${{ github.job }}:${{ github.event.number }}" \
              --owner "${{ github.repository_owner }}" \
              --source-repo "${{ github.event.repository.name }}" \
              --target-repo "${{ github.event.repository.name }}-preview"
          fi
        env:
          GH_TOKEN: ${{ steps.my-app.outputs.token }}
          SOURCE: ${{ vars.SOURCE }}
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}-preview

  close:
    name: Close PR Preview
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'closed' }}

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get App Token
        id: my-app
        run: bash ./.github/scripts/token.sh
        env:
          APP_ID: ${{ secrets.APP_ID }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to Preview Repo
        run: |
          bash ./.github/scripts/preview.sh "${{ github.job }}:${{ github.event.number }}" \
            --owner "${{ github.repository_owner }}" \
            --source-repo "${{ github.event.repository.name }}" \
            --target-repo "${{ github.event.repository.name }}-preview"
        env:
          GH_TOKEN: ${{ steps.my-app.outputs.token }}
