# tox.ini
# 用于测试 scMagnify 依赖版本范围的配置文件

[tox]
# tox 4.0+ 的推荐设置
min_version = 4.0
isolated_build = True

# 定义我们的测试矩阵：
# 1. 默认 (py310, py311, py312): 测试 'latest-capped'，即 pyproject.toml 中定义的最新版本
# 2. 'min': 测试 pyproject.toml 中定义的 *最低* 版本
# 3. 'uncapped': 测试 PyPI 上的 *绝对最新* 版本，忽略 pyproject.toml 中的上限
envlist =
    py{310,311,312}
    py{310,311,312}-min
    py{310,311,312}-uncapped

[testenv]
# ==========================================================
# 基础环境配置 (默认的 "latest-capped" 场景)
# ==========================================================
installer = uv

description = Test with latest *capped* dependencies (respects pyproject.toml)

# tox 默认会运行 `pip install .`
# pip 会自动读取 pyproject.toml 并遵守所有版本限制
# (例如 scanpy<1.10.4, mudata<=0.2.3)

# 运行的命令：只测试导入
# 我们使用 {envname} 和 {envpython} 变量来获取清晰的日志
commands =
    python -c "import scmagnify; print(f'✅ Import OK on {envpython} ({envname})')"


# ==========================================================
# "min" 场景: 测试最低版本
# ==========================================================
[testenv:py{310,311,312}-min]
description = Test with *minimum* specified dependencies

# 'deps' 会在 tox 运行 `pip install .` *之前* 被安装。
# pip 稍后会看到这些包已安装，并判定它们满足 '>=X' 的要求。
deps =
    # --- 钉住所有 '>= X' 的依赖 ---
    rich==10.0.0
    scanpy==1.9.0
    torch==2.0.0
    cellrank==2.0.0
    SEACells==0.3.3
    decoupler==2.1.1
    genomepy==0.16.1
    pyarrow==20.0.0
    pysam==0.23.1
    PyComplexHeatmap==1.8.2

    # --- 对于只有 '< Y' 或 '<= Y' 的依赖，我们钉住允许的最新版本 ---
    mudata==0.2.3
    pycirclize==1.10.0


# ==========================================================
# "uncapped" 场景: 测试 PyPI 上的绝对最新版
# ==========================================================
[testenv:py{310,311,312}-uncapped]
description = Test with *latest uncapped* dependencies (ignores pyproject.toml)

# 1. 告诉 tox 不要自动安装我们的包
skip_install = true

# 2. 我们手动安装：
#    a. 安装包本身，但不拉取它的依赖 (--no-deps)
#    b. 安装所有依赖项，但不带任何版本限制
deps =
    . --no-deps
    rich
    scanpy
    mudata
    torch
    cellrank
    SEACells
    decoupler
    genomepy
    pyarrow
    pysam
    pycirclize
    PyComplexHeatmap
    pooch
    MOODS-python
    pytabix
    pygam
    pyranges
    tensorly
    session-info
