var ft=Object.defineProperty;var l=(h,e)=>ft(h,"name",{value:e,configurable:!0});import{defineComponent as z,mergeModels as ke,useModel as _,ref as x,onMounted as me,onUnmounted as xe,resolveDirective as fe,openBlock as A,createElementBlock as I,createVNode as R,unref as s,withCtx as F,withDirectives as $,createElementVNode as f,normalizeClass as Q,vShow as we,computed as Z,createBlock as J,createCommentVNode as P,Fragment as De,renderList as Ue,createTextVNode as _e,toDisplayString as j,withModifiers as H,Transition as vt,toValue as Mt,vModelText as wt,watch as W,toRaw as ge,nextTick as Ct,onBeforeUnmount as bt,isRef as ne}from"vue";import B from"primevue/button";import Be from"primevue/slider";import{u as Me,t as y,d as Oe,w as U,bY as Te,a as Ie,q as Ve,a2 as yt,k as qe}from"./index-BYfAAqfw.js";import Ae from"primevue/select";import kt from"primevue/checkbox";import{A as At,L as xt,P as pe,O as le,V as Pe,a as Rt,b as Ne,D as Ce,G as St,c as Et,M as It,F as Lt,S as Tt,d as de,e as Dt,f as Ut,g as _t,h as Pt,T as He,i as Bt,j as Ft,k as Ge,l as Qe,m as $t,n as Ee,C as We,o as ce,p as je,q as Ot,r as ze,E as Xe,N as Vt,s as Fe,t as $e,u as Ye,B as Ze,v as Je,w as Ht,x as zt,y as Nt,z as Gt,H as Ke,I as Wt,W as jt}from"./vendor-three-zdhtZbSm.js";import{ck as Xt}from"./vendor-other-ISwNJJIx.js";const Yt={class:"relative show-slider"},Zt={class:"absolute top-0 left-12 rounded-lg bg-black/50 p-4 shadow-lg w-[150px]"},et=z({__name:"PopupSlider",props:ke({icon:{default:"pi-expand"},tooltipText:{},min:{default:10},max:{default:150},step:{default:1}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(h){const e=_(h,"modelValue"),t=x(!1),a=l(()=>{t.value=!t.value},"toggleSlider"),o=l(r=>{r.target.closest(".show-slider")||(t.value=!1)},"closeSlider");return me(()=>{document.addEventListener("click",o)}),xe(()=>{document.removeEventListener("click",o)}),(r,n)=>{const i=fe("tooltip");return A(),I("div",Yt,[R(s(B),{class:"p-button-rounded p-button-text",onClick:a},{default:F(()=>[$(f("i",{class:Q(["pi",r.icon,"text-lg text-white"])},null,2),[[i,{value:r.tooltipText,showDelay:300},void 0,{right:!0}]])]),_:1}),$(f("div",Zt,[R(s(Be),{modelValue:e.value,"onUpdate:modelValue":n[0]||(n[0]=c=>e.value=c),class:"w-full",min:r.min,max:r.max,step:r.step},null,8,["modelValue","min","max","step"])],512),[[we,t.value]])])}}}),Jt={class:"flex flex-col"},Kt={class:Q(["pi","pi-camera","text-lg text-white"])},qt=z({__name:"CameraControls",props:{cameraType:{},cameraTypeModifiers:{},fov:{},fovModifiers:{}},emits:["update:cameraType","update:fov"],setup(h){const e=_(h,"cameraType"),t=_(h,"fov"),a=Z(()=>e.value==="perspective"),o=l(()=>{e.value=e.value==="perspective"?"orthographic":"perspective"},"switchCamera");return(r,n)=>{const i=fe("tooltip");return A(),I("div",Jt,[R(s(B),{class:"p-button-rounded p-button-text",onClick:o},{default:F(()=>[$(f("i",Kt,null,512),[[i,{value:r.$t("load3d.switchCamera"),showDelay:300},void 0,{right:!0}]])]),_:1}),a.value?(A(),J(et,{key:0,modelValue:t.value,"onUpdate:modelValue":n[0]||(n[0]=c=>t.value=c),"tooltip-text":r.$t("load3d.fov")},null,8,["modelValue","tooltip-text"])):P("",!0)])}}}),Qt={class:"flex flex-col"},ea={class:"show-export-formats relative"},ta={class:"pi pi-download text-lg text-white"},aa={class:"absolute top-0 left-12 rounded-lg bg-black/50 shadow-lg"},oa={class:"flex flex-col"},ia=z({__name:"ExportControls",emits:["exportModel"],setup(h,{emit:e}){const t=e,a=x(!1),o=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}],r=l(()=>{a.value=!a.value},"toggleExportFormats"),n=l(c=>{t("exportModel",c),a.value=!1},"exportModel"),i=l(c=>{c.target.closest(".show-export-formats")||(a.value=!1)},"closeExportFormatsList");return me(()=>{document.addEventListener("click",i)}),xe(()=>{document.removeEventListener("click",i)}),(c,g)=>{const p=fe("tooltip");return A(),I("div",Qt,[f("div",ea,[R(s(B),{class:"p-button-rounded p-button-text",onClick:r},{default:F(()=>[$(f("i",ta,null,512),[[p,{value:c.$t("load3d.exportModel"),showDelay:300},void 0,{right:!0}]])]),_:1}),$(f("div",aa,[f("div",oa,[(A(),I(De,null,Ue(o,M=>R(s(B),{key:M.value,class:"p-button-text text-white",onClick:l(b=>n(M.value),"onClick")},{default:F(()=>[_e(j(M.label),1)]),_:2},1032,["onClick"])),64))])],512),[[we,a.value]])])])}}}),ra={class:"flex flex-col"},na={key:0,class:"show-light-intensity relative"},sa={class:"pi pi-sun text-lg text-white"},la={class:"absolute top-0 left-12 rounded-lg bg-black/50 p-4 shadow-lg",style:{width:"150px"}},da=z({__name:"LightControls",props:{lightIntensity:{},lightIntensityModifiers:{},materialMode:{},materialModeModifiers:{}},emits:["update:lightIntensity","update:materialMode"],setup(h){const e=_(h,"lightIntensity"),t=_(h,"materialMode"),a=Z(()=>t.value==="original"),o=x(!1),r=Me().get("Comfy.Load3D.LightIntensityMaximum"),n=Me().get("Comfy.Load3D.LightIntensityMinimum"),i=Me().get("Comfy.Load3D.LightAdjustmentIncrement"),c=l(()=>{o.value=!o.value},"toggleLightIntensity"),g=l(p=>{p.target.closest(".show-light-intensity")||(o.value=!1)},"closeLightSlider");return me(()=>{document.addEventListener("click",g)}),xe(()=>{document.removeEventListener("click",g)}),(p,M)=>{const b=fe("tooltip");return A(),I("div",ra,[a.value?(A(),I("div",na,[R(s(B),{class:"p-button-rounded p-button-text",onClick:c},{default:F(()=>[$(f("i",sa,null,512),[[b,{value:p.$t("load3d.lightIntensity"),showDelay:300},void 0,{right:!0}]])]),_:1}),$(f("div",la,[R(s(Be),{modelValue:e.value,"onUpdate:modelValue":M[0]||(M[0]=m=>e.value=m),class:"w-full",min:s(n),max:s(r),step:s(i)},null,8,["modelValue","min","max","step"])],512),[[we,o.value]])])):P("",!0)])}}}),ca={class:"flex flex-col"},ua={class:"show-up-direction relative"},ga={class:"pi pi-arrow-up text-lg text-white"},ha={class:"absolute top-0 left-12 rounded-lg bg-black/50 shadow-lg"},pa={class:"flex flex-col"},ma={class:"show-material-mode relative"},fa={class:"pi pi-box text-lg text-white"},va={class:"absolute top-0 left-12 rounded-lg bg-black/50 shadow-lg"},Ma={class:"flex flex-col"},wa=z({__name:"ModelControls",props:{materialMode:{},materialModeModifiers:{},upDirection:{},upDirectionModifiers:{}},emits:["update:materialMode","update:upDirection"],setup(h){const e=_(h,"materialMode"),t=_(h,"upDirection"),a=x(!1),o=x(!1),r=["original","-x","+x","-y","+y","-z","+z"],n=Z(()=>["original","normal","wireframe"]),i=l(()=>{a.value=!a.value,o.value=!1},"toggleUpDirection"),c=l(m=>{t.value=m,a.value=!1},"selectUpDirection"),g=l(()=>{o.value=!o.value,a.value=!1},"toggleMaterialMode"),p=l(m=>{e.value=m,o.value=!1},"selectMaterialMode"),M=l(m=>y(`load3d.materialModes.${m}`),"formatMaterialMode"),b=l(m=>{const w=m.target;w.closest(".show-up-direction")||(a.value=!1),w.closest(".show-material-mode")||(o.value=!1)},"closeSceneSlider");return me(()=>{document.addEventListener("click",b)}),xe(()=>{document.removeEventListener("click",b)}),(m,w)=>{const u=fe("tooltip");return A(),I("div",ca,[f("div",ua,[R(s(B),{class:"p-button-rounded p-button-text",onClick:i},{default:F(()=>[$(f("i",ga,null,512),[[u,{value:s(y)("load3d.upDirection"),showDelay:300},void 0,{right:!0}]])]),_:1}),$(f("div",ha,[f("div",pa,[(A(),I(De,null,Ue(r,v=>R(s(B),{key:v,class:Q(["p-button-text text-white",{"bg-blue-500":t.value===v}]),onClick:l(K=>c(v),"onClick")},{default:F(()=>[_e(j(v.toUpperCase()),1)]),_:2},1032,["class","onClick"])),64))])],512),[[we,a.value]])]),f("div",ma,[R(s(B),{class:"p-button-rounded p-button-text",onClick:g},{default:F(()=>[$(f("i",fa,null,512),[[u,{value:s(y)("load3d.materialMode"),showDelay:300},void 0,{right:!0}]])]),_:1}),$(f("div",va,[f("div",Ma,[(A(!0),I(De,null,Ue(n.value,v=>(A(),J(s(B),{key:v,class:Q(["p-button-text whitespace-nowrap text-white",{"bg-blue-500":e.value===v}]),onClick:l(K=>p(v),"onClick")},{default:F(()=>[_e(j(M(v)),1)]),_:2},1032,["class","onClick"]))),128))])],512),[[we,o.value]])])])}}}),Ca={class:"flex flex-col"},ba={class:"pi pi-table text-lg text-white"},ya={key:0},ka={class:"pi pi-palette text-lg text-white"},Aa=["value"],xa={key:1},Ra={class:"pi pi-image text-lg text-white"},Sa={key:2},Ea={class:"pi pi-globe text-lg text-white"},Ia={key:4},La={class:"pi pi-times text-lg text-white"},Ta=z({__name:"SceneControls",props:{showGrid:{type:Boolean},showGridModifiers:{},backgroundColor:{},backgroundColorModifiers:{},backgroundImage:{},backgroundImageModifiers:{},backgroundRenderMode:{default:"tiled"},backgroundRenderModeModifiers:{},fov:{},fovModifiers:{}},emits:ke(["updateBackgroundImage"],["update:showGrid","update:backgroundColor","update:backgroundImage","update:backgroundRenderMode","update:fov"]),setup(h,{emit:e}){const t=e,a=_(h,"showGrid"),o=_(h,"backgroundColor"),r=_(h,"backgroundImage"),n=_(h,"backgroundRenderMode"),i=_(h,"fov"),c=Z(()=>r.value&&r.value!==""),g=x(null),p=x(null),M=l(()=>{a.value=!a.value},"toggleGrid"),b=l(N=>{o.value=N},"updateBackgroundColor"),m=l(()=>{g.value?.click()},"openColorPicker"),w=l(()=>{p.value?.click()},"openImagePicker"),u=l(N=>{const X=N.target;X.files&&X.files[0]&&t("updateBackgroundImage",X.files[0])},"uploadBackgroundImage"),v=l(()=>{t("updateBackgroundImage",null)},"removeBackgroundImage"),K=l(()=>{n.value=n.value==="panorama"?"tiled":"panorama"},"toggleBackgroundRenderMode");return(N,X)=>{const q=fe("tooltip");return A(),I("div",Ca,[R(s(B),{class:Q(["p-button-rounded p-button-text",{"p-button-outlined":a.value}]),onClick:M},{default:F(()=>[$(f("i",ba,null,512),[[q,{value:N.$t("load3d.showGrid"),showDelay:300},void 0,{right:!0}]])]),_:1},8,["class"]),c.value?P("",!0):(A(),I("div",ya,[R(s(B),{class:"p-button-rounded p-button-text",onClick:m},{default:F(()=>[$(f("i",ka,null,512),[[q,{value:N.$t("load3d.backgroundColor"),showDelay:300},void 0,{right:!0}]]),f("input",{ref_key:"colorPickerRef",ref:g,type:"color",value:o.value,class:"pointer-events-none absolute m-0 h-0 w-0 p-0 opacity-0",onInput:X[0]||(X[0]=ee=>b(ee.target.value))},null,40,Aa)]),_:1})])),c.value?P("",!0):(A(),I("div",xa,[R(s(B),{class:"p-button-rounded p-button-text",onClick:w},{default:F(()=>[$(f("i",Ra,null,512),[[q,{value:N.$t("load3d.uploadBackgroundImage"),showDelay:300},void 0,{right:!0}]]),f("input",{ref_key:"imagePickerRef",ref:p,type:"file",accept:"image/*",class:"pointer-events-none absolute m-0 h-0 w-0 p-0 opacity-0",onChange:u},null,544)]),_:1})])),c.value?(A(),I("div",Sa,[R(s(B),{class:Q(["p-button-rounded p-button-text",{"p-button-outlined":n.value==="panorama"}]),onClick:K},{default:F(()=>[$(f("i",Ea,null,512),[[q,{value:N.$t("load3d.panoramaMode"),showDelay:300},void 0,{right:!0}]])]),_:1},8,["class"])])):P("",!0),c.value&&n.value==="panorama"?(A(),J(et,{key:3,modelValue:i.value,"onUpdate:modelValue":X[1]||(X[1]=ee=>i.value=ee),"tooltip-text":N.$t("load3d.fov")},null,8,["modelValue","tooltip-text"])):P("",!0),c.value?(A(),I("div",Ia,[R(s(B),{class:"p-button-rounded p-button-text",onClick:v},{default:F(()=>[$(f("i",La,null,512),[[q,{value:N.$t("load3d.removeBackgroundImage"),showDelay:300},void 0,{right:!0}]])]),_:1})])):P("",!0)])}}}),Da={class:"show-menu relative"},Ua={class:"absolute top-0 left-12 rounded-lg bg-black/50 shadow-lg"},_a={class:"flex flex-col"},Pa={class:"whitespace-nowrap text-white"},Ba={class:"rounded-lg bg-smoke-700/30"},Fa=z({__name:"Load3DControls",props:{sceneConfig:{},sceneConfigModifiers:{},modelConfig:{},modelConfigModifiers:{},cameraConfig:{},cameraConfigModifiers:{},lightConfig:{},lightConfigModifiers:{}},emits:ke(["updateBackgroundImage","exportModel"],["update:sceneConfig","update:modelConfig","update:cameraConfig","update:lightConfig"]),setup(h,{emit:e}){const t=_(h,"sceneConfig"),a=_(h,"modelConfig"),o=_(h,"cameraConfig"),r=_(h,"lightConfig"),n=x(!1),i=x("scene"),c={scene:"load3d.scene",model:"load3d.model",camera:"load3d.camera",light:"load3d.light",export:"load3d.export"},g=Z(()=>["scene","model","camera","light","export"]),p=Z(()=>i.value==="scene"&&!!t.value),M=Z(()=>i.value==="model"&&!!a.value),b=Z(()=>i.value==="camera"&&!!o.value),m=Z(()=>i.value==="light"&&!!r.value&&!!a.value),w=Z(()=>i.value==="export"),u=l(()=>{n.value=!n.value},"toggleMenu"),v=l(G=>{i.value=G,n.value=!1},"selectCategory"),K=l(G=>`${{scene:"pi pi-image",model:"pi pi-box",camera:"pi pi-camera",light:"pi pi-sun",export:"pi pi-download"}[G]} text-white text-lg`,"getCategoryIcon"),N=e,X=l(G=>{N("updateBackgroundImage",G)},"handleBackgroundImageUpdate"),q=l(G=>{N("exportModel",G)},"handleExportModel"),ee=l(G=>{G.target.closest(".show-menu")||(n.value=!1)},"closeSlider");return me(()=>{document.addEventListener("click",ee)}),xe(()=>{document.removeEventListener("click",ee)}),(G,E)=>(A(),I("div",{class:"pointer-events-auto absolute top-12 left-2 z-20 flex flex-col rounded-lg bg-smoke-700/30",onPointerdown:E[11]||(E[11]=H(()=>{},["stop"])),onPointermove:E[12]||(E[12]=H(()=>{},["stop"])),onPointerup:E[13]||(E[13]=H(()=>{},["stop"])),onWheel:E[14]||(E[14]=H(()=>{},["stop"]))},[f("div",Da,[R(s(B),{class:"p-button-rounded p-button-text",onClick:u},{default:F(()=>E[15]||(E[15]=[f("i",{class:"pi pi-bars text-lg text-white"},null,-1)])),_:1}),$(f("div",Ua,[f("div",_a,[(A(!0),I(De,null,Ue(g.value,T=>(A(),J(s(B),{key:T,class:Q(["p-button-text flex w-full items-center justify-start",{"bg-smoke-600":i.value===T}]),onClick:l(Re=>v(T),"onClick")},{default:F(()=>[f("i",{class:Q(K(T))},null,2),f("span",Pa,j(G.$t(c[T])),1)]),_:2},1032,["class","onClick"]))),128))])],512),[[we,n.value]])]),$(f("div",Ba,[p.value?(A(),J(Ta,{key:0,ref:"sceneControlsRef","show-grid":t.value.showGrid,"onUpdate:showGrid":E[0]||(E[0]=T=>t.value.showGrid=T),"background-color":t.value.backgroundColor,"onUpdate:backgroundColor":E[1]||(E[1]=T=>t.value.backgroundColor=T),"background-image":t.value.backgroundImage,"onUpdate:backgroundImage":E[2]||(E[2]=T=>t.value.backgroundImage=T),"background-render-mode":t.value.backgroundRenderMode,"onUpdate:backgroundRenderMode":E[3]||(E[3]=T=>t.value.backgroundRenderMode=T),fov:o.value.fov,"onUpdate:fov":E[4]||(E[4]=T=>o.value.fov=T),onUpdateBackgroundImage:X},null,8,["show-grid","background-color","background-image","background-render-mode","fov"])):P("",!0),M.value?(A(),J(wa,{key:1,ref:"modelControlsRef","material-mode":a.value.materialMode,"onUpdate:materialMode":E[5]||(E[5]=T=>a.value.materialMode=T),"up-direction":a.value.upDirection,"onUpdate:upDirection":E[6]||(E[6]=T=>a.value.upDirection=T)},null,8,["material-mode","up-direction"])):P("",!0),b.value?(A(),J(qt,{key:2,ref:"cameraControlsRef","camera-type":o.value.cameraType,"onUpdate:cameraType":E[7]||(E[7]=T=>o.value.cameraType=T),fov:o.value.fov,"onUpdate:fov":E[8]||(E[8]=T=>o.value.fov=T)},null,8,["camera-type","fov"])):P("",!0),m.value?(A(),J(da,{key:3,ref:"lightControlsRef","light-intensity":r.value.intensity,"onUpdate:lightIntensity":E[9]||(E[9]=T=>r.value.intensity=T),"material-mode":a.value.materialMode,"onUpdate:materialMode":E[10]||(E[10]=T=>a.value.materialMode=T)},null,8,["light-intensity","material-mode"])):P("",!0),w.value?(A(),J(ia,{key:4,ref:"exportControlsRef",onExportModel:q},null,512)):P("",!0)],512),[[we,i.value]])],32))}}),$a={key:0,class:"bg-opacity-50 absolute inset-0 z-50 flex items-center justify-center bg-black"},Oa={class:"flex flex-col items-center"},Va={class:"mt-4 text-lg text-white"},Ha=z({__name:"LoadingOverlay",props:{loading:{type:Boolean},loadingMessage:{}},setup(h){return(e,t)=>(A(),J(vt,{name:"fade"},{default:F(()=>[e.loading?(A(),I("div",$a,[f("div",Oa,[t[0]||(t[0]=f("div",{class:"spinner"},null,-1)),f("div",Va,j(e.loadingMessage),1)])])):P("",!0)]),_:1}))}}),za=Oe(Ha,[["__scopeId","data-v-b13965f5"]]),tt=new Set([".gltf",".glb",".obj",".fbx",".stl"]);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.interfaces=window.comfyAPI.interfaces||{};window.comfyAPI.interfaces.SUPPORTED_EXTENSIONS=tt;function at(h){const e=x(!1),t=x(""),a=Z(()=>Mt(h.disabled)??!1);function o(c){const g=c.name.toLowerCase(),p=g.substring(g.lastIndexOf("."));return tt.has(p)}l(o,"isValidModelFile");function r(c){a.value||!c.dataTransfer||!c.dataTransfer.types.includes("Files")||(e.value=!0,c.dataTransfer.dropEffect="copy",t.value=y("load3d.dropToLoad"))}l(r,"handleDragOver");function n(){e.value=!1}l(n,"handleDragLeave");async function i(c){if(e.value=!1,a.value||!c.dataTransfer)return;const g=Array.from(c.dataTransfer.files);if(g.length===0)return;const p=g.find(o);p?await h.onModelDrop(p):U().addAlert(y("load3d.unsupportedFileType"))}return l(i,"handleDrop"),{isDragging:e,dragMessage:t,handleDragOver:r,handleDragLeave:n,handleDrop:i}}l(at,"useLoad3dDrag");const Na={key:0,class:"pointer-events-none absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"},Ga={class:"rounded-lg border-2 border-dashed border-blue-400 bg-blue-500/20 px-6 py-4 text-lg font-medium text-blue-100"},Wa=z({__name:"Load3DScene",props:{initializeLoad3d:{type:Function},cleanup:{type:Function},loading:{type:Boolean},loadingMessage:{},onModelDrop:{type:Function},isPreview:{type:Boolean}},setup(h){const e=h,t=x(null),a=x(null),{isDragging:o,dragMessage:r,handleDragOver:n,handleDragLeave:i,handleDrop:c}=at({onModelDrop:l(async g=>{e.onModelDrop&&await e.onModelDrop(g)},"onModelDrop"),disabled:Z(()=>e.isPreview)});return me(()=>{t.value&&e.initializeLoad3d(t.value)}),xe(()=>{e.cleanup()}),(g,p)=>(A(),I("div",{ref_key:"container",ref:t,class:"relative h-full w-full","data-capture-wheel":"true",onPointerdown:p[0]||(p[0]=H(()=>{},["stop"])),onPointermove:p[1]||(p[1]=H(()=>{},["stop"])),onPointerup:p[2]||(p[2]=H(()=>{},["stop"])),onMousedown:p[3]||(p[3]=H(()=>{},["stop"])),onMousemove:p[4]||(p[4]=H(()=>{},["stop"])),onMouseup:p[5]||(p[5]=H(()=>{},["stop"])),onContextmenu:p[6]||(p[6]=H(()=>{},["stop","prevent"])),onDragover:p[7]||(p[7]=H((...M)=>s(n)&&s(n)(...M),["prevent","stop"])),onDragleave:p[8]||(p[8]=H((...M)=>s(i)&&s(i)(...M),["stop"])),onDrop:p[9]||(p[9]=H((...M)=>s(c)&&s(c)(...M),["prevent","stop"]))},[R(za,{ref_key:"loadingOverlayRef",ref:a,loading:g.loading,"loading-message":g.loadingMessage},null,8,["loading","loading-message"]),!g.isPreview&&s(o)?(A(),I("div",Na,[f("div",Ga,j(s(r)),1)])):P("",!0)],544))}}),ja={key:0,class:"pointer-events-auto absolute top-0 left-0 z-10 flex w-full items-center justify-center gap-2 pt-2"},Xa=z({__name:"AnimationControls",props:{animations:{},animationsModifiers:{},playing:{type:Boolean},playingModifiers:{},selectedSpeed:{},selectedSpeedModifiers:{},selectedAnimation:{},selectedAnimationModifiers:{}},emits:["update:animations","update:playing","update:selectedSpeed","update:selectedAnimation"],setup(h){const e=_(h,"animations"),t=_(h,"playing"),a=_(h,"selectedSpeed"),o=_(h,"selectedAnimation"),r=[{name:"0.1x",value:.1},{name:"0.5x",value:.5},{name:"1x",value:1},{name:"1.5x",value:1.5},{name:"2x",value:2}],n=l(()=>{t.value=!t.value},"togglePlay");return(i,c)=>e.value&&e.value.length>0?(A(),I("div",ja,[R(s(B),{class:"p-button-rounded p-button-text",onClick:n},{default:F(()=>[f("i",{class:Q(["pi",t.value?"pi-pause":"pi-play","text-lg text-white"])},null,2)]),_:1}),R(s(Ae),{modelValue:a.value,"onUpdate:modelValue":c[0]||(c[0]=g=>a.value=g),options:r,"option-label":"name","option-value":"value",class:"w-24"},null,8,["modelValue"]),R(s(Ae),{modelValue:o.value,"onUpdate:modelValue":c[1]||(c[1]=g=>o.value=g),options:e.value,"option-label":"name","option-value":"index",class:"w-32"},null,8,["modelValue","options"])])):P("",!0)}}),Ya={class:"relative rounded-lg bg-smoke-700/30"},Za={class:"flex flex-col gap-2"},Ja={class:"pi pi-download text-lg text-white"},Ka={class:"pi pi-trash text-lg text-white"},qa={key:2,class:"mt-1 text-center text-xs text-white"},Qa=z({__name:"RecordingControls",props:{hasRecording:{type:Boolean},hasRecordingModifiers:{},isRecording:{type:Boolean},isRecordingModifiers:{},recordingDuration:{},recordingDurationModifiers:{}},emits:ke(["startRecording","stopRecording","exportRecording","clearRecording"],["update:hasRecording","update:isRecording","update:recordingDuration"]),setup(h,{emit:e}){const t=_(h,"hasRecording"),a=_(h,"isRecording"),o=_(h,"recordingDuration"),r=e,n=l(()=>{a.value?r("stopRecording"):r("startRecording")},"toggleRecording"),i=l(()=>{r("exportRecording")},"handleExportRecording"),c=l(()=>{r("clearRecording")},"handleClearRecording"),g=l(p=>{const M=Math.floor(p/60),b=Math.floor(p%60);return`${M.toString().padStart(2,"0")}:${b.toString().padStart(2,"0")}`},"formatDuration");return(p,M)=>{const b=fe("tooltip");return A(),I("div",Ya,[f("div",Za,[R(s(B),{class:Q(["p-button-rounded p-button-text",{"p-button-danger":a.value,"recording-button-blink":a.value}]),onClick:n},{default:F(()=>[$(f("i",{class:Q(["pi",a.value?"pi-circle-fill":"pi-video","text-lg text-white"])},null,2),[[b,{value:a.value?p.$t("load3d.stopRecording"):p.$t("load3d.startRecording"),showDelay:300},void 0,{right:!0}]])]),_:1},8,["class"]),t.value&&!a.value?(A(),J(s(B),{key:0,class:"p-button-rounded p-button-text",onClick:i},{default:F(()=>[$(f("i",Ja,null,512),[[b,{value:p.$t("load3d.exportRecording"),showDelay:300},void 0,{right:!0}]])]),_:1})):P("",!0),t.value&&!a.value?(A(),J(s(B),{key:1,class:"p-button-rounded p-button-text",onClick:c},{default:F(()=>[$(f("i",Ka,null,512),[[b,{value:p.$t("load3d.clearRecording"),showDelay:300},void 0,{right:!0}]])]),_:1})):P("",!0),o.value&&o.value>0&&!a.value?(A(),I("div",qa,j(g(o.value)),1)):P("",!0)])])}}}),eo=Oe(Qa,[["__scopeId","data-v-145dbaf6"]]),to={class:"space-y-4"},ao={class:"space-y-4"},oo={key:0,class:"space-y-4"},io=z({__name:"ViewerCameraControls",props:{cameraType:{},cameraTypeModifiers:{},fov:{},fovModifiers:{}},emits:["update:cameraType","update:fov"],setup(h){const e=[{title:y("load3d.cameraType.perspective"),value:"perspective"},{title:y("load3d.cameraType.orthographic"),value:"orthographic"}],t=_(h,"cameraType"),a=_(h,"fov"),o=Z(()=>t.value==="perspective");return(r,n)=>(A(),I("div",to,[f("div",ao,[f("label",null,j(s(y)("load3d.viewer.cameraType")),1),R(s(Ae),{modelValue:t.value,"onUpdate:modelValue":n[0]||(n[0]=i=>t.value=i),options:e,"option-label":"title","option-value":"value"},null,8,["modelValue"])]),o.value?(A(),I("div",oo,[f("label",null,j(s(y)("load3d.fov")),1),R(s(Be),{modelValue:a.value,"onUpdate:modelValue":n[1]||(n[1]=i=>a.value=i),min:10,max:150,step:1,"aria-label":s(y)("load3d.fov")},null,8,["modelValue","aria-label"])])):P("",!0)]))}}),ro={class:"space-y-4"},no=z({__name:"ViewerExportControls",emits:["exportModel"],setup(h,{emit:e}){const t=e,a=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}],o=x("obj"),r=l(n=>{t("exportModel",n)},"exportModel");return(n,i)=>(A(),I("div",ro,[R(s(Ae),{modelValue:o.value,"onUpdate:modelValue":i[0]||(i[0]=c=>o.value=c),options:a,"option-label":"label","option-value":"value"},null,8,["modelValue"]),R(s(B),{severity:"secondary",text:"",rounded:"",onClick:i[1]||(i[1]=c=>r(o.value))},{default:F(()=>[_e(j(n.$t("load3d.export")),1)]),_:1})]))}}),so={class:"space-y-4"},lo=z({__name:"ViewerLightControls",props:{lightIntensity:{},lightIntensityModifiers:{}},emits:["update:lightIntensity"],setup(h){const e=_(h,"lightIntensity"),t=Me().get("Comfy.Load3D.LightIntensityMaximum"),a=Me().get("Comfy.Load3D.LightIntensityMinimum"),o=Me().get("Comfy.Load3D.LightAdjustmentIncrement");return(r,n)=>(A(),I("div",so,[f("label",null,j(r.$t("load3d.lightIntensity")),1),R(s(Be),{modelValue:e.value,"onUpdate:modelValue":n[0]||(n[0]=i=>e.value=i),class:"w-full",min:s(a),max:s(t),step:s(o)},null,8,["modelValue","min","max","step"])]))}}),co={class:"space-y-4"},uo=z({__name:"ViewerModelControls",props:{upDirection:{},upDirectionModifiers:{},materialMode:{},materialModeModifiers:{}},emits:["update:upDirection","update:materialMode"],setup(h){const e=_(h,"upDirection"),t=_(h,"materialMode"),a=[{label:y("load3d.upDirections.original"),value:"original"},{label:"-X",value:"-x"},{label:"+X",value:"+x"},{label:"-Y",value:"-y"},{label:"+Y",value:"+y"},{label:"-Z",value:"-z"},{label:"+Z",value:"+z"}],o=Z(()=>[{label:y("load3d.materialModes.original"),value:"original"},{label:y("load3d.materialModes.normal"),value:"normal"},{label:y("load3d.materialModes.wireframe"),value:"wireframe"}]);return(r,n)=>(A(),I("div",co,[f("div",null,[f("label",null,j(r.$t("load3d.upDirection")),1),R(s(Ae),{modelValue:e.value,"onUpdate:modelValue":n[0]||(n[0]=i=>e.value=i),options:a,"option-label":"label","option-value":"value"},null,8,["modelValue"])]),f("div",null,[f("label",null,j(r.$t("load3d.materialMode")),1),R(s(Ae),{modelValue:t.value,"onUpdate:modelValue":n[1]||(n[1]=i=>t.value=i),options:o.value,"option-label":"label","option-value":"value"},null,8,["modelValue","options"])])]))}}),go={class:"space-y-4"},ho={key:0},po={for:"showGrid",class:"pl-2"},mo={key:1},fo={key:2,class:"space-y-2"},vo={class:"flex gap-2"},Mo=z({__name:"ViewerSceneControls",props:ke({hasBackgroundImage:{type:Boolean}},{backgroundColor:{},backgroundColorModifiers:{},showGrid:{type:Boolean},showGridModifiers:{},backgroundRenderMode:{},backgroundRenderModeModifiers:{}}),emits:ke(["updateBackgroundImage"],["update:backgroundColor","update:showGrid","update:backgroundRenderMode"]),setup(h,{emit:e}){const t=_(h,"backgroundColor"),a=_(h,"showGrid"),o=_(h,"backgroundRenderMode"),r=e,n=x(null),i=l(()=>{n.value?.click()},"openImagePicker"),c=l(M=>{const b=M.target;b.files&&b.files[0]&&r("updateBackgroundImage",b.files[0]),b.value=""},"handleImageUpload"),g=l(()=>{r("updateBackgroundImage",null)},"removeBackgroundImage"),p=l(M=>{o.value=M},"setBackgroundRenderMode");return(M,b)=>(A(),I("div",go,[M.hasBackgroundImage?P("",!0):(A(),I("div",ho,[f("label",null,j(M.$t("load3d.backgroundColor")),1),$(f("input",{"onUpdate:modelValue":b[0]||(b[0]=m=>t.value=m),type:"color",class:"w-full"},null,512),[[wt,t.value]])])),f("div",null,[R(s(kt),{modelValue:a.value,"onUpdate:modelValue":b[1]||(b[1]=m=>a.value=m),"input-id":"showGrid",binary:"",name:"showGrid"},null,8,["modelValue"]),f("label",po,j(M.$t("load3d.showGrid")),1)]),M.hasBackgroundImage?P("",!0):(A(),I("div",mo,[R(s(B),{severity:"secondary",label:M.$t("load3d.uploadBackgroundImage"),icon:"pi pi-image",class:"w-full",onClick:i},null,8,["label"]),f("input",{ref_key:"imagePickerRef",ref:n,type:"file",accept:"image/*",class:"hidden",onChange:c},null,544)])),M.hasBackgroundImage?(A(),I("div",fo,[f("div",vo,[R(s(B),{severity:o.value==="tiled"?"primary":"secondary",label:M.$t("load3d.tiledMode"),icon:"pi pi-th-large",class:"flex-1",onClick:b[2]||(b[2]=m=>p("tiled"))},null,8,["severity","label"]),R(s(B),{severity:o.value==="panorama"?"primary":"secondary",label:M.$t("load3d.panoramaMode"),icon:"pi pi-globe",class:"flex-1",onClick:b[3]||(b[3]=m=>p("panorama"))},null,8,["severity","label"])]),R(s(B),{severity:"secondary",label:M.$t("load3d.removeBackgroundImage"),icon:"pi pi-times",class:"w-full",onClick:g},null,8,["label"])])):P("",!0)]))}});class ot{static{l(this,"AnimationManager")}currentAnimation=null;animationActions=[];animationClips=[];selectedAnimationIndex=0;isAnimationPlaying=!1;animationSpeed=1;eventManager;constructor(e){this.eventManager=e}init(){}dispose(){this.currentAnimation&&(this.animationActions.forEach(e=>{e.stop()}),this.currentAnimation=null),this.animationActions=[],this.animationClips=[],this.selectedAnimationIndex=0,this.isAnimationPlaying=!1,this.animationSpeed=1,this.eventManager.emitEvent("animationListChange",[])}setupModelAnimations(e,t){this.currentAnimation&&(this.currentAnimation.stopAllAction(),this.animationActions=[]);let a=[];e.animations?.length>0?a=e.animations:t&&"animations"in t&&Array.isArray(t.animations)&&(a=t.animations),a.length>0?(this.animationClips=a,this.currentAnimation=new At(e),this.animationClips.length>0&&this.updateSelectedAnimation(0)):this.animationClips=[],this.updateAnimationList()}updateAnimationList(){let e=[];this.animationClips.length>0&&(e=this.animationClips.map((t,a)=>({name:t.name||`Animation ${a+1}`,index:a}))),this.eventManager.emitEvent("animationListChange",e)}setAnimationSpeed(e){this.animationSpeed=e,this.animationActions.forEach(t=>{t.setEffectiveTimeScale(e)})}updateSelectedAnimation(e){if(!this.currentAnimation||!this.animationClips||e>=this.animationClips.length){console.warn("Invalid animation update request");return}this.animationActions.forEach(o=>{o.stop()}),this.currentAnimation.stopAllAction(),this.animationActions=[],this.selectedAnimationIndex=e;const t=this.animationClips[e],a=this.currentAnimation.clipAction(t);a.setEffectiveTimeScale(this.animationSpeed),a.reset(),a.clampWhenFinished=!1,a.loop=xt,this.isAnimationPlaying?a.play():(a.play(),a.paused=!0),this.animationActions=[a]}toggleAnimation(e){if(!this.currentAnimation||this.animationActions.length===0){console.warn("No animation to toggle");return}this.isAnimationPlaying=e??!this.isAnimationPlaying,this.animationActions.forEach(t=>{this.isAnimationPlaying?(t.paused=!1,(t.time===0||t.time===t.getClip().duration)&&t.reset()):t.paused=!0})}update(e){this.currentAnimation&&this.isAnimationPlaying&&this.currentAnimation.update(e)}reset(){}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.AnimationManager=window.comfyAPI.AnimationManager||{};window.comfyAPI.AnimationManager.AnimationManager=ot;class it{static{l(this,"CameraManager")}perspectiveCamera;orthographicCamera;activeCamera;renderer;eventManager;nodeStorage;controls=null;DEFAULT_DISTANCE=10;DEFAULT_LOOK_AT=0;DEFAULT_CAMERA={near:.01,far:1e4};DEFAULT_PERSPECTIVE_CAMERA={fov:35,aspect:1};DEFAULT_FRUSTUM_SIZE=10;DEFAULT_ORTHOGRAPHIC_CAMERA={left:-this.DEFAULT_FRUSTUM_SIZE/2,right:this.DEFAULT_FRUSTUM_SIZE/2,top:this.DEFAULT_FRUSTUM_SIZE/2,bottom:-this.DEFAULT_FRUSTUM_SIZE/2};constructor(e,t,a){this.renderer=e,this.eventManager=t,this.nodeStorage=a,this.perspectiveCamera=new pe(this.DEFAULT_PERSPECTIVE_CAMERA.fov,this.DEFAULT_PERSPECTIVE_CAMERA.aspect,this.DEFAULT_CAMERA.near,this.DEFAULT_CAMERA.far),this.orthographicCamera=new le(this.DEFAULT_ORTHOGRAPHIC_CAMERA.left,this.DEFAULT_ORTHOGRAPHIC_CAMERA.right,this.DEFAULT_ORTHOGRAPHIC_CAMERA.top,this.DEFAULT_ORTHOGRAPHIC_CAMERA.bottom,this.DEFAULT_CAMERA.near,this.DEFAULT_CAMERA.far),this.reset(),this.activeCamera=this.perspectiveCamera}init(){}dispose(){}setControls(e){this.controls=e,this.controls&&this.controls.addEventListener("end",()=>{const t=this.getCameraState(),a=this.nodeStorage.loadNodeProperty("Camera Config",{cameraType:this.getCurrentCameraType(),fov:this.perspectiveCamera.fov});a.state=t,this.nodeStorage.storeNodeProperty("Camera Config",a)})}getCurrentCameraType(){return this.activeCamera===this.perspectiveCamera?"perspective":"orthographic"}toggleCamera(e){const t=this.activeCamera,a=t.position.clone(),o=t.rotation.clone(),r=this.controls?.target.clone()||new Pe,n=(t instanceof le,t.zoom);if(!e)this.activeCamera=t===this.perspectiveCamera?this.orthographicCamera:this.perspectiveCamera;else if(this.activeCamera=e==="perspective"?this.perspectiveCamera:this.orthographicCamera,t===this.activeCamera)return;this.activeCamera.position.copy(a),this.activeCamera.rotation.copy(o),this.activeCamera instanceof le?(this.activeCamera.zoom=n,this.activeCamera.updateProjectionMatrix()):this.activeCamera instanceof pe&&(this.activeCamera.zoom=n,this.activeCamera.updateProjectionMatrix()),this.controls&&(this.controls.object=this.activeCamera,this.controls.target.copy(r),this.controls.update()),this.eventManager.emitEvent("cameraTypeChange",e)}setFOV(e){this.activeCamera===this.perspectiveCamera&&(this.perspectiveCamera.fov=e,this.perspectiveCamera.updateProjectionMatrix()),this.eventManager.emitEvent("fovChange",e)}getCameraState(){return{position:this.activeCamera.position.clone(),target:this.controls?.target.clone()||new Pe,zoom:this.activeCamera instanceof le?this.activeCamera.zoom:this.activeCamera.zoom,cameraType:this.getCurrentCameraType()}}setCameraState(e){this.activeCamera.position.copy(e.position),this.controls?.target.copy(e.target),this.activeCamera instanceof le?(this.activeCamera.zoom=e.zoom,this.activeCamera.updateProjectionMatrix()):this.activeCamera instanceof pe&&(this.activeCamera.zoom=e.zoom,this.activeCamera.updateProjectionMatrix()),this.controls?.update()}handleResize(e,t){const a=e/t;this.updateAspectRatio(a)}updateAspectRatio(e){this.activeCamera===this.perspectiveCamera?(this.perspectiveCamera.aspect=e,this.perspectiveCamera.updateProjectionMatrix()):(this.orthographicCamera.left=-10*e/2,this.orthographicCamera.right=10*e/2,this.orthographicCamera.top=10/2,this.orthographicCamera.bottom=-10/2,this.orthographicCamera.updateProjectionMatrix())}setupForModel(e){const t=Math.max(e.x,e.z)*2,a=e.y*2;if(this.perspectiveCamera.position.set(t,a,t),this.orthographicCamera.position.set(t,a,t),this.activeCamera===this.perspectiveCamera)this.perspectiveCamera.lookAt(0,e.y/2,0),this.perspectiveCamera.updateProjectionMatrix();else{const o=Math.max(e.x,e.y,e.z)*2,r=this.perspectiveCamera.aspect;this.orthographicCamera.left=-o*r/2,this.orthographicCamera.right=o*r/2,this.orthographicCamera.top=o/2,this.orthographicCamera.bottom=-o/2,this.orthographicCamera.lookAt(0,e.y/2,0),this.orthographicCamera.updateProjectionMatrix()}this.controls?.target.set(0,e.y/2,0),this.controls?.update()}reset(){this.perspectiveCamera.position.set(this.DEFAULT_DISTANCE,this.DEFAULT_DISTANCE,this.DEFAULT_DISTANCE),this.orthographicCamera.position.set(this.DEFAULT_DISTANCE,this.DEFAULT_DISTANCE,this.DEFAULT_DISTANCE),this.perspectiveCamera.lookAt(this.DEFAULT_LOOK_AT,this.DEFAULT_LOOK_AT,this.DEFAULT_LOOK_AT),this.orthographicCamera.lookAt(this.DEFAULT_LOOK_AT,this.DEFAULT_LOOK_AT,this.DEFAULT_LOOK_AT),this.perspectiveCamera.updateProjectionMatrix(),this.orthographicCamera.updateProjectionMatrix()}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.CameraManager=window.comfyAPI.CameraManager||{};window.comfyAPI.CameraManager.CameraManager=it;class rt{static{l(this,"ControlsManager")}controls;eventManager;nodeStorage;camera;constructor(e,t,a,o){this.eventManager=a,this.nodeStorage=o,this.camera=t;const r=e.domElement.parentElement||e.domElement;this.controls=new Rt(t,r),this.controls.enableDamping=!0}init(){this.controls.addEventListener("end",()=>{const e={position:this.camera.position.clone(),target:this.controls.target.clone(),zoom:this.camera instanceof le?this.camera.zoom:this.camera.zoom,cameraType:this.camera instanceof pe?"perspective":"orthographic"},t=this.nodeStorage.loadNodeProperty("Camera Config",{cameraType:e.cameraType,fov:this.camera instanceof pe?this.camera.fov:75});t.state=e,this.nodeStorage.storeNodeProperty("Camera Config",t)})}dispose(){this.controls.dispose()}handleResize(){}update(){this.controls.update()}updateCamera(e){const t=this.controls.object.position.clone(),a=this.controls.target.clone();this.camera=e,this.controls.object=e,this.controls.target=a,e.position.copy(t),this.controls.update()}reset(){this.controls.target.set(0,0,0),this.controls.update()}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.ControlsManager=window.comfyAPI.ControlsManager||{};window.comfyAPI.ControlsManager.ControlsManager=rt;class nt{static{l(this,"EventManager")}listeners={};addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(a=>a!==t))}emitEvent(e,t){this.listeners[e]&&this.listeners[e].forEach(a=>a(t))}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.EventManager=window.comfyAPI.EventManager||{};window.comfyAPI.EventManager.EventManager=nt;class st{static{l(this,"LightingManager")}lights=[];currentIntensity=3;scene;eventManager;constructor(e,t){this.scene=e,this.eventManager=t}init(){this.setupLights()}dispose(){this.lights.forEach(e=>{this.scene.remove(e)}),this.lights=[]}setupLights(){const e=new Ne(16777215,.5);this.scene.add(e),this.lights.push(e);const t=new Ce(16777215,.8);t.position.set(0,10,10),this.scene.add(t),this.lights.push(t);const a=new Ce(16777215,.5);a.position.set(0,10,-10),this.scene.add(a),this.lights.push(a);const o=new Ce(16777215,.3);o.position.set(-10,0,0),this.scene.add(o),this.lights.push(o);const r=new Ce(16777215,.3);r.position.set(10,0,0),this.scene.add(r),this.lights.push(r);const n=new Ce(16777215,.2);n.position.set(0,-10,0),this.scene.add(n),this.lights.push(n)}setLightIntensity(e){this.currentIntensity=e,this.lights.forEach(t=>{t instanceof Ce?t===this.lights[1]?t.intensity=e*.8:t===this.lights[2]?t.intensity=e*.5:t===this.lights[5]?t.intensity=e*.2:t.intensity=e*.3:t instanceof Ne&&(t.intensity=e*.5)}),this.eventManager.emitEvent("lightIntensityChange",e)}reset(){}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.LightingManager=window.comfyAPI.LightingManager||{};window.comfyAPI.LightingManager.LightingManager=st;class lt{static{l(this,"LoaderManager")}gltfLoader;objLoader;mtlLoader;fbxLoader;stlLoader;modelManager;eventManager;constructor(e,t){this.modelManager=e,this.eventManager=t,this.gltfLoader=new St,this.objLoader=new Et,this.mtlLoader=new It,this.fbxLoader=new Lt,this.stlLoader=new Tt}init(){}dispose(){}async loadModel(e,t){try{this.eventManager.emitEvent("modelLoadingStart",null),this.modelManager.clearModel(),this.modelManager.originalURL=e;let a;if(t)a=t.split(".").pop()?.toLowerCase(),this.modelManager.originalFileName=t.split("/").pop()?.split(".")[0]||"model";else{const r=new URLSearchParams(e.split("?")[1]).get("filename");a=r?.split(".").pop()?.toLowerCase(),r?this.modelManager.originalFileName=r.split(".")[0]||"model":this.modelManager.originalFileName="model"}if(!a){U().addAlert(y("toastMessages.couldNotDetermineFileType"));return}let o=await this.loadModelInternal(e,a);o&&await this.modelManager.setupModel(o),this.eventManager.emitEvent("modelLoadingEnd",null)}catch(a){this.eventManager.emitEvent("modelLoadingEnd",null),console.error("Error loading model:",a),U().addAlert(y("toastMessages.errorLoadingModel"))}}async loadModelInternal(e,t){let a=null;const o=new URLSearchParams(e.split("?")[1]),r=o.get("filename");if(!r)return console.error("Missing filename in URL:",e),null;const n=o.get("type")==="output"?"output":"input",i=o.get("subfolder")??"",c="api/view?type="+n+"&subfolder="+encodeURIComponent(i)+"&filename=";switch(t){case"stl":this.stlLoader.setPath(c);const g=await this.stlLoader.loadAsync(r);this.modelManager.setOriginalModel(g),g.computeVertexNormals();const p=new de(g,this.modelManager.standardMaterial),M=new Dt;M.add(p),a=M;break;case"fbx":this.fbxLoader.setPath(c);const b=await this.fbxLoader.loadAsync(r);this.modelManager.setOriginalModel(b),a=b,b.traverse(w=>{w instanceof de&&this.modelManager.originalMaterials.set(w,w.material)});break;case"obj":if(this.modelManager.materialMode==="original")try{this.mtlLoader.setPath(c);const w=r.replace(/\.obj$/,".mtl"),u=await this.mtlLoader.loadAsync(w);u.preload(),this.objLoader.setMaterials(u)}catch{}this.objLoader.setPath(c),a=await this.objLoader.loadAsync(r),a.traverse(w=>{w instanceof de&&this.modelManager.originalMaterials.set(w,w.material)});break;case"gltf":case"glb":this.gltfLoader.setPath(c);const m=await this.gltfLoader.loadAsync(r);this.modelManager.setOriginalModel(m),a=m.scene,m.scene.traverse(w=>{w instanceof de&&(w.geometry.computeVertexNormals(),this.modelManager.originalMaterials.set(w,w.material))});break}return a}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.LoaderManager=window.comfyAPI.LoaderManager||{};window.comfyAPI.LoaderManager.LoaderManager=lt;class Y{static{l(this,"ModelExporter")}static detectFormatFromURL(e){try{const t=new URLSearchParams(e.split("?")[1]).get("filename");if(t)return t.split(".").pop()?.toLowerCase()||null}catch(t){console.error("Error parsing URL:",t)}return null}static canUseDirectURL(e,t){if(!e)return!1;const a=Y.detectFormatFromURL(e);return a?a.toLowerCase()===t.toLowerCase():!1}static async downloadFromURL(e,t){try{const o=await(await fetch(e)).blob();Te(t,o)}catch(a){throw console.error("Error downloading from URL:",a),U().addAlert(y("toastMessages.failedToDownloadFile")),a}}static async exportGLB(e,t="model.glb",a){if(a&&Y.canUseDirectURL(a,"glb"))return Y.downloadFromURL(a,t);const o=new Ut;try{await new Promise(n=>setTimeout(n,50));const r=await new Promise((n,i)=>{o.parse(e,c=>{n(c)},c=>{i(c)},{binary:!0})});await new Promise(n=>setTimeout(n,50)),Y.saveArrayBuffer(r,t)}catch(r){throw console.error("Error exporting GLB:",r),U().addAlert(y("toastMessages.failedToExportModel",{format:"GLB"})),r}}static async exportOBJ(e,t="model.obj",a){if(a&&Y.canUseDirectURL(a,"obj"))return Y.downloadFromURL(a,t);const o=new _t;try{await new Promise(n=>setTimeout(n,50));const r=o.parse(e);await new Promise(n=>setTimeout(n,50)),Y.saveString(r,t)}catch(r){throw console.error("Error exporting OBJ:",r),U().addAlert(y("toastMessages.failedToExportModel",{format:"OBJ"})),r}}static async exportSTL(e,t="model.stl",a){if(a&&Y.canUseDirectURL(a,"stl"))return Y.downloadFromURL(a,t);const o=new Pt;try{await new Promise(n=>setTimeout(n,50));const r=o.parse(e);await new Promise(n=>setTimeout(n,50)),Y.saveString(r,t)}catch(r){throw console.error("Error exporting STL:",r),U().addAlert(y("toastMessages.failedToExportModel",{format:"STL"})),r}}static saveArrayBuffer(e,t){const a=new Blob([e],{type:"application/octet-stream"});Te(t,a)}static saveString(e,t){const a=new Blob([e],{type:"text/plain"});Te(t,a)}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.ModelExporter=window.comfyAPI.ModelExporter||{};window.comfyAPI.ModelExporter.ModelExporter=Y;class dt{static{l(this,"NodeStorage")}node;constructor(e={}){this.node=e}storeNodeProperty(e,t){this.node&&this.node.properties&&(this.node.properties[e]=t)}loadNodeProperty(e,t){return!this.node||!this.node.properties||!(e in this.node.properties)?t:this.node.properties[e]}setNode(e){this.node=e}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.NodeStorage=window.comfyAPI.NodeStorage||{};window.comfyAPI.NodeStorage.NodeStorage=dt;class ct{static{l(this,"RecordingManager")}mediaRecorder=null;recordedChunks=[];isRecording=!1;recordingStream=null;recordingIndicator=null;scene;renderer;eventManager;recordingStartTime=0;recordingDuration=0;recordingCanvas=null;recordingContext=null;animationFrameId=null;constructor(e,t,a){this.scene=e,this.renderer=t,this.eventManager=a,this.setupRecordingIndicator()}setupRecordingIndicator(){const e=new He().load("data:image/svg+xml;base64,"+btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="24" fill="#4CAF50" opacity="0.8" />
        <circle cx="32" cy="32" r="16" fill="#2E7D32" opacity="0.8" />
      </svg>`)),t=new Bt({map:e,transparent:!0,depthTest:!1,depthWrite:!1});this.recordingIndicator=new Ft(t),this.recordingIndicator.scale.set(.5,.5,.5),this.recordingIndicator.position.set(-.8,.8,0),this.recordingIndicator.visible=!1,this.scene.add(this.recordingIndicator)}async startRecording(e,t){if(!this.isRecording)try{const a=this.renderer.domElement,o=a.width,r=a.height,n=e||o,i=t||r;if(this.recordingCanvas=document.createElement("canvas"),this.recordingCanvas.width=n,this.recordingCanvas.height=i,this.recordingContext=this.recordingCanvas.getContext("2d",{alpha:!1}),!this.recordingContext)throw new Error("Failed to get 2D context for recording canvas");const c=o/r,g=n/i;let p=0,M=0,b=o,m=r;Math.abs(c-g)>.01&&(c>g?(b=r*g,p=(o-b)/2):(m=o/g,M=(r-m)/2));const w=l(()=>{!this.isRecording||!this.recordingContext||(this.recordingContext.drawImage(a,p,M,b,m,0,0,n,i),this.animationFrameId=requestAnimationFrame(w))},"captureFrame");if(this.recordingStream=this.recordingCanvas.captureStream(30),!this.recordingStream)throw new Error("Failed to capture stream from canvas");this.mediaRecorder=new MediaRecorder(this.recordingStream,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:5e6}),this.recordedChunks=[],this.mediaRecorder.ondataavailable=u=>{u.data.size>0&&this.recordedChunks.push(u.data)},this.mediaRecorder.onstop=()=>{this.recordingIndicator.visible=!1,this.isRecording=!1,this.recordingStream=null,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.eventManager.emitEvent("recordingStopped",{duration:this.recordingDuration,hasRecording:this.recordedChunks.length>0})},this.recordingIndicator&&(this.recordingIndicator.visible=!0),this.mediaRecorder.start(100),this.isRecording=!0,this.recordingStartTime=Date.now(),w(),this.eventManager.emitEvent("recordingStarted",null)}catch(a){console.error("Error starting recording:",a),this.eventManager.emitEvent("recordingError",a)}}stopRecording(){!this.isRecording||!this.mediaRecorder||(this.recordingDuration=(Date.now()-this.recordingStartTime)/1e3,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.mediaRecorder.stop(),this.recordingStream&&this.recordingStream.getTracks().forEach(e=>e.stop()),this.recordingCanvas=null,this.recordingContext=null)}getIsRecording(){return this.isRecording}hasRecording(){return this.recordedChunks.length>0}getRecordingDuration(){return this.recordingDuration}getRecordingData(){if(this.recordedChunks.length!==0){const e=new Blob(this.recordedChunks,{type:"video/webm"});return URL.createObjectURL(e)}return null}exportRecording(e="scene-recording.mp4"){if(this.recordedChunks.length===0){this.eventManager.emitEvent("recordingError",new Error("No recording available to export"));return}this.eventManager.emitEvent("exportingRecording",null);try{const t=new Blob(this.recordedChunks,{type:"video/webm"});Te(e,t),this.eventManager.emitEvent("recordingExported",null)}catch(t){console.error("Error exporting recording:",t),this.eventManager.emitEvent("recordingError",t)}}clearRecording(){this.recordedChunks=[],this.recordingDuration=0,this.eventManager.emitEvent("recordingCleared",null)}dispose(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.stopRecording(),this.clearRecording(),this.recordingCanvas=null,this.recordingContext=null,this.recordingIndicator&&(this.scene.remove(this.recordingIndicator),this.recordingIndicator.material.map?.dispose(),this.recordingIndicator.material.dispose())}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.RecordingManager=window.comfyAPI.RecordingManager||{};window.comfyAPI.RecordingManager.RecordingManager=ct;class ie{static{l(this,"Load3dUtils")}static async uploadTempImage(e,t,a="png"){const o=await fetch(e).then(g=>g.blob()),r=`${t}_${Date.now()}.${a}`,n=new File([o],r,{type:a==="mp4"?"video/mp4":"image/png"}),i=new FormData;i.append("image",n),i.append("subfolder","threed"),i.append("type","temp");const c=await Ie.fetchApi("/upload/image",{method:"POST",body:i});if(c.status!==200){const g=`Error uploading temp file: ${c.status} - ${c.statusText}`;throw U().addAlert(g),new Error(g)}return await c.json()}static async uploadFile(e,t){let a;try{const o=new FormData;o.append("image",e),o.append("subfolder",t);const r=await Ie.fetchApi("/upload/image",{method:"POST",body:o});if(r.status===200){const n=await r.json();let i=n.name;n.subfolder&&(i=n.subfolder+"/"+i),a=i}else U().addAlert(r.status+" - "+r.statusText)}catch(o){console.error("Upload error:",o),U().addAlert(o instanceof Error?o.message:y("toastMessages.fileUploadFailed"))}return a}static splitFilePath(e){const t=e.lastIndexOf("/");return t===-1?["",e]:[e.substring(0,t),e.substring(t+1)]}static getResourceURL(e,t,a="input"){return`/view?${["filename="+encodeURIComponent(t),"type="+a,"subfolder="+e,Ve.getRandParam().substring(1)].join("&")}`}static async uploadMultipleFiles(e,t="3d"){const a=Array.from(e).map(o=>this.uploadFile(o,t));await Promise.all(a)}}class ut{static{l(this,"SceneManager")}scene;gridHelper;backgroundScene;backgroundCamera;backgroundMesh=null;backgroundTexture=null;backgroundRenderMode="tiled";backgroundColorMaterial=null;currentBackgroundType="color";currentBackgroundColor="#282828";eventManager;renderer;getActiveCamera;getControls;constructor(e,t,a,o){this.renderer=e,this.eventManager=o,this.scene=new Ge,this.getActiveCamera=t,this.getControls=a,this.gridHelper=new Qe(20,20),this.gridHelper.position.set(0,0,0),this.scene.add(this.gridHelper),this.backgroundScene=new Ge,this.backgroundCamera=new le(-1,1,1,-1,-1,1),this.initBackgroundScene()}initBackgroundScene(){const e=new $t(2,2);this.backgroundColorMaterial=new Ee({color:new We(this.currentBackgroundColor),transparent:!1,depthWrite:!1,depthTest:!1,side:ce}),this.backgroundMesh=new de(e,this.backgroundColorMaterial),this.backgroundMesh.position.set(0,0,0),this.backgroundScene.add(this.backgroundMesh),this.renderer.setClearColor(0,0)}init(){}dispose(){this.backgroundTexture&&this.backgroundTexture.dispose(),this.backgroundColorMaterial&&this.backgroundColorMaterial.dispose(),this.backgroundMesh&&(this.backgroundMesh.geometry.dispose(),this.backgroundMesh.material instanceof je&&this.backgroundMesh.material.dispose()),this.scene.background&&(this.scene.background=null),this.scene.clear()}toggleGrid(e){this.gridHelper&&(this.gridHelper.visible=e),this.eventManager.emitEvent("showGridChange",e)}setBackgroundColor(e){this.currentBackgroundColor=e,this.currentBackgroundType="color",this.scene.background instanceof Ot&&(this.scene.background=null),this.backgroundRenderMode==="panorama"&&(this.backgroundRenderMode="tiled",this.eventManager.emitEvent("backgroundRenderModeChange","tiled")),(!this.backgroundMesh||!this.backgroundColorMaterial)&&this.initBackgroundScene(),this.backgroundColorMaterial.color.set(e),this.backgroundColorMaterial.map=null,this.backgroundColorMaterial.transparent=!1,this.backgroundColorMaterial.needsUpdate=!0,this.backgroundMesh&&(this.backgroundMesh.material=this.backgroundColorMaterial),this.backgroundTexture&&(this.backgroundTexture.dispose(),this.backgroundTexture=null),this.eventManager.emitEvent("backgroundColorChange",e)}async setBackgroundImage(e){if(e===""){this.setBackgroundColor(this.currentBackgroundColor);return}this.eventManager.emitEvent("backgroundImageLoadingStart",null);let t="input",a=ie.splitFilePath(e),o=a[0],r=a[1];o==="temp"?(t="temp",a=["",r]):o==="output"&&(t="output",a=["",r]);let n=ie.getResourceURL(...a,t);n.startsWith("/api")||(n="/api"+n);try{const i=new He,c=await new Promise((g,p)=>{i.load(n,g,void 0,p)});if(this.backgroundTexture&&this.backgroundTexture.dispose(),c.colorSpace=ze,this.backgroundTexture=c,this.currentBackgroundType="image",this.backgroundRenderMode==="panorama")c.mapping=Xe,this.scene.background=c;else{this.backgroundMesh||this.initBackgroundScene();const g=new Ee({map:c,transparent:!0,depthWrite:!1,depthTest:!1,side:ce});this.backgroundMesh&&(this.backgroundMesh.material!==this.backgroundColorMaterial&&this.backgroundMesh.material instanceof je&&this.backgroundMesh.material.dispose(),this.backgroundMesh.material=g,this.backgroundMesh.position.set(0,0,0)),this.updateBackgroundSize(this.backgroundTexture,this.backgroundMesh,this.renderer.domElement.clientWidth,this.renderer.domElement.clientHeight)}this.eventManager.emitEvent("backgroundImageChange",e),this.eventManager.emitEvent("backgroundImageLoadingEnd",null)}catch(i){this.eventManager.emitEvent("backgroundImageLoadingEnd",null),console.error("Error loading background image:",i),this.setBackgroundColor(this.currentBackgroundColor)}}removeBackgroundImage(){this.setBackgroundColor(this.currentBackgroundColor),this.eventManager.emitEvent("backgroundImageLoadingEnd",null)}setBackgroundRenderMode(e){if(this.backgroundRenderMode!==e){if(this.backgroundRenderMode=e,this.currentBackgroundType==="image"&&this.backgroundTexture)try{e==="panorama"?(this.backgroundTexture.mapping=Xe,this.scene.background=this.backgroundTexture):(this.scene.background=null,this.backgroundMesh&&this.backgroundMesh.material instanceof Ee&&(this.backgroundMesh.material.map=this.backgroundTexture,this.backgroundMesh.material.needsUpdate=!0))}catch(t){console.error("Error set background render mode:",t)}this.eventManager.emitEvent("backgroundRenderModeChange",e)}}updateBackgroundSize(e,t,a,o){if(!e||!t)return;const r=t.material;if(!r.map)return;const n=e.image.width/e.image.height,i=a/o;n>i?t.scale.set(n/i,1,1):t.scale.set(1,i/n,1),r.needsUpdate=!0}handleResize(e,t){this.backgroundTexture&&this.backgroundMesh&&this.currentBackgroundType==="image"&&this.updateBackgroundSize(this.backgroundTexture,this.backgroundMesh,e,t)}renderBackground(){if((this.backgroundRenderMode==="tiled"||this.currentBackgroundType==="color")&&this.backgroundMesh){const e=this.renderer.toneMapping,t=this.renderer.toneMappingExposure;this.renderer.toneMapping=Vt,this.renderer.render(this.backgroundScene,this.backgroundCamera),this.renderer.toneMapping=e,this.renderer.toneMappingExposure=t}}getCurrentBackgroundInfo(){return{type:this.currentBackgroundType,value:this.currentBackgroundType==="color"?this.currentBackgroundColor:""}}captureScene(e,t){return new Promise(async(a,o)=>{try{const r=this.renderer.domElement.width,n=this.renderer.domElement.height,i=this.renderer.getClearColor(new We),c=this.renderer.getClearAlpha(),g=this.renderer.outputColorSpace;if(this.renderer.setSize(e,t),this.getActiveCamera()instanceof pe){const u=this.getActiveCamera();u.aspect=e/t,u.updateProjectionMatrix()}else{const u=this.getActiveCamera(),v=10,K=e/t;u.left=-v*K/2,u.right=v*K/2,u.top=v/2,u.bottom=-v/2,u.updateProjectionMatrix()}this.backgroundTexture&&this.backgroundMesh&&this.currentBackgroundType==="image"&&this.updateBackgroundSize(this.backgroundTexture,this.backgroundMesh,e,t);const p=new Map;this.renderer.clear(),this.renderBackground(),this.renderer.render(this.scene,this.getActiveCamera());const M=this.renderer.domElement.toDataURL("image/png");this.renderer.setClearColor(0,0),this.renderer.clear(),this.renderer.render(this.scene,this.getActiveCamera());const b=this.renderer.domElement.toDataURL("image/png");this.scene.traverse(u=>{u instanceof de&&(p.set(u,u.material),u.material=new Fe({flatShading:!1,side:ce,normalScale:new $e(1,1)}))});const m=this.gridHelper.visible;this.gridHelper.visible=!1,this.renderer.setClearColor(0,1),this.renderer.clear(),this.renderer.render(this.scene,this.getActiveCamera());const w=this.renderer.domElement.toDataURL("image/png");this.scene.traverse(u=>{if(u instanceof de){const v=p.get(u);v&&(u.material=v)}}),this.renderer.setClearColor(16777215,1),this.renderer.clear(),this.gridHelper.visible=m,this.renderer.setClearColor(i,c),this.renderer.setSize(r,n),this.renderer.outputColorSpace=g,this.handleResize(r,n),a({scene:M,mask:b,normal:w})}catch(r){o(r)}})}reset(){}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.SceneManager=window.comfyAPI.SceneManager||{};window.comfyAPI.SceneManager.SceneManager=ut;class gt{static{l(this,"SceneModelManager")}currentModel=null;originalModel=null;originalRotation=null;currentUpDirection="original";materialMode="original";originalMaterials=new WeakMap;normalMaterial;standardMaterial;wireframeMaterial;depthMaterial;originalFileName=null;originalURL=null;appliedTexture=null;textureLoader;scene;renderer;eventManager;activeCamera;setupCamera;constructor(e,t,a,o,r){this.scene=e,this.renderer=t,this.eventManager=a,this.activeCamera=o(),this.setupCamera=r,this.textureLoader=new He,this.normalMaterial=new Fe({flatShading:!1,side:ce,normalScale:new $e(1,1),transparent:!1,opacity:1}),this.wireframeMaterial=new Ee({color:16777215,wireframe:!0,transparent:!1,opacity:1}),this.depthMaterial=new Ye({depthPacking:Ze,side:ce}),this.standardMaterial=this.createSTLMaterial()}init(){}dispose(){this.clearModel(),this.normalMaterial.dispose(),this.standardMaterial.dispose(),this.wireframeMaterial.dispose(),this.depthMaterial.dispose(),this.appliedTexture&&(this.appliedTexture.dispose(),this.appliedTexture=null)}createSTLMaterial(){return new Je({color:8421504,metalness:.1,roughness:.8,flatShading:!1,side:ce})}setMaterialMode(e){!this.currentModel||e===this.materialMode||(this.materialMode=e,e==="depth"?this.renderer.outputColorSpace=Ht:this.renderer.outputColorSpace=ze,this.currentModel&&(this.currentModel.visible=!0),this.currentModel.traverse(t=>{if(t instanceof de)switch(e){case"depth":this.originalMaterials.has(t)||this.originalMaterials.set(t,t.material);const a=new Ye({depthPacking:Ze,side:ce});a.onBeforeCompile=r=>{r.uniforms.cameraType={value:this.activeCamera instanceof le?1:0},r.fragmentShader=`
                uniform float cameraType;
                ${r.fragmentShader}
              `,r.fragmentShader=r.fragmentShader.replace(/gl_FragColor\s*=\s*vec4\(\s*vec3\(\s*1.0\s*-\s*fragCoordZ\s*\)\s*,\s*opacity\s*\)\s*;/,`
                  float depth = 1.0 - fragCoordZ;
                  if (cameraType > 0.5) {
                    depth = pow(depth, 400.0);
                  } else {
                    depth = pow(depth, 0.6);
                  }
                  gl_FragColor = vec4(vec3(depth), opacity);
                `)},a.customProgramCacheKey=()=>this.activeCamera instanceof le?"ortho":"persp",t.material=a;break;case"normal":this.originalMaterials.has(t)||this.originalMaterials.set(t,t.material),t.material=new Fe({flatShading:!1,side:ce,normalScale:new $e(1,1),transparent:!1,opacity:1});break;case"wireframe":this.originalMaterials.has(t)||this.originalMaterials.set(t,t.material),t.material=new Ee({color:16777215,wireframe:!0,transparent:!1,opacity:1});break;case"original":const o=this.originalMaterials.get(t);o?t.material=o:this.appliedTexture?t.material=new Je({map:this.appliedTexture,metalness:.1,roughness:.8,side:ce}):t.material=this.standardMaterial;break}}),this.eventManager.emitEvent("materialModeChange",e))}setupModelMaterials(e){e.traverse(t=>{t instanceof de&&this.originalMaterials.set(t,t.material)}),this.setMaterialMode("original")}clearModel(){const e=[];this.scene.traverse(t=>{t instanceof Qe||t instanceof Nt||t instanceof Gt||e.push(t)}),e.forEach(t=>{t.parent&&t.parent!==this.scene?t.parent.remove(t):this.scene.remove(t),t instanceof de&&(t.geometry?.dispose(),Array.isArray(t.material)?t.material.forEach(a=>a.dispose()):t.material?.dispose())}),this.reset()}reset(){this.currentModel=null,this.originalModel=null,this.originalRotation=null,this.currentUpDirection="original",this.setMaterialMode("original"),this.originalFileName=null,this.originalURL=null,this.appliedTexture&&(this.appliedTexture.dispose(),this.appliedTexture=null),this.originalMaterials=new WeakMap}addModelToScene(e){this.currentModel=e,this.scene.add(this.currentModel)}async setupModel(e){this.currentModel=e;const t=new zt().setFromObject(e),a=t.getSize(new Pe),o=t.getCenter(new Pe),i=5/Math.max(a.x,a.y,a.z);e.scale.multiplyScalar(i),t.setFromObject(e),t.getCenter(o),t.getSize(a),e.position.set(-o.x,-t.min.y,-o.z),this.scene.add(e),this.materialMode!=="original"&&this.setMaterialMode(this.materialMode),this.currentUpDirection!=="original"&&this.setUpDirection(this.currentUpDirection),this.setupModelMaterials(e),this.setupCamera(a)}setOriginalModel(e){this.originalModel=e}setUpDirection(e){if(this.currentModel){switch(!this.originalRotation&&this.currentModel.rotation&&(this.originalRotation=this.currentModel.rotation.clone()),this.currentUpDirection=e,this.originalRotation&&this.currentModel.rotation.copy(this.originalRotation),e){case"original":break;case"-x":this.currentModel.rotation.z=Math.PI/2;break;case"+x":this.currentModel.rotation.z=-Math.PI/2;break;case"-y":this.currentModel.rotation.x=Math.PI;break;case"+y":break;case"-z":this.currentModel.rotation.x=Math.PI/2;break;case"+z":this.currentModel.rotation.x=-Math.PI/2;break}this.eventManager.emitEvent("upDirectionChange",e)}}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.SceneModelManager=window.comfyAPI.SceneModelManager||{};window.comfyAPI.SceneModelManager.SceneModelManager=gt;class ht{static{l(this,"ViewHelperManager")}viewHelper={};viewHelperContainer={};getActiveCamera;getControls;nodeStorage;renderer;constructor(e,t,a,o){this.renderer=e,this.getActiveCamera=t,this.getControls=a,this.nodeStorage=o}init(){}dispose(){this.viewHelper&&this.viewHelper.dispose(),this.viewHelperContainer&&this.viewHelperContainer.parentNode&&this.viewHelperContainer.parentNode.removeChild(this.viewHelperContainer)}createViewHelper(e){this.viewHelperContainer=document.createElement("div"),this.viewHelperContainer.style.position="absolute",this.viewHelperContainer.style.bottom="0",this.viewHelperContainer.style.left="0",this.viewHelperContainer.style.width="128px",this.viewHelperContainer.style.height="128px",this.viewHelperContainer.addEventListener("pointerup",t=>{t.stopPropagation(),this.viewHelper.handleClick(t)}),this.viewHelperContainer.addEventListener("pointerdown",t=>{t.stopPropagation()}),e.appendChild(this.viewHelperContainer),this.viewHelper=new Ke(this.getActiveCamera(),this.viewHelperContainer),this.viewHelper.center=this.getControls().target}update(e){if(this.viewHelper.animating&&(this.viewHelper.update(e),!this.viewHelper.animating)){const t={position:this.getActiveCamera().position.clone(),target:this.getControls().target.clone(),zoom:this.getActiveCamera()instanceof le?this.getActiveCamera().zoom:this.getActiveCamera().zoom,cameraType:this.getActiveCamera()instanceof pe?"perspective":"orthographic"},a=this.nodeStorage.loadNodeProperty("Camera Config",{cameraType:t.cameraType,fov:this.getActiveCamera()instanceof pe?this.getActiveCamera().fov:75});a.state=t,this.nodeStorage.storeNodeProperty("Camera Config",a)}}handleResize(){}visibleViewHelper(e){e?(this.viewHelper.visible=!0,this.viewHelperContainer.style.display="block"):(this.viewHelper.visible=!1,this.viewHelperContainer.style.display="none")}recreateViewHelper(){this.viewHelper&&this.viewHelper.dispose(),this.viewHelper=new Ke(this.getActiveCamera(),this.viewHelperContainer),this.viewHelper.center=this.getControls().target}reset(){}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.ViewHelperManager=window.comfyAPI.ViewHelperManager||{};window.comfyAPI.ViewHelperManager.ViewHelperManager=ht;class pt{static{l(this,"Load3d")}renderer;clock;animationFrameId=null;node;loadingPromise=null;eventManager;nodeStorage;sceneManager;cameraManager;controlsManager;lightingManager;viewHelperManager;loaderManager;modelManager;recordingManager;animationManager;STATUS_MOUSE_ON_NODE;STATUS_MOUSE_ON_SCENE;STATUS_MOUSE_ON_VIEWER;INITIAL_RENDER_DONE=!1;targetWidth=512;targetHeight=512;targetAspectRatio=1;isViewerMode=!1;rightMouseDownX=0;rightMouseDownY=0;rightMouseMoved=!1;dragThreshold=5;contextMenuAbortController=null;constructor(e,t={node:{}}){this.node=t.node||{},this.clock=new Wt,this.isViewerMode=t.isViewerMode||!1;const a=this.node.widgets?.find(r=>r.name==="width"),o=this.node.widgets?.find(r=>r.name==="height");a&&o&&(this.targetWidth=a.value,this.targetHeight=o.value,this.targetAspectRatio=this.targetWidth/this.targetHeight),this.renderer=new jt({alpha:!0,antialias:!0}),this.renderer.setSize(300,300),this.renderer.setClearColor(2631720),this.renderer.autoClear=!1,this.renderer.outputColorSpace=ze,this.renderer.domElement.classList.add("flex","!h-full","!w-full"),e.appendChild(this.renderer.domElement),this.eventManager=new nt,this.nodeStorage=new dt(this.node),this.sceneManager=new ut(this.renderer,this.getActiveCamera.bind(this),this.getControls.bind(this),this.eventManager),this.cameraManager=new it(this.renderer,this.eventManager,this.nodeStorage),this.controlsManager=new rt(this.renderer,this.cameraManager.activeCamera,this.eventManager,this.nodeStorage),this.cameraManager.setControls(this.controlsManager.controls),this.lightingManager=new st(this.sceneManager.scene,this.eventManager),this.viewHelperManager=new ht(this.renderer,this.getActiveCamera.bind(this),this.getControls.bind(this),this.nodeStorage),this.modelManager=new gt(this.sceneManager.scene,this.renderer,this.eventManager,this.getActiveCamera.bind(this),this.setupCamera.bind(this)),this.loaderManager=new lt(this.modelManager,this.eventManager),this.recordingManager=new ct(this.sceneManager.scene,this.renderer,this.eventManager),this.animationManager=new ot(this.eventManager),this.sceneManager.init(),this.cameraManager.init(),this.controlsManager.init(),this.lightingManager.init(),this.loaderManager.init(),this.animationManager.init(),this.viewHelperManager.createViewHelper(e),this.viewHelperManager.init(),this.STATUS_MOUSE_ON_NODE=!1,this.STATUS_MOUSE_ON_SCENE=!1,this.STATUS_MOUSE_ON_VIEWER=!1,this.initContextMenu(),this.handleResize(),this.startAnimation(),setTimeout(()=>{this.forceRender()},100)}initContextMenu(){const e=this.renderer.domElement;this.contextMenuAbortController=new AbortController;const{signal:t}=this.contextMenuAbortController,a=l(n=>{n.button===2&&(this.rightMouseDownX=n.clientX,this.rightMouseDownY=n.clientY,this.rightMouseMoved=!1)},"mousedownHandler"),o=l(n=>{if(n.buttons===2){const i=Math.abs(n.clientX-this.rightMouseDownX),c=Math.abs(n.clientY-this.rightMouseDownY);(i>this.dragThreshold||c>this.dragThreshold)&&(this.rightMouseMoved=!0)}},"mousemoveHandler"),r=l(n=>{if(this.isViewerMode)return;const i=Math.abs(n.clientX-this.rightMouseDownX),c=Math.abs(n.clientY-this.rightMouseDownY),g=this.rightMouseMoved||i>this.dragThreshold||c>this.dragThreshold;this.rightMouseMoved=!1,!g&&(n.preventDefault(),n.stopPropagation(),this.showNodeContextMenu(n))},"contextmenuHandler");e.addEventListener("mousedown",a,{signal:t}),e.addEventListener("mousemove",o,{signal:t}),e.addEventListener("contextmenu",r,{signal:t})}showNodeContextMenu(e){const t=Ve.canvas.getNodeMenuOptions(this.node);new yt.ContextMenu(t,{event:e,title:this.node.type,extra:this.node})}getEventManager(){return this.eventManager}getSceneManager(){return this.sceneManager}getCameraManager(){return this.cameraManager}getControlsManager(){return this.controlsManager}getLightingManager(){return this.lightingManager}getViewHelperManager(){return this.viewHelperManager}getLoaderManager(){return this.loaderManager}getModelManager(){return this.modelManager}getRecordingManager(){return this.recordingManager}forceRender(){const e=this.clock.getDelta();this.animationManager.update(e),this.viewHelperManager.update(e),this.controlsManager.update(),this.renderMainScene(),this.resetViewport(),this.viewHelperManager.viewHelper.render&&this.viewHelperManager.viewHelper.render(this.renderer),this.INITIAL_RENDER_DONE=!0}renderMainScene(){const e=this.renderer.domElement.clientWidth,t=this.renderer.domElement.clientHeight,a=this.node.widgets?.find(n=>n.name==="width"),o=this.node.widgets?.find(n=>n.name==="height");if(a&&o||this.isViewerMode){a&&o&&(this.targetWidth=a.value,this.targetHeight=o.value,this.targetAspectRatio=this.targetWidth/this.targetHeight);const n=e/t;let i,c,g=0,p=0;n>this.targetAspectRatio?(c=t,i=c*this.targetAspectRatio,g=(e-i)/2):(i=e,c=i/this.targetAspectRatio,p=(t-c)/2),this.renderer.setViewport(0,0,e,t),this.renderer.setScissor(0,0,e,t),this.renderer.setScissorTest(!0),this.renderer.setClearColor(657930),this.renderer.clear(),this.renderer.setViewport(g,p,i,c),this.renderer.setScissor(g,p,i,c);const M=i/c;this.cameraManager.updateAspectRatio(M)}else this.renderer.setViewport(0,0,e,t),this.renderer.setScissor(0,0,e,t),this.renderer.setScissorTest(!0);this.sceneManager.renderBackground(),this.renderer.render(this.sceneManager.scene,this.cameraManager.activeCamera)}resetViewport(){const e=this.renderer.domElement.clientWidth,t=this.renderer.domElement.clientHeight;this.renderer.setViewport(0,0,e,t),this.renderer.setScissor(0,0,e,t),this.renderer.setScissorTest(!1)}getActiveCamera(){return this.cameraManager.activeCamera}getControls(){return this.controlsManager.controls}setupCamera(e){this.cameraManager.setupForModel(e)}startAnimation(){const e=l(()=>{if(this.animationFrameId=requestAnimationFrame(e),!this.isActive())return;const t=this.clock.getDelta();this.animationManager.update(t),this.viewHelperManager.update(t),this.controlsManager.update(),this.renderMainScene(),this.resetViewport(),this.viewHelperManager.viewHelper.render&&this.viewHelperManager.viewHelper.render(this.renderer)},"animate");e()}updateStatusMouseOnNode(e){this.STATUS_MOUSE_ON_NODE=e}updateStatusMouseOnScene(e){this.STATUS_MOUSE_ON_SCENE=e}updateStatusMouseOnViewer(e){this.STATUS_MOUSE_ON_VIEWER=e}isActive(){return this.STATUS_MOUSE_ON_NODE||this.STATUS_MOUSE_ON_SCENE||this.STATUS_MOUSE_ON_VIEWER||this.isRecording()||!this.INITIAL_RENDER_DONE}async exportModel(e){if(!this.modelManager.currentModel)throw new Error("No model to export");const t=`Exporting as ${e.toUpperCase()}...`;this.eventManager.emitEvent("exportLoadingStart",t);try{const a=this.modelManager.currentModel.clone(),r=`${this.modelManager.originalFileName||"model"}.${e}`,n=this.modelManager.originalURL;switch(await new Promise(i=>setTimeout(i,10)),e){case"glb":await Y.exportGLB(a,r,n);break;case"obj":await Y.exportOBJ(a,r,n);break;case"stl":await Y.exportSTL(a,r);break;default:throw new Error(`Unsupported export format: ${e}`)}await new Promise(i=>setTimeout(i,10))}catch(a){throw console.error(`Error exporting model as ${e}:`,a),a}finally{this.eventManager.emitEvent("exportLoadingEnd",null)}}setBackgroundColor(e){this.sceneManager.setBackgroundColor(e),this.forceRender()}async setBackgroundImage(e){if(await this.sceneManager.setBackgroundImage(e),this.sceneManager.backgroundTexture&&this.sceneManager.backgroundMesh){const t=this.renderer.domElement.clientWidth,a=this.renderer.domElement.clientHeight,o=this.node.widgets?.find(i=>i.name==="width"),r=this.node.widgets?.find(i=>i.name==="height");if(o&&r||this.isViewerMode){const i=t/a;let c,g;i>this.targetAspectRatio?(g=a,c=g*this.targetAspectRatio):(c=t,g=c/this.targetAspectRatio),this.sceneManager.updateBackgroundSize(this.sceneManager.backgroundTexture,this.sceneManager.backgroundMesh,c,g)}else this.sceneManager.updateBackgroundSize(this.sceneManager.backgroundTexture,this.sceneManager.backgroundMesh,t,a)}this.forceRender()}removeBackgroundImage(){this.sceneManager.removeBackgroundImage(),this.forceRender()}toggleGrid(e){this.sceneManager.toggleGrid(e),this.forceRender()}setBackgroundRenderMode(e){this.sceneManager.setBackgroundRenderMode(e),this.forceRender()}toggleCamera(e){this.cameraManager.toggleCamera(e),this.controlsManager.updateCamera(this.cameraManager.activeCamera),this.viewHelperManager.recreateViewHelper(),this.handleResize(),this.forceRender()}getCurrentCameraType(){return this.cameraManager.getCurrentCameraType()}getCurrentModel(){return this.modelManager.currentModel}setCameraState(e){this.cameraManager.setCameraState(e),this.forceRender()}getCameraState(){return this.cameraManager.getCameraState()}setFOV(e){this.cameraManager.setFOV(e),this.forceRender()}setMaterialMode(e){this.modelManager.setMaterialMode(e),this.forceRender()}async loadModel(e,t){if(this.loadingPromise)try{await this.loadingPromise}catch{}return this.loadingPromise=this._loadModelInternal(e,t),this.loadingPromise}async _loadModelInternal(e,t){this.cameraManager.reset(),this.controlsManager.reset(),this.modelManager.clearModel(),this.animationManager.dispose(),await this.loaderManager.loadModel(e,t),this.modelManager.currentModel&&this.animationManager.setupModelAnimations(this.modelManager.currentModel,this.modelManager.originalModel),this.handleResize(),this.forceRender(),this.loadingPromise=null}clearModel(){this.animationManager.dispose(),this.modelManager.clearModel(),this.forceRender()}setUpDirection(e){this.modelManager.setUpDirection(e),this.forceRender()}setLightIntensity(e){this.lightingManager.setLightIntensity(e),this.forceRender()}setTargetSize(e,t){this.targetWidth=e,this.targetHeight=t,this.targetAspectRatio=e/t,this.forceRender()}addEventListener(e,t){this.eventManager.addEventListener(e,t)}removeEventListener(e,t){this.eventManager.removeEventListener(e,t)}refreshViewport(){this.handleResize(),this.forceRender()}handleResize(){const e=this.renderer?.domElement;if(!e){console.warn("Parent element not found");return}const t=e.clientWidth,a=e.clientHeight,o=this.node.widgets?.find(i=>i.name==="width"),r=this.node.widgets?.find(i=>i.name==="height");if(o&&r||this.isViewerMode){o&&r&&(this.targetWidth=o.value,this.targetHeight=r.value,this.targetAspectRatio=this.targetWidth/this.targetHeight);const i=t/a;let c,g;i>this.targetAspectRatio?(g=a,c=g*this.targetAspectRatio):(c=t,g=c/this.targetAspectRatio),this.renderer.setSize(t,a),this.cameraManager.handleResize(c,g),this.sceneManager.handleResize(c,g)}else this.renderer.setSize(t,a),this.cameraManager.handleResize(t,a),this.sceneManager.handleResize(t,a);this.forceRender()}captureScene(e,t){return this.sceneManager.captureScene(e,t)}loadNodeProperty(e,t){return this.nodeStorage.loadNodeProperty(e,t)}async startRecording(){return this.viewHelperManager.visibleViewHelper(!1),this.recordingManager.startRecording(this.targetWidth,this.targetHeight)}stopRecording(){this.viewHelperManager.visibleViewHelper(!0),this.recordingManager.stopRecording(),this.eventManager.emitEvent("recordingStatusChange",!1)}isRecording(){return this.recordingManager.getIsRecording()}getRecordingDuration(){return this.recordingManager.getRecordingDuration()}getRecordingData(){return this.recordingManager.getRecordingData()}exportRecording(e){this.recordingManager.exportRecording(e)}clearRecording(){this.recordingManager.clearRecording()}setAnimationSpeed(e){this.animationManager.setAnimationSpeed(e)}updateSelectedAnimation(e){this.animationManager.updateSelectedAnimation(e)}toggleAnimation(e){this.animationManager.toggleAnimation(e)}hasAnimations(){return this.animationManager.animationClips.length>0}remove(){this.contextMenuAbortController&&(this.contextMenuAbortController.abort(),this.contextMenuAbortController=null),this.renderer.forceContextLoss();const e=this.renderer.domElement,t=new Event("webglcontextlost",{bubbles:!0,cancelable:!0});e.dispatchEvent(t),this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.sceneManager.dispose(),this.cameraManager.dispose(),this.controlsManager.dispose(),this.lightingManager.dispose(),this.viewHelperManager.dispose(),this.loaderManager.dispose(),this.modelManager.dispose(),this.recordingManager.dispose(),this.animationManager.dispose(),this.renderer.dispose(),this.renderer.domElement.remove()}}const ue=new Map,be=new Map,wo=l(h=>{const e=Xt(h);let t=null;const a=x({showGrid:!0,backgroundColor:"#000000",backgroundImage:"",backgroundRenderMode:"tiled"}),o=x({upDirection:"original",materialMode:"original"}),r=x({cameraType:"perspective",fov:75}),n=x({intensity:5}),i=x(!1),c=x(!1),g=x(0),p=x([]),M=x(!1),b=x(1),m=x(0),w=x(!1),u=x(""),v=x(!1),K=l(async d=>{const D=ge(e.value);if(!d||!D)return;const L=D;try{t=new pt(d,{node:L});const O=L.widgets?.find(oe=>oe.name==="width"),ae=L.widgets?.find(oe=>oe.name==="height");O&&ae||(v.value=!0),await N(L),L.onMouseEnter=function(){t?.refreshViewport(),t?.updateStatusMouseOnNode(!0)},L.onMouseLeave=function(){t?.updateStatusMouseOnNode(!1)},L.onResize=function(){t?.handleResize()},L.onDrawBackground=function(){t&&(t.renderer.domElement.hidden=this.flags.collapsed??!1)},L.onRemoved=function(){he().removeLoad3d(L),be.delete(L)},ue.set(L,t);const ve=be.get(L);ve&&t&&(ve.forEach(oe=>{t&&oe(t)}),be.delete(L)),te("add")}catch(O){console.error("Error initializing Load3d:",O),U().addAlert(y("toastMessages.failedToInitializeLoad3d"))}},"initializeLoad3d"),N=l(async d=>{if(!t)return;const D=d.properties["Scene Config"];D&&(a.value={...a.value,...D,backgroundRenderMode:D.backgroundRenderMode||"tiled"});const L=d.properties["Model Config"];L&&(o.value=L);const O=d.properties["Camera Config"],ae=O?.state;O&&(r.value=O);const ve=d.properties["Light Config"];ve&&(n.value=ve);const oe=d.widgets?.find(se=>se.name==="model_file");if(oe?.value){const se=X(oe.value);if(se){w.value=!0,u.value=y("load3d.reloadingModel");try{await t.loadModel(se),ae&&(await Ct(),t.setCameraState(ae))}catch(mt){console.error("Failed to reload model:",mt),U().addAlert(y("toastMessages.failedToLoadModel"))}finally{w.value=!1,u.value=""}}}else ae&&t.setCameraState(ae)},"restoreConfigurationsFromNode"),X=l(d=>{if(!d)return null;try{if(d.startsWith("http"))return d;const[D,L]=ie.splitFilePath(d);return Ie.apiURL(ie.getResourceURL(D,L,v.value?"output":"input"))}catch(D){return console.error("Failed to construct model URL:",D),null}},"getModelUrl"),q=l(d=>{const D=ge(e.value);if(!D)return;const L=D,O=ue.get(L);if(O){d(O);return}be.has(L)||be.set(L,[]),be.get(L).push(d)},"waitForLoad3d");W(a,async d=>{t&&e.value&&(e.value.properties["Scene Config"]=d,t.toggleGrid(d.showGrid),t.setBackgroundColor(d.backgroundColor),await t.setBackgroundImage(d.backgroundImage||""),d.backgroundRenderMode&&t.setBackgroundRenderMode(d.backgroundRenderMode))},{deep:!0}),W(o,d=>{t&&e.value&&(e.value.properties["Model Config"]=d,t.setUpDirection(d.upDirection),t.setMaterialMode(d.materialMode))},{deep:!0}),W(r,d=>{t&&e.value&&(e.value.properties["Camera Config"]=d,t.toggleCamera(d.cameraType),t.setFOV(d.fov))},{deep:!0}),W(n,d=>{t&&e.value&&(e.value.properties["Light Config"]=d,t.setLightIntensity(d.intensity))},{deep:!0}),W(M,d=>{t&&t.toggleAnimation(d)}),W(b,d=>{t&&d&&t.setAnimationSpeed(d)}),W(m,d=>{t&&d!==void 0&&t.updateSelectedAnimation(d)});const ee=l(()=>{t?.updateStatusMouseOnScene(!0)},"handleMouseEnter"),G=l(()=>{t?.updateStatusMouseOnScene(!1)},"handleMouseLeave"),E=l(async()=>{t&&(await t.startRecording(),i.value=!0)},"handleStartRecording"),T=l(()=>{t&&(t.stopRecording(),i.value=!1,g.value=t.getRecordingDuration(),c.value=g.value>0)},"handleStopRecording"),Re=l(()=>{if(t){const D=`${new Date().toISOString().replace(/[:.]/g,"-")}-scene-recording.mp4`;t.exportRecording(D)}},"handleExportRecording"),Le=l(()=>{t&&(t.clearRecording(),c.value=!1,g.value=0)},"handleClearRecording"),k=l(async d=>{if(!d){a.value.backgroundImage="",await t?.setBackgroundImage("");return}const D=e.value?.properties["Resource Folder"]||"",L=D.trim()?`3d/${D.trim()}`:"3d",O=await ie.uploadFile(d,L);a.value.backgroundImage=O,await t?.setBackgroundImage(O)},"handleBackgroundImageUpdate"),C=l(async d=>{if(!t){U().addAlert(y("toastMessages.no3dSceneToExport"));return}try{await t.exportModel(d)}catch(D){console.error("Error exporting model:",D),U().addAlert(y("toastMessages.failedToExportModel",{format:d.toUpperCase()}))}},"handleExportModel"),re=l(async d=>{if(!t){U().addAlert(y("toastMessages.no3dScene"));return}const D=ge(e.value);if(D)try{const L=D.properties["Resource Folder"]||"",O=L.trim()?`3d/${L.trim()}`:"3d";w.value=!0,u.value=y("load3d.uploadingModel");const ae=await ie.uploadFile(d,O);if(!ae){U().addAlert(y("toastMessages.fileUploadFailed"));return}const ve=Ie.apiURL(ie.getResourceURL(...ie.splitFilePath(ae),v.value?"output":"input"));u.value=y("load3d.loadingModel"),await t.loadModel(ve);const oe=D.widgets?.find(se=>se.name==="model_file");if(oe){const se=oe.options;se?.values&&!se.values.includes(ae)&&se.values.push(ae),oe.value=ae}}catch(L){console.error("Model drop failed:",L),U().addAlert(y("toastMessages.failedToLoadModel"))}finally{w.value=!1,u.value=""}},"handleModelDrop"),V={materialModeChange:l(d=>{o.value.materialMode=d},"materialModeChange"),backgroundColorChange:l(d=>{a.value.backgroundColor=d},"backgroundColorChange"),backgroundRenderModeChange:l(d=>{a.value.backgroundRenderMode=d},"backgroundRenderModeChange"),lightIntensityChange:l(d=>{n.value.intensity=d},"lightIntensityChange"),fovChange:l(d=>{r.value.fov=d},"fovChange"),cameraTypeChange:l(d=>{r.value.cameraType=d},"cameraTypeChange"),showGridChange:l(d=>{a.value.showGrid=d},"showGridChange"),upDirectionChange:l(d=>{o.value.upDirection=d},"upDirectionChange"),backgroundImageChange:l(d=>{a.value.backgroundImage=d},"backgroundImageChange"),backgroundImageLoadingStart:l(()=>{u.value=y("load3d.loadingBackgroundImage"),w.value=!0},"backgroundImageLoadingStart"),backgroundImageLoadingEnd:l(()=>{u.value="",w.value=!1},"backgroundImageLoadingEnd"),modelLoadingStart:l(()=>{u.value=y("load3d.loadingModel"),w.value=!0},"modelLoadingStart"),modelLoadingEnd:l(()=>{u.value="",w.value=!1},"modelLoadingEnd"),exportLoadingStart:l(d=>{u.value=d||y("load3d.exportingModel"),w.value=!0},"exportLoadingStart"),exportLoadingEnd:l(()=>{u.value="",w.value=!1},"exportLoadingEnd"),recordingStatusChange:l(d=>{i.value=d,!d&&t&&(g.value=t.getRecordingDuration(),c.value=g.value>0)},"recordingStatusChange"),animationListChange:l(d=>{p.value=d},"animationListChange")},te=l(d=>{Object.entries(V).forEach(([D,L])=>{const O=`${d}EventListener`;t?.[O](D,L)})},"handleEvents");return{load3d:t,sceneConfig:a,modelConfig:o,cameraConfig:r,lightConfig:n,isRecording:i,isPreview:v,hasRecording:c,recordingDuration:g,animations:p,playing:M,selectedSpeed:b,selectedAnimation:m,loading:w,loadingMessage:u,initializeLoad3d:K,waitForLoad3d:q,handleMouseEnter:ee,handleMouseLeave:G,handleStartRecording:E,handleStopRecording:T,handleExportRecording:Re,handleClearRecording:Le,handleBackgroundImageUpdate:k,handleExportModel:C,handleModelDrop:re,cleanup:l(()=>{te("remove");const d=ge(e.value);if(!d)return;const D=d;ue.get(D)===t&&ue.delete(D),t?.remove(),t=null},"cleanup")}},"useLoad3d"),Co=l(h=>{const e=x(""),t=x(!0),a=x("perspective"),o=x(75),r=x(1),n=x(""),i=x(!1),c=x("tiled"),g=x("original"),p=x("original"),M=x(!0),b=x(!1);let m=null,w=null;const u=x({backgroundColor:"#282828",showGrid:!0,cameraType:"perspective",fov:75,lightIntensity:1,cameraState:null,backgroundImage:"",backgroundRenderMode:"tiled",upDirection:"original",materialMode:"original"});return W(e,k=>{if(m)try{m.setBackgroundColor(k)}catch(C){console.error("Error updating background color:",C),U().addAlert(y("toastMessages.failedToUpdateBackgroundColor",{color:k}))}}),W(t,k=>{if(m)try{m.toggleGrid(k)}catch(C){console.error("Error toggling grid:",C),U().addAlert(y("toastMessages.failedToToggleGrid",{show:k?"on":"off"}))}}),W(a,k=>{if(m)try{m.toggleCamera(k)}catch(C){console.error("Error toggling camera:",C),U().addAlert(y("toastMessages.failedToToggleCamera",{camera:k}))}}),W(o,k=>{if(m)try{m.setFOV(Number(k))}catch(C){console.error("Error updating FOV:",C),U().addAlert(y("toastMessages.failedToUpdateFOV",{fov:k}))}}),W(r,k=>{if(m)try{m.setLightIntensity(Number(k))}catch(C){console.error("Error updating light intensity:",C),U().addAlert(y("toastMessages.failedToUpdateLightIntensity",{intensity:k}))}}),W(n,async k=>{if(m)try{await m.setBackgroundImage(k),i.value=!!k}catch(C){console.error("Error updating background image:",C),U().addAlert(y("toastMessages.failedToUpdateBackgroundImage"))}}),W(c,k=>{if(m)try{m.setBackgroundRenderMode(k)}catch(C){console.error("Error updating background render mode:",C),U().addAlert(y("toastMessages.failedToUpdateBackgroundRenderMode",{mode:k}))}}),W(g,k=>{if(m)try{m.setUpDirection(k)}catch(C){console.error("Error updating up direction:",C),U().addAlert(y("toastMessages.failedToUpdateUpDirection",{direction:k}))}}),W(p,k=>{if(m)try{m.setMaterialMode(k)}catch(C){console.error("Error updating material mode:",C),U().addAlert(y("toastMessages.failedToUpdateMaterialMode",{mode:k}))}}),{backgroundColor:e,showGrid:t,cameraType:a,fov:o,lightIntensity:r,backgroundImage:n,hasBackgroundImage:i,backgroundRenderMode:c,upDirection:g,materialMode:p,needApplyChanges:M,isPreview:b,initializeViewer:l(async(k,C)=>{if(k){w=C;try{m=new pt(k,{node:h,disablePreview:!0,isViewerMode:!0}),await he().copyLoad3dState(C,m);const re=C.getCameraState(),V=h.properties["Scene Config"],te=h.properties["Model Config"],S=h.properties["Camera Config"],d=h.properties["Light Config"];b.value=h.type==="Preview3D",V&&(e.value=V.backgroundColor||C.sceneManager.currentBackgroundColor,t.value=V.showGrid??C.sceneManager.gridHelper.visible,c.value=V.backgroundRenderMode||C.sceneManager.backgroundRenderMode||"tiled",C.sceneManager.getCurrentBackgroundInfo().type==="image"&&V.backgroundImage?(n.value=V.backgroundImage,i.value=!0):(n.value="",i.value=!1)),S&&(a.value=S.cameraType||C.getCurrentCameraType(),o.value=S.fov||C.cameraManager.perspectiveCamera.fov),d?r.value=d.intensity||1:r.value=1,te&&(g.value=te.upDirection||C.modelManager.currentUpDirection,p.value=te.materialMode||C.modelManager.materialMode),u.value={backgroundColor:e.value,showGrid:t.value,cameraType:a.value,fov:o.value,lightIntensity:r.value,cameraState:re,backgroundImage:n.value,backgroundRenderMode:c.value,upDirection:g.value,materialMode:p.value};const D=h.widgets?.find(O=>O.name==="width"),L=h.widgets?.find(O=>O.name==="height");D&&L&&m.setTargetSize(ge(D).value,ge(L).value)}catch(re){console.error("Error initializing Load3d viewer:",re),U().addAlert(y("toastMessages.failedToInitializeLoad3dViewer"))}}},"initializeViewer"),exportModel:l(async k=>{if(m)try{await m.exportModel(k)}catch(C){console.error("Error exporting model:",C),U().addAlert(y("toastMessages.failedToExportModel",{format:k.toUpperCase()}))}},"exportModel"),handleResize:l(()=>{m?.handleResize()},"handleResize"),handleMouseEnter:l(()=>{m?.updateStatusMouseOnViewer(!0)},"handleMouseEnter"),handleMouseLeave:l(()=>{m?.updateStatusMouseOnViewer(!1)},"handleMouseLeave"),restoreInitialState:l(()=>{const k=h;if(M.value=!1,k.properties){k.properties["Scene Config"]={showGrid:u.value.showGrid,backgroundColor:u.value.backgroundColor,backgroundImage:u.value.backgroundImage,backgroundRenderMode:u.value.backgroundRenderMode},k.properties["Camera Config"]={cameraType:u.value.cameraType,fov:u.value.fov},k.properties["Light Config"]={intensity:u.value.lightIntensity},k.properties["Model Config"]={upDirection:u.value.upDirection,materialMode:u.value.materialMode};const C=k.properties["Camera Config"];k.properties["Camera Config"]={...C,state:u.value.cameraState}}},"restoreInitialState"),applyChanges:l(async()=>{if(!w||!m)return!1;const k=m.getCameraState(),C=h;return C.properties&&(C.properties["Scene Config"]={showGrid:t.value,backgroundColor:e.value,backgroundImage:n.value,backgroundRenderMode:c.value},C.properties["Camera Config"]={cameraType:a.value,fov:o.value,state:k},C.properties["Light Config"]={intensity:r.value},C.properties["Model Config"]={upDirection:g.value,materialMode:p.value}),await he().copyLoad3dState(m,w),await w.setBackgroundImage(n.value),w.setBackgroundRenderMode(c.value),w.forceRender(),C.graph&&C.graph.setDirtyCanvas(!0,!0),!0},"applyChanges"),refreshViewport:l(()=>{he().handleViewportRefresh(m)},"refreshViewport"),handleBackgroundImageUpdate:l(async k=>{if(!k){n.value="",i.value=!1;return}try{const C=h.properties["Resource Folder"]||"",re=C.trim()?`3d/${C.trim()}`:"3d",V=await ie.uploadFile(k,re);V&&(n.value=V,i.value=!0)}catch(C){console.error("Error uploading background image:",C),U().addAlert(y("toastMessages.failedToUploadBackgroundImage"))}},"handleBackgroundImageUpdate"),handleModelDrop:l(async k=>{if(!m){U().addAlert(y("toastMessages.no3dScene"));return}try{const C=h.properties["Resource Folder"]||"",re=C.trim()?`3d/${C.trim()}`:"3d",V=await ie.uploadFile(k,re);if(!V){U().addAlert(y("toastMessages.fileUploadFailed"));return}const te=Ie.apiURL(ie.getResourceURL(...ie.splitFilePath(V),"input"));await m.loadModel(te);const S=h.widgets?.find(d=>d.name==="model_file");if(S){const d=S.options;d?.values&&!d.values.includes(V)&&d.values.push(V),S.value=V}}catch(C){console.error("Model drop failed:",C),U().addAlert(y("toastMessages.failedToLoadModel"))}},"handleModelDrop"),cleanup:l(()=>{m?.remove(),m=null,w=null},"cleanup")}},"useLoad3dViewer"),Se=new Map;class ye{static{l(this,"Load3dService")}static instance;constructor(){}static getInstance(){return ye.instance||(ye.instance=new ye),ye.instance}getLoad3d(e){const t=ge(e);return ue.get(t)||null}getNodeByLoad3d(e){for(const[t,a]of ue)if(a===e)return t;return null}removeLoad3d(e){const t=ge(e),a=ue.get(t);a&&(a.remove(),ue.delete(t))}clear(){for(const[e]of ue)this.removeLoad3d(e)}getOrCreateViewer(e){return Se.has(e.id)||Se.set(e.id,Co(e)),Se.get(e.id)}removeViewer(e){const t=Se.get(e.id);t&&t.cleanup(),Se.delete(e.id)}async copyLoad3dState(e,t){const a=e.modelManager.currentModel;if(a){const i=a.clone();t.getModelManager().currentModel=i,t.getSceneManager().scene.add(i),t.getModelManager().materialMode=e.getModelManager().materialMode,t.getModelManager().currentUpDirection=e.getModelManager().currentUpDirection,t.setMaterialMode(e.getModelManager().materialMode),t.setUpDirection(e.getModelManager().currentUpDirection),e.getModelManager().appliedTexture&&(t.getModelManager().appliedTexture=e.getModelManager().appliedTexture)}const o=e.getCurrentCameraType(),r=e.getCameraState();if(t.toggleCamera(o),t.setCameraState(r),t.setBackgroundColor(e.getSceneManager().currentBackgroundColor),t.toggleGrid(e.getSceneManager().gridHelper.visible),e.getSceneManager().getCurrentBackgroundInfo().type==="image"){const g=this.getNodeByLoad3d(e)?.properties?.["Scene Config"]?.backgroundImage;g&&await t.setBackgroundImage(g)}else await t.setBackgroundImage("");t.setLightIntensity(e.getLightingManager().lights[1]?.intensity||1),o==="perspective"&&t.setFOV(e.getCameraManager().perspectiveCamera.fov)}handleViewportRefresh(e){if(!e)return;e.handleResize();const t=e.getCurrentCameraType();e.toggleCamera(t==="perspective"?"orthographic":"perspective"),e.toggleCamera(t),e.getControlsManager().controls.update()}async handleViewerClose(e){const t=he().getOrCreateViewer(e);t.needApplyChanges.value&&(await t.applyChanges(),e.syncLoad3dConfig&&e.syncLoad3dConfig()),he().removeViewer(e)}}const he=l(()=>ye.getInstance(),"useLoad3dService"),bo={key:0,class:"pointer-events-none absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"},yo={class:"rounded-lg border-2 border-dashed border-blue-400 bg-blue-500/20 px-6 py-4 text-lg font-medium text-blue-100"},ko={class:"flex w-72 flex-col"},Ao={class:"flex-1 overflow-y-auto p-4"},xo={class:"space-y-2"},Ro={class:"space-y-4 p-2"},So={class:"space-y-4 p-2"},Eo={class:"space-y-4 p-2"},Io={class:"space-y-4 p-2"},Lo={class:"space-y-4 p-2"},To={class:"p-4"},Do={class:"flex gap-2"},Uo=z({__name:"Load3dViewerContent",props:{node:{}},setup(h){const e=h,t=x(),a=x(),o=x(),r=x(!1),n=x(null),i=he().getOrCreateViewer(ge(e.node)),{isDragging:c,dragMessage:g,handleDragOver:p,handleDragLeave:M,handleDrop:b}=at({onModelDrop:l(async w=>{await i.handleModelDrop(w)},"onModelDrop"),disabled:i.isPreview});me(async()=>{const w=he().getLoad3d(e.node);w&&a.value&&await i.initializeViewer(a.value,w),t.value&&(n.value=new MutationObserver(u=>{u.forEach(v=>{v.type==="attributes"&&v.attributeName==="maximized"&&(r.value=v.target.getAttribute("maximized")==="true",setTimeout(()=>{i.refreshViewport()},0))})}),n.value.observe(t.value,{attributes:!0,attributeFilter:["maximized"]})),window.addEventListener("resize",i.handleResize)});const m=l(()=>{i.restoreInitialState(),qe().closeDialog()},"handleCancel");return bt(()=>{window.removeEventListener("resize",i.handleResize),n.value&&(n.value.disconnect(),n.value=null)}),(w,u)=>(A(),I("div",{ref_key:"viewerContentRef",ref:t,class:Q(["flex w-full",[r.value?"h-full":"h-[70vh]"]]),onMouseenter:u[13]||(u[13]=(...v)=>s(i).handleMouseEnter&&s(i).handleMouseEnter(...v)),onMouseleave:u[14]||(u[14]=(...v)=>s(i).handleMouseLeave&&s(i).handleMouseLeave(...v))},[f("div",{ref_key:"mainContentRef",ref:o,class:"relative flex-1"},[f("div",{ref_key:"containerRef",ref:a,class:"absolute h-full w-full",onResize:u[0]||(u[0]=(...v)=>s(i).handleResize&&s(i).handleResize(...v)),onDragover:u[1]||(u[1]=H((...v)=>s(p)&&s(p)(...v),["prevent","stop"])),onDragleave:u[2]||(u[2]=H((...v)=>s(M)&&s(M)(...v),["stop"])),onDrop:u[3]||(u[3]=H((...v)=>s(b)&&s(b)(...v),["prevent","stop"]))},null,544),s(c)?(A(),I("div",bo,[f("div",yo,j(s(g)),1)])):P("",!0)],512),f("div",ko,[f("div",Ao,[f("div",xo,[f("div",Ro,[R(Mo,{"background-color":s(i).backgroundColor.value,"onUpdate:backgroundColor":u[4]||(u[4]=v=>s(i).backgroundColor.value=v),"show-grid":s(i).showGrid.value,"onUpdate:showGrid":u[5]||(u[5]=v=>s(i).showGrid.value=v),"background-render-mode":s(i).backgroundRenderMode.value,"onUpdate:backgroundRenderMode":u[6]||(u[6]=v=>s(i).backgroundRenderMode.value=v),fov:s(i).fov.value,"onUpdate:fov":u[7]||(u[7]=v=>s(i).fov.value=v),"has-background-image":s(i).hasBackgroundImage.value,onUpdateBackgroundImage:s(i).handleBackgroundImageUpdate},null,8,["background-color","show-grid","background-render-mode","fov","has-background-image","onUpdateBackgroundImage"])]),f("div",So,[R(uo,{"up-direction":s(i).upDirection.value,"onUpdate:upDirection":u[8]||(u[8]=v=>s(i).upDirection.value=v),"material-mode":s(i).materialMode.value,"onUpdate:materialMode":u[9]||(u[9]=v=>s(i).materialMode.value=v)},null,8,["up-direction","material-mode"])]),f("div",Eo,[R(io,{"camera-type":s(i).cameraType.value,"onUpdate:cameraType":u[10]||(u[10]=v=>s(i).cameraType.value=v),fov:s(i).fov.value,"onUpdate:fov":u[11]||(u[11]=v=>s(i).fov.value=v)},null,8,["camera-type","fov"])]),f("div",Io,[R(lo,{"light-intensity":s(i).lightIntensity.value,"onUpdate:lightIntensity":u[12]||(u[12]=v=>s(i).lightIntensity.value=v)},null,8,["light-intensity"])]),f("div",Lo,[R(no,{onExportModel:s(i).exportModel},null,8,["onExportModel"])])])]),f("div",To,[f("div",Do,[R(s(B),{icon:"pi pi-times",severity:"secondary",label:s(y)("g.cancel"),onClick:m},null,8,["label"])])])])],34))}}),_o=Oe(Uo,[["__scopeId","data-v-c2079a9f"]]),Po={class:"relative rounded-lg bg-smoke-700/30"},Bo={class:"flex flex-col gap-2"},Fo={class:"pi pi-expand text-lg text-white"},$o=z({__name:"ViewerControls",props:{node:{}},setup(h){const e=l(()=>{const t={node:h.node};qe().showDialog({key:"global-load3d-viewer",title:y("load3d.viewer.title"),component:_o,props:t,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:l(async()=>{await he().handleViewerClose(t.node)},"onClose")}})},"openIn3DViewer");return(t,a)=>{const o=fe("tooltip");return A(),I("div",Po,[f("div",Bo,[R(s(B),{class:"p-button-rounded p-button-text",onClick:e},{default:F(()=>[$(f("i",Fo,null,512),[[o,{value:s(y)("load3d.openIn3DViewer"),showDelay:300},void 0,{right:!0}]])]),_:1})])])}}}),Oo={class:"pointer-events-none absolute top-0 left-0 h-full w-full"},Vo={key:1,class:"pointer-events-auto absolute top-12 right-2 z-20"},Jo=z({__name:"Load3D",props:{widget:{},nodeId:{}},setup(h){const e=h;function t(te){return"node"in te&&te.node!==void 0}l(t,"isComponentWidget");const a=x(null);t(e.widget)?a.value=e.widget.node:e.nodeId&&me(()=>{a.value=Ve.rootGraph?.getNodeById(e.nodeId)||null});const o=x(null),{sceneConfig:r,modelConfig:n,cameraConfig:i,lightConfig:c,isRecording:g,isPreview:p,hasRecording:M,recordingDuration:b,animations:m,playing:w,selectedSpeed:u,selectedAnimation:v,loading:K,loadingMessage:N,initializeLoad3d:X,handleMouseEnter:q,handleMouseLeave:ee,handleStartRecording:G,handleStopRecording:E,handleExportRecording:T,handleClearRecording:Re,handleBackgroundImageUpdate:Le,handleExportModel:k,handleModelDrop:C,cleanup:re}=wo(a),V=Z(()=>Me().get("Comfy.Load3D.3DViewerEnable"));return(te,S)=>(A(),I("div",{class:"widget-expands relative h-full w-full",onMouseenter:S[11]||(S[11]=(...d)=>s(q)&&s(q)(...d)),onMouseleave:S[12]||(S[12]=(...d)=>s(ee)&&s(ee)(...d)),onPointerdown:S[13]||(S[13]=H(()=>{},["stop"])),onPointermove:S[14]||(S[14]=H(()=>{},["stop"])),onPointerup:S[15]||(S[15]=H(()=>{},["stop"]))},[a.value?(A(),J(Wa,{key:0,ref_key:"load3DSceneRef",ref:o,"initialize-load3d":s(X),cleanup:s(re),loading:s(K),"loading-message":s(N),"on-model-drop":s(p)?void 0:s(C),"is-preview":s(p)},null,8,["initialize-load3d","cleanup","loading","loading-message","on-model-drop","is-preview"])):P("",!0),f("div",Oo,[R(Fa,{"scene-config":s(r),"onUpdate:sceneConfig":S[0]||(S[0]=d=>ne(r)?r.value=d:null),"model-config":s(n),"onUpdate:modelConfig":S[1]||(S[1]=d=>ne(n)?n.value=d:null),"camera-config":s(i),"onUpdate:cameraConfig":S[2]||(S[2]=d=>ne(i)?i.value=d:null),"light-config":s(c),"onUpdate:lightConfig":S[3]||(S[3]=d=>ne(c)?c.value=d:null),onUpdateBackgroundImage:s(Le),onExportModel:s(k)},null,8,["scene-config","model-config","camera-config","light-config","onUpdateBackgroundImage","onExportModel"]),s(m)&&s(m).length>0?(A(),J(Xa,{key:0,animations:s(m),"onUpdate:animations":S[4]||(S[4]=d=>ne(m)?m.value=d:null),playing:s(w),"onUpdate:playing":S[5]||(S[5]=d=>ne(w)?w.value=d:null),"selected-speed":s(u),"onUpdate:selectedSpeed":S[6]||(S[6]=d=>ne(u)?u.value=d:null),"selected-animation":s(v),"onUpdate:selectedAnimation":S[7]||(S[7]=d=>ne(v)?v.value=d:null)},null,8,["animations","playing","selected-speed","selected-animation"])):P("",!0)]),V.value&&a.value?(A(),I("div",Vo,[R($o,{node:a.value},null,8,["node"])])):P("",!0),s(p)?P("",!0):(A(),I("div",{key:2,class:Q(["pointer-events-auto absolute right-2 z-20",{"top-12":!V.value,"top-24":V.value}])},[R(eo,{"is-recording":s(g),"onUpdate:isRecording":S[8]||(S[8]=d=>ne(g)?g.value=d:null),"has-recording":s(M),"onUpdate:hasRecording":S[9]||(S[9]=d=>ne(M)?M.value=d:null),"recording-duration":s(b),"onUpdate:recordingDuration":S[10]||(S[10]=d=>ne(b)?b.value=d:null),onStartRecording:s(G),onStopRecording:s(E),onExportRecording:s(T),onClearRecording:s(Re)},null,8,["is-recording","has-recording","recording-duration","onStartRecording","onStopRecording","onExportRecording","onClearRecording"])],2))],32))}});export{ie as L,Jo as _,_o as a,wo as b,ue as n,he as u};
//# sourceMappingURL=Load3D.vue_vue_type_script_setup_true_lang-DAvDQFPr.js.map
