# PYTEMPLIFY ISOLATED TEST ENVIRONMENT
# This CMakeLists.txt is managed by pytemplify for validation purposes.
# It is independent of your project's build system.
#
# Generated by pytemplify validation framework
# Test: {{ test_name }}

cmake_minimum_required(VERSION 3.14)
project({{ test_name }}_pytemplify_validation)

# Standard C++ settings
set(CMAKE_CXX_STANDARD {{ cxx_standard }})
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Default build type when not specified by caller
if(NOT CMAKE_BUILD_TYPE)
set(CMAKE_BUILD_TYPE {{ build_type | default("Debug") }})
endif()

{% if enable_coverage -%}
# Enable coverage compile/link flags early so FetchContent-built dependencies
# (like googletest) are also built with coverage instrumentation.
message(STATUS "Enabling coverage flags for test build")
# Add compilation flags for coverage and ensure debug info / no optimization
add_compile_options(--coverage -g -O0)

# Also set global C/C++ flags so FetchContent-built targets inherit coverage instrumentation.
# Use both -fprofile-arcs and -ftest-coverage for GCC/Clang compatibility.
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fprofile-arcs -ftest-coverage -g -O0")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fprofile-arcs -ftest-coverage -g -O0")

# Ensure linker gets coverage flags too
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} --coverage")
{% endif %}

{% if policy_cmp0135 | default(False) -%}
# GoogleTest requires this policy for FetchContent
if(POLICY CMP0135)
cmake_policy(SET CMP0135 NEW)
endif()
{% endif %}

{% if policy_cmp0105 | default(False) -%}
# Suppress warnings from GoogleTest about cmake_minimum_required
if(POLICY CMP0105)
cmake_policy(SET CMP0105 NEW)
endif()
{% endif %}

{% if disable_windows -%}
# Platform check
if(WIN32)
message(FATAL_ERROR "This test configuration does not support Windows.")
endif()
{% endif %}

# Additional cmake definitions
{% for definition in cmake_definitions -%}
add_definitions(-D{{ definition }})
{% endfor %}

# Google Test setup via FetchContent
include(FetchContent)

# Use shared cache for FetchContent to avoid re-downloading GoogleTest for each test
# This significantly improves performance by reusing the same GoogleTest download
if(NOT DEFINED FETCHCONTENT_BASE_DIR)
set(FETCHCONTENT_BASE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../.fetchcontent_cache" CACHE PATH "FetchContent base directory")
endif()
FetchContent_Declare(
googletest
GIT_REPOSITORY https://github.com/google/googletest.git
GIT_TAG {{ gtest_version }}
)

# For Windows: Prevent overriding the parent project's compiler/linker settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

enable_testing()

# Test executable name
set(TEST_TARGET {{ test_name }})

# Find all source files using glob patterns
{% for pattern in source_patterns -%}
file(GLOB_RECURSE {{ pattern.name }}_{{ loop.index }}_SOURCES "{{ pattern.path }}")
{% endfor %}

# Collect all source files
set(ALL_SOURCES
{% for pattern in source_patterns -%}
{{ "${" + pattern.name + "_" + loop.index|string + "_SOURCES}" }}
{% endfor %}
)

# Create test executable
add_executable(${TEST_TARGET}
{{ test_file }}
${ALL_SOURCES}
)

# Include directories
target_include_directories(${TEST_TARGET} PRIVATE
{% for inc_dir in include_dirs -%}
{{ inc_dir }}
{% endfor %}
)

# Link libraries
target_link_libraries(${TEST_TARGET}
GTest::gtest_main
GTest::gmock_main
{% for lib in link_libraries -%}
{{ lib }}
{% endfor %}
)

# Compiler flags
target_compile_options(${TEST_TARGET} PRIVATE
-Wall
-Wextra
{% if warnings_as_errors -%}
-Werror
{% endif %}
{% if enable_coverage -%}
-fprofile-arcs
-ftest-coverage
-g
-O0
{% endif %}
{% for flag in extra_compile_flags -%}
{{ flag }}
{% endfor %}
)

# Compiler features
target_compile_features(${TEST_TARGET} PRIVATE cxx_std_{{ cxx_standard }})

{% if enable_coverage -%}
# Add coverage linking flags (ensure linker gets coverage instrumentation)
target_link_options(${TEST_TARGET} PRIVATE --coverage)
{% endif %}

# Register tests with CTest
include(GoogleTest)
gtest_discover_tests(${TEST_TARGET})

{% if enable_coverage -%}
# Add a custom target to run the tests and generate code coverage data
# Use absolute binary directory paths so lcov can find .gcda/.gcno files generated during the build.
add_custom_target(test_coverage
COMMAND ${CMAKE_CTEST_COMMAND} --verbose
COMMAND lcov --capture --directory ${CMAKE_BINARY_DIR} --output-file ${CMAKE_BINARY_DIR}/coverage.info
COMMAND lcov --remove ${CMAKE_BINARY_DIR}/coverage.info '/usr/*' '*/googletest/*' '*/test_*.cpp' --output-file ${CMAKE_BINARY_DIR}/cleaned_coverage.info
COMMAND lcov --list ${CMAKE_BINARY_DIR}/cleaned_coverage.info
COMMAND genhtml ${CMAKE_BINARY_DIR}/cleaned_coverage.info --output-directory ${CMAKE_BINARY_DIR}/coverage_report
WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
COMMENT "Running tests with coverage and generating coverage report (SUT only, excluding test files)"
)

{% endif %}