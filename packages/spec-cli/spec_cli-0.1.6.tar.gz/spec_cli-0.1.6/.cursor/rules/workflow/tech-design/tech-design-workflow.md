# 技术方案生成工作流

目标：使用 AI（基于给定的功能点清单和可选的代码仓库）自动化生成可交付的技术实现方案文档，供人工微调后交由 AI/工程团队实施代码开发工作。

## 一、触发机制

### 1.元指令

可通过如下元指令激活工作流：

- `tech manual` — 激活 `${workflowName}` 手动推进模式，严格按如下阶段顺序推进： **Collect → Research → Innovation → EXECUTE**
- `tech auto` — 激活 `${workflowName}` 自动推进模式，按相同阶段顺序推进，全程不停顿；仅在触发自动回退仍无法形成安全假设时，记录高危风险并以最小化假设继续。
  **触发后行为**: 一旦触发，我将严格遵循以下 `${workflowName}` 工作流协议，直到任务完成或您明确表示退出。

### 2.阶段显示

每次响应的**第一行**必须声明：`[STAGE: ${stageName} ] | [${workflowName}] | [${workflowMode}]`；缺失视为 **严重违反协议** 。

触发后默认进入  **Collect** ，并按上述格式在第一行声明阶段，并打印全局变量。

### 3. 阶段流转与人工确认（强制门禁）

手动模式：各阶段结束均需人工手动流转到下一阶段；未确认即推进视为严重违反协议。

自动模式：阶段间不等待人工确认，直通推进，直到整个工作流全部完成；门禁规则发生时按“自动/手动门禁策略”处理。

### 4.模式门禁策略（Manual/Auto）

- 手动模式：

  - P0：阻断并停顿，待澄清后推进。
  - P1：建议停顿；若带假设推进，需负责人同意并记录缓解策略。
  - P2：记录假设与后续验证任务，可继续。
- 自动模式：

  - P0：自动回退尝试补齐；仍无法补齐时，以最小化且安全的临时假设继续，并高亮为未决高风险。
  - P1/P2：记录假设与缓解策略后继续，不停顿；将验证任务纳入计划。

说明：两模式均需将假设、证据与决策写入相应产物（澄清列表、决策日志、风险清单），并在后续阶段闭环验证。

#### 执行节拍与变量

- 手动：执行阶段每完成 `executionPauseEveryNTasks`（默认 3）个任务停顿。
- 自动：无节拍停顿。
- 任务计数口径：以 `execution_plan.csv` 中的原子任务为单位。

#### 自动回退与记录

- 自动在 P0 无法补齐时，以“最小化且安全”假设继续；同时在决策日志与风险清单中记录：时间、事项、影响面、后续验证任务与负责人。

## 二、动态变量定义

> 执行时由 LLM 以 YAML 片段**更新**，用作全局变量。以下变量用于**统一生成路径**与**命名规则**。

```yaml

# === Runtime Vars (managed by AI) ===

projectName: ""                   # 必填

repoRoot: "."                     # 仓库根；相对路径

taskRoot: ".tasks"                # 任务根目录（强约束）

taskName: ""                      # 原始任务名，后缀为 taskDateFmt

taskDateFmt: "YYYYMMDD"           # 日期格式（默认 YYYYMMDD）

tempDirName: "temp"               # 临时目录名

workflowName: "Tech_Design_Workflow"   # 工作流名称
workflowMode: "Auto"              # 工作流模式，默认Auto

assetDirName: "assets"            # 可选：非代码产物子目录；若不需要则置为 ""

linkStyle: "relative"             # 文档内链接相对路径

safeSlug: false                   # 是否将任务名 slug 化为英文（默认 false，允许中文目录）

subTaskFile: false                # 是否写子任务文件

executionPauseEveryNTasks: 3     # 手动模式执行阶段：每完成N个任务停顿一次

```

---

## 三、核心原则

- **规划优先（Planning-first）**：在生成方案细节之前，先进行充分的计划和分解，形成关于技术方案生成的完备的分阶段实施计划，经确认后再进入具体执行。这确保了AI有清晰的行动蓝图，避免盲目产出偏离需求的内容。
- **事实基线（Fact Baseline）**：研究阶段要把 需求资料、现有代码能⼒、依赖与约束形成可证伪的证据集。
- **允许澄清**：遇证据不足或矛盾时立即生成 Clarification 并停流转。
- **回退/暂停**：手动模式下，任何阶段若证据不足则回退到上游阶段或暂停，直到人工确认。
- **原子化声明（Atomic Claims）**：把复杂结论拆成原子断言，便于验证与追溯。
- **不确定性标注（Explicit Uncertainty）**：所有结论必须带置信度与缺失证据说明。
- **最小化幻觉**：AI 产生的每个 Claim 必须带 Evidence Anchor 或标注为 "Assumption" 并列 Clarification。

## 四、术语定义

术语：

- **Claim**：基于功能更点文档/代码库的事实陈述（带证据锚点或待确认）。
- **Evidence Anchor**：支持 Claim 的原始工件引用（需求资料 段落 ID、文件路径+commit、DB schema 等）。每条事实断言都应附有至少一个证据锚点以证明其有效性，确保设计基于的事实具有可追溯来源。
- **Clarification**：当某个事实断言缺乏证据支持、验证结果不确定或需求存在模糊歧义时，需要向需求提出方（如PO）澄清的问题或假设（带优先级 P0/P1/P2）。
- **Fact Baseline**：研究阶段结束时的证据集。

Clarification 优先级：

- **P0 阻塞**：不解决会影响系统正确性或关键业务；相关实现/讨论禁止推进。
- **P1 高**：强烈建议实现前解决；若无法即时解决，必须附**临时缓解方案**并由人工批准。
- **P2 低**：可在假设下短暂前行，但需**记录假设**并创建后续验证任务。

## 五、产物目录与路径约定

> 所有产物存放在同一项目根目录下 `.tasks/<taskName>`，便于打包与归档。

```

.tasks/
   <taskName>/
        40_execution/
            技术方案设计文档.md                 # 技术方案设计文档

```

## 六、工作流整体流程

```
收集(Collect) → 研究（Research）→ 创新（Innovation）→  执行（Execution）
```

工作流各阶段的**输出约束**：

- Collect/Research/Innovation 阶段：只打印阶段声明和简短执行总结（100字以内），不创建文件
- Execution 阶段：需要创建完整的交付文件

**执行约束**：

- 所有阶段都必须完成内部分析和处理工作
- Auto 模式下，各阶段完成后自动连续推进，不等待确认，每个阶段结束时必须明确声明"XX阶段完成，自动进入YY阶段"

## 七、工作流阶段详述

### 阶段1：收集(Collect)

**目标**：收集全部相关事实资料（功能点报告、可选的技术专家建议）

**步骤：**

* 检查是否提供了功能点报告，如果没有提供则暂停工作流，并提示用户提供功能点报告。
* 收集功能点报告、可选的技术专家建议

### 阶段2: 研究（Research）

**目标：** 基于事实资料，形成事实基线，并进行深入研究

**步骤：**

* **功能点原子化（Atomicization）**：把每个功能点拆为原子条目，把每个专家建议结构化为"建议条目"
* 代码库静态分析（可选）：

  - 识别到核心文件和功能
  - 识别到相应的技术栈
  - 识别到代码仓库中与本次功能点相关的文件和代码片段
  - 找到相关功能的入口点
  - 分析相关领域模型与状态机
  - 相关数据库表

- 深度分析：从功能点报告和专家建议，分析出核心业务流程、业务规则、关键数据实体

* **Fact Baseline 汇总输出** ：

  - 汇总当前阶段的研究成果形成 `fact_baseline.json`（逻辑文件，无需真正生成），内容包括每个需求项的状态（`confirmed`/`blocked`/`inconclusive`）、证据锚点，以及术语映射关系。

### 阶段3: 创新（Innovation）

**目标：** 在事实基线约束下，穷尽性提出并评估多种实现路径，对比取舍，产出 **推荐设计方案草案**。

**步骤：**

* **方案发散：** 基于事实基线提出多种架构/技术/模块划分等组合方案。
  * 技术栈：对于相应技术，则优先使用携程内部框架支持的。内部框架提供的技术，包括但不限于Qshedule/QMQ/Qconfig/Dal/SOA/CRedis/Minos，可通过 **Tech Doc** MCP工具 查询到。
* **方案成型：** 为每个方案给出简要说明与必要图示，明确模块职责与数据/控制流。
* **可行性与依据：** 校核强制需求与约束、复杂度与风险，标注假设并引用经验依据。
* **对比评估：** 构建对比矩阵按关键维度评估与打分，汇总优缺点。
* **方案选择：** 选定推荐方案并记录取舍理由；未定因素记为澄清/假设，后续处理。

完成创新阶段后，AI应该产出一个经过深思熟虑的 **方案设计草案** 。它包括推荐方案的高层次设计，以及备选方案的简要记录和对比分析

**输出：**

***《方案选型分析报告》：** 详细记录各个备选方案的内容和评估结果。通常采用表格或分段说明形式，包括每个方案的描述、主要优劣点，以及对比矩阵分析结果。

***《推荐方案设计说明》：** 针对最终选定的方案，提供更详细的设计草案说明。包括整体架构图或模块图、关键技术选型解释、各主要组件的职责和交互、满足需求的方案如何实现等。

### 阶段4: 执行（Execution）

**目标：** 按推荐方案，生成完整可交付的技术方案文档

**步骤：**

- 以推荐方案为基础，根据后续提供的技术方案模板，生成完整的可交付的技术方案文档。

**输出：**

***《技术方案设计文档》：** 这是一份最终综合文档，涵盖系统设计的各个方面。

技术方案文档内容约束：

- 生成的文档中，必须符合模板格式
- 禁止生成实际代码，文档中涉及的每个类/接口/方法/属性，只需要包含必要的注释即可（职责、业务逻辑、边界条件、输入/输出说明）。

# 八、模板

### 1.技术方案文档模板

技术方案文档模板：[tech-solution-template](./tech-solution-template.md)