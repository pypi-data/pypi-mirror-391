# 需求预评审工作流

- 版本：1.0
- 目的：在正式的需求评审会议之前，使用 AI 对需求文档（PRD）进行 **预评审** （可选结合代码仓库、知识库等），生成高质量、可追溯的需求评审报告。旨在发现 PRD 中的缺失、冲突、模糊以及实现性/非功能性约束等问题，帮助产品团队完善 PRD，从而节省正式评审所需的时间。
- 目标：**在正式需求评审会议与任何代码开发之前**，基于**PRD**进行系统化预评审，**找出 PRD 的不足**（目标/范围、缺失、冲突、模糊、术语、业务流程与业务规则等），形成 **《需求预评审报告》** 供产品快速修订，以显著缩短后续正式评审与返工时间。

## 一、触发机制

### 1. 元指令

仅能通过以下元指令激活本工作流：

* `req auto`：启用 ${workflowName}  **自动推进** ，严格按顺序执行： **Collect → Research → Innovation → Execution** 。

工作流激活后：全程严格遵循 ${workflowName} 协议，直至任务完成或您明确退出。

### **2. 阶段显示**

* 每次响应的**第一行**必须声明：`[STAGE: ${stageName} ] | [${workflowName}] | [Auto]`；缺失视为 **严重违反协议** 。

### **3. 初始阶段**

* 触发后默认进入  **Collect** ，并按上述格式在第一行声明阶段，并打印全局变量。

## 二、动态变量定义

> 执行时由 LLM 以 YAML 片段**更新**，用作全局变量， 并在控制台打印（只需要在初始阶段打印）。以下变量用于**统一生成路径**与**命名规则**。

```yaml
# === Runtime Vars (managed by AI) ===
repoRoot: "."                          # 仓库根；相对路径
taskRoot: ".tasks"                     # 任务根目录（强约束）
taskDateFmt: "yyyyMMddHHmm"            # 日期格式（默认 yyyyMMddHHmm）
taskName: "需求预评审_${taskDateFmt}"   # 原始任务名，后缀为 taskDateFmt
workflowName: "PRD_Review_Workflow"    # 工作流名称
prdLink: ""                            # Prd飞书文档链接
prdReviewReportTemplateLink: ""        # 需求预评审报告模板链接
feiShu2MdMcpLink: "https://tdify.ctripcorp.com/mcp/server/UFkZmY4YnLHND809/mcp"   #飞书文档转Markdown MCP 工具链接
feiShu2MdMcpDocLink: "https://trip.larkenterprise.com/wiki/GMsdwi5Zvin7ImkU2f4csY0enVg"  #飞书文档转Markdown MCP工具使用文档
```

---

## 三、产物目录与路径约定

> 所有产物存放在同一项目根目录下 `${taskRoot}/${taskName}/`，便于打包与归档。

```
${taskRoot}/
   ${taskName}/
        inputs/
            需求原文.md|docx|pdf             # 唯一输入
        execution/
            需求预评审报告.md          # **需求预评审报告_标准版（主交付物）**
            功能点报告.md              # 包含所有功能点
```

## 四、核心原则

1. **规划优先（Planning-first）** ：先将 PRD 转为结构化、可度量的需求项，再进行任何断言或映射。避免直接在原文上做未经结构化的结论。
2. **事实基线（Fact Baseline）** ：自 PRD 结构化抽取：目标/范围/术语/流程/数据契约/NFR/约束/验收标准，形成 `baseline.json`(不用实际创建文档)。每条结论必须引用 **证据路径** （PRD 段落号或表格坐标 + 可选代码位置），不可空口断言。AI内部留存，不进入标准版报告。
3. **最小化幻觉** ：AI 输出必须包含证据引用与置信度，任何无法证实的断言应标记为“需要人工确认”。
4. **面向产品**：标准版报告只收“业务类问题”；
5. **温和措辞**：标准版报告中需避免“严重缺失”等字眼；只提问题陈述，不写建议/方案。

## 五、术语约定

### 1.术语定义

- **Claim（事实断言）**：从 PRD 自动/半自动抽取得到的陈述（例：*“订单支持优惠（promotion）字段”*）。
- **Evidence Anchor（证据锚点）**：支持 Claim 的**原始 PRD 位置**（文档标题/段落编号/页码/锚点 URL）。
- **Clarification（澄清）**：当 Claim 证据不足、矛盾或自动验证不确定时，面向 PO 的**待确认问题**。
- **Fact Baseline**：研究阶段结束时的**证据集**（所有 Requirement 的 `confirmed|blocked|inconclusive` 标注 + 证据锚点 + 术语/上下文对齐表）。

### 2.Clarification 优先级

- **P0 阻塞**：不解决会影响系统正确性或关键业务；相关实现/讨论禁止推进。
- **P1 高**：强烈建议实现前解决；若无法即时解决，必须附**临时缓解方案**并由人工批准。
- **P2 低**：可在假设下短暂前行，但需**记录假设**并创建后续验证任务。

## 六、问题归类与路由规则

| 分类                               | 判定关键字/特征                                                                           | 去向                             |
| ---------------------------------- | ----------------------------------------------------------------------------------------- | -------------------------------- |
| **业务术语/范围/目标**       | 术语定义、范围边界、非目标、角色/权限                                                     | 标准版报告                       |
| **业务流程/状态机/生命周期** | 整体&子流程、状态与转换、版本兼容路径、异常/撤销/更正、增量/存量数据场景、批处理/定时任务 | 标准版报告                       |
| **业务规则**                 | 触发条件、优先级、时效、地域例外、唯一性/互斥                                             | 标准版报告                       |
| **数据要素（业务语义）**     | 字段含义/是否必填/业务来源/口径（非表结构）                                               | 标准版报告                       |
| **验收口径**                 | Given-When-Then、成功/失败判定、边界样例                                                  | 标准版报告                       |
| **业务监控KPI**              | 活跃、转化、完成率、拒绝率、黑名单命中等**业务指标**                                | 标准版报告                       |
| **技术实现细节**             | 性能/QPS/延迟、回滚/补偿、重试/幂等、DB/索引、迁移、埋点方案                              | 不进报告                         |
| **双栈问题**（业务+技术）    | 既涉及业务口径又含实现细节                                                                | **拆分**：业务部分进报告； |

> 执行阶段要做自动校验：若“技术关键词”内容出现在标准版草稿里，需要自动移除。

## 七、工作流阶段-总体流程

```
收集(Collect) → 研究（Research）→ 创新（Innovation）→ 执行（Execution）
```

为加快工作流执行速度的约束：

- 工作流各阶段，只需要在控制台打印各阶段进入时的阶段声明，不允许打印除阶段声明之外的信息，如思考过程或执行结论。
- 整个过程中，仅在收集阶段和执行阶段，需要创建文件。其他阶段不用创建文件。

## 八、工作流阶段-详述

### 阶段 1：收集(Collect)

**目标**：收集并落盘 PRD文档、需求预评审报告模板 至 inputs/。
**输出**：需求原文.xxx

**步骤**：

1. **检查feishu2md_fileLink MCP工具是否已配置**：

   * 已配置：若 mcp 配置文件("~/.cursor/mcp.json")中存在一个 url 为 ${feiShu2MdMcpLink} 的配置，则为已配置。否则为未配置
   * 未配置：若 mcp 配置文件中不存在此url，则为未配置。用户可能安装了其他的飞书MCP工具，但不存在此URL，此时也认为未配置。
   * 若未配置feishu2md_fileLink MCP工具，则提示用户自行阅读文档 ${feiShu2MdMcpDocLink} 来配置，并停止整个工作流

2.检查目录（${taskRoot}/${taskName}/inputs）是否已创建，若不存在则创建

3.确定需要落盘的目标文件列表：

* 需求预评审报告模板：若 ${prdReviewReportTemplateLink} 不为空，则需要落盘需求预评审报告模板
* PRD 文档：若 ${prdLink} 不为空，则需要落盘 PRD 文档

4.按照如下步骤落盘目标文件：

* **使用feishu2md_fileLink工具获取目标文件内容原文的文件下载链接**，将链接中的协议从https 改为 http，就得到最终的下载链接 fileDownloadLink
* 使用如下命令下载文件 至 inputs/需求原文.xxx。
  ```bash
  curl -o 需求原文.md  -v "${fileDownloadLink}"
  ```

### 阶段 2：研究（Research）

**入口条件**：已获取 PRD 原文；

**目标**：

1. 将 PRD 拆解为可验证的原子需求 Claim；
2. 为每项需求建立对应的 Evidence Anchor；
3. 生成 Clarification 问题清单；
4. 构建 Fact Baseline（事实基线）；
5. 提取关键术语并对齐上下文；
6. 扫描并发现需求气味问题。

**步骤**：

1. **PRD 原子化解析**：

   * **结构解构** ：根据 PRD 的标题层级和章节类型（如目标、范围、非目标、业务流程、业务规则、数据、边界、验收标准）对文档进行结构化拆解。
   * **句法切分** ：按句子或要点将上述内容进一步细分为原子级的需求项（采用主语-谓语-宾语 (SVO) 结构，并对动词谓语进行规范化）。
2. **Claim 生成与证据绑定**：

   * 为每条原子需求生成规范化的 Claim，并绑定相应的证据锚点（锚点信息包括章节标题、段落编号、页码或链接地址）。
   * Claim 数据结构包含以下标准字段：`id`、`text`、`anchor`、`certainty`（置信度等级：high/medium/low）和 `source_section`。
3. **自动一致性与约束校验**：

   - 目标/范围/非目标三者互斥校验；数量/单位一致性（例如并发上限、SLA 数值）。
   - MUST/SHOULD/MAY（RFC2119）用词一致性；时态与条件触发词（when/unless）完整性。
4. **需求气味扫描**（示例见附录 A）：

   - 模糊词（“快速、灵活、稳定、等”）、占位符（TBD/TBA/？）、未量化指标（“高”、“大量”、“超过”）。
   - 引用未定义对象（术语表缺失）、跨章节引用失配、图例/状态图缺席。
5. **术语与上下文对齐**：

   - 抽取所有**领域名词**与**状态词**；与现有术语表比对；输出 `glossary_gaps.md`（新增建议定义/同义词合并/冲突术语）。
6. **Clarification 生成与分级**：

   - 对证据不足或互斥的 Claims 生成澄清问题，打上 **P0/P1/P2**，并设定建议回答格式（可选项/数值域/样例）。
7. 功能点拆分：

   - 要求使用敏捷开发的思想来拆分史诗、用户故事地图等，要求使用 EARS 语法来描述用户故事
8. **Fact Baseline 汇总输出** ：

   - 汇总当前阶段的研究成果形成 `fact_baseline.json`（逻辑文件，无需真正生成），内容包括每个需求项的状态（`confirmed`/`blocked`/`inconclusive`）、证据锚点，以及术语映射关系。

**要点**：

- 数据要素只收业务语义（字段意义/是否业务必填/口径），不涉及表结构、索引、枚举编码实现。
- 异常/边界强调业务视角（例如“撤销是否允许部分金额？”），不讨论补偿/回滚实现策略。

**质量门禁（QG-R）**：

- 证据覆盖率 ≥95%；P0/P1 澄清完成率 =100%; 未达标则驳回到本阶段循环。

### 阶段3: 创新（Innovation）

**入口条件** ：已完成“研究 (Research)”阶段，生成了初步的证据基线和澄清问题。

目标：在**仅依赖 PRD 文档**的前提下，利用领域模式库和缺口分析方法，以发散思维识别出 PRD 中**可能存在缺失**的流程、生命周期、状态或业务规则。此阶段的所有结论都必须显式标注为**“推断”或“假设”**。

**方法**：

1. **领域模式库映射**（不引入外部事实，只用 PRD 中出现的名词）：

   - 将 PRD 抽取出的实体名词（如 订单/支付/商品/用户/订阅/内容/库存 等）映射到通用模式库（典型生命周期与状态机模板）。
   - 生成**覆盖矩阵**：`实体 × 关键状态 × 典型转换`，对照 PRD 是否出现说明；未出现者记为**缺口（Hypothesis）**。
2. **业务规则骨架检测**：

   - 针对定价/优惠、额度/配额、风控/合规模块，枚举**必备规则骨架**（触发条件、优先级、冲突消解、阈值、时效性、地域例外）。
   - PRD 未提及时，记录为**假设缺口**并提出**最小澄清问题**。
3. **场景穷举（边界/异常优先）**：考虑各类边界情况和异常场景，重点关注：

   * **时间边界** （如分布式时钟、日切、跨时区）。
   * **金额边界** （如舍入规则、不同币种）。
   * **并发边界** （如重复提交、请求幂等）。
   * **失败处理** （如撤单、退款、回滚）。
   * **撤销与更正路径** （操作撤销与数据更正流程）。
   * **合规/隐私** （合规要求和用户隐私条款提示）。
   * **数据处理** （增量数据更新、历史存量数据迁移或回填）。
4. **代码库分析（可选）**：如果提供了代码仓库，则针对 PRD 描述的功能点在代码库中进行验证分析：

   * 检查实现代码中是否存在流程、状态、生命周期或业务规则与 PRD 描述不符或缺失的情况。
   * 检查是否涉及增量数据更新、存量数据迁移，或需要定时任务（Job）处理、消息监听等机制。
   * 检查 PRD 是否遗漏了必要的监控指标定义。
5. **多方案并行与对比**：

   - 对于每个“疑似缺口”，给出**2~3 个解释方案**（例如状态是否合并/拆分），形成 `options_matrix.md`（维度：完整性、复杂度、对既有表述的兼容性、风险）。

**注意**：

- 本阶段发现的置信度为High的潜在业务影响（比如增量、存量场景流程缺失、遗漏、不全等），需要记录到评审报告中, 并注明推断或假设。

**质量门禁（QG-I）**：

* 所有提出的缺口都必须附有 **可追溯的触发依据** （即对应于 PRD 中的具体名词或句段）；
* 禁止出现与 PRD 中明确表述相冲突的“强断言”类型结论。

### 阶段4: 执行（Execution）

**入口条件** ：已完成前述“研究 (Research)”和“创新 (Innovation)”阶段，生成了相关的澄清问题和假设缺口分析结果。

**目标** ：生成《需求预评审报告》 和 《功能点报告》

输出：装配交付物：

* 《需求预评审报告》（文件名：`需求预评审报告.md`）：仅包含业务类问题；不提供任何解决建议；语气需保持委婉；不附带证据锚点。
* 《功能点报告》（文件名：`功能点报告.md`）：使用EARS 语法来描述用户故事，符合敏捷开发模式，包含所有功能点。

步骤：

1.根据基于之前阶段产出的成果 和《功能点报告》模板，生成最终的功能点报告

2.确定《需求预评审报告模板》

* 若收集阶段，已根据${prdReviewReportTemplateLink}落盘用户自定义的《需求预评审报告模板》，则使用该模板；否则使用默认模板，默认模板见后文。

3.填写《需求预评审报告》

* 基于之前阶段产出的成果，和 《需求预评审报告模板》 **组装并生成**最终的《需求预评审报告》，着重突出术语表缺失以及 PRD 中存在的业务问题或风险

自动路由检查 ：

* 若报告文本命中技术关键词（如 “QPS/回滚/重试/幂等/超时/表/索引/MQ/Job/迁移/埋点” 等），需要自动移除。

评审报告文档内容约束：

* 文档语气：语气柔和，不可出现“存在严重缺失”等容易让产品经理看了心情不好的字眼
* 报告中不得给出建议
* 报告文档的结构、标题层次需与模板完全一致，不得增加新的标题层次与新的标题
* 需求功能点概述，需要以表格形式展示
* 报告中问题澄清单中，只需要列出高价值、重要、高优先级的问题
* 报告中描述内容需要结构清晰，表述精炼简洁，易于阅读；
* 报告中对同一个问题，只能列到优先级最高的分类下，不可在多个分类下重复出现；
* 评审明细中多个问题以无序列表形式展示

**质量门禁（QG-I）**：

- 报告标准版已生成且仅含业务类分组；若不满足，则重新执行当前阶段。

## 九、模板

### 1.《需求预评审报告》模板

(1) 模板

```markdown
# 需求预评审报告

## 0. 基本信息
- PRD 名称/版本：{{report.meta.prd_name}} / {{report.meta.prd_version}}
- 预评审日期：{{report.meta.review_date}}
- 执行者：{{report.meta.reviewer}}

## 1. 结论摘要
{{report.summary}}

## 2. 需求功能点概览

| 功能模块 | 功能点名称 | 功能描述 |
|---------|-----------|---------|
{{#report.features}}
| {{moduleName}} | {{name}} | {{desc}} |
{{/report.features}}

## 3. Clarification 问题澄清单
| ID | 优先级 | 问题 | 期望回答格式 | 状态 |
|----|--------|------|---------------|------|
{{#report.clarifications}}
| {{id}} | {{priority}} | {{question}} | {{expected_format}} | {{status}} |
{{/report.clarifications}}

## 4. 评审明细

{{#report.details.p0}}
### {{category}}
{{#items}}
🟠 {{questionName}}
- **问题内容：** {{questionContent}}
- **原文出处：** {{evidence}}

{{/items}}
{{/report.details.p0}}

{{#report.details.p1}}
### {{category}}
{{#items}}
 🟡 {{questionName}}
- **问题内容：** {{questionContent}}
- **原文出处：** {{evidence}}

{{/items}}
{{/report.details.p1}}

{{#report.details.p2}}
### {{category}}
{{#items}}
🟢 {{questionName}}
- **问题内容：** {{questionContent}}
- **原文出处：** {{evidence}}

{{/items}}
{{/report.details.p2}}
```

（2）运行时（工作流会构建 context）：

```json
{
  "report": {
    "meta": {
      "prd_name":"需求名称",
      "prd_version":"需求版本号，格式: v1.0.0",
      "review_date":"预评审日期，格式: yyyy-MM-dd HH:mm",
      "reviewer":"评审人"
    },
    "summary":"评审摘要",
    "features":[{"id":"F1","moduleName":"功能模块名","name":"功能点名称","desc":"功能点描述"}],
    "clarifications":[
      {"id":"CLAR-P0-001","priority":"P0","question":"澄清问题内容","expected_format":"期望回答格式","status":"open"}
    ],
    "details":{"p0":[{"category":"评审明细分类", "questionName":"问题名称，精简的问题名称", "questionContent":"详细问题内容，也就是每一个具体的问题","evidence":"问题对应的原文出处; 格式为：章节路径 + 原文内容; 章节路劲[形如：一、第一章>2.第一节>a.第一部分，章节路径一定要全，不可他跳过] ， 原文内容[形如： '原文内容片段']; 章节路劲和原文内容都一定要有。" }],"p1":[],"p2":[]}
  }
}
```

（3）评审明细分类(category)：

|               分类名称 | 描述（判定依据）                                                                                                                                                                                                                                                                                                                                                                                                               |
| ---------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|  `P0 术语定义要清晰` | 文档中出现未定义或含糊的专有名词、身份、角色或关键概念；需要在 PRD 中给出精确定义与适用范围                                                                                                                                                                                                                                                                                                                                    |
|  `P0 业务流程需提供` | PRD 未给出整体业务流程、子功能业务流程、各业务流程对应的流程图                                                                                                                                                                                                                                                                                                                                                                 |
| ` P0 业务逻辑需完整` | PRD 未给出整体业务、子模块业务、边界业务、版本兼容的逻辑                                                                                                                                                                                                                                                                                                                                                                       |
|      P1 业务流程需准确 | 有分支的业务流程需要提供分支判断流程；需要避免矛盾的业务流程；业务流程和业务逻辑描述要匹配；                                                                                                                                                                                                                                                                                                                                   |
|      P1 业务逻辑需清晰 | 需要对业务逻辑进行准确描述，能准确表达业务逻辑，如：超过某个数量，需要明确告知超过是大于还是等于等于；<br />需要对对特殊业务逻辑进行清晰描述，如：非拉丁文下面无需特殊处理，需要解释原因；<br />需要对一些有多种含义的逻辑进行清晰描述，如：计算汇率的时候，需要告知使用哪种汇率；<br />业务逻辑提供的方案要唯一，如：使用外部数据，要明确是采用接口方案还是使用数据表方案；<br />需要对业务逻辑进行清晰描述，清晰表达业务逻辑 |
|      P1 外部依赖需明确 | 需要明确提供依赖的外部接口、接口接入文档；需要明确提供依赖的外部数据，并标明来源；                                                                                                                                                                                                                                                                                                                                             |
|  P2 外部依赖描述需清晰 | 对外部接口字段的使用逻辑、条件排除或错误处理未说明                                                                                                                                                                                                                                                                                                                                                                             |

### 2.《功能点报告》模板

功能点报告示例如下：

```markdown
# Rewards Sorting 功能点与用户故事拆分

**创建时间**: 2025-10-23
**PRD版本**: V1
**使用语法**: EARS (Easy Approach to Requirements Syntax)

---

## 📌 Epic 1: Rewards Sorting 查询页

### 功能点 1.1: 模块号搜索

#### 用户故事 1.1.1: 模糊搜索模块号
**作为** 运营人员  
**我想要** 通过模块号进行模糊搜索  
**以便于** 快速定位到需要编辑的模块配置

**EARS需求**:

````markdown
WHEN 运营人员在搜索框输入模块号关键字, 
THEN Rewards Sorting系统 shall 返回所有包含该关键字的模块号列表

WHEN 搜索框为空, 
THEN Rewards Sorting系统 shall 展示所有模块号，按照模块号创建时间从晚到早降序排列

```

**验收标准**:

- [ ] 支持输入部分模块号名称进行搜索
- [ ] 搜索结果实时展示
- [ ] 搜索结果按创建时间降序排列
- [ ] 空搜索时展示全部模块号

---

#### 用户故事 1.1.2: 重置搜索

**作为** 运营人员
**我想要** 清除当前搜索条件
**以便于** 重新查看所有模块号列表

**EARS需求**:

````markdown
WHEN 运营人员点击Reset按钮, 
THEN Rewards Sorting系统 shall 清空搜索输入框并展示所有模块号列表
````

**验收标准**:

- [ ] Reset按钮点击后清空搜索框
- [ ] 恢复显示所有模块号
- [ ] 按默认排序展示

---

```

## 十、附录

### 附录 A：需求气味词典（示例）

- 模糊：快速/高效/稳定/灵活/智能/友好/简单/无缝/大部分/通常/可能/尽量/显著/较多/较少/超过。
- 未量化：高可用/高并发/低延迟/可扩展/安全/可靠/易用（需转化为**量化指标**）。
- 占位：TBD/TBA/？/待定/后续补充/参见 XXX。
- 指代不明：它/该功能/上述/如下/本模块（需替换为**明确名词**）。

### 附录 B：术语表模板（片段）

```markdown
| 术语 | 定义 | 别名 | 适用范围 | 证据锚点 |
|------|------|------|----------|----------|

### 附录 C：Clarification 模板（片段）

```markdown
- ID：CLAR-P0-001
- 关联 Claim：C-023
- 问题：退款是否允许部分金额？是否存在优先级覆盖？
- 期望回答格式：选项 + 示例（允许/不允许；如允许，列出边界条件与审计要求）
- 证据锚点：PRD §4.2 撤销流程
- 优先级：P0
- 状态：open/resolved

```

### 附录 E：检测规则示例（可用于半自动扫描）

- 模糊词正则：`/(快速|灵活|稳定|高效|智能|友好|简单|大部分|通常|可能)/`。
- TBD 占位：`/(TBD|TBA|待定|\?)/`。
- RFC2119：`/(MUST|SHOULD|MAY|不得|必须|建议)/`。
- 数量单位：`/\b(\d+\.?\d*)\s*(ms|s|QPS|TPS|%|GB|MB)\b/`（缺失时提示量化）。
