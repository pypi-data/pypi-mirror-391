---
alwaysApply: true
title: "context entrance"
description: "workflow dispatcher and executor"
---

# Context Entrance

> **职责：路由 + 自动启动工作流**

本入口负责：

1. **识别命令并路由到对应工作流**
2. **自动加载工作流上下文和规则**
3. **启动工作流执行**

---

## 指令映射来源

指令映射定义在：`[commond.yaml](commond.yaml)`

---

## 执行流程

### 1. 命令识别与解析

- 从用户输入中提取 `command` 和 `mode`
- 解析命令类型：
  - **单命令**：直接映射到一个工作流（如 `req`、`tech`、`coding`）
  - **组合命令**：按顺序执行多个工作流（如 `dev`、`full`）
- 解析执行模式：
  - **auto**：自动模式，工作流各阶段自动连续执行
  - **manual**：手动模式（默认），每个阶段完成后暂停等待确认

### 2. 上下文加载

根据命令映射的 `contextEntrance` 字段：
- 读取工作流的 `context-map.yaml`
- 加载 `includes` 中定义的所有相关规则文件
- 排除 `excludes` 中定义的不相关内容

### 3. 工作流初始化

- 从用户输入中提取工作流所需参数（如 PRD 链接、文档链接等）
- 初始化工作流的动态变量（如 taskName、taskDateFmt、prdLink 等）
- 打印工作流启动信息和全局变量

### 4. 工作流执行

- **自动启动工作流的第一个阶段**
- 按照工作流定义的阶段顺序执行
- 在 auto 模式下：自动推进所有阶段直至完成
- 在 manual 模式下：每个阶段完成后等待用户确认再继续

### 5. 组合命令处理

对于组合命令（如 `dev`）：
- 按顺序执行工作流列表中的每个工作流
- 在 auto 模式下：前一个工作流完成后自动启动下一个
- 在 manual 模式下：前一个工作流完成后等待用户确认再启动下一个

---

## 行为规范

### ✅ 必须做的事

1. **准确识别命令**：从用户输入中提取 command 和 mode
2. **参数提取**：识别并提取用户输入中的所有参数（URL、文件路径等）
3. **加载上下文**：读取并应用工作流的 context-map.yaml 中定义的规则
4. **初始化变量**：根据当前时间、用户输入等初始化工作流全局变量
5. **启动执行**：自动进入工作流的第一个阶段并开始执行
6. **阶段声明**：每次响应的第一行声明当前阶段信息

### ❌ 禁止做的事

1. **不修改用户参数**：用户提供的链接、路径等参数必须原样使用
2. **不跳过阶段**：必须按工作流定义的阶段顺序执行
3. **不干涉工作流内部设计**：不改变工作流的阶段划分和执行逻辑
4. **不自作主张**：在 manual 模式下不能自动推进到下一阶段

---

## 阶段声明格式

每次响应的**第一行**必须使用以下格式声明当前状态：

```
[STAGE: ${stageName}] | [${workflowName}] | [${mode}]
```

示例：
```
[STAGE: Collect] | [PRD_Review_Workflow] | [Auto]
```

---

## 命令示例

### 单命令示例

```bash
# 需求评审（自动模式）
req auto https://trip.larkenterprise.com/wiki/xxx

# 技术方案设计（手动模式）
tech manual https://trip.larkenterprise.com/wiki/xxx

# 代码生成（自动模式）
coding auto https://trip.larkenterprise.com/wiki/xxx
```

### 组合命令示例

```bash
# 全流程开发（自动模式）：需求评审 → 技术设计 → 代码生成
dev auto https://trip.larkenterprise.com/wiki/xxx
```

---

## 一句话总结

> **入口负责识别命令、加载上下文、启动工作流执行。**
