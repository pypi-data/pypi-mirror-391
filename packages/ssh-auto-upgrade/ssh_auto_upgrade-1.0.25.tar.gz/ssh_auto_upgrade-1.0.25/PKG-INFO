Metadata-Version: 2.4
Name: ssh-auto-upgrade
Version: 1.0.25
Summary: è‡ªåŠ¨æ£€æµ‹å’Œå‡çº§OpenSSHçš„å·¥å…·
Author-email: åå…¬äº¤ä¹Ÿç”¨åˆ¸ <liumou.site@qq.com>
License: MIT
Project-URL: Homepage, https://gitee.com/liumou_site/ssh-automatic-upgrade
Project-URL: Repository, https://gitee.com/liumou_site/ssh-automatic-upgrade
Project-URL: Bug Reports, https://gitee.com/liumou_site/ssh-automatic-upgrade/issues
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: System Administrators
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: POSIX :: Linux
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.6
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Classifier: Programming Language :: Python :: 3.14
Classifier: Topic :: System :: Systems Administration
Requires-Python: >=3.6
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: requests>=2.25.0
Requires-Dist: beautifulsoup4>=4.9.0
Requires-Dist: systemd-python>=234
Requires-Dist: dbus-python>=1.2.0
Requires-Dist: plpm-liumou-stable>=1.0.1
Requires-Dist: paramiko>=4.0.0
Dynamic: license-file

# SSHè‡ªåŠ¨å‡çº§å·¥å…·

> ä¸€ä¸ªä¸“ä¸šçš„OpenSSHè‡ªåŠ¨æ£€æµ‹å’Œå‡çº§å·¥å…·ï¼Œæ”¯æŒå®ˆæŠ¤è¿›ç¨‹æ¨¡å¼å’ŒsystemdæœåŠ¡ç®¡ç†

[![Python Version](https://img.shields.io/badge/python-3.6%2B-blue)](https://www.python.org/)

[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-Linux-lightgrey)](https://www.linux.org/)

- **é¡¹ç›®åœ°å€**: <https://gitee.com/liumou_site/ssh-automatic-upgrade>
- **PyPIåœ°å€**: <https://pypi.org/project/ssh-auto-upgrade>
- **æœ€æ–°ç‰ˆæœ¬**: ![PyPI](https://img.shields.io/pypi/v/ssh-auto-upgrade)
- **ä¸‹è½½é‡**: ![PyPI - Downloads](https://img.shields.io/pypi/dm/ssh-auto-upgrade?style=flat-square)

## ğŸ“– é¡¹ç›®ç®€ä»‹

SSHè‡ªåŠ¨å‡çº§å·¥å…·æ˜¯ä¸€ä¸ªä¸“ä¸ºLinuxç³»ç»Ÿç®¡ç†å‘˜è®¾è®¡çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹OpenSSHæœ€æ–°ç‰ˆæœ¬ã€ä¸‹è½½æºç ã€ç¼–è¯‘å®‰è£…ï¼Œå¹¶æ”¯æŒæ³¨å†Œä¸ºsystemdå®ˆæŠ¤è¿›ç¨‹æœåŠ¡ã€‚å·¥å…·é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œç¨³å®šæ€§ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ” **æ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹** - è‡ªåŠ¨ä»OpenSSHå®˜æ–¹æºæ£€æµ‹æœ€æ–°ç‰ˆæœ¬
- ğŸ“¥ **å¯é ä¸‹è½½æœºåˆ¶** - æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€è¿›åº¦æ˜¾ç¤ºå’Œæ–‡ä»¶å®Œæ•´æ€§éªŒè¯
- ğŸ›¡ï¸ **å®‰å…¨å®‰è£…æµç¨‹** - åŒ…å«å®‰è£…å‰éªŒè¯ã€å›æ»šæœºåˆ¶å’Œé”™è¯¯å¤„ç†
- ğŸ”§ **ç³»ç»ŸæœåŠ¡ç®¡ç†** - æ”¯æŒsystemdæœåŠ¡æ³¨å†Œã€å¯åŠ¨ã€åœæ­¢å’Œç®¡ç†
- ğŸ“‹ **ä¾èµ–è‡ªåŠ¨ç®¡ç†** - æ™ºèƒ½æ£€æµ‹å’Œå®‰è£…ç¼–è¯‘æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–
- ğŸ“Š **è¯¦ç»†æ—¥å¿—è®°å½•** - å®Œæ•´çš„å®‰è£…è¿‡ç¨‹æ—¥å¿—å’ŒçŠ¶æ€ç›‘æ§
- ğŸ”„ **å¾ªç¯æ—¥å¿—ç³»ç»Ÿ** - æ™ºèƒ½æ—¥å¿—æ–‡ä»¶è½®è½¬ï¼Œé˜²æ­¢ç£ç›˜ç©ºé—´è€—å°½
- ğŸ¯ **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„ä»£ç ç»“æ„ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- âš¡ **æ™ºèƒ½æ£€æµ‹æœºåˆ¶** - å¤šç»´åº¦ç³»ç»ŸçŠ¶æ€æ£€æµ‹å’ŒéªŒè¯
- ğŸ›¡ï¸ **å‚æ•°éªŒè¯ç³»ç»Ÿ** - å®Œå–„çš„è¾“å…¥éªŒè¯å’Œå®‰å…¨æ£€æŸ¥

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```bash
ssh_auto_upgrade/
â”œâ”€â”€ ğŸ“ src/ssh_auto_upgrade/
â”‚   â”œâ”€â”€ ğŸš€ main.py                    # ä¸»ç¨‹åºå…¥å£ï¼Œå®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
â”‚   â”œâ”€â”€ ğŸ” version_detector.py         # ç‰ˆæœ¬æ£€æµ‹æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“¥ downloader.py              # ä¸‹è½½å™¨æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ› ï¸ installer.py               # å®‰è£…å™¨æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ âš™ï¸ installer_service_manager.py # å®‰è£…å™¨æœåŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ“ installer_file_manager.py   # å®‰è£…å™¨æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ”§ service_manager.py          # systemdæœåŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ“‹ dependencies.py            # ä¾èµ–ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“ dependency_constants.py     # ä¾èµ–å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ ğŸ“Š logger.py                   # æ—¥å¿—è®°å½•æ¨¡å—ï¼ˆæ”¯æŒå¾ªç¯æ—¥å¿—ï¼‰
â”‚   â”œâ”€â”€ ğŸ”¨ compile.py                  # ä¼ ç»Ÿç¼–è¯‘è„šæœ¬ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ ğŸ§¹ legacy_cleaner.py         # é—ç•™æ–‡ä»¶æ¸…ç†æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ” mirror_checker.py          # é•œåƒæºæ£€æŸ¥æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ” service_detector.py         # æœåŠ¡æ£€æµ‹æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ” systemd_checker.py          # systemdæ£€æŸ¥æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ” time_checker.py            # æ—¶é—´æ£€æŸ¥æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ” installer_service_detector.py # å®‰è£…å™¨æœåŠ¡æ£€æµ‹
â”‚   â”œâ”€â”€ âš™ï¸ ssh_config_manager.py       # SSHé…ç½®ç®¡ç†
â”‚   â””â”€â”€ âœ… argument_validator.py       # å‚æ•°éªŒè¯æ¨¡å—
â”œâ”€â”€ ğŸ“„ pyproject.toml                  # é¡¹ç›®é…ç½®å’Œæ‰“åŒ…ä¿¡æ¯
â”œâ”€â”€ ğŸ“„ requirements.txt               # Pythonä¾èµ–åˆ—è¡¨
â””â”€â”€ ğŸ“„ setup.py                       # ä¼ ç»Ÿæ‰“åŒ…é…ç½®
```

### ğŸ”„ å·¥ä½œæµç¨‹

#### å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼å®Œæ•´æµç¨‹

```mermaid
graph TD
    A[å¯åŠ¨ç¨‹åº] --> B[æƒé™æ£€æŸ¥]
    B --> C[å‚æ•°éªŒè¯]
    C --> D[systemdæ£€æŸ¥]
    D --> E[é•œåƒæºæ£€æµ‹]
    E --> F[ä¾èµ–æ£€æŸ¥]
    F --> G{æœåŠ¡æ³¨å†Œæ¨¡å¼?}
    G -->|æ˜¯| H[æ³¨å†ŒsystemdæœåŠ¡]
    G -->|å¦| I[è¿›å…¥å®ˆæŠ¤å¾ªç¯]
    H --> J[é€€å‡ºç¨‹åº]
    I --> K[æ—¶é—´æ®µæ£€æŸ¥]
    K -->|åœ¨æ—¶é—´æ®µå†…| L[ç‰ˆæœ¬æ£€æµ‹]
    K -->|ä¸åœ¨æ—¶é—´æ®µå†…| M[ç­‰å¾…1å°æ—¶]
    L --> N{éœ€è¦å‡çº§?}
    N -->|æ˜¯| O[åœæ­¢SSHæœåŠ¡]
    N -->|å¦| M
    O --> P[ä¸‹è½½æºç ]
    P --> Q[ç¼–è¯‘å®‰è£…]
    Q --> R[éªŒè¯å®‰è£…]
    R --> S[é‡å¯æœåŠ¡]
    S --> T[é…ç½®rootç™»å½•]
    T --> M
    M --> I
```

1. **ç³»ç»Ÿåˆå§‹åŒ–æ£€æŸ¥**
   - **æƒé™éªŒè¯** â†’ æ£€æŸ¥rootæƒé™ï¼ˆå¿…éœ€ï¼‰
   - **å‚æ•°éªŒè¯** â†’ éªŒè¯å‘½ä»¤è¡Œå‚æ•°æ ¼å¼å’Œç»„åˆ
   - **systemdæ£€æŸ¥** â†’ ç¡®ä¿ç³»ç»Ÿæ”¯æŒsystemd
   - **é•œåƒæºæ£€æµ‹** â†’ éªŒè¯OpenSSHé•œåƒæºå¯ç”¨æ€§

2. **ä¾èµ–ç¯å¢ƒå‡†å¤‡**
   - **ç¼–è¯‘ä¾èµ–æ£€æŸ¥** â†’ æ£€æµ‹gccã€makeã€autoconfç­‰ç¼–è¯‘å·¥å…·
   - **è‡ªåŠ¨å®‰è£…ç¼ºå¤±ä¾èµ–** â†’ ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…
   - **ä¾èµ–éªŒè¯** â†’ ç¡®ä¿æ‰€æœ‰ç¼–è¯‘ç¯å¢ƒå°±ç»ª

3. **æœåŠ¡æ³¨å†Œæ¨¡å¼**ï¼ˆå¦‚æœæŒ‡å®š--serviceå‚æ•°ï¼‰
   - **systemdæœåŠ¡åˆ›å»º** â†’ ç”ŸæˆsystemdæœåŠ¡å•å…ƒæ–‡ä»¶
   - **æœåŠ¡æ³¨å†Œ** â†’ æ³¨å†Œåˆ°systemdå¹¶è®¾ç½®å¼€æœºè‡ªå¯
   - **æœåŠ¡é…ç½®** â†’ é…ç½®æœåŠ¡å‚æ•°å’Œå·¥ä½œç›®å½•

4. **å®ˆæŠ¤è¿›ç¨‹ä¸»å¾ªç¯**ï¼ˆéæœåŠ¡æ³¨å†Œæ¨¡å¼ï¼‰
   - **æ—¶é—´æ®µæ£€æŸ¥** â†’ éªŒè¯å½“å‰æ—¶é—´æ˜¯å¦åœ¨å…è®¸å‡çº§çš„æ—¶é—´æ®µ
   - **ç‰ˆæœ¬æ£€æµ‹** â†’ æ£€æŸ¥å½“å‰OpenSSHç‰ˆæœ¬å’Œæœ€æ–°å¯ç”¨ç‰ˆæœ¬
   - **å‡çº§å†³ç­–** â†’ æ ¹æ®ç‰ˆæœ¬å¯¹æ¯”å’Œforceå‚æ•°å†³å®šæ˜¯å¦å‡çº§

5. **OpenSSHå‡çº§æµç¨‹**ï¼ˆå½“éœ€è¦å‡çº§æ—¶ï¼‰
   - **æœåŠ¡åœæ­¢** â†’ åœæ­¢SSHå®ˆæŠ¤æœåŠ¡ï¼ˆCLSã€xc-sshç­‰ï¼‰
   - **åŸç”ŸæœåŠ¡ç¦ç”¨** â†’ ç¦ç”¨ç³»ç»ŸåŸç”ŸSSHæœåŠ¡é¿å…ç«¯å£å†²çª
   - **æºç ä¸‹è½½** â†’ ä»é•œåƒæºä¸‹è½½OpenSSHæºç åŒ…
   - **ç¼–è¯‘å®‰è£…** â†’ é…ç½®ã€ç¼–è¯‘å¹¶å®‰è£…åˆ°æŒ‡å®šç›®å½•
   - **å®‰è£…éªŒè¯** â†’ éªŒè¯æ–°ç‰ˆæœ¬å®‰è£…æ˜¯å¦æˆåŠŸ
   - **æœåŠ¡é‡å¯** â†’ é‡æ–°å¯åŠ¨SSHæœåŠ¡å’Œå®ˆæŠ¤æœåŠ¡
   - **é…ç½®æ›´æ–°** â†’ æ ¹æ®å‚æ•°è®¾ç½®rootç™»å½•æƒé™
   - **é—ç•™æ¸…ç†** â†’ æ¸…ç†æ—§ç‰ˆæœ¬æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬

6. **å¾ªç¯ç­‰å¾…**
   - **æ—¶é—´æ£€æŸ¥** â†’ æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦åœ¨å‡çº§æ—¶é—´æ®µ
   - **æ—¥å¿—è®°å½•** â†’ è®°å½•æ‰€æœ‰æ“ä½œå’ŒçŠ¶æ€å˜åŒ–
   - **å¼‚å¸¸å¤„ç†** â†’ å¤„ç†ç½‘ç»œã€æƒé™ã€ä¾èµ–ç­‰å¼‚å¸¸æƒ…å†µ

#### ğŸ” å·¥ä½œæµç¨‹å…³é”®æ”¹è¿›

**ç›¸æ¯”ä¼ ç»Ÿå‡çº§å·¥å…·çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š**

1. **æ™ºèƒ½æ—¶é—´æ§åˆ¶**
   - æ”¯æŒæ—¶é—´æ®µé™åˆ¶ï¼ˆ`--start-time` å’Œ `--end-time`ï¼‰
   - é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸè¿›è¡Œå‡çº§æ“ä½œ
   - æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿åœ¨å®‰å…¨æ—¶é—´æ®µå†…æ‰§è¡Œ

2. **æœåŠ¡å…¼å®¹æ€§å¤„ç†**
   - è‡ªåŠ¨æ£€æµ‹å¹¶åœæ­¢CLSã€xc-sshç­‰SSHå®ˆæŠ¤æœåŠ¡
   - æ™ºèƒ½ç¦ç”¨ç³»ç»ŸåŸç”ŸSSHæœåŠ¡é¿å…ç«¯å£å†²çª
   - å‡çº§å®Œæˆåè‡ªåŠ¨æ¢å¤æ‰€æœ‰æœåŠ¡

3. **å¼‚å¸¸å®‰å…¨æœºåˆ¶**
   - å®Œæ•´çš„ä¾èµ–æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
   - å®‰è£…å¤±è´¥è‡ªåŠ¨å›æ»šæœºåˆ¶
   - æœåŠ¡çŠ¶æ€éªŒè¯ç¡®ä¿å‡çº§æˆåŠŸ
   - å¾ªç¯æ—¥å¿—ç³»ç»Ÿé˜²æ­¢ç£ç›˜ç©ºé—´è€—å°½

4. **å‚æ•°éªŒè¯ç³»ç»Ÿ**
   - ä¸¥æ ¼çš„å‘½ä»¤è¡Œå‚æ•°æ ¼å¼éªŒè¯
   - å‚æ•°ç»„åˆé€»è¾‘æ£€æŸ¥
   - å‹å¥½çš„é”™è¯¯æç¤ºä¿¡æ¯

5. **é•œåƒæºæ™ºèƒ½æ£€æµ‹**
   - è‡ªåŠ¨æ£€æµ‹é˜¿é‡Œäº‘é•œåƒæºå¯ç”¨æ€§
   - æ”¯æŒç‰ˆæœ¬å·è§£æå’Œæ’åº
   - ç½‘ç»œå¼‚å¸¸é‡è¯•æœºåˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿä¾èµ–å®‰è£…

åœ¨å®‰è£…PythonåŒ…ä¹‹å‰ï¼Œè¯·ç¡®ä¿ç³»ç»Ÿå·²å®‰è£…å¿…è¦çš„ç¼–è¯‘ä¾èµ–ï¼š

```bash
# Ubuntu/Debian ç³»ç»Ÿ
sudo apt update
sudo apt install libsystemd-dev libdbus-1-dev libglib2.0-dev pkg-config

# CentOS/RHELç³»ç»Ÿ  
sudo yum install systemd-devel dbus-devel glib2-devel pkgconfig

# æˆ–è€…ä½¿ç”¨ dnf (CentOS 8+/RHEL 8+)
sudo dnf install systemd-devel dbus-devel glib2-devel pkgconfig
```

### æ–¹æ³•ä¸€ï¼šé€šè¿‡PyPIå®‰è£…ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨pip3å¹¶æ·»åŠ æ¸…åå¤§å­¦é•œåƒæºåŠ é€Ÿå®‰è£…
pip3 install ssh-auto-upgrade -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### æ–¹æ³•äºŒï¼šå¼€å‘æ¨¡å¼å®‰è£…ï¼ˆä»æºç å®‰è£…ï¼‰

```bash
# å¼€å‘æ¨¡å¼å®‰è£…ï¼Œä¾¿äºä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨æ¸…åå¤§å­¦é•œåƒæº
pip3 install -e . -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬

```bash
# ä½¿ç”¨æ¸…åå¤§å­¦é•œåƒæºå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
pip3 install --upgrade ssh-auto-upgrade -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### å¸è½½å·¥å…·

```bash
pip3 uninstall ssh-auto-upgrade
```

## âš™ï¸ ä½¿ç”¨è¯´æ˜

### å‘½ä»¤è¡Œå‚æ•°

```bash
# æŸ¥çœ‹æ‰€æœ‰é€‰é¡¹
ssh-auto-upgrade --help

# åŸºæœ¬ç”¨æ³•ç¤ºä¾‹
ssh-auto-upgrade

# è‡ªå®šä¹‰é•œåƒæº
ssh-auto-upgrade --mirror https://mirrors.aliyun.com/openssh/portable/

# è‡ªå®šä¹‰å®‰è£…ç›®å½•
ssh-auto-upgrade --install-dir /usr/local/openssh

# è‡ªå®šä¹‰ä¸‹è½½ç›®å½•
ssh-auto-upgrade --download-dir /tmp/ssh-upgrade

# è‡ªå®šä¹‰æ—¥å¿—ç›®å½•
ssh-auto-upgrade --log-dir /var/log/ssh-auto-upgrade

# å¼ºåˆ¶å‡çº§ï¼ˆå³ä½¿ç‰ˆæœ¬ç›¸åŒä¹Ÿæ‰§è¡Œå®‰è£…ï¼‰
ssh-auto-upgrade --force

# æ³¨å†Œä¸ºsystemdæœåŠ¡ï¼ˆéœ€è¦rootæƒé™ï¼‰
ssh-auto-upgrade --service

# è®¾ç½®å‡çº§æ—¶é—´æ®µï¼ˆé»˜è®¤00:00:00-08:00:00ï¼‰
ssh-auto-upgrade --upgrade-time 00:00:00-08:00:00

# è®¾ç½®è·¨å¤©æ—¶é—´æ®µ
ssh-auto-upgrade --upgrade-time 22:00:00-06:00:00

# æ™ºèƒ½æ£€æµ‹rootç™»å½•é…ç½®ï¼ˆé»˜è®¤ï¼‰
ssh-auto-upgrade --root-login auto

# å¼ºåˆ¶å¯ç”¨rootç™»å½•
ssh-auto-upgrade --root-login yes

# å¼ºåˆ¶ç¦ç”¨rootç™»å½•
ssh-auto-upgrade --root-login no

# ä½¿ç”¨ç®€åŒ–å‚æ•°è®¾ç½®rootç™»å½•
ssh-auto-upgrade -rl yes
ssh-auto-upgrade -rl no

# ç»„åˆä½¿ç”¨ç¤ºä¾‹
ssh-auto-upgrade --force --upgrade-time 00:00:00-08:00:00 --root-login yes
ssh-auto-upgrade --service --mirror https://mirrors.aliyun.com/openssh/portable/ -rl no
```

### å‚æ•°è¯´æ˜

| å‚æ•° | çŸ­å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| `--mirror` | `-m` | `https://mirrors.aliyun.com/openssh/portable/` | OpenSSHé•œåƒæºURL |
| `--install-dir` | `-i` | `/usr/local/openssh` | OpenSSHå®‰è£…ç›®å½• |
| `--download-dir` | `-d` | `/tmp/ssh-upgrade` | ä¸‹è½½ç›®å½• |
| `--log-dir` | `-l` | `/var/log/ssh-auto-upgrade` | æ—¥å¿—ç›®å½• |
| `--force` | `-f` | `false` | å¼ºåˆ¶å‡çº§ï¼Œå³ä½¿ç‰ˆæœ¬ç›¸åŒä¹Ÿæ‰§è¡Œå®‰è£… |
| `--service` | æ—  | `false` | æ³¨å†Œä¸ºsystemdæœåŠ¡ |
| `--upgrade-time` | `-t` | `00:00:00-08:00:00` | å‡çº§æ—¶é—´æ®µï¼Œæ ¼å¼ä¸º HH:MM:SS-HH:MM:SS |
| `--root-login` | `-rl` | `auto` | rootç™»å½•é…ç½®ï¼šauto(æ™ºèƒ½æ£€æµ‹), yes(å¯ç”¨), no(ç¦ç”¨) |

### systemdæœåŠ¡ç®¡ç†

#### æ³¨å†Œä¸ºsystemdæœåŠ¡

```bash
sudo ssh-auto-upgrade --service
```

#### âš ï¸ é‡è¦è¯´æ˜ï¼šå‡çº§æœŸé—´æœåŠ¡ç®¡ç†

**å‡çº§æœŸé—´éœ€è¦åœæ­¢çš„æœåŠ¡ï¼š**

- **CLSæœåŠ¡** - ä¸»è¦çš„SSHå®ˆæŠ¤è¿›ç¨‹æœåŠ¡
- **xc-ssh.service** - å±äºSSHå®ˆæŠ¤çš„è¾…åŠ©æœåŠ¡

**æœåŠ¡åœæ­¢æµç¨‹ï¼š**

1. å‡çº§å‰è‡ªåŠ¨æ£€æŸ¥å¹¶åœæ­¢ä¸Šè¿°ä¸¤ä¸ªæœåŠ¡
2. å‡çº§å®Œæˆåè‡ªåŠ¨é‡æ–°å¯åŠ¨æœåŠ¡
3. å¦‚æœæœåŠ¡ä¸å­˜åœ¨ï¼Œä¼šè¾“å‡ºæç¤ºä¿¡æ¯å¹¶ç»§ç»­æ‰§è¡Œ

**å†²çªæœåŠ¡å¤„ç†å»ºè®®ï¼š**

- å¦‚æœæœ‰å…¶ä»–ä¸SSHç›¸å…³çš„æœåŠ¡å­˜åœ¨å†²çªï¼Œå»ºè®®ï¼š
  - **ä¿®æ”¹æœåŠ¡åç§°** - é¿å…ä¸SSHå®ˆæŠ¤æœåŠ¡å†²çª
  - **ä½¿ç”¨ä¸åŒç«¯å£** - é…ç½®ä¸åŒçš„ç›‘å¬ç«¯å£
  - **ä¸è¦ä½¿ç”¨æœ¬å·¥å…·** - å¦‚æœå­˜åœ¨æ— æ³•è§£å†³çš„å†²çª

**å®‰å…¨ç‰¹æ€§ï¼š**

- è‡ªåŠ¨æ£€æŸ¥æœåŠ¡å­˜åœ¨æ€§ï¼Œé¿å…æ“ä½œä¸å­˜åœ¨çš„æœåŠ¡
- æœåŠ¡åœæ­¢å¤±è´¥ä¸ä¼šå½±å“ä¸»è¦å‡çº§æµç¨‹
- æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### å®‰è£…ä½¿ç”¨æ•ˆæœ

```shell
[root@ecs ~]# pip3 install ssh-auto-upgrade -i https://pypi.tuna.tsinghua.edu.cn/simple/
Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple/
Collecting ssh-auto-upgrade
  Using cached https://pypi.tuna.tsinghua.edu.cn/packages/76/5a/0058bc6b79ff1f35dfcdc00de7d2d61636de768da4225c3601c1db20c4e8/ssh_auto_upgrade-1.0.21-py3-none-any.whl (61 kB)
Collecting requests>=2.25.0
  Using cached https://pypi.tuna.tsinghua.edu.cn/packages/70/8e/0e2d847013cb52cd35b38c009bb167a1a26b2ce6cd6965bf26b47bc0bf44/requests-2.31.0-py3-none-any.whl (62 kB)
Requirement already satisfied: systemd-python>=234 in /usr/lib64/python3.7/site-packages (from ssh-auto-upgrade) (234)
Collecting beautifulsoup4>=4.9.0
  Using cached https://pypi.tuna.tsinghua.edu.cn/packages/94/fe/3aed5d0be4d404d12d36ab97e2f1791424d9ca39c2f754a6285d59a3b01d/beautifulsoup4-4.14.2-py3-none-any.whl (106 kB)
Collecting dbus-python>=1.2.0
  Using cached https://pypi.tuna.tsinghua.edu.cn/packages/ff/24/63118050c7dd7be04b1ccd60eab53fef00abe844442e1b6dec92dae505d6/dbus-python-1.4.0.tar.gz (232 kB)
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
    Preparing wheel metadata ... done
Collecting plpm-liumou-stable>=1.0.1
  Downloading https://pypi.tuna.tsinghua.edu.cn/packages/58/a3/b83da7d015409f17ad35396122f360ea640de77bceced807efa93b196195/plpm_liumou_stable-1.0.2-py3-none-any.whl (29 kB)
Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/lib/python3.7/site-packages (from requests>=2.25.0->ssh-auto-upgrade) (1.24.3)
Collecting certifi>=2017.4.17
  Downloading https://pypi.tuna.tsinghua.edu.cn/packages/e4/37/af0d2ef3967ac0d6113837b44a4f0bfe1328c2b9763bd5b1744520e5cfed/certifi-2025.10.5-py3-none-any.whl (163 kB)
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 163 kB 796 kB/s 
Collecting charset-normalizer<4,>=2
  Downloading https://pypi.tuna.tsinghua.edu.cn/packages/0a/4c/925909008ed5a988ccbb72dcc897407e5d6d3bd72410d69e051fc0c14647/charset_normalizer-3.4.4-py3-none-any.whl (53 kB)
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 53 kB 2.6 MB/s 
Requirement already satisfied: idna<4,>=2.5 in /usr/lib/python3.7/site-packages (from requests>=2.25.0->ssh-auto-upgrade) (2.8)
Collecting soupsieve>1.2
  Downloading https://pypi.tuna.tsinghua.edu.cn/packages/49/37/673d6490efc51ec46d198c75903d99de59baffdd47aea3d071b80a9e4e89/soupsieve-2.4.1-py3-none-any.whl (36 kB)
Collecting typing-extensions>=4.0.0
  Using cached https://pypi.tuna.tsinghua.edu.cn/packages/ec/6b/63cc3df74987c36fe26157ee12e09e8f9db4de771e0f3404263117e75b95/typing_extensions-4.7.1-py3-none-any.whl (33 kB)
Building wheels for collected packages: dbus-python
  Building wheel for dbus-python (PEP 517) ... done
  Created wheel for dbus-python: filename=dbus_python-1.4.0-cp37-cp37m-linux_aarch64.whl size=127550 sha256=a2282c2e21565b51d59f983b9d70bf7ea795c6f8c9b6f35086b8e1a15c392549
  Stored in directory: /root/.cache/pip/wheels/3a/74/b0/4bad641f2016f4157e1fb2d2f217945f745c493ee4f2ef5277
Successfully built dbus-python
ERROR: docker-compose 1.22.0 has requirement requests!=2.11.0,!=2.12.2,!=2.18.0,<2.22,>=2.6.1, but you'll have requests 2.31.0 which is incompatible.
Installing collected packages: certifi, charset-normalizer, requests, soupsieve, typing-extensions, beautifulsoup4, dbus-python, plpm-liumou-stable, ssh-auto-upgrade
  Attempting uninstall: requests
    Found existing installation: requests 2.21.0
    Uninstalling requests-2.21.0:
      Successfully uninstalled requests-2.21.0
Successfully installed beautifulsoup4-4.14.2 certifi-2025.10.5 charset-normalizer-3.4.4 dbus-python-1.4.0 plpm-liumou-stable-1.0.2 requests-2.31.0 soupsieve-2.4.1 ssh-auto-upgrade-1.0.21 typing-extensions-4.7.1
[root@ecs ~]# ssh-auto-upgrade -h
usage: ssh-auto-upgrade [-h] [--mirror MIRROR] [--install-dir INSTALL_DIR]
                        [--download-dir DOWNLOAD_DIR] [--log-dir LOG_DIR]
                        [--force] [--service] [--upgrade-time UPGRADE_TIME]
                        [--root-login {auto,yes,no}] [--check-interval [1-48]]

OpenSSHè‡ªåŠ¨å‡çº§å®ˆæŠ¤è¿›ç¨‹å·¥å…·-V1.0.21

optional arguments:
  -h, --help            show this help message and exit
  --mirror MIRROR, -m MIRROR
                        OpenSSHé•œåƒæºURL
  --install-dir INSTALL_DIR, -i INSTALL_DIR
                        OpenSSHå®‰è£…ç›®å½•
  --download-dir DOWNLOAD_DIR, -d DOWNLOAD_DIR
                        ä¸‹è½½ç›®å½•
  --log-dir LOG_DIR, -l LOG_DIR
                        æ—¥å¿—ç›®å½•
  --force, -f           å¼ºåˆ¶å‡çº§ï¼Œå³ä½¿ç‰ˆæœ¬ç›¸åŒä¹Ÿæ‰§è¡Œå®‰è£…
  --service, -s         æ³¨å†Œä¸ºsystemdæœåŠ¡
  --upgrade-time UPGRADE_TIME, -t UPGRADE_TIME
                        å‡çº§æ—¶é—´æ®µï¼Œæ ¼å¼ä¸º HH:MM:SS-HH:MM:SSï¼Œé»˜è®¤00:00:00-08:00:00
  --root-login {auto,yes,no}
                        å‡çº§årootç™»å½•é…ç½®: auto(æ™ºèƒ½æ£€æµ‹å½“å‰é…ç½®ï¼Œé»˜è®¤), yes(å¯ç”¨), no(ç¦ç”¨)
  --check-interval [1-48]
                        æ£€æµ‹é—´éš”æ—¶é—´ï¼Œå•ä½å°æ—¶ï¼Œé»˜è®¤1ï¼Œæœ€ä½1ï¼Œæœ€å¤§48
[root@ecs ~]# ssh-auto-upgrade -s
2025-10-30 09:41:39 - ssh_auto_upgrade - INFO - [main.py:84] main() - æ£€æµ‹åˆ°å½“å‰rootç™»å½•é…ç½®: ç¦ç”¨
2025-10-30 09:41:39 - ssh_auto_upgrade - INFO - [main.py:85] main() - é»˜è®¤è®¾ç½®ä¸º: --root-login no
2025-10-30 09:41:39 - ssh_auto_upgrade - INFO - [main.py:86] main() - å¯é€šè¿‡ --root-login yes/no å‚æ•°å¼ºåˆ¶è®¾ç½®
2025-10-30 09:41:39 - ssh_auto_upgrade - INFO - [main.py:89] main() - æ£€æŸ¥é•œåƒåœ°å€å¯ç”¨æ€§
2025-10-30 09:41:39 - ssh_auto_upgrade.mirror_checker - INFO - [mirror_checker.py:47] check_mirror_availability() - å¼€å§‹æ£€æµ‹é•œåƒåœ°å€å¯ç”¨æ€§: https://mirrors.aliyun.com/openssh/portable/
2025-10-30 09:41:39 - ssh_auto_upgrade.mirror_checker - INFO - [mirror_checker.py:67] check_mirror_availability() - âœ“ é•œåƒåœ°å€å¯ç”¨: https://mirrors.aliyun.com/openssh/portable/
2025-10-30 09:41:39 - ssh_auto_upgrade - INFO - [main.py:100] main() - é•œåƒåœ°å€æ£€æµ‹é€šè¿‡
2025-10-30 09:41:39 - ssh_auto_upgrade - INFO - [main.py:103] main() - æ£€æŸ¥ç¼–è¯‘ä¾èµ–
2025-10-30 09:41:39 - ssh_auto_upgrade.dependencies - INFO - [dependencies.py:44] _init_modules() - plpmæ¨¡å—å·²æˆåŠŸåŠ è½½
2025-10-30 09:41:39 - ssh_auto_upgrade.dependencies - INFO - [dependencies.py:280] ensure_dependencies() - æ£€æŸ¥ç¼–è¯‘ä¾èµ–...
2025-10-30 09:41:39 - ssh_auto_upgrade.dependencies - INFO - [dependencies.py:281] ensure_dependencies() - æ£€æµ‹åˆ°ç³»ç»Ÿ: kylin
2025-10-30 09:41:39 - ssh_auto_upgrade.dependencies - INFO - [dependencies.py:282] ensure_dependencies() - æ£€æµ‹åˆ°åŒ…ç®¡ç†å™¨: yum
2025-10-30 09:41:40 - ssh_auto_upgrade.dependencies - INFO - [dependencies.py:288] ensure_dependencies() - âœ“ æ‰€æœ‰ç¼–è¯‘ä¾èµ–å·²å®‰è£…
2025-10-30 09:41:40 - ssh_auto_upgrade - INFO - [main.py:116] main() - ç¼–è¯‘ä¾èµ–æ£€æŸ¥é€šè¿‡
2025-10-30 09:41:40 - ssh_auto_upgrade - INFO - [service_registrar.py:27] register_service() - æ­£åœ¨æ³¨å†ŒsystemdæœåŠ¡...
2025-10-30 09:41:40 - ssh_auto_upgrade - INFO - [service_registrar.py:33] register_service() - å¼€å§‹æœåŠ¡æ£€æµ‹æµç¨‹...
=== å¼€å§‹æœåŠ¡æ£€æµ‹æµç¨‹ ===
âš ï¸  æ£€æµ‹åˆ°xc-sshæœåŠ¡å­˜åœ¨
è¯·ç¡®è®¤è¯¥æœåŠ¡æ˜¯å¦ä¸ºSSHå®ˆæŠ¤æœåŠ¡ï¼š
   - å¦‚æœæ˜¯SSHå®ˆæŠ¤æœåŠ¡ï¼Œå¯ä»¥ç»§ç»­æ³¨å†Œï¼Œå‡çº§æœŸé—´ä¼šåœæ­¢è¯¥æœåŠ¡ï¼Œå‡çº§å®Œæˆåå¯åŠ¨
   - å¦‚æœä¸æ˜¯SSHå®ˆæŠ¤æœåŠ¡ï¼Œå»ºè®®é‡å‘½åè¯¥æœåŠ¡ä»¥é¿å…å†²çª
xc-sshæœåŠ¡æ˜¯å¦ä¸ºSSHå®ˆæŠ¤æœåŠ¡ï¼Ÿ(y/n): y
ç¡®è®¤xc-sshä¸ºSSHå®ˆæŠ¤æœåŠ¡ï¼Œç»§ç»­æ³¨å†Œ...
âœ“ ç¡®è®¤ä»¥ä¸‹æœåŠ¡ä¸ºSSHå®ˆæŠ¤æœåŠ¡: xc-ssh
è¿™äº›æœåŠ¡å°†åœ¨å‡çº§æœŸé—´è¢«åœæ­¢ï¼Œå‡çº§å®Œæˆåé‡æ–°å¯åŠ¨ã€‚
=== æœåŠ¡æ£€æµ‹æµç¨‹å®Œæˆ ===
2025-10-30 09:41:44 - ssh_auto_upgrade - INFO - [service_registrar.py:86] register_service() - æˆåŠŸ: systemdæœåŠ¡æ³¨å†ŒæˆåŠŸï¼ŒæœåŠ¡å·²å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯

æœåŠ¡å·²æ³¨å†Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç®¡ç†:
  systemctl start ssh-auto-upgrade    # å¯åŠ¨æœåŠ¡
  systemctl stop ssh-auto-upgrade     # åœæ­¢æœåŠ¡
  systemctl status ssh-auto-upgrade   # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
  systemctl enable ssh-auto-upgrade   # å¯ç”¨å¼€æœºè‡ªå¯
  systemctl disable ssh-auto-upgrade  # ç¦ç”¨å¼€æœºè‡ªå¯

æœåŠ¡å¯åŠ¨å‘½ä»¤ (ExecStart):
  /usr/local/bin/ssh-auto-upgrade --mirror https://mirrors.aliyun.com/openssh/portable/ --install-dir /usr/local/openssh --download-dir /tmp/ssh-upgrade --log-dir /var/log/ssh-auto-upgrade --upgrade-time 00:00:00-08:00:00 --root-login no
[root@ecs ~]# 
```

### æ—¶é—´æ®µå‡çº§åŠŸèƒ½

å·¥å…·æ”¯æŒè®¾ç½®ç‰¹å®šçš„å‡çº§æ—¶é—´æ®µï¼Œåªæœ‰åœ¨æŒ‡å®šæ—¶é—´æ®µå†…æ‰ä¼šæ‰§è¡Œç‰ˆæœ¬æ£€æµ‹å’Œå‡çº§æ“ä½œï¼Œå…¶ä»–æ—¶é—´è‡ªåŠ¨è·³è¿‡æ£€æµ‹ã€‚

#### æ—¶é—´æ®µæ ¼å¼

- **æ ¼å¼**: `HH:MM:SS-HH:MM:SS`
- **ç¤ºä¾‹**: `00:00:00-08:00:00` (å‡Œæ™¨0ç‚¹åˆ°æ—©ä¸Š8ç‚¹)
- **è·¨å¤©æ”¯æŒ**: `22:00:00-06:00:00` (æ™šä¸Š10ç‚¹åˆ°æ¬¡æ—¥æ—©ä¸Š6ç‚¹)

#### ä½¿ç”¨åœºæ™¯

1. **ä¸šåŠ¡ä½å³°æœŸå‡çº§** - åœ¨å‡Œæ™¨æ—¶æ®µè‡ªåŠ¨å‡çº§ï¼Œé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡
2. **ç½‘ç»œç©ºé—²æ—¶æ®µ** - åœ¨ç½‘ç»œä½¿ç”¨ç‡ä½çš„æ—¶æ®µè¿›è¡Œä¸‹è½½å’Œå®‰è£…
3. **è¿ç»´çª—å£æœŸ** - åœ¨é¢„å®šçš„ç»´æŠ¤çª—å£å†…æ‰§è¡Œå‡çº§æ“ä½œ

#### ç¤ºä¾‹æ—¥å¿—

```
å‡çº§æ—¶é—´æ®µè®¾ç½®ä¸º: 00:00:00 - 08:00:00
å½“å‰æ—¶é—´ 09:33:09 ä¸åœ¨å‡çº§æ—¶é—´æ®µå†…ï¼Œè·³è¿‡æ£€æµ‹...
ç­‰å¾…1å°æ—¶åå†æ¬¡æ£€æŸ¥...
```

### Rootç™»å½•é…ç½®åŠŸèƒ½

å·¥å…·æ”¯æŒåœ¨OpenSSHå‡çº§åè‡ªåŠ¨é…ç½®rootç™»å½•æƒé™ï¼Œå¯ä»¥æ ¹æ®å½“å‰ç³»ç»Ÿé…ç½®æ™ºèƒ½å¤„ç†æˆ–å¼ºåˆ¶è®¾ç½®ã€‚

#### æ™ºèƒ½æ£€æµ‹æœºåˆ¶

- **é…ç½®æ–‡ä»¶ä¸å­˜åœ¨** - é»˜è®¤å¯ç”¨rootç™»å½•
- **é…ç½®æœªè®¾ç½®** - é»˜è®¤å¯ç”¨rootç™»å½•  
- **é…ç½®è¢«æ³¨é‡Š** - é»˜è®¤å¯ç”¨rootç™»å½•
- **é…ç½®å·²è®¾ç½®** - éµå¾ªå½“å‰é…ç½®å€¼

#### å‘½ä»¤è¡Œå‚æ•°

```bash
# æ™ºèƒ½æ£€æµ‹rootç™»å½•é…ç½®ï¼ˆé»˜è®¤ï¼‰
ssh-auto-upgrade --root-login auto

# å¼ºåˆ¶å¯ç”¨rootç™»å½•
ssh-auto-upgrade --root-login yes

# å¼ºåˆ¶ç¦ç”¨rootç™»å½•
ssh-auto-upgrade --root-login no

# å¼ºåˆ¶å‡çº§å¹¶å¯ç”¨rootç™»å½•
ssh-auto-upgrade --force --root-login yes

# æ³¨å†ŒæœåŠ¡æ—¶è®¾ç½®rootç™»å½•é…ç½®
ssh-auto-upgrade --service --root-login yes
ssh-auto-upgrade --service --root-login no

# ç»“åˆæ—¶é—´æ®µå’Œrootç™»å½•é…ç½®
ssh-auto-upgrade --upgrade-time 00:00:00-08:00:00 --root-login yes
```

#### é…ç½®å¤„ç†æµç¨‹

1. **å‡çº§å‰æ£€æµ‹** - æ£€æŸ¥å½“å‰SSHé…ç½®ä¸­çš„rootç™»å½•è®¾ç½®
2. **å‡çº§æ‰§è¡Œ** - å®ŒæˆOpenSSHç‰ˆæœ¬å‡çº§
3. **é…ç½®åº”ç”¨** - æ ¹æ®å‚æ•°è®¾ç½®rootç™»å½•æƒé™
4. **æœåŠ¡é‡å¯** - é‡å¯SSHæœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ

#### å®‰å…¨ç‰¹æ€§

- **è‡ªåŠ¨å¤‡ä»½** - ä¿®æ”¹é…ç½®å‰è‡ªåŠ¨å¤‡ä»½åŸæ–‡ä»¶
- **æƒé™ä¿æŠ¤** - ç¡®ä¿é…ç½®æ–‡ä»¶æƒé™æ­£ç¡®
- **é”™è¯¯æ¢å¤** - é…ç½®å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤å¤‡ä»½

#### ç¤ºä¾‹æ—¥å¿—

```
æ£€æŸ¥å½“å‰rootç™»å½•é…ç½®...
å½“å‰rootç™»å½•çŠ¶æ€: å¯ç”¨ (PermitRootLogin yes)
OpenSSHå‡çº§æˆåŠŸ! æ–°ç‰ˆæœ¬: 9.6p1
SSHæœåŠ¡é‡å¯æˆåŠŸ
å·²å¯ç”¨rootç™»å½•: rootç™»å½•å·²å¯ç”¨
SSHæœåŠ¡é‡å¯æˆåŠŸï¼ˆåº”ç”¨rootç™»å½•é…ç½®ï¼‰: SSHæœåŠ¡é‡å¯æˆåŠŸ
```

### å¾ªç¯æ—¥å¿—ç³»ç»Ÿ

å·¥å…·é‡‡ç”¨æ™ºèƒ½å¾ªç¯æ—¥å¿—ç³»ç»Ÿï¼Œæœ‰æ•ˆé˜²æ­¢æ—¥å¿—æ–‡ä»¶æ— é™å¢é•¿å¯¼è‡´ç£ç›˜ç©ºé—´è€—å°½ã€‚

#### æ ¸å¿ƒç‰¹æ€§

- **è‡ªåŠ¨è½®è½¬** - æ—¥å¿—æ–‡ä»¶è¾¾åˆ°æŒ‡å®šå¤§å°åè‡ªåŠ¨åˆ›å»ºæ–°æ–‡ä»¶
- **æ™ºèƒ½å‘½å** - æ”¯æŒ `.1`, `.2` ç­‰æ‰©å±•åæ ¼å¼çš„æ—¥å¿—è½®è½¬
- **è·¯å¾„è¿½è¸ª** - è‡ªåŠ¨è¿½è¸ªå½“å‰æ´»åŠ¨æ—¥å¿—æ–‡ä»¶è·¯å¾„
- **å…¼å®¹æ¨¡å¼** - åŒæ—¶æ”¯æŒå¾ªç¯æ—¥å¿—å’Œæ™®é€šæ–‡ä»¶æ—¥å¿—

#### æ—¥å¿—æ–‡ä»¶ç»“æ„

```
/var/log/ssh-auto-upgrade/
â”œâ”€â”€ ssh_upgrade.log          # å½“å‰æ´»åŠ¨æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ ssh_upgrade.1.log        # ä¸Šä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ ssh_upgrade.2.log        # æ›´æ—©çš„æ—¥å¿—æ–‡ä»¶
â””â”€â”€ ...
```

#### é…ç½®å‚æ•°

```python
# åœ¨ä»£ç ä¸­é…ç½®å¾ªç¯æ—¥å¿—
logger = setup_logger(
    log_dir="/var/log/ssh-auto-upgrade",
    max_bytes=10*1024*1024,     # 10MB per file
    backup_count=5             # Keep 5 backup files
)
```

#### ä½¿ç”¨ç¤ºä¾‹

```bash
# æŸ¥çœ‹å½“å‰æ´»åŠ¨æ—¥å¿—æ–‡ä»¶
 tail -f /var/log/ssh-auto-upgrade/ssh_upgrade.log

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
ls -la /var/log/ssh-auto-upgrade/

# æŸ¥çœ‹ä¸Šä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„å†…å®¹
cat /var/log/ssh-auto-upgrade/ssh_upgrade.1.log
```

### ä½œä¸ºPythonæ¨¡å—ä½¿ç”¨

```python
from ssh_auto_upgrade import VersionDetector, Downloader, Installer

# æ£€æµ‹æœ€æ–°ç‰ˆæœ¬
detector = VersionDetector()
version_info = detector.get_latest_version()
print(f"æœ€æ–°ç‰ˆæœ¬: {version_info['version']}")

# ä¸‹è½½å®‰è£…æ–‡ä»¶
downloader = Downloader()
script_path = downloader.download_install_script()

# æ‰§è¡Œå®‰è£…
installer = Installer(script_path, version_info['download_url'])
if installer.install_openssh():
    print("å®‰è£…æˆåŠŸ!")
```

## âœ… æµ‹è¯•éªŒè¯

### æœåŠ¡ç®¡ç†åŠŸèƒ½æµ‹è¯•

é¡¹ç›®å·²é€šè¿‡å…¨é¢çš„æœåŠ¡ç®¡ç†åŠŸèƒ½æµ‹è¯•ï¼ŒéªŒè¯äº†ServiceManagerç±»çš„å®Œæ•´åŠŸèƒ½ï¼š

#### ğŸ§ª æµ‹è¯•ç¯å¢ƒ
- **æµ‹è¯•ç³»ç»Ÿ**: Ubuntu Linux
- **æµ‹è¯•æœåŠ¡**: vsftpd (FTPæœåŠ¡å™¨)
- **æµ‹è¯•å·¥å…·**: è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬ `test_service_manager.py`

#### ğŸ“Š æµ‹è¯•ç»“æœ

æ‰€æœ‰5é¡¹æ ¸å¿ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼š

1. **âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•** - ServiceManagerå®ä¾‹åŒ–ã€systemdæ£€æµ‹ã€å¯æ‰§è¡Œæ–‡ä»¶æ£€æŸ¥
2. **âœ… æœåŠ¡çŠ¶æ€æ£€æŸ¥** - ä½¿ç”¨D-Bus APIå‡†ç¡®æ£€æµ‹æœåŠ¡çŠ¶æ€
3. **âœ… æœåŠ¡æ§åˆ¶åŠŸèƒ½** - å¯åŠ¨ã€åœæ­¢ã€å¯ç”¨ã€ç¦ç”¨æœåŠ¡æ“ä½œ
4. **âœ… æœåŠ¡æ–‡ä»¶åˆ›å»º** - æ­£ç¡®ç”ŸæˆsystemdæœåŠ¡æ–‡ä»¶
5. **âœ… å®Œæ•´æœåŠ¡ç®¡ç†æµç¨‹** - å®Œæ•´çš„æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### ğŸ”§ å…³é”®ä¿®å¤

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š
- **D-Busæ¥å£è°ƒç”¨ä¼˜åŒ–** - å°†`bus.get_interface()`æ”¹ä¸ºä½¿ç”¨é¢„åˆå§‹åŒ–çš„æ¥å£å¯¹è±¡
- **APIè°ƒç”¨ä¸€è‡´æ€§** - ç¡®ä¿æ‰€æœ‰æœåŠ¡æ§åˆ¶æ–¹æ³•ä½¿ç”¨ä¸€è‡´çš„D-Bus APIè°ƒç”¨æ–¹å¼
- **é”™è¯¯å¤„ç†å®Œå–„** - å¢å¼ºäº†å¼‚å¸¸å¤„ç†å’ŒçŠ¶æ€éªŒè¯æœºåˆ¶

#### ğŸ¯ åŠŸèƒ½éªŒè¯

é€šè¿‡vsftpdæœåŠ¡çš„å®é™…æµ‹è¯•ï¼ŒéªŒè¯äº†ServiceManagerç±»çš„ä»¥ä¸‹èƒ½åŠ›ï¼š
- **æœåŠ¡æ£€æµ‹** - å‡†ç¡®è¯†åˆ«æœåŠ¡å­˜åœ¨çŠ¶æ€
- **æœåŠ¡æ§åˆ¶** - å¯é çš„å¯åŠ¨ã€åœæ­¢ã€å¯ç”¨ã€ç¦ç”¨æ“ä½œ
- **æœåŠ¡æ–‡ä»¶ç®¡ç†** - æ­£ç¡®çš„systemdæœåŠ¡æ–‡ä»¶ç”Ÿæˆ
- **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’ŒçŠ¶æ€åé¦ˆ
- **æƒé™ç®¡ç†** - æ­£ç¡®çš„rootæƒé™æ£€æŸ¥

### ç³»ç»Ÿå…¼å®¹æ€§

å·¥å…·å·²åœ¨ä»¥ä¸‹ç¯å¢ƒä¸­éªŒè¯ï¼š
- âœ… Ubuntu 20.04+ (systemdç¯å¢ƒ)
- âœ… Debian 10+ (systemdç¯å¢ƒ)
- âœ… CentOS 7+ (systemdç¯å¢ƒ)

### ä¾èµ–éªŒè¯

æ‰€æœ‰Pythonä¾èµ–åŒ…å·²æ›´æ–°å¹¶éªŒè¯ï¼š
- âœ… `requests>=2.25.0` - HTTPè¯·æ±‚å¤„ç†
- âœ… `beautifulsoup4>=4.9.0` - HTMLè§£æ
- âœ… `systemd-python>=234` - systemdé›†æˆ
- âœ… `dbus-python>=1.2.0` - D-Bus APIé›†æˆï¼ˆæ–°å¢ï¼‰

é¡¹ç›®ç°å·²å…·å¤‡å®Œæ•´ã€å¯é çš„æœåŠ¡ç®¡ç†èƒ½åŠ›ï¼Œå¯ä»¥å®‰å…¨åœ°ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### Pythonç¯å¢ƒ

- **Python**: 3.6 æˆ–æ›´é«˜ç‰ˆæœ¬
- **pip**: åŒ…ç®¡ç†å·¥å…·

### ç³»ç»ŸåŒ…ï¼ˆè‡ªåŠ¨æ£€æµ‹å’Œå®‰è£…ï¼‰

- **ç¼–è¯‘å·¥å…·**: gcc, make, autoconf, automake
- **å¼€å‘åº“**: zlib-devel, openssl-devel, pam-devel
- **ç³»ç»Ÿå·¥å…·**: wget, tar, systemd

### PythonåŒ…ä¾èµ–

- **requests** >= 2.25.0 - HTTPè¯·æ±‚å¤„ç†
- **beautifulsoup4** >= 4.9.0 - HTMLè§£æ

## ğŸ”§ æ¨¡å—è¯¦è§£

### æ ¸å¿ƒæ¨¡å—

#### 1. ç‰ˆæœ¬æ£€æµ‹æ¨¡å— (`version_detector.py`)

- ä»OpenSSHå®˜æ–¹é•œåƒæºè§£ææœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
- æ£€æµ‹å½“å‰ç³»ç»Ÿå®‰è£…çš„OpenSSHç‰ˆæœ¬
- æ”¯æŒè‡ªå®šä¹‰é•œåƒæºURL

#### 2. ä¸‹è½½å™¨æ¨¡å— (`downloader.py`)

- æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œè¿›åº¦æ˜¾ç¤º
- æ–‡ä»¶å®Œæ•´æ€§éªŒè¯å’Œé”™è¯¯é‡è¯•
- å¯é…ç½®çš„ä¸‹è½½ç›®å½•å’Œè¶…æ—¶è®¾ç½®

#### 3. å®‰è£…å™¨æ¨¡å— (`installer.py`)

- å®Œæ•´çš„ç¼–è¯‘å®‰è£…æµç¨‹æ§åˆ¶
- é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
- ä¸æœåŠ¡ç®¡ç†å’Œæ–‡ä»¶ç®¡ç†æ¨¡å—ååŒå·¥ä½œ

#### 4. æœåŠ¡ç®¡ç†æ¨¡å— (`service_manager.py`)

- systemdæœåŠ¡æ³¨å†Œå’Œç®¡ç†
- æœåŠ¡çŠ¶æ€ç›‘æ§å’Œæ•…éšœæ¢å¤
- æƒé™éªŒè¯å’Œå®‰å…¨æ§åˆ¶
- **D-Bus APIé›†æˆ** - ä½¿ç”¨dbus-pythonè¿›è¡ŒsystemdæœåŠ¡ç®¡ç†
- **æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†** - å®Œæ•´çš„æœåŠ¡åˆ›å»ºã€å¯ç”¨ã€å¯åŠ¨ã€åœæ­¢ã€ç¦ç”¨ã€ç§»é™¤æµç¨‹
- **é”™è¯¯å¤„ç†æœºåˆ¶** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’ŒçŠ¶æ€åé¦ˆ

##### âœ… æœåŠ¡ç®¡ç†åŠŸèƒ½æµ‹è¯•éªŒè¯

é€šè¿‡å…¨é¢çš„åŠŸèƒ½æµ‹è¯•éªŒè¯ï¼ŒServiceManagerç±»å·²ç¡®è®¤å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š

- **âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•** - å®ä¾‹åŒ–ã€systemdæ£€æµ‹ã€å¯æ‰§è¡Œæ–‡ä»¶æ£€æŸ¥
- **âœ… æœåŠ¡çŠ¶æ€æ£€æŸ¥** - ä½¿ç”¨D-Bus APIå‡†ç¡®æ£€æµ‹æœåŠ¡çŠ¶æ€
- **âœ… æœåŠ¡æ§åˆ¶åŠŸèƒ½** - å¯åŠ¨ã€åœæ­¢ã€å¯ç”¨ã€ç¦ç”¨æœåŠ¡
- **âœ… æœåŠ¡æ–‡ä»¶åˆ›å»º** - æ­£ç¡®ç”ŸæˆsystemdæœåŠ¡æ–‡ä»¶
- **âœ… å®Œæ•´æœåŠ¡ç®¡ç†æµç¨‹** - å®Œæ•´çš„æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

##### ğŸ”§ å…³é”®ä¿®å¤

- ä¿®å¤äº†D-Busæ¥å£è°ƒç”¨é—®é¢˜ï¼Œå°†`bus.get_interface()`æ”¹ä¸ºä½¿ç”¨é¢„åˆå§‹åŒ–çš„æ¥å£å¯¹è±¡
- ç¡®ä¿æ‰€æœ‰æœåŠ¡æ§åˆ¶æ–¹æ³•ä½¿ç”¨ä¸€è‡´çš„D-Bus APIè°ƒç”¨æ–¹å¼
- å®Œå–„äº†é”™è¯¯å¤„ç†å’ŒçŠ¶æ€éªŒè¯æœºåˆ¶

### è¾…åŠ©æ¨¡å—

#### ä¾èµ–ç®¡ç†æ¨¡å— (`dependencies.py`)

- è‡ªåŠ¨æ£€æµ‹ç³»ç»ŸåŒ…ç®¡ç†å™¨ï¼ˆapt/yum/dnfç­‰ï¼‰
- æ™ºèƒ½å®‰è£…ç¼ºå¤±çš„ç¼–è¯‘ä¾èµ–
- æ”¯æŒå¤šç§Linuxå‘è¡Œç‰ˆ

#### å‚æ•°éªŒè¯æ¨¡å— (`argument_validator.py`)

- æ—¶é—´æ ¼å¼éªŒè¯å’Œè§£æ
- è·¯å¾„æœ‰æ•ˆæ€§æ£€æŸ¥
- å‚æ•°ç»„åˆé€»è¾‘éªŒè¯
- é”™è¯¯æç¤ºå’Œä¿®å¤å»ºè®®

#### ç³»ç»Ÿæ£€æµ‹æ¨¡å—

- **é•œåƒæºæ£€æŸ¥ (`mirror_checker.py`)** - éªŒè¯é•œåƒæºå¯ç”¨æ€§å’Œå“åº”é€Ÿåº¦
- **æœåŠ¡æ£€æµ‹ (`service_detector.py`)** - æ£€æµ‹SSHç›¸å…³æœåŠ¡çŠ¶æ€
- **systemdæ£€æŸ¥ (`systemd_checker.py`)** - éªŒè¯systemdç¯å¢ƒå’Œæ”¯æŒ
- **æ—¶é—´æ£€æŸ¥ (`time_checker.py`)** - æ—¶é—´æ®µéªŒè¯å’Œæ ¼å¼æ£€æŸ¥
- **å®‰è£…å™¨æœåŠ¡æ£€æµ‹ (`installer_service_detector.py`)** - å®‰è£…å™¨æœåŠ¡çŠ¶æ€æ£€æµ‹

#### é…ç½®ç®¡ç†æ¨¡å—

- **SSHé…ç½®ç®¡ç† (`ssh_config_manager.py`)** - SSHé…ç½®æ–‡ä»¶è§£æå’Œä¿®æ”¹
- **é—ç•™æ¸…ç† (`legacy_cleaner.py`)** - æ¸…ç†æ—§ç‰ˆæœ¬æ–‡ä»¶å’Œé…ç½®

#### æ—¥å¿—è®°å½•æ¨¡å— (`logger.py`)

- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- æ–‡ä»¶å’Œæ§åˆ¶å°åŒé‡è¾“å‡º
- **å¾ªç¯æ—¥å¿—ç³»ç»Ÿ** - æ”¯æŒæ—¥å¿—æ–‡ä»¶è½®è½¬å’Œå¤§å°é™åˆ¶
- **æ™ºèƒ½è·¯å¾„ç®¡ç†** - è‡ªåŠ¨ç®¡ç†å½“å‰æ´»åŠ¨æ—¥å¿—æ–‡ä»¶è·¯å¾„
- æ—¶é—´æˆ³å’Œæ—¥å¿—çº§åˆ«è¿‡æ»¤

##### å¾ªç¯æ—¥å¿—ç³»ç»Ÿç‰¹æ€§

- **è‡ªåŠ¨è½®è½¬** - æ—¥å¿—æ–‡ä»¶è¾¾åˆ°æŒ‡å®šå¤§å°åè‡ªåŠ¨åˆ›å»ºæ–°æ–‡ä»¶
- **æ–‡ä»¶é™åˆ¶** - æ”¯æŒè®¾ç½®æœ€å¤§æ—¥å¿—æ–‡ä»¶æ•°é‡å’Œæ€»å¤§å°é™åˆ¶
- **è·¯å¾„è¿½è¸ª** - æ™ºèƒ½è¿½è¸ªå½“å‰æ´»åŠ¨æ—¥å¿—æ–‡ä»¶è·¯å¾„
- **å…¼å®¹æ€§** - åŒæ—¶æ”¯æŒå¾ªç¯æ—¥å¿—å’Œæ™®é€šæ–‡ä»¶æ—¥å¿—

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æƒé™ä¸è¶³

```bash
# ç¡®ä¿ä»¥rootæƒé™è¿è¡ŒæœåŠ¡æ³¨å†Œ
sudo ssh-auto-upgrade --service
```

#### 2. ç½‘ç»œè¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping mirrors.aliyun.com
```

#### 3. ä¾èµ–å®‰è£…å¤±è´¥

```bash
# æ‰‹åŠ¨å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆUbuntu/Debianï¼‰
sudo apt update
sudo apt install build-essential zlib1g-dev libssl-dev libpam0g-dev

# CentOS/RHEL
sudo yum install gcc make zlib-devel openssl-devel pam-devel
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u ssh-auto-upgrade

# å®æ—¶ç›‘æ§æ—¥å¿—
sudo journalctl -u ssh-auto-upgrade -f

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
sudo journalctl -u ssh-auto-upgrade --since "2024-01-01" --until "2024-01-02"
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„è´¡çŒ®ï¼è¯·å‚è€ƒä»¥ä¸‹æ­¥éª¤ï¼š

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. **Forké¡¹ç›®**

   ```bash
   git clone https://gitee.com/liumou_site/ssh-automatic-upgrade.git
   cd ssh-automatic-upgrade
   ```

2. **åˆ›å»ºç‰¹æ€§åˆ†æ”¯**

   ```bash
   git checkout -b feature/ä½ çš„ç‰¹æ€§åç§°
   ```

3. **æäº¤æ›´æ”¹**

   ```bash
   git commit -m "æè¿°ä½ çš„ç‰¹æ€§"
   ```

4. **æ¨é€åˆ°åˆ†æ”¯**

   ```bash
   git push origin feature/ä½ çš„ç‰¹æ€§åç§°
   ```

5. **åˆ›å»ºPull Request**

### ä»£ç è§„èŒƒ

- éµå¾ªPEP 8 Pythonä»£ç è§„èŒƒ
- æ·»åŠ é€‚å½“çš„æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆdocstringï¼‰
- åŒ…å«å•å…ƒæµ‹è¯•ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
- æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MITè®¸å¯è¯](LICENSE)ã€‚æ‚¨å¯ä»¥è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘æœ¬è½¯ä»¶ã€‚

## ğŸ”— ç›¸å…³é“¾æ¥

- **é¡¹ç›®ä¸»é¡µ**: <https://gitee.com/liumou_site/ssh-automatic-upgrade>
- **é—®é¢˜åé¦ˆ**: è¯·åœ¨Gitee Issuesä¸­æäº¤
- **ä½œè€…ä¸»é¡µ**: <https://liumou.site>
- **QQç¾¤**: [ç‚¹å‡»é“¾æ¥åŠ å…¥ç¾¤èŠã€åå…¬äº¤ä¹Ÿç”¨åˆ¸ã€‘ï¼š](https://qm.qq.com/q/rjB2YGP0M)

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºè¿™ä¸ªé¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼ç‰¹åˆ«æ„Ÿè°¢ï¼š

- OpenSSHå¼€å‘å›¢é˜Ÿæä¾›ä¼˜ç§€çš„SSHå®ç°
- å„Linuxå‘è¡Œç‰ˆç»´æŠ¤è€…
- å¼€æºç¤¾åŒºçš„æ”¯æŒå’Œåé¦ˆ

---

**æ³¨æ„**: ä½¿ç”¨æœ¬å·¥å…·å‰è¯·ç¡®ä¿æ‚¨äº†è§£ç›¸å…³é£é™©ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚å·¥å…·ä½œè€…ä¸å¯¹å› ä½¿ç”¨æœ¬å·¥å…·å¯¼è‡´çš„ä»»ä½•é—®é¢˜è´Ÿè´£ã€‚
