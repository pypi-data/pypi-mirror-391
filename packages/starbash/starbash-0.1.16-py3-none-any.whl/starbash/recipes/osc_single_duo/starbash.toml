
[repo]
kind = "recipe"

[recipe]

# Lower priority recipes are tried to match first
# - we want this to match after the osc_dual_duo has a chance
priority = 20

author.name = "FIXMEsirilsomeone"
author.email = "FIXMEsirilsomeone"

# for single duo look for this
auto.require.filter = ["HaOiii"]
auto.require.color = true

# all sb.toml files can optionally contain a version section.  if version of the running starbash app is out of bounds a warning message will be printed
# to the user and the file will be ignored for future processing.
[recipe.require.version]
min="0.1.0"
max="4.5.8"

[recipe.stage.light]

description = "Extract OSC dual duo filter Ha, Oiii and Sii channels"
# disabled = true # FIXME, debugging later stuff

tool.name = "siril"

# Auto find input light frames for the current session
# Look for files in input repos, finding them by using the "relative" tag they contain
input.source = "repo"
input.required = 2    # siril needs at least 2 frames to stack
input.type = "light" # look in all raw repos, but look only for light files

# Auto find suitable masters of the following type
input.masters = ["bias", "flat"]

# the base name for our light files
context.light_base = '''light_s{session["id"]}'''

script = '''
    # Create a sequence from the raw light frames, seq file goes to process_dir
    link {light_base} -out={process_dir}
    cd {process_dir}

    # Calibrate the light frames using master bias and flat
    calibrate {light_base} -bias={master["bias"]} -flat={master["flat"]} -cfa -equalize_cfa

    # Remove background gradient on a per-frame basis (generates bkg_pp_light.seq)
    seqsubsky pp_{light_base} 1

    # FIXME only do this step for duo filters (refactor to share common light processing function)
    seqextract_HaOIII bkg_pp_{light_base} -resample=ha
    '''

# temporaries = ["FIXME"]

[recipe.stage.stack]

# this stage is only be considered if the previous stage in this same array
# was run.  It must be run inside the same tempdir (so that files from previous stage are available)

description = "Stack OSC single duo filter data: with Ha, Oiii extraction"

input.source = "recipe" # we will use output files from previous stages in this same recipe as our input

tool.name = "python"

# Based on the following definitions in the stage toml file...
# FIXME, we should inherit this - most recipes shouldn't have to declare it
output.dest = "repo" # write to a particular repo
output.type = "processed" # write output to the special processed repo

# if not specified starbash.py used
# script-file = "script.py"

# or inline python code can be provided here.  In this case I'm using some python
# code I'm temporarily sharing from the main project...
script = '''
    from starbash.recipes import osc
    osc.logger = logger
    osc.context = context
    osc.osc_process(has_ha_oiii=True, has_sii_oiii=False)
    '''