
[repo]
kind = "recipe"


[recipe]
author.name = "FIXMESiril?"
author.email = "FIXMESiril?"


[recipe.stage.master-flat]

# See master_bias/starbash.toml for more documentation

description = "Generate master flat"
# disabled = false

tool.name = "siril"
# tool.timeout = 15.0 # allow up to 15 seconds before we timeout and kill tool

# or auto?
# find the most recent raw fits for the current instrument (as of the time of session start)
# input.source = "most-recent" # only look for the most recent set of raws for this particular type
input.type = "flat" # look in all raw repos, but look only for flat files

# Look for files in input repos, finding them by using the "relative" tag they contain
input.source = "repo"
input.required = 2    # siril needs at least 2 frames to stack

# We require a master bias frame for this recipe.  By the time our recipe is invoked
# context.master.bias will have been set to a full path to a master bias frame
input.masters = ["bias"]

# Based on the following definitions in the stage toml file...
output.dest = "repo"   # write to a particular repo
output.type = "master" # write output to the special masters repo

# FIXME for early development we have support for simple absolute file paths with globs
#input.source = "path"
#input.path = "/workspaces/starbash/images/from_astroboy/M 27/2025-09-16/FLAT/*.fit*"

script = '''
    # Create a sequence from the raw flat frames
    link flat -out={process_dir}
    cd {process_dir}

    # Calibrate the flat frames using master bias
    calibrate flat -bias={master["bias"]}

    # Stack the pre-processed (calibrated) flat frames
    stack pp_flat rej 3 3 -norm=mul -out={output["base_path"]}
    '''

temporaries = ["flat", "pp_flat"]
