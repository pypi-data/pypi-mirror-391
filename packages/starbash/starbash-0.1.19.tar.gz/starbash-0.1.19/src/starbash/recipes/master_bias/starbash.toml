
[repo]
kind = "recipe"


[recipe]
author.name = "FIXMESiril?"
author.email = "FIXMESiril?"

[recipe.stage.master-bias]

description = "Generate master bias"
# disabled = false # turn on to skip

# Restrict processing of this stage to only if detected hardware was found for this session
# For any camera
# auto.for-camera = []

tool.name = "siril"
# tool.timeout = 15.0 # allow up to 15 seconds before we timeout and kill tool

# or auto?
# find the most recent raw fits for the current instrument (as of the time of session start)
# input.source = "most-recent" # only look for the most recent set of raws for this particular type
input.type = "bias" # look in all raw repos, but look only for bias files

# Look for files in input repos, finding them by using the "relative" tag they contain
input.source = "repo"
input.required = 2    # siril needs at least 2 frames to stack
# old school paths also work (but are not recommended)
# input.path = ".../from_astroboy/masters-raw/2025-09-09/BIAS/*.fit*"

# Based on the following definitions in the stage toml file...
output.dest = "repo"   # write to a particular repo
output.type = "master" # write output to the special masters repo


# context.target - the name of the target (m31 etc...) we are processing (if available)
# the following fields will be auto populated in the context before entry:
# context.output.base_path - the full filepath to write the output file to **excluding the suffix**
# context.output.full_path - the full filepath to write the output file to (including suffix)
# context.output.repo - points to the destination repo object
# context.output.relative_base_path - the relative path within the repo (excluding suffix) (for logging/user message purposes)
# (NOT implemented / needed) context.output.suffix - the suffix to append to the output file (e.g. .fits or .fit.gz)

# The following constants are auto defined before running the tool
# context.process_dir (points to the session specific semi-persistent local dir for that sessions written/read data files)
# context.masters (FIXME) - need to find this name dynamically by looking for a suitable writable repo
# context.temp_dir (points to a temporary directory this tool can use for writing)

# Everything in the constants dict will be predefined as named variables for use by the script
# context.date = "2025-09-0.9"  # FIXME - later find auto latest date with bias frames

# output file will be place in the masters repo
# if the output already exists processing will be skipped
#
# with a path like "{instrument}/{date}/{imagetyp}/{sessionconfig}.fits"
# this path comes from master_repo.relative
# context.output = "{output.root}/{instrument}/{date}/{imagetyp}/{sessionconfig}.fits"


script = '''
    # Convert Bias Frames to .fit files
    link frames -out={process_dir}
    cd {process_dir}

    # Stack frames
    stack frames rej 3 3 -nonorm -out={output["base_path"]}
    '''
