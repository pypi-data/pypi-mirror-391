name: Build Without Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-no-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.10'
        channels: conda-forge,defaults
        channel-priority: strict

    - name: Install minimal conda dependencies
      shell: bash -l {0}
      run: |
        conda install -y \
          cereal \
          catch2 \
          cmake \
          boost \
          yaml-cpp \
          zeromq \
          cxx-compiler \
          pkg-config \
          openmpi \
          elfutils \
          zlib

    - name: Set up MPI environment
      shell: bash -l {0}
      run: |
        echo "MPI_HOME=$CONDA_PREFIX" >> $GITHUB_ENV
        echo "MPI_C_COMPILER=$CONDA_PREFIX/bin/mpicc" >> $GITHUB_ENV
        echo "MPI_CXX_COMPILER=$CONDA_PREFIX/bin/mpic++" >> $GITHUB_ENV

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          libssl-dev

    - name: Upgrade pip and install build tools
      shell: bash -l {0}
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools nanobind

    - name: Build and install package (no tests)
      shell: bash -l {0}
      run: |
        pip install -v .
      timeout-minutes: 45
      env:
        IOWARP_BUILD_TESTS: "OFF"

    - name: Verify installation
      shell: bash -l {0}
      run: |
        python -c "import iowarp_core; print('Version:', iowarp_core.get_version())"
        python -c "import iowarp_core; print('Components:', list(iowarp_core.COMPONENTS.keys()))"

    - name: Check installed files
      shell: bash -l {0}
      run: |
        pip show iowarp-core
        python -c "import iowarp_core; import os; print('Module location:', os.path.dirname(iowarp_core.__file__))"
