"""
åŠ¨æ€ä¸“å®¶ç”Ÿæˆç³»ç»Ÿ - æä¾›ä¸“å®¶æ¨èçš„åŸåˆ™æ€§æŒ‡å¯¼
"""

from typing import Any


class DynamicExpertManager:
    """åŠ¨æ€ä¸“å®¶ç®¡ç†å™¨ - ç®¡ç†å½“å‰ä¼šè¯çš„ä¸“å®¶"""

    def __init__(self, data_dir: str | None = None):
        # ä¿ç•™data_dirå‚æ•°ä»¥å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†å®é™…ä¸ä½¿ç”¨
        self.current_experts: dict[str, Any] = {}

    def set_current_experts(self, experts: dict[str, Any]) -> None:
        """è®¾ç½®å½“å‰ä¼šè¯çš„ä¸“å®¶"""
        self.current_experts = experts

    def get_current_experts(self) -> dict[str, Any]:
        """è·å–å½“å‰ä¼šè¯çš„ä¸“å®¶"""
        return self.current_experts

    def clear_current_experts(self) -> None:
        """æ¸…é™¤å½“å‰ä¸“å®¶"""
        self.current_experts = {}

    def validate_expert_data(self, expert_data: dict[str, Any] | None) -> bool:
        """éªŒè¯ä¸“å®¶æ•°æ®å®Œæ•´æ€§"""
        if expert_data is None:
            return False

        required_fields = [
            "name",
            "description",
            "core_traits",
            "speaking_style",
            "base_prompt",
        ]

        for field in required_fields:
            if field not in expert_data or not expert_data[field]:
                return False

        # æ·»åŠ é»˜è®¤emoji
        if "emoji" not in expert_data:
            expert_data["emoji"] = "ğŸ‘¤"

        return True

    def format_expert_list(self, experts: dict[str, Any]) -> list[dict[str, Any]]:
        """æ ¼å¼åŒ–ä¸“å®¶åˆ—è¡¨ç”¨äºæ˜¾ç¤º"""
        return [
            {
                "name": expert["name"],
                "emoji": expert.get("emoji", "ğŸ‘¤"),
                "description": expert["description"],
                "core_traits": expert["core_traits"],
                "speaking_style": expert["speaking_style"],
                # ç§»é™¤ç¡¬ç¼–ç çš„çœŸå®äººç‰©åˆ¤æ–­ï¼Œäº¤ç»™MCP Hostç«¯LLMå¤„ç†
                # "is_real_person": self._is_likely_real_person(expert),
            }
            for expert in experts.values()
        ]


def get_question_analysis_guidance() -> str:
    """è·å–é—®é¢˜åˆ†ææŒ‡å¯¼åŸåˆ™ï¼ˆä¾›MCP Hostç«¯LLMä½¿ç”¨ï¼‰"""
    return """
# é—®é¢˜åˆ†ææŒ‡å¯¼åŸåˆ™

## åˆ†æç»´åº¦
è¯·ä»ä»¥ä¸‹ç»´åº¦åˆ†æé—®é¢˜ï¼š

### 1. é—®é¢˜å¤æ‚åº¦
- ç®€å•é—®é¢˜ï¼šè¡¨è¿°æ¸…æ™°ã€ç­”æ¡ˆç›¸å¯¹æ˜ç¡®
- ä¸­ç­‰å¤æ‚åº¦ï¼šæ¶‰åŠå¤šä¸ªå› ç´ ã€éœ€è¦æƒè¡¡
- é«˜å¤æ‚åº¦ï¼šå¤šé¢†åŸŸäº¤å‰ã€å­˜åœ¨äº‰è®®ã€éœ€è¦æ·±åº¦æ€è€ƒ

### 2. é—®é¢˜ç±»å‹
- æ–¹æ³•å’¨è¯¢ï¼š"å¦‚ä½•"ã€"æ€ä¹ˆ"ç±»é—®é¢˜
- åŸå› åˆ†æï¼š"ä¸ºä»€ä¹ˆ"ã€"åŸå› "ç±»é—®é¢˜
- å†³ç­–æ”¯æŒï¼š"é€‰æ‹©"ã€"å†³ç­–"ç±»é—®é¢˜
- è¶‹åŠ¿é¢„æµ‹ï¼š"æœªæ¥"ã€"è¶‹åŠ¿"ç±»é—®é¢˜
- å¯¹æ¯”åˆ†æï¼š"æ¯”è¾ƒ"ã€"å¯¹æ¯”"ç±»é—®é¢˜

### 3. é¢†åŸŸè¯†åˆ«
è¯†åˆ«é—®é¢˜æ‰€æ¶‰åŠçš„ä¸»è¦é¢†åŸŸï¼š
- å•†ä¸šç®¡ç†ï¼šä¼ä¸šç»è¥ã€æŠ•èµ„ã€å¸‚åœºè¥é”€
- ç§‘æŠ€åˆ›æ–°ï¼šæŠ€æœ¯å‘å±•ã€äººå·¥æ™ºèƒ½ã€æ•°å­—åŒ–
- å“²å­¦æ€è¾¨ï¼šä»·å€¼è§‚ã€é“å¾·ä¼¦ç†ã€å­˜åœ¨æ„ä¹‰
- å¿ƒç†è¡Œä¸ºï¼šæƒ…ç»ªç®¡ç†ã€è®¤çŸ¥åå·®ã€äººé™…å…³ç³»
- æ•™è‚²æˆé•¿ï¼šå­¦ä¹ æ–¹æ³•ã€çŸ¥è¯†ä½“ç³»ã€èƒ½åŠ›åŸ¹å…»
- ç¤¾ä¼šæ–‡åŒ–ï¼šåˆ¶åº¦è®¾è®¡ã€æ–‡åŒ–ä¼ æ‰¿ã€å…¬å…±æ”¿ç­–
- å¥åº·ç”Ÿæ´»ï¼šèº«å¿ƒå¥åº·ã€ç”Ÿæ´»æ–¹å¼ã€å…»ç”Ÿä¿å¥
- åˆ›æ–°è®¾è®¡ï¼šåˆ›æ„æ€ç»´ã€äº§å“è®¾è®¡ã€ç”¨æˆ·ä½“éªŒ
- é¢†å¯¼ç®¡ç†ï¼šå›¢é˜Ÿå»ºè®¾ã€å†³ç­–åˆ¶å®šã€æ²Ÿé€šåè°ƒ
- æˆ˜ç•¥è§„åˆ’ï¼šé•¿æœŸå‘å±•ã€ç«äº‰ä¼˜åŠ¿ã€èµ„æºé…ç½®

## åˆ†æè¦æ±‚
- å‡†ç¡®è¯†åˆ«é—®é¢˜çš„æ ¸å¿ƒè¦ç´ 
- åˆ¤æ–­é—®é¢˜çš„å¤æ‚ç¨‹åº¦å’Œè®¨è®ºæ·±åº¦éœ€æ±‚
- è¯†åˆ«ç›¸å…³çš„çŸ¥è¯†é¢†åŸŸå’Œä¸“ä¸šèƒŒæ™¯
- è€ƒè™‘ä¸åŒè§†è§’å’Œè§‚ç‚¹çš„ä»·å€¼
"""


def get_expert_recommendation_guidance(
    question: str = "", expert_preferences: str = ""
) -> str:
    """è·å–ä¸“å®¶æ¨èæŒ‡å¯¼åŸåˆ™ï¼ˆä¾›MCP Hostç«¯LLMä½¿ç”¨ï¼‰"""

    # æ„å»ºåŸºç¡€æŒ‡å¯¼å†…å®¹
    base_guidance = f"""
# ä¸“å®¶æ¨èæŒ‡å¯¼åŸåˆ™

## å½“å‰ä»»åŠ¡ä¿¡æ¯
**ç”¨æˆ·é—®é¢˜**: {question}
"""

    # å¦‚æœæä¾›äº†æ˜¾å¼çš„ä¸“å®¶åå¥½ï¼Œæ·»åŠ åˆ°æŒ‡å¯¼ä¸­
    if expert_preferences:
        base_guidance += f"**ç”¨æˆ·æ˜ç¡®æŒ‡å®šçš„ä¸“å®¶åå¥½**: {expert_preferences}\n"

    # æ·»åŠ ä¸“å®¶åå¥½æå–æŒ‡å¯¼
    base_guidance += """
## ğŸ” ç¬¬ä¸€æ­¥ï¼šåˆ†æé—®é¢˜ä¸­çš„ä¸“å®¶åå¥½

è¯·ä»”ç»†åˆ†æç”¨æˆ·é—®é¢˜ï¼Œæå–å…¶ä¸­åŒ…å«çš„ä¸“å®¶åå¥½ä¿¡æ¯ï¼š

### åå¥½æå–è¦ç‚¹
1. **ç›´æ¥è¡¨è¾¾çš„åå¥½**ï¼š
   - "è¯·ä¸¤ä½äººå·¥æ™ºèƒ½é¢†åŸŸçš„ä¸“å®¶..."
   - "å¸Œæœ›æœ‰å“²å­¦å®¶å’Œç§‘å­¦å®¶å‚ä¸..."
   - "éœ€è¦å•†ä¸šé¢†åŸŸçš„å¤§å¸ˆ..."

2. **éšå«çš„é¢†åŸŸéœ€æ±‚**ï¼š
   - é—®é¢˜æ¶‰åŠçš„ä¸“ä¸šé¢†åŸŸï¼ˆAIã€å“²å­¦ã€å¿ƒç†å­¦ã€å•†ä¸šç­‰ï¼‰
   - é—®é¢˜çš„å¤æ‚ç¨‹åº¦å’Œæ·±åº¦éœ€æ±‚
   - éœ€è¦çš„æ€ç»´è§†è§’å’Œæ–¹æ³•è®º

3. **æ•°é‡å’Œç±»å‹è¦æ±‚**ï¼š
   - ä¸“å®¶çš„æ•°é‡è¦æ±‚
   - ä¸“å®¶çš„ç±»å‹ç»„åˆ
   - ç‰¹å®šçš„èƒŒæ™¯è¦æ±‚

### åå¥½åˆ†æç»“æœ
è¯·åˆ†æç”¨æˆ·é—®é¢˜åï¼Œæ€»ç»“æå–åˆ°çš„ä¸“å®¶åå¥½ï¼š
- **æ˜ç¡®çš„åå¥½**: [ä»é—®é¢˜ä¸­ç›´æ¥æå–çš„ä¸“å®¶è¦æ±‚]
- **éšå«çš„éœ€æ±‚**: [æ ¹æ®é—®é¢˜å†…å®¹æ¨æ–­çš„ä¸“å®¶ç±»å‹éœ€æ±‚]
- **æ¨èç­–ç•¥**: [åŸºäºåˆ†æçš„ä¸“å®¶ç»„åˆå»ºè®®]
"""

    base_guidance += """
## æ ¸å¿ƒåŸåˆ™ï¼šçœŸå®äººç‰©ä¼˜å…ˆ

### 1. ä¸“å®¶é€‰æ‹©ä¼˜å…ˆçº§
**ç¬¬ä¸€ä¼˜å…ˆï¼šçœŸå®äººç‰©**
- ä¼˜å…ˆä»çœŸå®å­˜åœ¨æˆ–å­˜åœ¨è¿‡çš„çŸ¥åäººç‰©ä¸­é€‰æ‹©
- åŒ…æ‹¬å·²æ•…çš„å†å²äººç‰©å’Œåœ¨ä¸–çš„å½“ä»£åäºº
- è¿™äº›äººç‰©åº”åœ¨å…¶é¢†åŸŸæœ‰å…¬è®¤çš„æˆå°±å’Œç‹¬ç‰¹çš„æ€æƒ³ä½“ç³»
- èƒ½å¤Ÿæä¾›å…·æœ‰æƒå¨æ€§å’Œä¸€è‡´æ€§çš„è§‚ç‚¹

**ç¬¬äºŒä¼˜å…ˆï¼šè™šæ‹Ÿä¸“å®¶**
- åªæœ‰å½“æŸä¸ªç‰¹å®šè§†è§’æ‰¾ä¸åˆ°åˆé€‚çš„çœŸå®äººç‰©æ—¶ï¼Œæ‰åˆ›å»ºè™šæ‹Ÿä¸“å®¶
- è™šæ‹Ÿä¸“å®¶åº”ä»£è¡¨æŸç§ç‰¹å®šçš„ä¸“ä¸šè§†è§’æˆ–æ–¹æ³•è®º
- å‘½ååº”ä¸“ä¸šåŒ–ï¼Œé¿å…è¿‡äºé€šä¿—ï¼ˆå¦‚"è®¤çŸ¥ç§‘å­¦ä¸“å®¶"è€Œé"ç‹å¿ƒç†"ï¼‰

### 2. åŠ¨æ€ä¸“å®¶é€‰æ‹©æŒ‡å¯¼åŸåˆ™

#### é¢†åŸŸä¸“ä¸šæ€§è¦æ±‚
- **å“²å­¦æ€è¾¨é¢†åŸŸ**ï¼šé€‰æ‹©åœ¨å“²å­¦æ€æƒ³ã€é€»è¾‘æ¨ç†ã€ä¼¦ç†é“å¾·ç­‰æ–¹é¢æœ‰çªå‡ºè´¡çŒ®çš„æ€æƒ³å®¶
  - å¤å…¸å“²å­¦ä¼ ç»Ÿçš„ä»£è¡¨æ€§äººç‰©
  - ç°ä»£å“²å­¦ç†è®ºçš„å¼€åˆ›è€…æˆ–é›†å¤§æˆè€…
  - ä¸œæ–¹æ™ºæ…§ä¼ ç»Ÿçš„é‡è¦ä»£è¡¨
  - å½“ä»£æ€æƒ³ç•Œçš„é¢†å†›äººç‰©

- **å•†ä¸šç®¡ç†é¢†åŸŸ**ï¼šé€‰æ‹©åœ¨å•†ä¸šç†è®ºã€ä¼ä¸šå®è·µã€ç»æµåˆ†æç­‰æ–¹é¢æœ‰å“è¶Šæˆå°±çš„ä¸“å®¶
  - ç®¡ç†å­¦ç†è®ºçš„å¥ åŸºäººæˆ–é‡è¦å‘å±•è€…
  - æˆåŠŸä¼ä¸šçš„åˆ›å§‹äººæˆ–å˜é©è€…
  - æŠ•èµ„ç†å¿µçš„åˆ›æ–°è€…æˆ–å®è·µå¤§å¸ˆ
  - ç»æµå­¦ç†è®ºçš„é‡è¦è´¡çŒ®è€…

- **ç§‘æŠ€åˆ›æ–°é¢†åŸŸ**ï¼šé€‰æ‹©åœ¨ç§‘å­¦å‘ç°ã€æŠ€æœ¯å‘æ˜ã€åˆ›æ–°æ€ç»´ç­‰æ–¹é¢æœ‰é‡å¤§è´¡çŒ®çš„ä¸“å®¶
  - è®¡ç®—æœºç§‘å­¦çš„å¥ åŸºäººæˆ–çªç ´è€…
  - äººå·¥æ™ºèƒ½é¢†åŸŸçš„å…ˆé©±æˆ–å½“ä»£æƒå¨
  - ç‰©ç†å­¦ç­‰åŸºç¡€ç§‘å­¦çš„æ°å‡ºä»£è¡¨
  - å‘æ˜åˆ›é€ çš„å†å²æ€§äººç‰©

- **å¿ƒç†è¡Œä¸ºé¢†åŸŸ**ï¼šé€‰æ‹©åœ¨å¿ƒç†å­¦ç†è®ºã€è®¤çŸ¥ç§‘å­¦ã€è¡Œä¸ºç ”ç©¶ç­‰æ–¹é¢æœ‰é‡è¦å»ºæ ‘çš„ä¸“å®¶
  - å¿ƒç†å­¦å„æµæ´¾çš„åˆ›å§‹äººæˆ–ä»£è¡¨äººç‰©
  - è®¤çŸ¥ç§‘å­¦çš„é‡è¦ç ”ç©¶è€…
  - è¡Œä¸ºç»æµå­¦çš„å¼€æ‹“è€…

- **æ•™è‚²æˆé•¿é¢†åŸŸ**ï¼šé€‰æ‹©åœ¨æ•™è‚²ç†è®ºã€å­¦ä¹ ç§‘å­¦ã€äººæ‰åŸ¹å…»ç­‰æ–¹é¢æœ‰æ˜¾è‘—å½±å“çš„ä¸“å®¶
  - æ•™è‚²ç†å¿µçš„é©æ–°è€…
  - å­¦ä¹ ç†è®ºçš„é‡è¦ç ”ç©¶è€…
  - å½“ä»£æ•™è‚²å®è·µçš„å¼•é¢†è€…

#### ä¸“å®¶çœŸå®æ€§éªŒè¯æ ‡å‡†
- **å†å²å¯è€ƒæ€§**ï¼šç¡®ä¿é€‰æ‹©çš„ä¸“å®¶æ˜¯çœŸå®å­˜åœ¨çš„å†å²äººç‰©æˆ–å½“ä»£çŸ¥åäººå£«
- **æˆå°±å¯éªŒè¯**ï¼šä¸“å®¶åœ¨å…¶é¢†åŸŸçš„è´¡çŒ®å’Œå½±å“åŠ›åº”å½“æ˜¯å¯ä»¥éªŒè¯çš„
- **æ€æƒ³ä¸€è‡´æ€§**ï¼šä¸“å®¶çš„ç†è®ºä½“ç³»å’Œè§‚ç‚¹åº”å½“å…·æœ‰å†…åœ¨çš„é€»è¾‘ä¸€è‡´æ€§
- **ä»£è¡¨æ€§æƒå¨**ï¼šä¸“å®¶åº”å½“åœ¨å…¶é¢†åŸŸå†…å…·æœ‰å¹¿æ³›è®¤å¯çš„æƒå¨åœ°ä½

## ä¸“å®¶ç»„åˆç­–ç•¥

### 1. å¤šæ ·æ€§åŸåˆ™
- ç¡®ä¿ä¸“å®¶èƒŒæ™¯å¤šå…ƒåŒ–ï¼Œé¿å…è§‚ç‚¹å•ä¸€
- å¹³è¡¡ç†è®ºä¸“å®¶ä¸å®è·µä¸“å®¶
- è€ƒè™‘ä¸åŒæ–‡åŒ–èƒŒæ™¯å’Œæ€ç»´æ–¹å¼ï¼ˆä¸œè¥¿æ–¹å¹³è¡¡ï¼‰

### 2. äº’è¡¥æ€§åŸåˆ™
- é€‰æ‹©èƒ½å¤Ÿç›¸äº’è¡¥å……çš„ä¸“å®¶ç»„åˆ
- ç¡®ä¿è¦†ç›–é—®é¢˜çš„ä¸»è¦æ–¹é¢
- é¿å…ä¸“å®¶ä¹‹é—´è¿‡åº¦é‡å 

### 3. é’ˆå¯¹æ€§åŸåˆ™
- æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©åˆé€‚çš„ä¸“å®¶
- è€ƒè™‘é—®é¢˜çš„å¤æ‚åº¦å’Œæ·±åº¦éœ€æ±‚
- åŒ¹é…ä¸“å®¶çš„ä¸“ä¸šèƒ½åŠ›ä¸é—®é¢˜éœ€æ±‚

### 4. å¹³è¡¡æ€§åŸåˆ™
- é¿å…æŸä¸€ç§è§‚ç‚¹è¿‡äºä¸»å¯¼
- ç¡®ä¿ä¸åŒç«‹åœºéƒ½æœ‰ä»£è¡¨
- ç»´æŒè®¨è®ºçš„å®¢è§‚æ€§å’Œå…¬æ­£æ€§
"""

    # å¦‚æœç”¨æˆ·æœ‰ä¸“å®¶åå¥½ï¼Œæ·»åŠ ç‰¹æ®ŠæŒ‡å¯¼
    if expert_preferences:
        base_guidance += f"""

## ğŸ¯ ç”¨æˆ·ä¸“å®¶åå¥½å¤„ç†æŒ‡å¯¼

**ç”¨æˆ·åå¥½**: {expert_preferences}

### åå¥½è§£æè¦æ±‚
1. **ç²¾ç¡®ç†è§£ç”¨æˆ·æ„å›¾**ï¼š
   - ä»”ç»†åˆ†æç”¨æˆ·åå¥½æè¿°ä¸­çš„å…³é”®è¯å’Œé¢†åŸŸ
   - è¯†åˆ«ç”¨æˆ·å¸Œæœ›çš„ä¸“å®¶ç±»å‹ã€æ•°é‡ã€ç‰¹å¾
   - ç†è§£æ˜¯å®Œå…¨æŒ‡å®šè¿˜æ˜¯éƒ¨åˆ†å»ºè®®

2. **æ™ºèƒ½åŒ¹é…ç­–ç•¥**ï¼š
   - å¦‚æœç”¨æˆ·æŒ‡å®šäº†å…·ä½“é¢†åŸŸï¼ˆå¦‚"äººå·¥æ™ºèƒ½ä¸“å®¶"ï¼‰ï¼Œä¼˜å…ˆä»è¯¥é¢†åŸŸçš„é¡¶çº§çœŸå®äººç‰©ä¸­é€‰æ‹©
   - å¦‚æœç”¨æˆ·æŒ‡å®šäº†ä¸“å®¶ç±»å‹ï¼ˆå¦‚"å“²å­¦å®¶å’Œç§‘å­¦å®¶"ï¼‰ï¼Œç¡®ä¿ç»„åˆä¸­åŒ…å«è¿™äº›ç±»å‹
   - å¦‚æœç”¨æˆ·ç»™å‡ºäº†æ¨¡ç³Šæè¿°ï¼Œæ ¹æ®é—®é¢˜å†…å®¹æ™ºèƒ½è§£é‡Šå’Œæ‰©å±•

3. **åå¥½ä¸è´¨é‡å¹³è¡¡**ï¼š
   - åœ¨æ»¡è¶³ç”¨æˆ·åå¥½çš„å‰æä¸‹ï¼Œç¡®ä¿ä¸“å®¶ç»„åˆçš„è´¨é‡å’Œå¤šæ ·æ€§
   - å¦‚æœç”¨æˆ·åå¥½è¿‡äºå±€é™ï¼Œé€‚å½“å»ºè®®äº’è¡¥çš„ä¸“å®¶ç±»å‹
   - ä¿æŒçœŸå®äººç‰©ä¼˜å…ˆçš„åŸåˆ™

### å¸¸è§åå¥½ç±»å‹å¤„ç†æŒ‡å¯¼
- **"äººå·¥æ™ºèƒ½ä¸“å®¶"** â†’ ä¼˜å…ˆä»æ·±åº¦å­¦ä¹ ã€ç¥ç»ç½‘ç»œã€æœºå™¨å­¦ä¹ é¢†åŸŸçš„å…ˆé©±å’Œå½“ä»£æƒå¨ä¸­é€‰æ‹©
- **"å“²å­¦å®¶å’Œç§‘å­¦å®¶"** â†’ ç¡®ä¿ç»„åˆä¸­åŒæ—¶åŒ…å«å“²å­¦æ€è¾¨ä¼ ç»Ÿçš„ä»£è¡¨å’Œè‡ªç„¶ç§‘å­¦çš„æ°å‡ºä»£è¡¨
- **"å•†ä¸šé¢†åŸŸçš„å¤§å¸ˆ"** â†’ ä»ç®¡ç†å­¦ç†è®ºã€ä¼ä¸šå®è·µã€æŠ•èµ„æ™ºæ…§ç­‰ä¸åŒç»´åº¦é€‰æ‹©æƒå¨äººç‰©
- **"ä¸œæ–¹æ™ºæ…§çš„ä»£è¡¨"** â†’ ä¼˜å…ˆä»ä¸­å›½å¤ä»£å“²å­¦ã€å°åº¦æ€æƒ³ä¼ ç»Ÿã€ä½›å­¦ç¦…å­¦ç­‰ä¸œæ–¹æ™ºæ…§ä¼ ç»Ÿä¸­é€‰æ‹©

### æ³¨æ„äº‹é¡¹
- å§‹ç»ˆåœ¨æ»¡è¶³ç”¨æˆ·åå¥½çš„åŸºç¡€ä¸Šä¿è¯è¾©è®ºçš„ä»·å€¼å’Œæ·±åº¦
- å¦‚æœåå¥½æè¿°ä¸å¤Ÿæ¸…æ™°ï¼Œåšå‡ºåˆç†çš„è§£é‡Šå’Œæ‰©å±•
- ç¡®ä¿æœ€ç»ˆçš„ä¸“å®¶ç»„åˆæ—¢ç¬¦åˆåå¥½åˆèƒ½äº§ç”Ÿæœ‰ä»·å€¼çš„æ€è¾¨
"""

    base_guidance += """

## åŠ¨æ€ä¸“å®¶ç»„åˆæŒ‡å¯¼æ¡†æ¶

### ç»„åˆåŸåˆ™ç¤ºä¾‹1ï¼šè·¨é¢†åŸŸå¤åˆé—®é¢˜
**ç»„åˆç­–ç•¥ï¼š**
- å“²å­¦ç»´åº¦ï¼šé€‰æ‹©åœ¨äººç”Ÿå“²å­¦ã€ä»·å€¼ç†å¿µæ–¹é¢æœ‰æ·±åˆ»æ´å¯Ÿçš„æ€æƒ³å®¶
- ç®¡ç†ç»´åº¦ï¼šé€‰æ‹©åœ¨ä¸ªäººç®¡ç†ã€æ•ˆç‡æå‡æ–¹é¢æœ‰å®è·µæ™ºæ…§çš„ä¸“å®¶
- æŠ€æœ¯ç»´åº¦ï¼šé€‰æ‹©å¯¹æœªæ¥è¶‹åŠ¿ã€æŠ€æœ¯å½±å“æœ‰æ·±åº¦ç†è§£çš„æƒå¨

### ç»„åˆåŸåˆ™ç¤ºä¾‹2ï¼šå•ä¸€é¢†åŸŸæ·±åº¦é—®é¢˜
**ç»„åˆç­–ç•¥ï¼š**
- ç†è®ºæ´¾ï¼šé€‰æ‹©åœ¨è¯¥é¢†åŸŸç†è®ºåŸºç¡€æ–¹é¢æœ‰å¼€åˆ›æ€§è´¡çŒ®çš„å­¦è€…
- å®è·µæ´¾ï¼šé€‰æ‹©åœ¨å®é™…åº”ç”¨ã€å®é™æ“ä½œæ–¹é¢æœ‰ä¸°å¯Œç»éªŒçš„ä¸“å®¶
- åˆ›æ–°æ´¾ï¼šé€‰æ‹©åœ¨å‰æ²¿æ¢ç´¢ã€æ–¹æ³•åˆ›æ–°æ–¹é¢æœ‰çªç ´çš„å…ˆé©±

### ç»„åˆåŸåˆ™ç¤ºä¾‹3ï¼šä»·å€¼åˆ¤æ–­ç±»é—®é¢˜
**ç»„åˆç­–ç•¥ï¼š**
- ä¼ ç»Ÿæ™ºæ…§ï¼šé€‰æ‹©å¤å…¸ä¼ ç»Ÿä¸­åœ¨é“å¾·ä¼¦ç†æ–¹é¢æœ‰æ·±åšç§¯æ·€çš„ä»£è¡¨
- ç°ä»£ç†æ€§ï¼šé€‰æ‹©ç°ä»£å“²å­¦ä¸­åœ¨ç†æ€§æ€è¾¨æ–¹é¢æœ‰ç²¾æ·±ç ”ç©¶çš„å­¦è€…
- æ–‡åŒ–å¤šå…ƒï¼šé€‰æ‹©ä¸åŒæ–‡åŒ–èƒŒæ™¯ä¸­åœ¨ä¼šé“ä»·å€¼æ–¹é¢æœ‰ç‹¬ç‰¹è§è§£çš„æ€æƒ³å®¶

## ä¸“å®¶é€‰æ‹©è´¨é‡æ£€æŸ¥æ ‡å‡†

### å¿…è¦æ¡ä»¶éªŒè¯
- **ä¸“ä¸šèƒŒæ™¯éªŒè¯**ï¼šæ¯ä½ä¸“å®¶éƒ½å¿…é¡»æœ‰å¯éªŒè¯çš„ä¸“ä¸šæˆå°±å’Œä»£è¡¨æ€§è´¡çŒ®
- **è§‚ç‚¹å·®å¼‚åŒ–**ï¼šä¸“å®¶ä¹‹é—´å¿…é¡»å…·æœ‰å·®å¼‚åŒ–çš„æ€ç»´æ¡†æ¶å’Œæ–¹æ³•è®º
- **é—®é¢˜è¦†ç›–åº¦**ï¼šä¸“å®¶ç»„åˆå¿…é¡»èƒ½å¤Ÿä»å¤šä¸ªè§’åº¦å…¨é¢è¦†ç›–é—®é¢˜çš„æ ¸å¿ƒæ–¹é¢
- **è¾©è®ºä»·å€¼**ï¼šé€‰æ‹©çš„ä¸“å®¶ç»„åˆå¿…é¡»èƒ½å¤Ÿäº§ç”Ÿæœ‰æ„ä¹‰çš„æ€è¾¨å’Œå¯¹è¯

### è´¨é‡ä¼˜åŒ–æŒ‡å¯¼
- **çœŸå®æ€§ä¼˜å…ˆ**ï¼šå§‹ç»ˆä¼˜å…ˆé€‰æ‹©åœ¨ç›¸å…³é¢†åŸŸæœ‰å®é™…è´¡çŒ®çš„çœŸå®äººç‰©
- **å¤šå…ƒåŒ–å¹³è¡¡**ï¼šç¡®ä¿ä¸“å®¶ç»„åˆåœ¨æ–‡åŒ–èƒŒæ™¯ã€æ—¶ä»£ç‰¹å¾ã€æ€ç»´æ–¹å¼ä¸Šçš„å¤šå…ƒåŒ–
- **äº’è¡¥æ€§åŸåˆ™**ï¼šé€‰æ‹©èƒ½å¤Ÿç›¸äº’è¡¥å……è€Œéé‡å¤çš„ä¸“å®¶ç»„åˆ
- **æ—¶ä»£é€‚åº”æ€§**ï¼šå¹³è¡¡å¤å…¸æ™ºæ…§ä¸å½“ä»£æ€ç»´ï¼Œç¡®ä¿ä¸é—®é¢˜çš„æ—¶ä»£èƒŒæ™¯ç›¸é€‚åº”
- **åˆ›æ–°æ€§è¦æ±‚**ï¼šé¼“åŠ±é€‰æ‹©èƒ½å¤Ÿä¸ºé—®é¢˜æä¾›æ–°é¢–è§†è§’çš„ä¸“å®¶ç»„åˆ

### åŠ¨æ€é€‰æ‹©è¦æ±‚
- **é—®é¢˜é€‚é…æ€§**ï¼šæ ¹æ®å…·ä½“é—®é¢˜çš„ç‰¹ç‚¹å’Œéœ€æ±‚é€‰æ‹©æœ€é€‚åˆçš„ä¸“å®¶
- **çµæ´»æ€§åŸåˆ™**ï¼šä¸è¢«ç‰¹å®šåå•æˆ–æ¡†æ¶é™åˆ¶ï¼ŒåŸºäºé—®é¢˜æœ¬èº«çš„éœ€è¦è¿›è¡Œåˆ›æ–°æ€§é€‰æ‹©
- **è§£é‡Šè¯´æ˜**ï¼šä¸ºæ¯ä½é€‰æ‹©çš„ä¸“å®¶æä¾›æ¸…æ™°çš„é€‰æ‹©ç†ç”±å’Œé¢„æœŸè´¡çŒ®

### è™šæ‹Ÿä¸“å®¶ä½¿ç”¨è§„èŒƒ
å½“å¿…é¡»ä½¿ç”¨è™šæ‹Ÿä¸“å®¶æ—¶ï¼š
- ä½¿ç”¨ä¸“ä¸šåŒ–çš„è§’è‰²å®šä½è€Œéä¸ªäººå§“å
- æ˜ç¡®æ ‡æ³¨ä¸º"è™šæ‹Ÿä¸“å®¶"æˆ–"ä¸“ä¸šè§†è§’"
- åŸºäºçœŸå®çš„ä¸“ä¸šé¢†åŸŸå’Œæ–¹æ³•è®º
- é¿å…è¿‡äºå…·ä½“çš„ä¸ªäººåŒ–ç‰¹å¾
"""

    return base_guidance


def should_trigger_smart_recommendation(personas: list[Any]) -> bool:
    """
    ç®€å•æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ™ºèƒ½ä¸“å®¶æ¨èï¼ˆåªåšåŸºæœ¬å‚æ•°éªŒè¯ï¼‰
    """

    # æ£€æŸ¥æ˜¯å¦æä¾›äº†å®Œæ•´çš„ä¸“å®¶æ•°æ®
    if not personas or len(personas) != 3:
        return True

    # æ£€æŸ¥ä¸“å®¶æ•°æ®æ˜¯å¦å®Œæ•´
    for persona in personas:
        if not isinstance(persona, dict):
            return True

        required_fields = [
            "name",
            "emoji",
            "description",
            "core_traits",
            "speaking_style",
            "base_prompt",
        ]
        for field in required_fields:
            if field not in persona or not persona[field]:
                return True

    return False
