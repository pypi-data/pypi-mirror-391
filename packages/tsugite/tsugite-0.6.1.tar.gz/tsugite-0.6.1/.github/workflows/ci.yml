name: CI

on:
  push:
  pull_request:

jobs:
  install-and-test:
    name: Install and test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[dronecan]" pytest pytest-cov

      - name: Run pytest
        run: |
          pytest -v tests --maxfail=3 --disable-warnings

      # === Coverage & badge update (only on ubuntu) ===
      - name: Run pytest with coverage
        if: matrix.os == 'ubuntu-latest'
        run: |
          pytest tests/ --cov=tsugite --cov-report=xml --cov-report=term-missing

      - name: Extract coverage percent
        if: matrix.os == 'ubuntu-latest'
        id: cov
        run: |
          value=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1)
          percent=$(awk "BEGIN {printf \"%.0f\", $value * 100}")
          echo "coverage=$percent" >> $GITHUB_OUTPUT

      - name: Update coverage gist
        if: matrix.os == 'ubuntu-latest'
        env:
          GIST_ID: 20c5b223bf0056aa734fec26e21d939d
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          COVERAGE="${{ steps.cov.outputs.coverage }}%"
          CONTENT="{\"coverage\": \"${COVERAGE}\"}"
          JSON_PAYLOAD=$(jq -nc --arg content "$CONTENT" \
            '{files: {"coverage.json": {content: $content}}}')
          curl -s -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.github.com/gists/$GIST_ID"

  pylint:
    name: Pylint on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint

      - name: Run pylint
        run: |
          pylint src/tsugite/backend/registry.py src/tsugite/utils.py
