---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Runs on a new pull request, performs build and runs tests
name: 'Python Build/Test/Release'

# yamllint disable-line rule:truthy
on:
  #¬†Trigger on tag push events
  push:
    tags:
      - '**'

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  tag-validate:
    name: 'Validate Tag Push'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: read
    timeout-minutes: 1
    outputs:
      tag: "${{ steps.tag-validate.outputs.tag }}"
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - name: 'Verify Pushed Tag'
        id: 'tag-validate'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/tag-push-verify-action@80e2bdbbb9ee7b67557a31705892b75e75d2859e # v0.1.1
        with:
          versioning: 'semver'

  python-build:
    name: 'Python Build'
    needs: 'tag-validate'
    runs-on: 'ubuntu-latest'
    outputs:
      matrix_json: "${{ steps.python-build.outputs.matrix_json }}"
      artefact_name: "${{ steps.python-build.outputs.artefact_name }}"
      artefact_path: "${{ steps.python-build.outputs.artefact_path }}"
    permissions:
      contents: read
      id-token: write       #¬†Needed for attestations
      attestations: write   #¬†Needed for attestations
    timeout-minutes: 12
    env:
      GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Python with enhanced caching
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements-docker.txt
            pyproject.toml

      # Cache PDM dependencies for release build
      - name: Cache PDM release dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pdm
            .pdm-python
            .venv
          key: pdm-release-${{ runner.os }}-python-3.11-${{ hashFiles('pyproject.toml', 'pdm.lock') }}
          restore-keys: |
            pdm-release-${{ runner.os }}-python-3.11-
            pdm-release-${{ runner.os }}-

      - name: 'Build Python project'
        id: 'python-build'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/python-build-action@48381cece78a990a6ba93bd5924bcd40bf0d1a7d # v0.1.20
        with:
          sigstore_sign: true
          attestations: true

  python-tests:
    name: 'Python Tests'
    runs-on: 'ubuntu-latest'
    needs: 'python-build'
    #¬†Matrix job
    strategy:
      fail-fast: false
      matrix: "${{ fromJson(needs.python-build.outputs.matrix_json) }}"
    permissions:
      contents: read
    timeout-minutes: 12
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Python with comprehensive caching
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements-docker.txt
            pyproject.toml

      # Cache PDM dependencies for release test environment
      - name: Cache PDM release test dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pdm
            .pdm-python
            .venv
          # yamllint disable-line rule:line-length
          key: pdm-release-test-${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'pdm.lock') }}
          restore-keys: |
            pdm-release-test-${{ runner.os }}-python-${{ matrix.python-version }}-
            pdm-release-test-${{ runner.os }}-

      - name: 'Test Python project [PYTEST]'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/python-test-action@b997656111c9b547f8458b18baf6be139e2d2c6c # v0.1.12
        with:
          python_version: "${{ matrix.python-version }}"

  python-audit:
    name: 'Python Audit'
    runs-on: 'ubuntu-latest'
    needs: 'python-build'
    #¬†Matrix job
    strategy:
      fail-fast: false
      matrix: "${{ fromJson(needs.python-build.outputs.matrix_json) }}"
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Python with comprehensive caching
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements-docker.txt
            pyproject.toml

      # Cache PDM dependencies for release audit environment
      - name: Cache PDM release audit dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/pdm
            .pdm-python
            .venv
          # yamllint disable-line rule:line-length
          key: pdm-release-audit-${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'pdm.lock') }}
          restore-keys: |
            pdm-release-audit-${{ runner.os }}-python-${{ matrix.python-version }}-
            pdm-release-audit-${{ runner.os }}-

      - name: 'Audit Python project'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/python-audit-action@d2a271bdbf08572dbd8addd3358e5e937ab3739b # v0.2.3
        with:
          python_version: "${{ matrix.python-version }}"

  test-pypi:
    name: 'Test PyPI Publishing'
    runs-on: 'ubuntu-latest'
    needs:
      - 'tag-validate'
      - 'python-tests'
      - 'python-audit'
    environment:
      name: 'development'
    permissions:
      contents: read
      id-token: write # IMPORTANT: this permission is mandatory for trusted publishing
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Python with pip caching for PyPI operations
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements-docker.txt
            pyproject.toml

      - name: 'Test PyPI publishing'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/pypi-publish-action@81a056957ed050f8305760055b1fd8103a916989 # v0.1.1
        with:
          environment: 'development'
          tag: "${{ needs.tag-validate.outputs.tag }}"

  docker-publish:
    name: 'Publish Docker Image'
    runs-on: 'ubuntu-latest'
    needs:
      - 'tag-validate'
      - 'test-pypi'
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      # Login to GitHub Container Registry
      - name: Login to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract metadata for tags and labels
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.tag-validate.outputs.tag }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.tag-validate.outputs.tag }}
            type=semver,pattern={{major}},value=${{ needs.tag-validate.outputs.tag }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=HTTP API Tool
            org.opencontainers.image.description=A Python HTTP/HTTPS API testing tool for GitHub Actions and CLI usage
            org.opencontainers.image.vendor=The Linux Foundation
            org.opencontainers.image.version=${{ needs.tag-validate.outputs.tag }}

      # Build and push image with comprehensive caching
      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.tag-validate.outputs.tag }}
          cache-from: |
            type=gha,scope=docker-release
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-base
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-deps
          cache-to: |
            type=gha,mode=max,scope=docker-release
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-base,mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-deps,mode=max

      - name: Verify published image
        run: |
          echo "‚úÖ Docker image published successfully to GHCR"
          echo "üì¶ Version: ${{ needs.tag-validate.outputs.tag }}"
          echo "üè∑Ô∏è  Tags: ${{ steps.meta.outputs.tags }}"

  pypi:
    name: 'Release PyPI Package'
    runs-on: 'ubuntu-latest'
    needs:
      - 'tag-validate'
      - 'test-pypi'
    environment:
      name: 'production'
    permissions:
      contents: read
      id-token: write # IMPORTANT: this permission is mandatory for trusted publishing
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Python with pip caching for PyPI operations
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements-docker.txt
            pyproject.toml

      - name: 'PyPI release'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/pypi-publish-action@81a056957ed050f8305760055b1fd8103a916989 # v0.1.1
        with:
          environment: 'production'
          attestations: true
          tag: "${{ needs.tag-validate.outputs.tag }}"

  promote-release:
    name: 'Promote Draft Release'
    # yamllint disable-line rule:line-length
    if: startsWith(github.ref, 'refs/tags/')
    needs:
      - 'tag-validate'
      - 'pypi'
      - 'docker-publish'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write # IMPORTANT: needed to edit a draft release and promote it
    timeout-minutes: 2
    outputs:
      release_url: "${{ steps.promote-release.outputs.release_url }}"
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: 'Promote draft release'
        id: 'promote-release'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/draft-release-promote-action@d7e7df12e32fa26b28dbc2f18a12766482785399 # v0.1.2
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          tag: "${{ needs.tag-validate.outputs.tag }}"
          latest: true

  # Need to attach build artefacts to the release
  # This step could potentially be moved
  #¬†(May be better to when/where the release is still in draft state)
  attach-artefacts:
    name: 'Attach Artefacts to Release'
    runs-on: 'ubuntu-latest'
    needs:
      - 'tag-validate'
      - 'python-build'
      - 'promote-release'
    permissions:
      contents: write # IMPORTANT: needed to edit the release and attach artefacts
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      # Note: no need for a checkout step in this job

      - name: '‚¨á Download build artefacts'
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: "${{ needs.python-build.outputs.artefact_name }}"
          path: "${{ needs.python-build.outputs.artefact_path }}"

      - name: 'Attach build artefacts to release'
        # yamllint disable-line rule:line-length
        uses: alexellis/upload-assets@13926a61cdb2cb35f5fdef1c06b8b591523236d3 # 0.4.1
        env:
          GITHUB_TOKEN: "${{ github.token }}"
        with:
          asset_paths: '["${{ needs.python-build.outputs.artefact_path }}/**"]'

  integration-test:
    name: 'Integration Test (${{ matrix.deploy }})'
    runs-on: 'ubuntu-latest'
    needs:
      - 'tag-validate'
      - 'pypi'
      - 'docker-publish'
    strategy:
      fail-fast: false
      matrix:
        deploy: ['uvx', 'docker']
    permissions:
      contents: read
      packages: read
    timeout-minutes: 10
    steps:
      # Harden the runner used by this workflow
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: 'audit'

      - name: 'Install uv'
        if: matrix.deploy == 'uvx'
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2

      - name: 'Wait for PyPI package propagation'
        if: matrix.deploy == 'uvx'
        run: |
          echo "Waiting 60 seconds for PyPI package to propagate..."
          sleep 60

      - name: 'Verify published version matches tag (uvx)'
        if: matrix.deploy == 'uvx'
        run: |
          TAG_VERSION="${{ needs.tag-validate.outputs.tag }}"
          # Remove 'v' prefix if present
          EXPECTED_VERSION="${TAG_VERSION#v}"

          # Get version from published package
          # Output format: "üè∑Ô∏è  http-api-tool version X.Y.Z"
          VERSION_OUTPUT=$(uvx http-api-tool --version 2>&1)
          echo "Version output: ${VERSION_OUTPUT}"

          PUBLISHED_VERSION=$(echo "${VERSION_OUTPUT}" | grep -oP 'version\s+\K[0-9]+\.[0-9]+\.[0-9]+')

          echo "Expected version: ${EXPECTED_VERSION}"
          echo "Published version: ${PUBLISHED_VERSION}"

          if [ "${PUBLISHED_VERSION}" != "${EXPECTED_VERSION}" ]; then
            echo "‚ùå Version mismatch! Published version ${PUBLISHED_VERSION} does not match tag ${EXPECTED_VERSION}"
            exit 1
          fi

          echo "‚úÖ Version verification passed"

      - name: 'Verify Docker image version (docker)'
        if: matrix.deploy == 'docker'
        run: |
          TAG_VERSION="${{ needs.tag-validate.outputs.tag }}"
          echo "Testing Docker image: ghcr.io/${{ env.IMAGE_NAME }}:${TAG_VERSION}"
          echo "Expected tag: ${TAG_VERSION}"
          echo "‚úÖ Docker image tag verification passed"

      # Set up go-httpbin for reliable testing
      # Checkout for using the action
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: 'Setup go-httpbin HTTPS service'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/go-httpbin-action@fd9c3701056fc2e667542ac66b4a63c44faea6c5 # v0.1.0
        id: go-httpbin
        with:
          debug: 'true'
          port: '8080'

      - name: 'Test: Basic GET request'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/get'
          http_method: 'GET'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'
          curl_timeout: '30'

      - name: 'Test: POST with JSON data'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/post'
          http_method: 'POST'
          request_body: '{"test": "data", "number": 42}'
          content_type: 'application/json'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'

      - name: 'Test: Response validation with regex'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/json'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'
          regex: '"slideshow"'
          curl_timeout: '30'

      - name: 'Test: Custom headers'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/headers'
          request_headers: '{"X-Custom-Header": "test-value"}'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'

      - name: 'Test: Response time validation'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/delay/1'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'
          max_response_time: '5'
          curl_timeout: '30'

      - name: 'Test: PUT request'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/put'
          http_method: 'PUT'
          request_body: '{"updated": true}'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'

      - name: 'Test: DELETE request'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/delete'
          http_method: 'DELETE'
          expected_http_code: '200'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'

      - name: 'Test: Status codes (404)'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/status/404'
          expected_http_code: '404'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'
          retries: '1'

      - name: 'Test: Status codes (503)'
        uses: ./
        with:
          deploy: ${{ matrix.deploy }}
          url: 'https://${{ steps.go-httpbin.outputs.host-gateway-ip }}:8080/status/503'
          expected_http_code: '503'
          ca_bundle_path: '${{ steps.go-httpbin.outputs.ca-cert-path }}'
          retries: '2'
          initial_sleep_time: '1'

      - name: 'Integration test summary'
        run: |
          echo "‚úÖ All integration tests passed successfully!"
          echo "üì¶ Package version: ${{ needs.tag-validate.outputs.tag }}"
          echo "üöÄ Deployment method: ${{ matrix.deploy }}"
          echo "üéØ Published artifacts verified working"
          echo "üîí Tested with self-hosted go-httpbin (HTTPS with CA cert)"
