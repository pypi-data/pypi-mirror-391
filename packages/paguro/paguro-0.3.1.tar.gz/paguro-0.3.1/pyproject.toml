[build-system]
requires = ["setuptools >= 62", "wheel", "setuptools_scm[toml] >= 6.2"]

[project]
name = "paguro"
authors = [{ name = "Bernardo Dionisi", email = "bernardo.dionisi@gmail.com" }]
description = "Data validation and manipulation using Polars"
readme = "README.md"
license = { text = "Apache-2.0" }
keywords = [
    "data science",
    "data quality",
    "data engineering",
    "polars",
    "metadata",
    "validation",
    "summary statistics",
    "deferred pipelines",
]

classifiers = [
    "Topic :: Software Development :: Libraries :: Python Modules",
    "License :: OSI Approved :: Apache Software License",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "Operating System :: OS Independent",
]
requires-python = ">=3.10"
dependencies = [
    "polars >= 1.32.0",
    "typing_extensions>= 4.0.0; python_version < '3.11'", # Self, Unpack (Python 3.11+)
]
dynamic = ["version"]

[project.optional-dependencies]
extra = [
    "numpy >= 1.23.0",
    "rich",
]
test = [
    "pytest",
    "pytest-cov",
    "pytest-xdist",
    "nox",
]
lint = [
    "ruff == 0.9.2",
]
typing = [
    "mypy",
]
docs = [
    "sphinx-tutorials == 0.0.7",
]

[project.urls]
Homepage = "https://github.com/bernardodionisi/paguro"
Source = "https://github.com/bernardodionisi/paguro"
Issues = "https://github.com/bernardodionisi/paguro/issues"
Documentation = "https://bernardodionisi.github.io/paguro/latest/"

[tool.setuptools_scm]
write_to = "src/paguro/_version.py"

[tool.setuptools.packages.find]
where = ["src"]

[tool.setuptools.package-data]
"paguro.datasets.data" = ["*.csv", "*.parquet", "post/*.csv", "post/*.parquet"]

[tool.distutils.bdist_wheel]
universal = false

# ---------- tests

[tool.pytest.ini_options]
minversion = "6.2"
addopts = "-s --showlocals"
testpaths = ["tests"]

# ---------- coverage

[tool.coverage.run]
source = ["paguro"]
branch = true
omit = [
    "**/paguro/_version.py",
    "**/paguro/typing.py",
    "**/paguro/ashi/**", # todo: include ashi in testing
    "**/paguro/shared/_getattr/**", # todo: include _getattr in testing

]

[tool.coverage.report]
fail_under = 40  # goal 85 at least
skip_covered = true
show_missing = true
sort = "-Cover"
exclude_lines = [
    "pragma: no cover",
    "@overload",
    "except ImportError",
    "if TYPE_CHECKING:",
    "from typing_extensions import ",
]


# ---------- mypy


[tool.mypy]
python_version = "3.10"
files = ["src"]
exclude = "src/paguro/shared/_getattr"
strict = false
#check_untyped_defs = false
#disallow_untyped_defs = false

[[tool.mypy.overrides]]
module = [
    "polars.*",
    "numpy.*",
    "pyarrow.*",
    "rich.*",
    "deltalake",
    "jax",
    "pyiceberg",
    "pyiceberg.*",
    "xlsxwriter.*",
    "rapidfuzz",
    "rapidfuzz.*",
]
ignore_missing_imports = true

# --------- linting/formatting

[tool.ruff]
line-length = 75
fix = true
exclude = [
    "src/paguro/shared/_getattr/", # do not include _getattr in linting/formatting
    "src/paguro/ashi/", # todo: include ashi in lint/format

    "tutorials",
    "docs",
    "tests",
]

# ruff settings are adapted from polars to standardize formatting/linting
[tool.ruff.lint]
select = [
    "ANN", # flake8-annotations
    "B", # flake8-bugbear
    "C4", # flake8-comprehensions
    "D", # flake8-docstrings
    "D417", # undocumented-param
    "E", # pycodestyle
    "EM", # flake8-errmsg
    "F", # pyflakes
    "FA", # flake8-future-annotations
    "FBT001", # flake8-boolean-trap
    "I", # isort
    "ICN", # flake8-import-conventions
    "INT", # flake8-gettext
    "PERF", # perflint
    "PIE", # flake8-pie
    "PT", # flake8-pytest-style
    "PTH", # flake8-use-pathlib
    "PYI", # flake8-pyi
    "RUF", # ruff-specific rules
    "SIM", # flake8-simplify
    "TCH", # flake8-type-checking
    "TD", # flake8-todos
    "TID", # flake8-tidy-imports
    "TRY", # tryceratops
    "UP", # pyupgrade
    "W", # pycodestyle
]
ignore = [
    # ------------------------------------------------------------------
    "D100", # Missing docstring in public module
    "D104", # Missing docstring in public package
    "D105", # Missing docstring in magic method
    # ------------------------------------------------------------------
    "ANN401", # Dynamically typed expressions (Any) are disallowed
    "D401", # Relax NumPy docstring convention: first line should be imperative
    "E501", # Line length regulated by formatter
    "ICN001", #`package` should be imported as `pkg`
    "PT011", # pytest.raises is too broad, set match or use a more specific exception
    "PYI041", # Use float instead of int | float
    "RUF022", # `__all__` is not sorted
    "RUF005", # Consider expression instead of concatenation
    "SIM102", # Use a single `if` statement instead of nested `if` statements
    "SIM108", # Use ternary operator
    "SIM114", # Combine `if` branches
    "TD002", # Missing author in TODO
    "TD003", # Missing issue link on the line following this TODO
    "TRY003", # Avoid specifying long messages outside the exception class
]
allowed-confusables = ["Âµ"]

[tool.ruff.lint.isort]
required-imports = ["from __future__ import annotations"]

[tool.ruff.lint.per-file-ignores]
"utils/_dependencies.py" = ["ICN001"]
"tests/**/*.py" = ["D100", "D102", "D103", "B018", "FBT001"]

[tool.ruff.lint.pycodestyle]
max-doc-length = 88

[tool.ruff.lint.pydocstyle]
convention = "numpy"

[tool.ruff.lint.flake8-tidy-imports]
ban-relative-imports = "all"

[tool.ruff.lint.flake8-type-checking]
strict = true

[tool.ruff.format]
docstring-code-format = true
