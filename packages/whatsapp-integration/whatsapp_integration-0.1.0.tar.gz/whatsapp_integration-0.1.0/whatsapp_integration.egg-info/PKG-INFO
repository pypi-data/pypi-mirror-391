Metadata-Version: 2.4
Name: whatsapp_integration
Version: 0.1.0
Summary: Reusable Django WhatsApp integration (Celery, rate-limiter, webhook, idempotency)
Author: OFFSIDE INTEGRATED TECHNOLOGY (Somtochukwu Emmanuel)
Author-email: offsideint@gmail.com
License: MIT
Keywords: django,whatsapp,celery,webhook
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: Django>=3.2
Requires-Dist: requests>=2.28
Requires-Dist: celery>=5.2
Requires-Dist: redis>=4.3
Requires-Dist: psycopg2-binary>=2.9
Requires-Dist: python-dotenv>=0.21
Requires-Dist: reportlab>=4.0
Requires-Dist: djangorestframework>=3.16.1
Requires-Dist: setuptools>=80.9.0
Dynamic: license-file

# Whatsapp Integration

**A reusable Django app providing enterprise-grade WhatsApp Business API integration with message queuing, Celery task orchestration, Redis-based rate limiting (Lua token bucket), idempotency, and webhook handling.**

Designed for **production environments** and **multi-project reusability**, this package provides a scalable way to send, track, and process WhatsApp messages across your Django applications.

---

## âœ¨ Features

- âœ… **Reusable Django app** â€“ install once, integrate anywhere  
- ğŸš€ **Celery task orchestration** â€“ background message processing with exponential backoff  
- ğŸ§  **Idempotency & retry safety** â€“ prevents duplicate messages during failures  
- ğŸ” **Secure webhook verification** â€“ HMAC validation and token-based verification  
- ğŸ’¬ **Unified service API** â€“ `send_text` and `send_template` with optional components  
- ğŸ§© **Redis Lua rate limiter** â€“ atomic token bucket algorithm for scalable throughput  
- âš™ï¸ **Configurable** â€“ all keys & tokens loaded from Django `settings.py`  
- ğŸ§± **PostgreSQL-optimized schema** â€“ indexed queries for performance  
- ğŸ§° **CI/CD & Docker ready** â€“ comes with workflows, Dockerfile, and docker-compose  
- ğŸ“„ **PDF Generator Tool** â€“ generate a full repo snapshot in a single PDF  

---

## ğŸ§© Architecture Overview

```bash

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      | Django App â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ whatsapp_integration                                    â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ models.py â† WhatsAppMessage, WebhookEvent           â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ services/ â† WhatsAppService abstraction             â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ tasks.py â† Celery async workers                     â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ rate_limiter/ â† Redis Lua token bucket              â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ views.py â† Webhook endpoints                        â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€ commands.py â† Command + Event dispatcher            â”‚ â”‚
â”‚ â”‚ â””â”€â”€ utils.py â† Error classification, helpers            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
---

## ğŸ›  Installation

### 1ï¸âƒ£ Install from PyPI (or locally)
```bash
pip install whatsapp_integration
```

### âš™ï¸ Configuration

- Add the app to your Django settings:
```bash
INSTALLED_APPS = [
    ...
    "whatsapp_integration",
]
```

- Environment Variables / Settings
```bash
WHATSAPP_PHONE_NUMBER_ID = "1234567890"
WHATSAPP_ACCESS_TOKEN = "your_long_lived_graph_api_token"
WHATSAPP_VERIFY_TOKEN = "your_webhook_verify_token"
WHATSAPP_APP_SECRET = "facebook_app_secret"   # optional but recommended
WHATSAPP_RATE_PER_SECOND = 1.5                # messages per second allowed
REDIS_URL = "redis://localhost:6379/0"
```

- Make migrations
```bash
python manage.py makemigrations
```


- Celery Setup

In your settings.py:
```bash
CELERY_BROKER_URL = "redis://localhost:6379/0"
CELERY_RESULT_BACKEND = "redis://localhost:6379/0"
```

Then in your project root:
```bash
celery -A your_project worker -l info
```

### ğŸ”„ Sending Messages

Use the service directly or queue messages for asynchronous processing.

Example: Send text message immediately
```bash
from whatsapp_integration.services import whatsapp_service

whatsapp_service.default_whatsapp_service.send_text(
    recipient="15551234567",
    message="Hello from Django WhatsApp Integration!"
)
```

Example: Queue message for async send via Celery
```bash
from whatsapp_integration.models import WhatsAppMessage
from whatsapp_integration.tasks import send_whatsapp_message_task

msg = WhatsAppMessage.objects.create(
    recipient="15551234567",
    message_type="text",
    payload={"body": "Queued message test"}
)
send_whatsapp_message_task.delay(str(msg.id))
```

### ğŸ“¬ Handling Webhooks

Facebook/WhatsApp will send inbound messages or delivery updates to your webhook.

##### URL Mapping

Add to your root urls.py:
```bash
urlpatterns = [
    ...
    path("api/v1/whatsapp/", include("whatsapp_integration.urls")),
]
```

This registers:
```bash
GET api/v1/whatsapp/webhook/verify/ â†’ for verification handshake

POST api/v1/whatsapp/webhook/ â†’ for inbound message events
```

Example verification response
```
GET api/v1/whatsapp/webhook/verify/?hub.mode=subscribe&hub.verify_token=YOUR_TOKEN&hub.challenge=CHALLENGE
```

Returns CHALLENGE if token matches.

### ğŸš¦ Rate Limiting (Lua + Redis)
How it works

A token bucket algorithm written in Lua ensures you never exceed Metaâ€™s rate limits:

Each message consumes a â€œtokenâ€.

Tokens regenerate over time according to WHATSAPP_RATE_PER_SECOND.

Fully atomic via Redis EVALSHA (no race conditions).

Lua script: lua_token_bucket.lua

Settings
WHATSAPP_RATE_PER_SECOND = 1.0

### ğŸ§  Reliability & Idempotency

- Each message is stored with a unique idempotency_key

- Retries use the same key to avoid duplicate delivery

- Failed messages persist for visibility and can be retried manually

##### Celery Task Behavior
- Exponential backoff retry (2^n seconds)
- acks_late=True to avoid loss on worker crash
- Max 8 retries before marking message as failed

### ğŸ” Webhook Security

- Optional HMAC verification (X-Hub-Signature-256)

- Prevents spoofed or replayed requests

- Use your Facebook App Secret for signing

### ğŸ§© Database Schema


#### WhatsAppMessage
| **Field**       | **Type**                                   | **Notes**                 |
| --------------- | ------------------------------------------ | ------------------------- |
| recipient       | `CharField`                                | phone number              |
| message_type    | `text` / `template`                        | message category          |
| payload         | `JSONField`                                | message body / components |
| status          | `queued` / `sent` / `failed` / `delivered` | lifecycle state           |
| idempotency_key | `UUID`                                     | prevents duplicates       |
| attempts        | `Integer`                                  | number of retries         |
| created_at      | `DateTime`                                 | timestamp                 |


#### WhatsAppWebhookEvent

| **Field** | **Type**    | **Description**           |
| --------- | ----------- | ------------------------- |
| event_id  | `CharField` | deduplication key         |
| payload   | `JSONField` | raw webhook payload       |
| processed | `Boolean`   | flag to avoid re-handling |

### Includes:

- Webhook verification test

- Event persistence test

(Extendable for rate limiter and Celery integration)

### ğŸ§± Deploying

Recommended environment:

- PostgreSQL

- Redis 7+

- Gunicorn with 2â€“4 workers

- Celery worker pool (concurrency >= 4)

- Nginx reverse proxy for SSL termination

Production tips:

- Use environment variables for tokens

- Rotate access tokens periodically

- Enable HTTPS and secure webhook secret

### ğŸ’¡ Extending Functionality

- Add custom event handlers via register_handler in commands.py

- Extend rate limiter for per-tenant quotas

- Plug in Prometheus metrics to monitor message throughput

- Integrate with an internal analytics pipeline via Celery chains

### ğŸ— Performance Best Practices

- Use persistent Redis connection pools (max_connections=100)

- Deploy Celery worker with concurrency matching CPU cores

- Shard messages across multiple phone numbers if exceeding rate limits

- Use DB connection pooling (e.g. pgBouncer)

- Enable GZIP compression on webhook endpoints for large payloads


### ğŸ“œ License

MIT License Â© 2025 OFFSIDE INTEGRATED TECHNOLOGY (Somtochukwu Emmanuel)

## ğŸ¤ Contributing

Fork this repo

Create a feature branch
```bash
git checkout -b feature/awesome
```

Commit changes
```bash
git commit -m 'Add awesome feature'
```

Push branch and open a PR ğŸ‰

### ğŸ“ Support

For enterprise inquiries, please contact offsideint@gmail.com

For bugs, open an issue on GitHub.

Built with â¤ï¸ by OFFSIDE INTEGRATED TECHNOLOGY â€” because WhatsApp deserves enterprise-grade Django integration.
