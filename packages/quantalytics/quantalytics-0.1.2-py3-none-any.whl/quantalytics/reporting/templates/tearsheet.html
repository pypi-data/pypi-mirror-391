<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>__QA_REPORT_TITLE__</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-R9JpA3aI0bY8h1NIsDPKySx1VHa4EraseFH8blYNx+a3Pl6xNcNehJIK/gB+BeIV" crossorigin="anonymous">
  <style>
    :root {
      color-scheme: light;
      --color-bg: #f7f8fa;
      --color-surface: #ffffff;
      --color-primary: #264653;
      --color-accent: #358dc2;
      --color-muted: #6c757d;
    }

    body {
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      background: var(--color-bg);
      color: #1b1f24;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    header {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .header-logo img {
      max-height: 72px;
      max-width: 140px;
      border-radius: 12px;
      object-fit: contain;
      display: block;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    header h1 {
      margin: 0 0 0.35rem;
      font-size: clamp(2rem, 4vw, 2.75rem);
      color: var(--color-primary);
    }

    header p {
      margin: 0.15rem 0;
      color: var(--color-muted);
      max-width: 720px;
      font-size: 0.9rem;
    }

    .panel {
      background: var(--color-surface);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(11, 16, 27, 0.08);
      padding: 1.75rem;
      margin-bottom: 1rem;
      page-break-inside: avoid;
    }

    .panel h2 {
      margin: 0 0 1rem;
      font-size: 1.25rem;
      color: var(--color-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .panel-actions button {
      border: none;
      background: #358dc2;
      color: #fff;
      padding: 0.4rem 0.85rem;
      border-radius: 20px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: opacity 0.2s ease;
    }

    .panel-actions button:hover:not(:disabled) {
      opacity: 0.85;
    }

    .panel-actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background: #f2f7f9;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-muted);
    }

    .info-icon {
      font-size: 0.75rem;
      margin-left: 0.25rem;
      color: var(--color-accent);
      cursor: help;
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--color-primary);
    }

    .plot-container {
      width: 100%;
      height: 320px;
    }

    .plot-container--half {
      height: 160px;
    }

    .risk-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .risk-section .chart-area {
      flex: 17;
      min-width: 280px;
    }

    .risk-section .table-area {
      flex: 7;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .two-column-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .two-column-grid .primary {
      flex: 17;
      min-width: 280px;
    }

    .two-column-grid .secondary {
      flex: 7;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chart-stack {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .chart-title {
      margin-bottom: 0.4rem;
      color: var(--color-primary);
      font-size: 1rem;
    }

    .metric-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .metric-table th {
      text-align: left;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: var(--color-muted);
      text-transform: uppercase;
      padding-bottom: 0.4rem;
    }

    .metric-table tr:nth-child(even) {
      background: #f6fafb;
    }

    .dual-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .dual-grid .half {
      flex: 1;
      min-width: 260px;
    }


    .metric-table td {
      padding: 0.4rem 0.25rem;
    }

    .metric-table tr:nth-child(even) {
      background: #f6fafb;
    }

    @media (max-width: 768px) {
      .panel {
        padding: 1.25rem;
      }

      .grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }
  </style>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>

<body>
  <div class="page">
    <header>
      <div class="header-logo">
        <img src="header-logo.png" alt="Client identity" />
      </div>
      <div class="header-text">
        <h1>__QA_REPORT_TITLE__</h1>
        <p id="header-subtitle-primary">__QA_HEADER_SUBTITLE_PRIMARY__</p>
        <p id="header-subtitle-secondary">__QA_HEADER_SUBTITLE_SECONDARY__</p>
      </div>
    </header>

    <section class="panel">
      <div class="panel-header">
        <h2>Portfolio Summary</h2>
        <div class="panel-actions"><button class="panel-export" type="button">PNG</button></div>
      </div>
      <div class="grid">
        <div class="stat-card">
          <span class="stat-label">CAGR</span>
          <span class="stat-value" id="stat-annual-return">--%</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Sharpe Ratio<span class="info-icon" title="Average excess return per unit of total volatility, rewarding higher risk-adjusted performance.">ⓘ</span></span>
          <span class="stat-value" id="stat-sharpe">--</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Max Drawdown</span>
          <span class="stat-value" id="stat-mdd">--%</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Win Rate</span>
          <span class="stat-value" id="stat-win-rate">--%</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">RoMaD<span class="info-icon" title="Return over maximum drawdown, highlighting reward relative to capital at risk.">ⓘ</span></span>
          <span class="stat-value" id="stat-romad">--%</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Sortino<span class="info-icon" title="Focuses on downside volatility, penalizing losses more than upside fluctuations.">ⓘ</span></span>
          <span class="stat-value" id="stat-sortino">--%</span>
        </div>
      </div>
      <div class="two-column-grid" style="margin-top:1.5rem;">
        <div class="primary">
          <div id="chart-cumulative" class="plot-container"></div>
        </div>
        <div class="secondary">
          <div>
            <h3 class="chart-title">Strategy Parameters</h3>
            <table class="metric-table" id="table-parameters"></table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Performance Analysis</h2>
        <div class="panel-actions"><button class="panel-export" type="button">PNG</button></div>
      </div>
      <div class="risk-section">
        <div class="chart-area">
          <h3 class="chart-title">EOY Returns</h3>
          <div id="chart-eoy" class="plot-container" style="height: 260px;"></div>
        </div>
        <div class="table-area">
          <div>
            <h3 class="chart-title">EOY Breakdown</h3>
            <table class="metric-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th style="text-align:right;">Return</th>
                  <th style="text-align:right;">Cumulative</th>
                </tr>
              </thead>
              <tbody id="table-eoy"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="risk-section">
        <div class="chart-area">
          <h3 class="chart-title">Daily Returns</h3>
          <div id="chart-daily" class="plot-container" style="height: 260px;"></div>
        </div>
        <div class="table-area">
          <div>
            <h3 class="chart-title">Period Returns</h3>
            <table class="metric-table">
              <thead>
                <tr>
                  <th>Period</th>
                  <th style="text-align:right;">Return</th>
                </tr>
              </thead>
              <tbody id="period-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Risk Analysis</h2>
        <div class="panel-actions"><button class="panel-export" type="button">PNG</button></div>
      </div>
      <div class="risk-section">
        <div class="chart-area">
          <div class="chart-stack">
            <div>
              <h3 class="chart-title">Rolling Sharpe</h3>
              <div id="chart-roll-sharpe" class="plot-container plot-container--half"></div>
            </div>
            <div>
              <h3 class="chart-title">Rolling Sortino</h3>
              <div id="chart-roll-sortino" class="plot-container plot-container--half"></div>
            </div>
          </div>
        </div>
        <div class="table-area">
          <h3 class="chart-title">Risk-adjusted Returns</h3>
          <table class="metric-table" id="table-risk-adjusted"></table>
        </div>
      </div>
      <div class="risk-section">
        <div class="chart-area">
          <h3 class="chart-title">Underwater Curve</h3>
          <div id="chart-underwater" class="plot-container" style="height: 260px;"></div>
        </div>
        <div class="table-area">
          <h3 class="chart-title">Volatility & Drawdown</h3>
          <table class="metric-table" id="table-vol-draw"></table>
        </div>
      </div>
      <div class="risk-section">
        <div class="chart-area">
          <h3 class="chart-title">Return Distribution</h3>
          <div id="chart-return-dist" class="plot-container" style="height: 260px;"></div>
        </div>
        <div class="table-area">
          <h3 class="chart-title">Distribution & Tail Risk</h3>
          <table class="metric-table" id="table-tail"></table>
        </div>
      </div>
      <div class="risk-section">
        <div class="chart-area">
          <h3 class="chart-title">Top 5 Longest Drawdowns</h3>
          <div id="chart-drawdown-highlight" class="plot-container" style="height: 260px;"></div>
        </div>
        <div class="table-area">
          <h3 class="chart-title">Worst 10 Drawdowns</h3>
          <table class="metric-table">
            <thead>
              <tr>
                <th>Started</th>
                <th>Recovered</th>
                <th style="text-align:right;">Drawdown</th>
                <th style="text-align:right;">Days</th>
              </tr>
            </thead>
            <tbody id="table-drawdowns"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Consistency Metrics</h2>
        <div class="panel-actions"><button class="panel-export" type="button">PNG</button></div>
      </div>
      <div class="two-column-grid">
        <div class="primary">
          <div class="chart-stack">
            <div>
              <h3 class="chart-title">Monthly Returns Heatmap</h3>
              <div id="chart-heatmap" class="plot-container" style="height: 320px;"></div>
            </div>
            <div>
              <h3 class="chart-title">Win Rate Progression</h3>
              <div id="chart-winrate" class="plot-container" style="height: 300px;"></div>
            </div>
          </div>
        </div>
        <div class="secondary">
          <div>
            <h3 class="chart-title">Consistency Snapshot</h3>
            <table class="metric-table" id="table-consistency"></table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Placeholder data for scaffolding
    const dates = Array.from({ length: 60 }, (_, i) => {
      const d = new Date();
      d.setMonth(d.getMonth() - (60 - i));
      return d.toISOString().split("T")[0];
    });

    const sampleReturns = dates.map((_, idx) => {
      const base = Math.pow(1.12, idx / 12) - 1; // 12% annualized profile
      const noise = (Math.sin(idx / 3) + Math.cos(idx / 5)) * 0.2;
      return parseFloat((base + noise).toFixed(2));
    });

    const sampleDrawdown = sampleReturns.map((value, idx) => {
      const peak = Math.max(...sampleReturns.slice(0, idx + 1));
      return parseFloat((value - peak).toFixed(2));
    });

    const dailyReturnSeries = sampleReturns.map((value, idx) => {
      if (idx === 0) {
        return 0;
      }
      return parseFloat((value - sampleReturns[idx - 1]).toFixed(3));
    });

    const eoyYears = ["2020", "2021", "2022", "2023", "2024"];
    const eoyReturns = [8.5, 14.2, -3.7, 11.6, 9.8];
    const dailyBars = Array.from({ length: 60 }, () => parseFloat((Math.random() * 2 - 1).toFixed(2)));
    const periodReturns = [
      ["MTD", "1.2%"],
      ["3M", "3.9%"],
      ["6M", "7.4%"],
      ["YTD", "9.8%"],
      ["1Y", "12.1%"],
      ["3Y", "35.5%"],
      ["5Y", "61.2%"],
      ["10Y", "108.3%"],
      ["All-time", "145.0%"],
    ];

    const rollingSharpe = sampleReturns.map((_, idx) => parseFloat((1 + Math.sin(idx / 6)).toFixed(2)));
    const rollingSortino = sampleReturns.map((_, idx) => parseFloat((0.9 + Math.cos(idx / 7)).toFixed(2)));
    const underwaterSeries = sampleDrawdown;
    const drawdownBands = [
      { start: dates[5], end: dates[7] },
      { start: dates[14], end: dates[17] },
      { start: dates[24], end: dates[26] },
      { start: dates[33], end: dates[35] },
      { start: dates[42], end: dates[44] },
    ];

    const riskAdjustedRows = [
      ["Sharpe Ratio", "1.65"],
      ["Sortino Ratio", "2.10"],
      ["Smart Sharpe", "5.87"],
      ["Smart Sortino", "10.39"],
      ["Sortino/√2", "7.46"],
      ["Smart Sortino/√2", "7.35"],
      ["Calmar Ratio", "1.80"],
      ["Omega Ratio", "1.48"],
      ["RoMaD", "1.42x"],
    ];
    const riskTooltipMap = {
      "Sharpe Ratio": "Average excess return per unit of total volatility.",
      "Sortino Ratio": "Similar to Sharpe but only penalizes downside variation.",
      "Smart Sharpe": "Sharpe adjusted for higher moments and persistence.",
      "Smart Sortino": "Sortino adjusted for higher moments and downside risk.",
      "Sortino/√2": "Sortino scaled by √2 to match half-normal downside.",
      "Smart Sortino/√2": "Smart Sortino scaled for half-normal downside.",
      "Calmar Ratio": "Annualized return divided by maximum drawdown, highlighting return per unit drawdown.",
      "Omega Ratio": "Ratio of gains to losses above/below a threshold, capturing tail asymmetry.",
      "RoMaD": "Return over maximum drawdown, emphasizing recovery efficiency.",
    };
    const volRows = [
      ["Annualized Vol", "9.5%"],
      ["Max Drawdown", "-8.7%"],
      ["Longest DD Days", "48 days"],
      ["Average Drawdown", "-2.4%"],
      ["Average DD Days", "15 days"],
      ["Underwater %", "3.2%"],
      ["Recovery Factor", "1.6x"],
      ["Ulcer Index", "3.1"],
    ];
    const tailRows = [
      ["Skewness", "0.28"],
      ["Kurtosis", "3.9"],
      ["Daily VaR", "-2.1%"],
      ["Expected Shortfall", "-3.4%"],
      ["Serenity Index", "5.2"],
    ];
    const parameterRows = [
      ["Name", "base"],
      ["Trade Count", "70"],
      ["Account Size", "$700,000"],
      ["Bot Count", "40"],
      ["Trade Selection Type", "median"],
      ["Median Rank", "0.8"],
      ["Training Length", "6m"],
      ["Testing Length", "1m"],
      ["Optimizer", "max_sharpe"],
      ["Multi-Stage Optimizer", "max_sharpe"],
      ["Puts", "18B / 28T"],
      ["Calls", "22B / 42T"],
      ["ICs", "0B / 0T"],
    ];
    const heatmapMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const heatmapYears = ["2021", "2022", "2023", "2024", "2025"];
    const heatmapValues = heatmapYears.map(() => heatmapMonths.map(() => parseFloat(((Math.random() * 4) - 1.5).toFixed(2))));
    const winRateBuckets = ["Day", "Week", "Month", "Quarter", "Year"];
    const winRateValues = [58, 60, 62, 66, 71];
    const consistencyRows = [
      ["Time in Market", "92%"],
      ["Avg Up Month", "+2.1%"],
      ["Avg Down Month", "-1.3%"],
      ["Winning Days", "142"],
      ["Losing Days", "108"],
      ["Expected Daily%", "0.22%"],
      ["Expected Monthly%", "3.91%"],
      ["Expected Yearly%", "56.66%"],
      ["Best Day", "2.93%"],
      ["Worst Day", "-3.87%"],
      ["Best Month", "13.52%"],
      ["Worst Month", "-5.19%"],
      ["Best Year", "90.86%"],
      ["Worst Year", "46.24%"],
    ];
    const eoyTableRows = [
      ["2019", "46.24%", "46.55%"],
      ["2020", "90.86%", "91.54%"],
      ["2021", "51.39%", "52.09%"],
      ["2022", "65.36%", "66.28%"],
      ["2023", "48.47%", "49.29%"],
      ["2024", "49.23%", "49.39%"],
      ["2025", "49.61%", "62.99%"],
    ];
    const drawdownRows = [
      ["2025-10-10", "2025-10-30", "-8.27%", "21"],
      ["2022-11-02", "2022-11-21", "-5.12%", "20"],
      ["2022-01-19", "2022-02-28", "-4.28%", "41"],
      ["2020-06-12", "2020-06-24", "-4.24%", "13"],
      ["2024-08-19", "2024-09-13", "-3.97%", "26"],
      ["2022-12-02", "2023-01-13", "-3.93%", "43"],
      ["2020-12-21", "2021-01-20", "-3.62%", "31"],
      ["2024-11-08", "2024-11-29", "-3.51%", "22"],
      ["2020-09-11", "2020-09-30", "-3.46%", "20"],
      ["2024-12-16", "2025-01-16", "-3.41%", "32"],
    ];

    function renderStats() {
      document.getElementById("stat-annual-return").textContent = "12.4%";
      document.getElementById("stat-sharpe").textContent = "1.65";
      document.getElementById("stat-mdd").textContent = "-8.7%";
      document.getElementById("stat-win-rate").textContent = "61%";
      document.getElementById("stat-romad").textContent = "1.42x";
      document.getElementById("stat-sortino").textContent = "2.10";
    }

    function renderCharts() {
      const chartPrimaryColor = "#358DC2";
      Plotly.newPlot("chart-cumulative", [
        {
          x: dates,
          y: sampleReturns,
          mode: "lines",
          name: "Strategy",
          line: { color: chartPrimaryColor, width: 3 },
          hovertemplate: "%{y:.2f}%<extra></extra>",
        },
      ], {
        margin: { t: 20, r: 10, b: 40, l: 50 },
        yaxis: { ticksuffix: "%", zeroline: false },
        xaxis: { type: "date" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      Plotly.newPlot("chart-eoy", [
        {
          x: eoyYears,
          y: eoyReturns,
          type: "bar",
          marker: { color: chartPrimaryColor },
          hovertemplate: "%{y:.1f}%<extra></extra>",
        },
        {
          x: eoyYears,
          y: eoyYears.map(() => 12.4),
          mode: "lines",
          name: "CAGR",
          line: { color: chartPrimaryColor, width: 2, dash: "dot" },
          hovertemplate: "CAGR 12.4%<extra></extra>",
        }
      ], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        yaxis: { ticksuffix: "%", zeroline: false },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        legend: { orientation: "h", x: 0.5, xanchor: "center", y: -0.25 },
      }, { responsive: true });

      Plotly.newPlot("chart-daily", [{
        x: Array.from({ length: dailyBars.length }, (_, i) => i + 1),
        y: dailyBars,
        type: "bar",
        marker: { color: chartPrimaryColor },
        hovertemplate: "%{y:.2f}%<extra></extra>",
      }], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        yaxis: { ticksuffix: "%", zeroline: false },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      const tableBody = document.getElementById("period-table");
      tableBody.innerHTML = periodReturns.map(
        ([label, value]) => `<tr><td>${label}</td><td align="right">${value}</td></tr>`
      ).join("");

      const distValues = dailyReturnSeries.slice(1);
      const distMean = distValues.reduce((acc, val) => acc + val, 0) / distValues.length;
      const distVariance = distValues.reduce((acc, val) => acc + Math.pow(val - distMean, 2), 0) / distValues.length;
      const distStd = Math.max(Math.sqrt(distVariance), 0.01);
      const normalX = [];
      const normalDensity = [];
      for (let i = -4; i <= 4; i += 0.1) {
        const x = distMean + i * distStd;
        const y = (1 / (distStd * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - distMean) / distStd, 2));
        normalX.push(x);
        normalDensity.push(y);
      }

      Plotly.newPlot("chart-return-dist", [
        {
          x: distValues,
          type: "histogram",
          histnorm: "probability density",
          nbinsx: 20,
          opacity: 0.75,
          marker: { color: chartPrimaryColor },
          hovertemplate: "%{x:.2f}%<extra></extra>",
        },
        {
          x: normalX,
          y: normalDensity,
          mode: "lines",
          line: { color: chartPrimaryColor, width: 2, dash: "dash" },
          hoverinfo: "skip",
        },
      ], {
        margin: { t: 10, r: 10, b: 40, l: 50 },
        xaxis: { title: "Daily Return (%)" },
        yaxis: { title: "Density" },
        showlegend: false,
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      Plotly.newPlot("chart-roll-sharpe", [
        {
          x: dates,
          y: rollingSharpe,
          mode: "lines",
          line: { color: chartPrimaryColor },
          hovertemplate: "%{y:.2f}<extra></extra>",
          showlegend: false,
        },
        {
          x: [dates[0], dates[dates.length - 1]],
          y: [1.65, 1.65],
          mode: "lines",
          line: { color: chartPrimaryColor, width: 2, dash: "dot" },
          hovertemplate: "Sharpe 1.65<extra></extra>",
          showlegend: false,
        }
      ], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        xaxis: { type: "date" },
        yaxis: { zeroline: false },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      Plotly.newPlot("chart-roll-sortino", [
        {
          x: dates,
          y: rollingSortino,
          mode: "lines",
          line: { color: chartPrimaryColor },
          hovertemplate: "%{y:.2f}<extra></extra>",
          showlegend: false,
        },
        {
          x: [dates[0], dates[dates.length - 1]],
          y: [2.10, 2.10],
          mode: "lines",
          line: { color: chartPrimaryColor, width: 2, dash: "dot" },
          hovertemplate: "Sortino 2.10<extra></extra>",
          showlegend: false,
        }
      ], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        xaxis: { type: "date" },
        yaxis: { zeroline: false },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      Plotly.newPlot("chart-underwater", [{
        x: dates,
        y: underwaterSeries,
        mode: "lines",
        fill: "tozeroy",
        line: { color: chartPrimaryColor },
        hovertemplate: "%{y:.2f}%<extra></extra>",
      }], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        yaxis: { ticksuffix: "%" },
        xaxis: { type: "date" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      Plotly.newPlot("chart-drawdown-highlight", [
        {
          x: dates,
          y: sampleReturns,
          mode: "lines",
          line: { color: chartPrimaryColor },
          showlegend: false,

        },
        ...drawdownBands.map(({ start, end }) => ({
          x: [start, end, end, start],
          y: [0, 0, Math.max(...sampleReturns), Math.max(...sampleReturns)],
          fill: "toself",
          fillcolor: "rgba(231,111,81,0.15)",
          line: { width: 0 },
          hoverinfo: "skip",
          showlegend: false,
        }))
      ], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        xaxis: { type: "date" },
        yaxis: { ticksuffix: "%" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      }, { responsive: true });

      const renderTable = (id, rows) => {
        const table = document.getElementById(id);
        table.innerHTML = rows
          .map(([label, value, sub]) => {
            const subLabel = sub ? `<div style="color:var(--color-muted);font-size:0.75rem;">${sub}</div>` : "";
            return `<tr><td>${label}${subLabel}</td><td align="right">${value}</td></tr>`;
          })
          .join("");
      };

      const riskTable = document.getElementById("table-risk-adjusted");
      riskTable.innerHTML = riskAdjustedRows
        .map(([label, value, sub]) => {
          const tooltip = riskTooltipMap[label] || "";
          const infoIcon = tooltip ? ` <span class="info-icon" title="${tooltip}">ⓘ</span>` : "";
          const subLabel = sub ? `<div style=\"color:var(--color-muted);font-size:0.75rem;\">${sub}</div>` : "";
          return `<tr><td>${label}${infoIcon}${subLabel}</td><td align=\"right\">${value}</td></tr>`;
        })
        .join("");
      const tailTooltipMap = {
        "Skewness": "Measures asymmetry; positive values suggest upside outliers, negative values indicate deeper downside tails.",
        "Kurtosis": "Indicates tail thickness; higher numbers mean more extreme events than a normal distribution.",
        "Daily VaR": "Value-at-Risk estimates the worst expected daily loss at the chosen confidence level.",
        "Expected Shortfall": "Expected Shortfall (cVaR) averages losses beyond the VaR cutoff, capturing tail severity.",
        "Serenity Index": "Combines return and drawdown profiles; higher values imply smoother equity curves with better rewards.",
      };
      const tailTable = document.getElementById("table-tail");
      tailTable.innerHTML = tailRows
        .map(([label, value]) => {
          const tooltip = tailTooltipMap[label] || "";
          const infoIcon = tooltip
            ? ` <span class="info-icon" title="${tooltip}">ⓘ</span>`
            : "";
          return `<tr><td>${label}${infoIcon}</td><td align="right">${value}</td></tr>`;
        })
        .join("");
      const volTooltipMap = {
        "Recovery Factor": "Recovery Factor = cumulative return divided by max drawdown; higher values reflect quicker recoveries.",
        "Ulcer Index": "Ulcer Index quantifies depth and duration of drawdowns; lower is smoother equity curve.",
      };
      const volTable = document.getElementById("table-vol-draw");
      volTable.innerHTML = volRows
        .map(([label, value]) => {
          const tooltip = volTooltipMap[label] || "";
          const infoIcon = tooltip
            ? ` <span class="info-icon" title="${tooltip}">ⓘ</span>`
            : "";
          return `<tr><td>${label}${infoIcon}</td><td align="right">${value}</td></tr>`;
        })
        .join("");
      document.getElementById("table-parameters").innerHTML = parameterRows
        .map(([label, value]) => `<tr><td>${label}</td><td align="right">${value}</td></tr>`)
        .join("");
      document.getElementById("table-drawdowns").innerHTML = drawdownRows
        .map(([start, end, dd, days]) => `<tr><td>${start}</td><td>${end}</td><td align="right">${dd}</td><td align="right">${days}</td></tr>`)
        .join("");
      document.getElementById("table-eoy").innerHTML = eoyTableRows
        .map(([year, ret, cum]) => `<tr><td>${year}</td><td align="right">${ret}</td><td align="right">${cum}</td></tr>`)
        .join("");

      Plotly.newPlot("chart-heatmap", [{
        z: heatmapValues,
        x: heatmapMonths,
        y: heatmapYears,
        type: "heatmap",
        colorscale: [
          [0.0, "#a50026"],
          [0.1, "#d73027"],
          [0.2, "#f46d43"],
          [0.3, "#fdae61"],
          [0.4, "#fee08b"],
          [0.5, "#ffffbf"],
          [0.6, "#d9ef8b"],
          [0.7, "#a6d96a"],
          [0.8, "#66bd63"],
          [0.9, "#1a9850"],
          [1.0, "#006837"],
        ],
        hovertemplate: "%{y} %{x}: %{z:.2f}%<extra></extra>",
        showscale: false,
      }], {
        margin: { t: 10, r: 10, b: 40, l: 50 },
        zmid: 0,
        yaxis: { automargin: true },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        annotations: [].concat(...heatmapYears.map((year, yi) =>
          heatmapMonths.map((month, xi) => {
            const value = heatmapValues[yi][xi];
            const textColor = Math.abs(value) < 0.8 ? "#1b1f24" : "#ffffff";
            return {
              x: month,
              y: year,
              text: `${value}%`,
              font: { color: textColor, size: 10 },
              showarrow: false,
            };
          })
        )),
      }, { responsive: true });

      Plotly.newPlot("chart-winrate", [{
        x: winRateBuckets,
        y: winRateValues,
        type: "bar",
        marker: { color: chartPrimaryColor },
        hovertemplate: "%{y:.0f}%<extra></extra>",
        text: winRateValues.map((v) => `${v}%`),
        textposition: "outside",
      }], {
        margin: { t: 10, r: 10, b: 40, l: 40 },
        yaxis: { ticksuffix: "%", range: [0, 100] },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        bargap: 0.4,
      }, { responsive: true });

      document.getElementById("table-consistency").innerHTML = consistencyRows
        .map(([label, value]) => `<tr><td>${label}</td><td align="right">${value}</td></tr>`)
        .join("");
    }

    async function copyPanel(panel, button) {
      if (!window.html2canvas) {
        alert("Screenshot capability is unavailable in this environment.");
        return;
      }
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = "Copying...";
      try {
        const canvas = await html2canvas(panel, { backgroundColor: "#ffffff", scale: 2 });
        const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
        if (blob && navigator.clipboard && window.ClipboardItem) {
          await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
          button.textContent = "Copied!";
        } else {
          const link = document.createElement("a");
          link.href = canvas.toDataURL("image/png");
          link.download = "quantalytics-panel.png";
          link.click();
          button.textContent = "Downloaded";
        }
      } catch (err) {
        console.error(err);
        button.textContent = "Failed";
      } finally {
        setTimeout(() => {
          button.disabled = false;
          button.textContent = originalText;
        }, 1500);
      }
    }

    function setupPanelExport() {
      document.querySelectorAll(".panel-export").forEach((button) => {
        button.addEventListener("click", () => {
          const panel = button.closest(".panel");
          if (panel) {
            copyPanel(panel, button);
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderStats();
      renderCharts();
      setupPanelExport();
    });
  </script>
</body>

</html>
