"""Generate cloud deployment instructions from stack configuration."""

from typing import Any, Optional

from getupandrun.cloud.detector import CloudDetector
from getupandrun.gpt.integration import StackConfig


class CloudInstructionGenerator:
    """Generate cloud deployment instructions for various platforms."""

    def __init__(self) -> None:
        """Initialize cloud instruction generator."""
        self.detector = CloudDetector()

    def generate_instructions(
        self, config: StackConfig, available_platforms: Optional[list[str]] = None
    ) -> str:
        """
        Generate cloud deployment instructions for a stack configuration.

        Args:
            config: StackConfig object containing stack definition
            available_platforms: Optional list of platforms to include.
                                 If None, uses all detected platforms.

        Returns:
            Markdown-formatted deployment instructions
        """
        if available_platforms is None:
            available_platforms = self.detector.get_available_platforms()

        if not available_platforms:
            available_platforms = self.detector.get_all_platforms()

        instructions = f"""# Cloud Deployment Instructions for {config.name}

{config.description or "Generated by GetUpAndRun"}

## Overview

This document contains cloud deployment instructions for your stack. The stack includes the following services:

"""
        for service in config.services:
            service_name = service.get("name", "service")
            service_type = service.get("type", "other")
            framework = service.get("framework", "")
            port = config.ports.get(service_name, "N/A")
            instructions += f"- **{service_name}**: {service_type} ({framework}) - Port: {port}\n"

        instructions += "\n---\n\n"

        # Generate platform-specific instructions
        if "AWS" in available_platforms:
            instructions += self._generate_aws_instructions(config)
            instructions += "\n---\n\n"

        if "GCP" in available_platforms:
            instructions += self._generate_gcp_instructions(config)
            instructions += "\n---\n\n"

        if "Docker Hub" in available_platforms:
            instructions += self._generate_docker_hub_instructions(config)
            instructions += "\n---\n\n"

        instructions += self._generate_general_instructions(config)

        return instructions

    def _generate_aws_instructions(self, config: StackConfig) -> str:
        """Generate AWS-specific deployment instructions."""
        aws_available = self.detector.detect_aws()
        instructions = "## AWS Deployment\n\n"

        if not aws_available:
            instructions += "⚠️ **Note**: AWS CLI is not detected on your system.\n"
            instructions += "Install it from: https://aws.amazon.com/cli/\n\n"

        instructions += "### Prerequisites\n\n"
        instructions += "1. AWS account with appropriate permissions\n"
        instructions += "2. AWS CLI installed and configured (`aws configure`)\n"
        instructions += "3. Docker images built and ready for deployment\n\n"

        instructions += "### Deployment Steps\n\n"

        # ECS/Fargate deployment
        instructions += "#### Option 1: AWS ECS (Fargate)\n\n"
        instructions += "1. **Build and push Docker images to ECR:**\n\n"
        instructions += "```bash\n"
        instructions += "# Create ECR repository\n"
        instructions += "aws ecr create-repository --repository-name {config.name} --region us-east-1\n\n"
        instructions += "# Login to ECR\n"
        instructions += "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin <account-id>.dkr.ecr.us-east-1.amazonaws.com\n\n"
        instructions += "# Build and push images for each service\n"
        for service in config.services:
            service_name = service.get("name", "service")
            instructions += f"docker build -t {config.name}-{service_name} ./{service_name}\n"
            instructions += f"docker tag {config.name}-{service_name}:latest <account-id>.dkr.ecr.us-east-1.amazonaws.com/{config.name}-{service_name}:latest\n"
            instructions += f"docker push <account-id>.dkr.ecr.us-east-1.amazonaws.com/{config.name}-{service_name}:latest\n\n"
        instructions += "```\n\n"

        instructions += "2. **Create ECS cluster and task definitions:**\n\n"
        instructions += "```bash\n"
        instructions += "# Create cluster\n"
        instructions += f"aws ecs create-cluster --cluster-name {config.name}-cluster --region us-east-1\n\n"
        instructions += "# Create task definitions for each service (example for one service)\n"
        instructions += "# Use AWS Console or CloudFormation/Terraform for full setup\n"
        instructions += "```\n\n"

        # Elastic Beanstalk alternative
        instructions += "#### Option 2: AWS Elastic Beanstalk\n\n"
        instructions += "1. **Install EB CLI:**\n\n"
        instructions += "```bash\n"
        instructions += "pip install awsebcli\n"
        instructions += "```\n\n"

        instructions += "2. **Initialize and deploy:**\n\n"
        instructions += "```bash\n"
        instructions += f"cd {config.name}\n"
        instructions += "eb init -p docker {config.name}-app --region us-east-1\n"
        instructions += "eb create {config.name}-env\n"
        instructions += "eb deploy\n"
        instructions += "```\n\n"

        return instructions

    def _generate_gcp_instructions(self, config: StackConfig) -> str:
        """Generate GCP-specific deployment instructions."""
        gcp_available = self.detector.detect_gcp()
        instructions = "## GCP Deployment\n\n"

        if not gcp_available:
            instructions += "⚠️ **Note**: GCP CLI (gcloud) is not detected on your system.\n"
            instructions += "Install it from: https://cloud.google.com/sdk/docs/install\n\n"

        instructions += "### Prerequisites\n\n"
        instructions += "1. GCP account with billing enabled\n"
        instructions += "2. GCP CLI installed and configured (`gcloud init`)\n"
        instructions += "3. Docker images built and ready for deployment\n\n"

        instructions += "### Deployment Steps\n\n"

        # Cloud Run deployment
        instructions += "#### Option 1: Cloud Run\n\n"
        instructions += "1. **Build and push Docker images to Container Registry:**\n\n"
        instructions += "```bash\n"
        instructions += "# Set project\n"
        instructions += "gcloud config set project YOUR_PROJECT_ID\n\n"
        instructions += "# Configure Docker for GCR\n"
        instructions += "gcloud auth configure-docker\n\n"
        instructions += "# Build and push images\n"
        for service in config.services:
            service_name = service.get("name", "service")
            port = config.ports.get(service_name, 8080)
            instructions += f"docker build -t gcr.io/YOUR_PROJECT_ID/{config.name}-{service_name} ./{service_name}\n"
            instructions += f"docker push gcr.io/YOUR_PROJECT_ID/{config.name}-{service_name}\n\n"
        instructions += "```\n\n"

        instructions += "2. **Deploy to Cloud Run:**\n\n"
        instructions += "```bash\n"
        for service in config.services:
            service_name = service.get("name", "service")
            port = config.ports.get(service_name, 8080)
            instructions += f"gcloud run deploy {config.name}-{service_name} \\\n"
            instructions += f"  --image gcr.io/YOUR_PROJECT_ID/{config.name}-{service_name} \\\n"
            instructions += f"  --platform managed \\\n"
            instructions += f"  --region us-central1 \\\n"
            instructions += f"  --port {port} \\\n"
            instructions += f"  --allow-unauthenticated\n\n"
        instructions += "```\n\n"

        # GKE alternative
        instructions += "#### Option 2: Google Kubernetes Engine (GKE)\n\n"
        instructions += "1. **Create GKE cluster:**\n\n"
        instructions += "```bash\n"
        instructions += "gcloud container clusters create {config.name}-cluster \\\n"
        instructions += "  --num-nodes=3 \\\n"
        instructions += "  --zone=us-central1-a\n"
        instructions += "```\n\n"

        instructions += "2. **Deploy using kubectl:**\n\n"
        instructions += "```bash\n"
        instructions += "# Get cluster credentials\n"
        instructions += "gcloud container clusters get-credentials {config.name}-cluster --zone us-central1-a\n\n"
        instructions += "# Apply Kubernetes manifests (create these from your docker-compose.yml)\n"
        instructions += "# Use kompose or similar tool to convert: kompose convert\n"
        instructions += "kubectl apply -f k8s/\n"
        instructions += "```\n\n"

        return instructions

    def _generate_docker_hub_instructions(self, config: StackConfig) -> str:
        """Generate Docker Hub deployment instructions."""
        docker_available = self.detector.detect_docker_hub()
        instructions = "## Docker Hub Deployment\n\n"

        if not docker_available:
            instructions += "⚠️ **Note**: Docker CLI is not detected on your system.\n"
            instructions += "Install it from: https://docs.docker.com/get-docker/\n\n"

        instructions += "### Prerequisites\n\n"
        instructions += "1. Docker Hub account (create at https://hub.docker.com/)\n"
        instructions += "2. Docker CLI installed\n"
        instructions += "3. Logged in to Docker Hub (`docker login`)\n\n"

        instructions += "### Deployment Steps\n\n"

        instructions += "1. **Build Docker images:**\n\n"
        instructions += "```bash\n"
        for service in config.services:
            service_name = service.get("name", "service")
            instructions += f"docker build -t YOUR_DOCKERHUB_USERNAME/{config.name}-{service_name} ./{service_name}\n"
        instructions += "```\n\n"

        instructions += "2. **Push images to Docker Hub:**\n\n"
        instructions += "```bash\n"
        for service in config.services:
            service_name = service.get("name", "service")
            instructions += f"docker push YOUR_DOCKERHUB_USERNAME/{config.name}-{service_name}\n"
        instructions += "```\n\n"

        instructions += "3. **Deploy using docker-compose on remote server:**\n\n"
        instructions += "```bash\n"
        instructions += "# On your deployment server, create docker-compose.yml with image references\n"
        instructions += "# Then run:\n"
        instructions += "docker-compose pull\n"
        instructions += "docker-compose up -d\n"
        instructions += "```\n\n"

        return instructions

    def _generate_general_instructions(self, config: StackConfig) -> str:
        """Generate general deployment instructions and tips."""
        instructions = "## General Deployment Tips\n\n"

        instructions += "### Environment Variables\n\n"
        instructions += "Make sure to set appropriate environment variables for your services:\n\n"
        instructions += "- Database connection strings\n"
        instructions += "- API keys and secrets\n"
        instructions += "- Service URLs and endpoints\n"
        instructions += "- Port configurations\n\n"

        instructions += "### Security Considerations\n\n"
        instructions += "- Use secrets management (AWS Secrets Manager, GCP Secret Manager)\n"
        instructions += "- Enable HTTPS/TLS for all services\n"
        instructions += "- Configure proper IAM roles and permissions\n"
        instructions += "- Use private container registries when possible\n"
        instructions += "- Set up monitoring and logging\n\n"

        instructions += "### Next Steps\n\n"
        instructions += "1. Review and customize the deployment instructions above\n"
        instructions += "2. Set up CI/CD pipelines for automated deployments\n"
        instructions += "3. Configure monitoring and alerting\n"
        instructions += "4. Set up backup and disaster recovery procedures\n"
        instructions += "5. Review and optimize costs\n\n"

        return instructions

