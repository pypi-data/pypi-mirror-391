from rich.console import Console
from rich.syntax import Syntax
import questionary
import os

console = Console()

def generate_makefile(compiler: str, flags: str, ldflags: str, src: str, output: str,
                      use_template: bool = False, template_name: str = None) -> bool:
    """Generate a Makefile interactively, with preview and save location choice."""
    makefile_content = f"""# Auto-generated by HPC Tools
# --------------------------------------------
# Compiler configuration
CC = {compiler}
CFLAGS = {flags}
LDFLAGS = {ldflags}

# Source and target
SOURCE = {src}
OBJ = $(SOURCE:.c=.o)
TARGET = {output}

# --------------------------------------------
# Build rules
all: $(TARGET)

$(TARGET): $(OBJ)
\t$(CC) $(CFLAGS) $(OBJ) $(LDFLAGS) -o $@

%.o: %.c
\t$(CC) -c $(CFLAGS) $< -o $@

clean:
\t@echo "Cleaning project..."
\trm -f $(OBJ) $(TARGET)

.PHONY: all clean
"""

    # ðŸŽ¨ Syntax-highlighted preview
    console.print("\n[bold cyan]ðŸ” Makefile Preview:[/bold cyan]\n")
    console.print(Syntax(makefile_content, "make", theme="monokai", line_numbers=True))

    # ðŸ’¾ Ask where to save
    path = questionary.path(
        "Save Makefile to (default: ./Makefile):"
    ).ask() or "Makefile"
    path = os.path.expanduser(path.strip())

    try:
        with open(path, "w") as f:
            f.write(makefile_content.strip() + "\n")
        console.print(f"[green] Makefile saved to:[/green] [bold]{os.path.abspath(path)}[/bold]")
        return True
    except Exception as e:
        console.print(f"[red] Failed to save Makefile:[/red] {e}")
        return False