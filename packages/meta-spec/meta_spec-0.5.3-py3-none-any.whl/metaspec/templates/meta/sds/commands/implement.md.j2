---
description: Execute specification writing by processing and completing all tasks from tasks.md
---

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

## Outline

**Goal**: Execute specification writing tasks systematically, following task order, respecting dependencies, and tracking progress.

**Important**: This command runs AFTER `/metaspec.sds.tasks`. It is the execution engine for specification development.

### Execution Flow

#### 1. Check Prerequisites

**Required files**:
- `specs/domain/001-{name}-spec/tasks.md` - Task breakdown
- `specs/domain/001-{name}-spec/plan.md` - Architecture plan
- `specs/domain/001-{name}-spec/spec.md` - Initial specification concept

**If missing**:
- Stop and instruct user to run `/metaspec.sds.tasks` first

#### 2. Load Specification Context

**Step 2a: Determine Current Specification**

Get current specification from Git branch or SPECIFY_FEATURE:
```bash
# From Git branch
current_spec=$(git branch --show-current)
# Or from environment variable
current_spec=$SPECIFY_FEATURE

# Example: "003-payment-processing"
```

**Step 2b: Read Current Specification Metadata**

Read frontmatter from current specification's spec.md:
```yaml
---
spec_id: 003-payment-processing
parent: 001-order-spec
root: 001-order-spec
type: parent
---
```

**Store context for sub-specification creation**:
- `current_id`: "003-payment-processing"
- `parent_id`: "001-order-spec" or null
- `root_id`: "001-order-spec"

**This context will be passed to specify** when creating sub-specifications:
- Sub-specifications will have: parent={current_id}, root={root_id}
- Example: If current=003, sub-specification 013 will have parent=003, root=001

**Step 2c: Read Planning Documents**

**Read all planning documents**:
- `specs/domain/{current_id}/tasks.md` - Task list (REQUIRED)
- `specs/domain/{current_id}/plan.md` - Architecture (REQUIRED)
- `specs/domain/{current_id}/spec.md` - Initial concept (REQUIRED)
- `/memory/constitution.md` - Design principles

**Extract key information**:
- Specification domain and purpose
- Entity definitions
- Validation rules (initial)
- Use cases
- Strategy (single spec vs. multi-spec)

#### 3. Parse tasks.md Structure

**Extract from tasks.md**:
- Phase list (Core, Phase, Component, Support, Cross-Ref)
- Task list per phase
- Task format: `- [ ] [TID] [P?] [LABEL] Description with path`
- Dependencies (sequential vs parallel)
- Checkpoints

**Build execution plan**:
```
Phase 1: Core Specification
  - SDS-T001 [CORE] Refactor to core specification
  
Phase 2: Phase Specifications (if multi-spec)
  - SDS-T002 [P] [PHASE] Create phase 1 specification
  - SDS-T003 [P] [PHASE] Create phase 2 specification
  ...

Phase 3: Supporting Specifications
  - SDS-T008 [SUPPORT] Create support specification 1
  ...

Phase 4: Cross-Reference Validation
  - SDS-T011 [REFINE] Validate integration
  ...
```

#### 4. Execute Specification Writing

**Execution rules**:

1. **Phase-by-phase**:
   - Complete Phase N before starting Phase N+1
   - Verify checkpoint after each phase

2. **Specification-first approach**:
   - Write complete specification sections
   - Include all required elements (entities, operations, validation, examples)
   - Ensure clarity and completeness

3. **Respect dependencies**:
   - Sequential tasks: Execute in order
   - Parallel tasks `[P]`: Can execute simultaneously
   - Core specification must be complete before sub-specifications

4. **Progress tracking**:
   - Mark completed tasks: `- [ ]` ‚Üí `- [x]`
   - Report after each task
   - Save tasks.md after each phase

**Execution order**:

```
Phase 1: Core Specification
  ‚Üí Execute SDS-T001 (refactor to core overview)
  ‚Üí Checkpoint: Core specification defines integration points

Phase 2: Phase/Component Specifications (if multi-spec)
  ‚Üí Execute SDS-T002, T003, T004... in parallel (phase specifications)
  ‚Üí Checkpoint: All phase specifications complete

Phase 3: Supporting Specifications
  ‚Üí Execute SDS-T008, T009... (supporting specifications)
  ‚Üí Checkpoint: All supporting specifications complete

Phase 4: Cross-Reference Validation
  ‚Üí Execute SDS-T011, T012, T013 (validation)
  ‚Üí Checkpoint: All specifications integrated
```

#### 5. Task Execution Details

**For each task**:

1. **Parse task**:
   - Extract: Task ID, Label, Description, File path
   - Check: Is parallel `[P]`?
   - Check: Is checkpoint task?

2. **Execute task BASED ON LABEL**:
   
   **[CORE] - Core Specification Refactoring**:
   - Read existing `specs/domain/001-{name}-spec/spec.md`
   - Extract sections to keep (Overview, Glossary, Use Cases - high-level)
   - Identify sections to move to sub-specifications (detailed entities, operations)
   - Add integration points section referencing sub-specifications
   - Add dependency diagram showing specification structure
   - Target: 300-800 lines (overview only)
   
   **Output structure**:
   ```markdown
   # {Specification Name} Core Domain Specification
   
   **Version**: 1.0.0
   **Status**: Draft
   
   ## Specification Overview
   [Keep: High-level problem, solution, capabilities]
   
   ## Glossary
   [Keep: Key terms]
   
   ## Use Cases
   [Keep: High-level scenarios]
   
   ## Core Entities Overview
   [NEW: Brief entity descriptions, reference sub-specifications]
  - Entity 1: [Brief description] ‚Üí See domain/002-{entity1}-specification
  - Entity 2: [Brief description] ‚Üí See domain/003-{entity2}-specification
   
   ## Integration Points
   [NEW: How sub-specifications integrate]
   - Phase specifications: 002-007
   - Component specifications: 008-010
   - Supporting specifications: 011-013
   
   ## Specification Architecture
   [NEW: Dependency diagram from plan.md]
   
   ## Version History
   [Keep/Add: Version tracking]
   ```
   
   **[PHASE] - Phase Specification Creation (CREATE NEW FEATURE)**:
   
   **IMPORTANT**: This creates a NEW specification FEATURE, not just a file.
   
   **Step-by-step**:
   
   a. **Extract task context** (from tasks.md):
      ```
      - [ ] SDS-T002 [P] [PHASE] Create 013-credit-card-payment specification
        - Context: parent=003-payment-processing, root=001-order-spec
        - Specification: Credit card payment processing
        - Entities: CreditCardPayment, CardValidationResult
        - Operations: process_credit_card_payment, validate_card
      ```
   
   b. **Set environment variables** for specify:
      ```bash
      export PARENT_SPEC_ID="003-payment-processing"  # From task context
      export ROOT_SPEC_ID="001-order-spec"        # From task context
      export SPEC_NUMBER="013"                       # From task description
      ```
   
   c. **Call /metaspec.sds.specify internally**:
      - Pass task scope, entities, operations to specify
      - specify will detect context (PARENT_SPEC_ID set)
      - specify will create 013-credit-card-payment/ with correct frontmatter
      - specify generates spec.md with parent chain
   
   d. **Verify sub-specification created**:
      ```yaml
      # Generated in specs/domain/013-credit-card-payment/spec.md
      ---
      spec_id: 013-credit-card-payment
      parent: 003-payment-processing
      root: 001-order-spec
      type: leaf
      ---
      
      # Credit Card Payment Specification
      
      **Parent chain**: 001-order-spec > 003-payment-processing > 013-credit-card-payment
      ```
   
   e. **Update current specification** (003-payment-processing/spec.md):
      - Read current spec.md
      - Find or create "## Sub-Specifications" section
      - Add 013 to the table:
        ```markdown
        | ID | Payment Method | Status |
        |----|---------------|--------|
        | [013](../013-credit-card-payment/spec.md) | Credit Card | Stable |
        ```
      - Update type in frontmatter: `type: parent` (if not already)
   
   f. **Mark task complete**:
      - Update tasks.md: `- [ ]` ‚Üí `- [x]`
   
   **Target**: Sub-specification with 500-1500 lines (complete specification)
   
   **[COMPONENT] / [SUPPORT] - Create Sub-Specification FEATURE**:
   
   **Same process as [PHASE] above**. Only differences are:
   
   | Type | Focus | Target Lines |
   |------|-------|--------------|
   | **[COMPONENT]** | Component interface, registration, validation | 500-1500 |
   | **[SUPPORT]** | Cross-cutting concerns (orchestration, artifacts) | 300-800 |
   
   **[REFINE] - Refinement/Validation Tasks**:
   - Update existing specification(s)
   - Add cross-references
   - Validate consistency (terminology, entity names)
   - Check dependencies (no cycles)
   - Ensure completeness

3. **Use Sub-Specification Template**:

```markdown
# {Sub-Specification Name} Domain Specification

**Version**: 1.0.0  
**Status**: Draft  
**Last Updated**: {date}

---

## Dependencies

**Domain Specifications**:
- **Depends on**: domain/001-{core}-spec

### Dependency Rationale

{Explain what this sub-specification depends on from core specification:}
- Entities used: [List core entities referenced]
- Operations extended: [List operations]
- Validation rules inherited: [List rules]

---

## Specification Overview

**Name**: {Sub-Specification Name}  
**Domain**: {Specific concern within main specification}  
**Purpose**: {What problem this sub-specification solves}

**Problem Statement**: {Detailed problem description}

**Solution**: {How this sub-specification addresses the problem}

**Scope**:
- ‚úÖ Included: {What's in scope}
- ‚ùå Excluded: {What's out of scope}

---

## Glossary

{Terms specific to this sub-specification}

- **{Term 1}**: {Definition}
  - Example: {Example usage}
  
- **{Term 2}**: {Definition}

---

## Use Cases

### Use Case 1: {Scenario Name}

**Scenario**: {Description}

**Actors**:
- Actor 1: {Role}
- Actor 2: {Role}

**Flow**:
1. {Step 1}
2. {Step 2}
3. {Step 3}

**Specification Elements Used**:
- {Element 1}
- {Element 2}

**Outcome**: {Expected result}

---

## Core Entities

{Entities specific to this sub-specification}

### Entity: {EntityName}

**Purpose**: {What this entity represents}

**Schema**:
```yaml
entity_name:
  field1:
    type: string
    required: true
    description: {field description}
  field2:
    type: number
    required: false
    description: {field description}
    constraints:
      - {constraint 1}
      - {constraint 2}
```

**Validation Rules**:
- VR001: {Validation rule 1}
- VR002: {Validation rule 2}

**Example**:
```json
{
  "field1": "example value",
  "field2": 42
}
```

---

## Workflow

{If this sub-specification involves state transitions or lifecycle}

### State Machine: {Entity Name}

**States**:
- `state_1`: {State description}
- `state_2`: {State description}

**Initial State**: `{initial_state}`

**Allowed Transitions**:

#### `state_1` ‚Üí `state_2`
- **Trigger**: {What causes this transition}
- **Precondition**: {What must be true}
- **Action**: {What happens}
- **Postcondition**: {Result state}

**Forbidden Transitions**:
- ‚ùå `state_x` ‚Üí `state_y`: {Reason}

---

## Specification Operations

{Operations specific to this sub-specification}

### Operation: {operation_name}

**Purpose**: {What this operation does}

**Request Schema**:
```yaml
operation_request:
  param1:
    type: string
    required: true
  param2:
    type: object
    required: false
```

**Response Schema**:
```yaml
operation_response:
  result:
    type: string
  error:
    type: string
    required: false
```

**Validation Rules**:
- {Rule 1}
- {Rule 2}

**Example**:
```json
// Request
{
  "param1": "value"
}

// Response
{
  "result": "success"
}
```

---

## Validation Rules

### Entity Validation
1. **{Entity 1}**: {Validation rules}
2. **{Entity 2}**: {Validation rules}

### Operation Validation
1. **{Operation 1}**: {Validation rules}
2. **{Operation 2}**: {Validation rules}

### Cross-Entity Validation
1. {Rule 1}
2. {Rule 2}

---

## Error Handling

### Error Codes
- `E001`: {Error description}
- `E002`: {Error description}

### Error Response Format
```yaml
error_response:
  code: string
  message: string
  details: object (optional)
```

---

## Examples

### Example 1: {Scenario Name}

**Context**: {Setup}

**Request**:
```json
{example request}
```

**Response**:
```json
{example response}
```

**Validation**: ‚úÖ All rules pass

### Example 2: {Error Scenario}

**Context**: {Setup with error condition}

**Request**:
```json
{example request}
```

**Response**:
```json
{error response}
```

**Validation**: ‚ùå {Which rule failed}

---

## Integration with Core Specification

### Entity References

**From Core Specification**:
- {Core Entity 1}: {How used in this sub-specification}
- {Core Entity 2}: {How used in this sub-specification}

### Operation Extensions

**Extends Core Operations**:
- {Core Operation 1}: {How extended}

**New Operations**:
- {New Operation 1}: {Why needed}

### Validation Rule Inheritance

**Inherited Rules**:
- {Core Rule 1}: Applied to {this entity}
- {Core Rule 2}: Applied to {this entity}

**Extended Rules**:
- {Extended Rule 1}: {How it extends core rule}

---

## Clarifications

### Session {date}

- **Q**: {Question about ambiguity}
  **A**: {Resolution}

---

## Version History

- **v1.0.0** ({date}): Initial sub-specification specification
  - Defined {N} entities
  - Specified {N} operations
  - Established {N} validation rules

---

**Specification Maintainers**: {Team}  
**Contributing**: See `/memory/specification-constitution.md`  
**License**: {License}
```

4. **Verify specification completeness**:
   
   **For Core Specification**:
   - [ ] Specification overview is clear and concise
   - [ ] Glossary includes all key terms
   - [ ] Use cases show specification value
   - [ ] Entity overview lists all entities
   - [ ] Integration points reference all sub-specifications
   - [ ] Dependency diagram is accurate
   - [ ] Size: 300-800 lines
   
   **For Sub-Specifications**:
   - [ ] Dependencies section references core specification
   - [ ] Purpose and scope are clear
   - [ ] Entities have complete schemas
   - [ ] Operations have request/response definitions
   - [ ] Validation rules are comprehensive
   - [ ] Examples demonstrate usage
   - [ ] Integration section explains core specification relationship
   - [ ] Size: 300-1500 lines (varies by type)
   
   **For Refinement Tasks**:
   - [ ] Cross-references are correct
   - [ ] Terminology is consistent
   - [ ] Dependencies are acyclic
   - [ ] Entity names match across specifications

5. **Mark complete**:
   - Update tasks.md: `- [ ] SDS-T001` ‚Üí `- [x] SDS-T001`
   - Report: "‚úÖ SDS-T001 complete: Created core specification overview"

6. **Handle errors**:
   - If task fails: Report error, suggest fix
   - If sequential task fails: Halt phase
   - If parallel task fails: Continue others, report at end

#### 6. Phase Checkpoints

**After each phase**:

1. **Verify checkpoint criteria**:
   - Phase 1: `‚úÖ Core specification defines integration points clearly`
   - Phase 2: `‚úÖ All phase/component specifications complete (500-1500 lines each)`
   - Phase 3: `‚úÖ All supporting specifications complete (300-800 lines each)`
   - Phase 4: `‚úÖ All specifications integrated and consistent`

2. **If checkpoint fails**:
   - Stop phase
   - Report failing criteria
   - Suggest fixes
   - Ask user: "Fix issues and continue? (yes/no)"

3. **If checkpoint passes**:
   - Report success
   - Save tasks.md
   - Proceed to next phase

#### 7. Progress Reporting

**After each task**:
```
‚úÖ SDS-T002 complete: Created order-creation specification

üìÑ File created:
   specs/domain/002-order-creation-spec/spec.md
   
üìä Specification:
   - Entities: 4 (Order, CartItem, Customer, ValidationRule)
   - Operations: 3 (initialize_order, validate_cart, create_order)
   - Validation Rules: 15
   - Examples: 3
   - Size: 800 lines

‚úÖ Quality checks:
   - Dependencies: ‚úÖ References core specification
   - Entities: ‚úÖ Complete schemas
   - Validation: ‚úÖ Comprehensive rules
   - Examples: ‚úÖ Demonstrates usage
   - Integration: ‚úÖ Explains core specification relationship
```

**After each phase**:
```
‚úÖ Phase 2 complete: Phase Specifications

üìä Summary:
   - Tasks: 7/7 complete
   - Time: 2.5 days
   
   Specifications created:
   - 002-order-creation-spec (800 lines) ‚úÖ
   - 003-payment-processing-spec (950 lines) ‚úÖ
   - 004-fulfillment-spec (850 lines) ‚úÖ
   - 005-shipping-spec (780 lines) ‚úÖ
   - 006-delivery-spec (720 lines) ‚úÖ
   - 007-returns-spec (680 lines) ‚úÖ
   - 008-refunds-spec (650 lines) ‚úÖ
   
   Checkpoint: ‚úÖ All phase specifications complete
   
   Next: Phase 3 (Supporting Specifications)
```

**Overall progress**:
```
üìä Specification Progress: 7/13 tasks (54%)
   Phase 1: ‚úÖ 1/1 (Core Specification)
   Phase 2: ‚úÖ 6/6 (Phase Specifications)
   Phase 3: üîÑ 0/3 (Supporting Specifications)
   Phase 4: ‚è≥ 0/3 (Cross-Reference Validation)
```

#### 8. Cross-Reference Validation

**After all specifications written**:

1. **Check core specification references**:
   - Verify all sub-specification references are correct
   - Ensure paths match actual files
   - Check version references

2. **Check sub-specification dependencies**:
   - Verify "Depends on" sections reference correct specifications
   - Check entity references are valid
   - Ensure operation references are correct

3. **Check terminology consistency**:
   - Glossary terms used consistently
   - Entity names match across specifications
   - No conflicting definitions

4. **Check dependency graph**:
   - Draw dependency graph
   - Verify no circular dependencies
   - Ensure core specification is at root

5. **Generate cross-reference report**:
```
‚úÖ Cross-Reference Validation Complete

üìä Statistics:
   - Total specifications: 10
   - Core specification: 1
   - Sub-specifications: 9
   - Cross-references: 47

‚úÖ Validation Results:
   - Dependency graph: ‚úÖ Acyclic
   - Entity references: ‚úÖ All valid (47/47)
   - Operation references: ‚úÖ All valid (23/23)
   - Terminology: ‚úÖ Consistent (52 terms)
   - File paths: ‚úÖ All correct

üìä Dependency Summary:
   Core (001) ‚Üí 9 sub-specifications
   - Phase specifications: 002-007 (6 specs)
   - Supporting specifications: 008-010 (3 specs)
   
   No circular dependencies detected ‚úÖ
```

#### 9. Completion Validation

**After all phases**:

1. **Verify completeness**:
   - [ ] All tasks marked `[x]`
   - [ ] All checkpoints passed
   - [ ] All specifications written
   - [ ] Cross-references validated
   - [ ] Constitution compliant

2. **Quality checks**:
   - Total specification size: {X} lines across {N} files
   - Each specification < 1500 lines
   - All entities have examples
   - All validation rules documented
   - Terminology consistent

3. **Constitution compliance**:
   - ‚úÖ Minimal Viable Abstraction: Entities have 3-5 core fields
   - ‚úÖ Specification-First: Specification defines WHAT, not HOW
   - ‚úÖ Clear Boundaries: Sub-specifications have distinct responsibilities
   - ‚úÖ Progressive Enhancement: MVP scope defined (P0 complete)
   - ‚úÖ Domain Specificity: Domain constraints respected

4. **Generate report**:
   ```
   ‚úÖ Domain specification complete
   
   üìä Summary:
   - Total specifications: 12
     - Core specification: 1 (650 lines)
     - Phase specifications: 7 (650-950 lines each)
     - Supporting specifications: 4 (550-700 lines each)
   - Total size: 8,200 lines
   - Time: 5 days
   
   üì¶ Specifications:
   - ‚úÖ Core specification (001-order-spec)
   - ‚úÖ Order creation phase (002-order-creation-spec)
   - ‚úÖ Payment processing phase (003-payment-processing-spec)
   - ‚úÖ Fulfillment phase (004-fulfillment-spec)
   - ‚úÖ Shipping phase (005-shipping-spec)
   - ‚úÖ Delivery phase (006-delivery-spec)
   - ‚úÖ Returns phase (007-returns-spec)
   - ‚úÖ Refunds phase (008-refunds-spec)
   - ‚úÖ Payment gateway support (009-payment-gateway-spec)
   - ‚úÖ Inventory sync support (010-inventory-sync-spec)
   - ‚úÖ Notification support (011-notification-spec)
   - ‚úÖ Audit log support (012-audit-spec)
   
   ‚úÖ Quality Metrics:
   - Cross-references: 52 (all valid)
   - Dependencies: Acyclic (no cycles)
   - Terminology: Consistent (58 terms)
   - Examples: 31 (across all specs)
   - Validation rules: 172 (comprehensive)
   
   üéØ MVP Status:
   - v1.0.0 ready for publication
   - Core + P0 sub-specifications complete
   
   üîÑ Next steps:
   1. Run /metaspec.sds.checklist to verify quality
   2. Run /metaspec.sds.analyze to check consistency
   3. Share with stakeholders for review
   4. Update CHANGELOG.md
   5. Create git tag v1.0.0
   
   üí° Suggested commit message:
      docs: complete specification system v1.0.0
   ```

#### 10. Incremental Saves

**Save progress frequently**:
- Save tasks.md after each phase
- Commit specifications after each checkpoint
- Push to git after significant milestones

**Suggested commit messages**:
```bash
git commit -m "docs: complete core specification overview (Phase 1)"
git commit -m "docs: add phase specifications (Phase 2)"
git commit -m "docs: add supporting specifications (Phase 3)"
git commit -m "docs: validate cross-references (Phase 4)"
```

## Important Notes

1. **Specification quality is paramount**
   - Write clear, comprehensive specifications
   - Include concrete examples
   - Document validation rules completely
   - Ensure terminology consistency

2. **Phase isolation**
   - Don't start Phase N+1 until Phase N complete
   - Verify checkpoint after each phase
   - Fix issues before proceeding

3. **Parallel execution**
   - Sub-specifications marked `[P]` can be written in parallel
   - Only if they are independent
   - Report all results together

4. **Constitution alignment**
   - Check principles after each phase
   - Ensure specifications are minimal and clear
   - Avoid over-specification

5. **Cross-reference integrity**
   - Validate references after all specifications written
   - Fix broken references immediately
   - Ensure dependency graph is acyclic

6. **Progress visibility**
   - Report after each task
   - Show percentage complete
   - Estimate time remaining

## Example: Phase 2 Execution

**Phase 2: Phase Specifications (7 specifications)**

```
Starting Phase 2: Phase Specifications (7 tasks, can be parallel)

‚úÖ SDS-T002: Create order-creation specification
   File: specs/domain/002-order-creation-spec/spec.md
   Entities: 4 (Order, CartItem, Customer, ValidationRule)
   Operations: 3 (initialize_order, validate_cart, create_order)
   Validation rules: 15
   Examples: 3
   Size: 800 lines ‚úÖ

‚úÖ SDS-T003: Create payment-processing specification
   File: specs/domain/003-payment-processing-spec/spec.md
   Entities: 5 (Payment, Transaction, PaymentMethod, Gateway, Receipt)
   Operations: 4 (authorize, capture, refund, verify)
   Validation rules: 18
   Examples: 4
   Size: 950 lines ‚úÖ

‚úÖ SDS-T004: Create fulfillment specification
   File: specs/domain/004-fulfillment-spec/spec.md
   Entities: 5 (FulfillmentOrder, InventoryItem, PickList, PackingSlip, Warehouse)
   Operations: 4 (allocate_inventory, create_picklist, pack_items, mark_shipped)
   Validation rules: 16
   Examples: 3
   Size: 850 lines ‚úÖ

‚úÖ SDS-T005: Create shipping specification
   [Similar details]
   Size: 780 lines ‚úÖ

‚úÖ SDS-T006: Create delivery specification
   [Similar details]
   Size: 720 lines ‚úÖ

‚úÖ SDS-T007: Create returns specification
   [Similar details]
   Size: 680 lines ‚úÖ

‚úÖ SDS-T008: Create refunds specification
   [Similar details]
   Size: 650 lines ‚úÖ

‚úÖ Phase 2 checkpoint: All phase specifications complete (600-1000 lines each)

Phase 2 complete: 7/7 tasks (2.5 days)

Next: Phase 3 (Supporting Specifications)
```


