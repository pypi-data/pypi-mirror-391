{% extends "aws/base_resource.tf.j2" %}
{% block resources %}
{% for table in resources %}
{{ resource_spacer() }}
resource "aws_dynamodb_table" "{{ table.name_sanitized }}" {
  name           = "{{ table.tableName }}"
  billing_mode   = "{{ table.billingMode | default('PAY_PER_REQUEST') }}"
  
  {% if table.billingMode == 'PROVISIONED' or table.get('provisionedThroughput') %}
  read_capacity  = {{ table.provisionedThroughput.readCapacityUnits | default(5) }}
  write_capacity = {{ table.provisionedThroughput.writeCapacityUnits | default(5) }}
  {% endif %}

  hash_key       = "{{ table.get('hash_key', table.get('keySchema', [{}])[0].get('attributeName', '')) }}"
  {% if table.get('range_key') or (table.get('keySchema', [])|length > 1) %}
  range_key      = "{{ table.get('range_key', table.get('keySchema', [{}])[1].get('attributeName', '')) }}"
  {% endif %}

  {% if table.get('attributes') %}
  {% for attr in table.attributes %}
  attribute {
    name = "{{ attr.name }}"
    type = "{{ attr.type }}"
  }
  {% endfor %}
  {% elif table.get('attributeDefinitions') %}
  {% for attr in table.attributeDefinitions %}
  attribute {
    name = "{{ attr.attributeName }}"
    type = "{{ attr.attributeType }}"
  }
  {% endfor %}
  {% endif %}

  {% if table.get('ttl') %}
  ttl {
    attribute_name = "{{ table.ttl.attribute_name }}"
    enabled        = {{ table.ttl.enabled | lower }}
  }
  {% elif table.get('timeToLiveSpecification') %}
  ttl {
    attribute_name = "{{ table.timeToLiveSpecification.attributeName }}"
    enabled        = {{ table.timeToLiveSpecification.enabled | lower }}
  }
  {% endif %}

  {% if table.get('global_secondary_indexes') or table.get('globalSecondaryIndexes') %}
  {% for gsi in table.get('global_secondary_indexes', table.get('globalSecondaryIndexes', [])) %}
  global_secondary_index {
    name               = "{{ gsi.get('name', gsi.get('indexName')) }}"
    hash_key           = "{{ gsi.get('hash_key', gsi.get('keySchema', [{}])[0].get('attributeName', '')) }}"
    {% if gsi.get('range_key') or (gsi.get('keySchema', [])|length > 1) %}
    range_key          = "{{ gsi.get('range_key', gsi.get('keySchema', [{}])[1].get('attributeName', '')) }}"
    {% endif %}
    {% if gsi.get('write_capacity') or gsi.get('provisionedThroughput') %}
    write_capacity     = {{ gsi.get('write_capacity', gsi.get('provisionedThroughput', {}).get('writeCapacityUnits', 5)) }}
    read_capacity      = {{ gsi.get('read_capacity', gsi.get('provisionedThroughput', {}).get('readCapacityUnits', 5)) }}
    {% endif %}
    projection_type    = "{{ gsi.get('projection_type', gsi.get('projection', {}).get('projectionType', 'ALL')) }}"
    {% if gsi.get('non_key_attributes') or gsi.get('projection', {}).get('nonKeyAttributes') %}
    non_key_attributes = {{ (gsi.get('non_key_attributes', gsi.get('projection', {}).get('nonKeyAttributes', []))) | tojson }}
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  {% if table.get('local_secondary_indexes') or table.get('localSecondaryIndexes') %}
  {% for lsi in table.get('local_secondary_indexes', table.get('localSecondaryIndexes', [])) %}
  local_secondary_index {
    name               = "{{ lsi.get('name', lsi.get('indexName')) }}"
    range_key          = "{{ lsi.get('range_key', lsi.get('keySchema', [{}])[-1].get('attributeName', '')) }}"
    projection_type    = "{{ lsi.get('projection_type', lsi.get('projection', {}).get('projectionType', 'ALL')) }}"
    {% if lsi.get('non_key_attributes') or lsi.get('projection', {}).get('nonKeyAttributes') %}
    non_key_attributes = {{ (lsi.get('non_key_attributes', lsi.get('projection', {}).get('nonKeyAttributes', []))) | tojson }}
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  {% if table.get('stream_enabled') is defined or table.get('streamSpecification') %}
  stream_enabled   = {{ table.get('stream_enabled', table.get('streamSpecification', {}).get('streamEnabled', false)) | lower }}
  {% if table.get('stream_view_type') or table.get('streamSpecification', {}).get('streamViewType') %}
  stream_view_type = "{{ table.get('stream_view_type', table.get('streamSpecification', {}).get('streamViewType')) }}"
  {% endif %}
  {% endif %}

  {% if table.get('server_side_encryption') or table.get('sseSpecification') %}
  server_side_encryption {
    enabled     = {{ table.get('server_side_encryption', {}).get('enabled', table.get('sseSpecification', {}).get('enabled', true)) | lower }}
    {% if table.get('server_side_encryption', {}).get('kms_key_arn') or table.get('sseSpecification', {}).get('kmsMasterKeyId') %}
    kms_key_arn = "{{ table.get('server_side_encryption', {}).get('kms_key_arn', table.get('sseSpecification', {}).get('kmsMasterKeyId')) }}"
    {% endif %}
  }
  {% endif %}

  {% if table.get('replica') %}
  {% for replica in table.replica %}
  replica {
    region_name = "{{ replica.region_name }}"
    {% if replica.get('kms_key_arn') %}
    kms_key_arn = "{{ replica.kms_key_arn }}"
    {% endif %}
    {% if replica.get('propagate_tags') is defined %}
    propagate_tags = {{ replica.propagate_tags | lower }}
    {% endif %}
    {% if replica.get('point_in_time_recovery') is defined %}
    point_in_time_recovery = {{ replica.point_in_time_recovery | lower }}
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  {% if table.get('restore_source_name') %}
  restore_source_name = "{{ table.restore_source_name }}"
  {% endif %}

  {% if table.get('restore_date_time') %}
  restore_date_time = "{{ table.restore_date_time }}"
  {% endif %}

  {% if table.get('restore_to_latest_time') is defined %}
  restore_to_latest_time = {{ table.restore_to_latest_time | lower }}
  {% endif %}

  {% if table.get('point_in_time_recovery') or table.get('pointInTimeRecoverySpecification') %}
  point_in_time_recovery {
    enabled = {{ table.get('point_in_time_recovery', {}).get('enabled', table.get('pointInTimeRecoverySpecification', {}).get('pointInTimeRecoveryEnabled', false)) | lower }}
  }
  {% endif %}

  {% if table.get('table_class') or table.get('tableClass') %}
  table_class = "{{ table.get('table_class', table.get('tableClass')) }}"
  {% endif %}

  {% if table.get('deletion_protection_enabled') is defined %}
  deletion_protection_enabled = {{ table.deletion_protection_enabled | lower }}
  {% endif %}

  {{ render_common_tags(table, indent=2) }}

  {% if table.get('lifecycle_prevent_destroy', true) %}
  lifecycle {
    prevent_destroy = true
  }
  {% endif %}
}

{% if table.get('autoscaling_enabled') %}
{% if table.billingMode == 'PROVISIONED' or table.get('provisionedThroughput') %}
resource "aws_appautoscaling_target" "{{ table.name_sanitized }}_read" {
  max_capacity       = {{ table.autoscaling_read_max_capacity | default(100) }}
  min_capacity       = {{ table.autoscaling_read_min_capacity | default(5) }}
  resource_id        = "table/${aws_dynamodb_table.{{ table.name_sanitized }}.name}"
  scalable_dimension = "dynamodb:table:ReadCapacityUnits"
  service_namespace  = "dynamodb"
}

resource "aws_appautoscaling_policy" "{{ table.name_sanitized }}_read" {
  name               = "{{ table.tableName }}-read-autoscaling"
  policy_type        = "TargetTrackingScaling"
  resource_id        = aws_appautoscaling_target.{{ table.name_sanitized }}_read.resource_id
  scalable_dimension = aws_appautoscaling_target.{{ table.name_sanitized }}_read.scalable_dimension
  service_namespace  = aws_appautoscaling_target.{{ table.name_sanitized }}_read.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "DynamoDBReadCapacityUtilization"
    }
    target_value = {{ table.autoscaling_read_target | default(70.0) }}
  }
}

resource "aws_appautoscaling_target" "{{ table.name_sanitized }}_write" {
  max_capacity       = {{ table.autoscaling_write_max_capacity | default(100) }}
  min_capacity       = {{ table.autoscaling_write_min_capacity | default(5) }}
  resource_id        = "table/${aws_dynamodb_table.{{ table.name_sanitized }}.name}"
  scalable_dimension = "dynamodb:table:WriteCapacityUnits"
  service_namespace  = "dynamodb"
}

resource "aws_appautoscaling_policy" "{{ table.name_sanitized }}_write" {
  name               = "{{ table.tableName }}-write-autoscaling"
  policy_type        = "TargetTrackingScaling"
  resource_id        = aws_appautoscaling_target.{{ table.name_sanitized }}_write.resource_id
  scalable_dimension = aws_appautoscaling_target.{{ table.name_sanitized }}_write.scalable_dimension
  service_namespace  = aws_appautoscaling_target.{{ table.name_sanitized }}_write.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "DynamoDBWriteCapacityUtilization"
    }
    target_value = {{ table.autoscaling_write_target | default(70.0) }}
  }
}
{% endif %}
{% endif %}

{% endfor %}
{% endblock %}
