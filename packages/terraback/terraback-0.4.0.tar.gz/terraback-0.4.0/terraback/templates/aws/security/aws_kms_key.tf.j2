{% extends "aws/base_resource.tf.j2" %}
{% block resources %}
{% for key in resources %}
{{ resource_spacer() }}
resource "aws_kms_key" "{{ key.name_sanitized }}" {
  {% if key.get('description') %}
  description = "{{ key.description }}"
  {% endif %}

  {% if key.get('key_usage') %}
  key_usage = "{{ key.key_usage }}"
  {% elif key.get('keyUsage') %}
  key_usage = "{{ key.keyUsage }}"
  {% endif %}

  {% if key.get('customer_master_key_spec') %}
  customer_master_key_spec = "{{ key.customer_master_key_spec }}"
  {% elif key.get('customerMasterKeySpec') %}
  customer_master_key_spec = "{{ key.customerMasterKeySpec }}"
  {% elif key.get('keySpec') %}
  customer_master_key_spec = "{{ key.keySpec }}"
  {% endif %}

  {% if key.get('is_enabled') is defined %}
  is_enabled = {{ key.is_enabled | lower }}
  {% elif key.get('enabled') is defined %}
  is_enabled = {{ key.enabled | lower }}
  {% endif %}

  {% if key.get('enable_key_rotation') is defined %}
  enable_key_rotation = {{ key.enable_key_rotation | lower }}
  {% elif key.get('keyRotationEnabled') is defined %}
  enable_key_rotation = {{ key.keyRotationEnabled | lower }}
  {% endif %}

  {% if key.get('deletion_window_in_days') %}
  deletion_window_in_days = {{ key.deletion_window_in_days }}
  {% elif key.get('pendingDeletionWindowInDays') %}
  deletion_window_in_days = {{ key.pendingDeletionWindowInDays }}
  {% endif %}

  {% if key.get('policy') %}
  policy = jsonencode({{ key.policy | tojson }})
  {% elif key.get('keyPolicy') %}
  policy = jsonencode({{ key.keyPolicy | tojson }})
  {% endif %}

  {% if key.get('bypass_policy_lockout_safety_check') is defined %}
  bypass_policy_lockout_safety_check = {{ key.bypass_policy_lockout_safety_check | lower }}
  {% endif %}

  {% if key.get('multi_region') is defined %}
  multi_region = {{ key.multi_region | lower }}
  {% elif key.get('multiRegion') is defined %}
  multi_region = {{ key.multiRegion | lower }}
  {% endif %}

  {{ render_common_tags(key, indent=2) }}

  {% if key.get('lifecycle_prevent_destroy', true) %}
  lifecycle {
    prevent_destroy = true
  }
  {% endif %}
}

resource "aws_kms_alias" "{{ key.name_sanitized }}" {
  {% if key.get('alias_name') %}
  name = "{{ key.alias_name }}"
  {% elif key.get('aliasName') %}
  name = "{{ key.aliasName }}"
  {% elif key.get('aliases') and key.aliases|length > 0 %}
  name = "{{ key.aliases[0].aliasName }}"
  {% else %}
  name = "alias/{{ key.name_sanitized }}"
  {% endif %}
  
  target_key_id = aws_kms_key.{{ key.name_sanitized }}.key_id
}

{% if key.get('grant_tokens') or key.get('grants') %}
{% for grant in key.get('grants', []) %}
{{ resource_spacer() }}
resource "aws_kms_grant" "{{ key.name_sanitized }}_{{ loop.index }}" {
  name              = "{{ grant.get('name', 'grant-' + loop.index|string) }}"
  key_id            = aws_kms_key.{{ key.name_sanitized }}.key_id
  grantee_principal = "{{ grant.granteePrincipal }}"
  
  {% if grant.get('operations') %}
  operations = {{ grant.operations | tojson }}
  {% endif %}

  {% if grant.get('constraints') %}
  {% for constraint in grant.constraints %}
  constraints {
    {% if constraint.get('encryptionContextEquals') %}
    encryption_context_equals = {{ constraint.encryptionContextEquals | tojson }}
    {% endif %}
    {% if constraint.get('encryptionContextSubset') %}
    encryption_context_subset = {{ constraint.encryptionContextSubset | tojson }}
    {% endif %}
  }
  {% endfor %}
  {% endif %}

  {% if grant.get('retiringPrincipal') %}
  retiring_principal = "{{ grant.retiringPrincipal }}"
  {% endif %}

  {% if grant.get('grant_creation_tokens') %}
  grant_creation_tokens = {{ grant.grant_creation_tokens | tojson }}
  {% elif grant.get('tokens') %}
  grant_creation_tokens = {{ grant.tokens | tojson }}
  {% endif %}
}

{% endfor %}
{% endif %}

{% if key.get('replica_keys') %}
{% for replica in key.replica_keys %}
{{ resource_spacer() }}
resource "aws_kms_replica_key" "{{ key.name_sanitized }}_{{ replica.region | replace('-', '_') }}" {
  description             = "{{ replica.get('description', key.get('description', 'Multi-region replica key')) }}"
  primary_key_arn         = aws_kms_key.{{ key.name_sanitized }}.arn
  
  {% if replica.get('policy') %}
  policy = jsonencode({{ replica.policy | tojson }})
  {% endif %}

  {% if replica.get('deletion_window_in_days') %}
  deletion_window_in_days = {{ replica.deletion_window_in_days }}
  {% endif %}

  {% if replica.get('bypass_policy_lockout_safety_check') is defined %}
  bypass_policy_lockout_safety_check = {{ replica.bypass_policy_lockout_safety_check | lower }}
  {% endif %}

  {{ render_common_tags(replica, indent=2) }}

  provider = aws.{{ replica.region | replace('-', '_') }}
}

{% endfor %}
{% endif %}

{% endfor %}
{% endblock %}
