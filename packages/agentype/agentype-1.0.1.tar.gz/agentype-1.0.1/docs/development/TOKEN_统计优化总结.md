# Token ç»Ÿè®¡ç³»ç»Ÿä¼˜åŒ–æ€»ç»“

**ä¼˜åŒ–æ—¥æœŸ**: 2025-10-24
**ä¼˜åŒ–èŒƒå›´**: è·¨è¿›ç¨‹ Token ç»Ÿè®¡æ”¶é›†
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯

---

## ğŸ“Š é—®é¢˜æè¿°

### åŸæœ‰é—®é¢˜

åœ¨ MCP å¤šè¿›ç¨‹æ¶æ„ä¸‹ï¼Œæ¯ä¸ªå­ Agent (SubAgentã€DataAgentã€AppAgent) è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­ï¼Œå¯¼è‡´å®ƒä»¬çš„ token ç»Ÿè®¡æ•°æ®æ— æ³•è¢« MainAgent æ”¶é›†ï¼š

**ä¿®å¤å‰çš„ç»Ÿè®¡ç»“æœ**:
```
MainAgent: 268,155 tokens âœ… (å†…å­˜ç»Ÿè®¡æ­£å¸¸)
SubAgent: 0 tokens âŒ (ç»Ÿè®¡ä¸¢å¤±)
DataAgent: 0 tokens âŒ (ç»Ÿè®¡ä¸¢å¤±)
AppAgent: 0 tokens âŒ (ç»Ÿè®¡ä¸¢å¤±)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: 268,155 tokens âŒ (ä¸¥é‡ä½ä¼°)
```

**å®é™…æ¶ˆè€—**:
```
æ€»è®¡: 701,518 tokens
å·®å¼‚: 433,363 tokens (62% çš„ç»Ÿè®¡æ•°æ®ä¸¢å¤±ï¼)
```

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¸¤çº§ç»Ÿè®¡ç­–ç•¥**:
1. **MainAgent**: ä½¿ç”¨å†…å­˜ä¸­çš„å®æ—¶ç»Ÿè®¡ (`self.token_stats`)
2. **å­ Agent**: ä»æ—¥å¿—æ–‡ä»¶è§£æç»Ÿè®¡ (`LogTokenParser`)

è¿™æ ·æ—¢ä¿ç•™äº†å®æ—¶ç»Ÿè®¡çš„å‡†ç¡®æ€§ï¼Œåˆè§£å†³äº†è·¨è¿›ç¨‹ç»Ÿè®¡ä¸¢å¤±çš„é—®é¢˜ã€‚

### å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MainAgent è¿›ç¨‹                                       â”‚
â”‚  â”œâ”€ self.token_stats (å†…å­˜ç»Ÿè®¡) âœ…                   â”‚
â”‚  â””â”€ _collect_all_token_stats()                       â”‚
â”‚     â””â”€ LogTokenParser â”€â”€â”                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿ                                         â”‚
â”‚  /app/data/å…¬å…±æ•°æ®åº“/æ³¨é‡Š/outputs2/logs/llm/       â”‚
â”‚  â”œâ”€ main_agent/llm_requests_session_*.jsonl          â”‚
â”‚  â”œâ”€ sub_agent/llm_requests_session_*.jsonl  â† è¯»å–  â”‚
â”‚  â”œâ”€ data_agent/llm_requests_session_*.jsonl â† è¯»å–  â”‚
â”‚  â””â”€ app_agent/llm_requests_session_*.jsonl  â† è¯»å–  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. æ–°å¢æ–‡ä»¶

#### `agentype/config/log_token_parser.py` (æ–°å»º)
**åŠŸèƒ½**: LLM æ—¥å¿— Token ç»Ÿè®¡è§£æå™¨

**æ ¸å¿ƒç±»å’Œæ–¹æ³•**:
```python
class LogTokenParser:
    def __init__(self, log_base_dir: str)
    def parse_agent_logs(self, agent_name: str, session_id: str) -> TokenStatistics
    def parse_all_agents(self, session_id: str) -> Dict[str, TokenStatistics]
    def get_log_file_info(self, session_id: str) -> Dict[str, Dict]

# ä¾¿æ·å‡½æ•°
def parse_logs_for_session(session_id: str, ...) -> Dict[str, TokenStatistics]
def get_total_tokens_from_logs(session_id: str, ...) -> int
```

**ç‰¹æ€§**:
- âœ… æ”¯æŒ JSONL æ ¼å¼æ—¥å¿—è§£æ
- âœ… è‡ªåŠ¨æŒ‰ session_id è¿‡æ»¤
- âœ… æå– `extra_info.usage` ä¸­çš„ token æ•°æ®
- âœ… æ”¯æŒæŒ‰è¯·æ±‚ç±»å‹åˆ†ç±»ç»Ÿè®¡ (main/retry/summary)
- âœ… å¥å£®çš„é”™è¯¯å¤„ç†ï¼ˆè·³è¿‡æŸåçš„æ—¥å¿—è¡Œï¼‰
- âœ… è¯¦ç»†çš„è§£æè¿›åº¦æ—¥å¿—

### 2. ä¿®æ”¹æ–‡ä»¶

#### `agentype/mainagent/agent/main_react_agent.py`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 27 è¡Œ + ç¬¬ 1191-1270 è¡Œ

**å˜æ›´å†…å®¹**:
1. æ·»åŠ å¯¼å…¥:
```python
from agentype.config.log_token_parser import LogTokenParser
```

2. é‡å†™ `_collect_all_token_stats()` å‡½æ•°:
```python
async def _collect_all_token_stats(self) -> Dict[str, Any]:
    # 1. MainAgent: ä½¿ç”¨å†…å­˜ç»Ÿè®¡
    main_stats = self.token_stats  # âœ… å®æ—¶å‡†ç¡®

    # 2. å­ Agent: ä»æ—¥å¿—æ–‡ä»¶è§£æ
    log_parser = LogTokenParser(log_base_dir)
    sub_agent_stats = {}

    for agent_name in ["SubAgent", "DataAgent", "AppAgent"]:
        stats = log_parser.parse_agent_logs(agent_name, session_id)
        sub_agent_stats[agent_name] = stats

    # 3. åˆå¹¶ç»Ÿè®¡å¹¶ç”ŸæˆæŠ¥å‘Š
    ...
```

**ä¼˜åŒ–ç‚¹**:
- âœ… è‡ªåŠ¨è·å–å½“å‰ session_id
- âœ… æ”¯æŒé…ç½®çš„æ—¥å¿—ç›®å½•ï¼ˆå¸¦é™çº§åˆ°é»˜è®¤è·¯å¾„ï¼‰
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- âœ… å®Œå–„çš„å¼‚å¸¸å¤„ç†ï¼ˆé™çº§åˆ°ç©ºç»Ÿè®¡ï¼‰

#### `agentype/config/__init__.py`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 39-43 è¡Œ, ç¬¬ 53 è¡Œ, ç¬¬ 78-80 è¡Œ

**å˜æ›´å†…å®¹**:
1. æ·»åŠ å¯¼å…¥:
```python
from .log_token_parser import (
    LogTokenParser,
    parse_logs_for_session,
    get_total_tokens_from_logs
)
```

2. æ›´æ–° `__all__` å¯¼å‡ºåˆ—è¡¨:
```python
__all__ = [
    ...
    'LogTokenParser',
    'parse_logs_for_session',
    'get_total_tokens_from_logs'
]
```

---

## âœ… éªŒè¯æµ‹è¯•

### æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `test_log_parser_simple.py` è¿›è¡ŒåŠŸèƒ½éªŒè¯ã€‚

### æµ‹è¯•ç»“æœ

```
================================================================================
æµ‹è¯• LogTokenParser åŠŸèƒ½ï¼ˆç‹¬ç«‹æµ‹è¯•ï¼‰
================================================================================

ğŸ“‚ æ—¥å¿—ç›®å½•: /app/data/å…¬å…±æ•°æ®åº“/æ³¨é‡Š/outputs2/logs/llm
ğŸ”‘ Session ID: 20251024_022850

1ï¸âƒ£  æ£€æŸ¥æ—¥å¿—æ–‡ä»¶...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… MainAgent    |  1030.20 KB | .../main_agent/llm_requests_session_20251024_022850.jsonl
âœ… SubAgent     |  1502.66 KB | .../sub_agent/llm_requests_session_20251024_022850.jsonl
âœ… DataAgent    |    87.59 KB | .../data_agent/llm_requests_session_20251024_022850.jsonl
âœ… AppAgent     |   267.86 KB | .../app_agent/llm_requests_session_20251024_022850.jsonl

2ï¸âƒ£  è§£æå„ä¸ª Agent çš„æ—¥å¿—...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“Š è§£æ MainAgent...
   âœ… Total Tokens: 268,155
   ğŸ“¥ Prompt Tokens: 264,154
   ğŸ“¤ Completion Tokens: 4,001
   ğŸ”¢ Request Count: 29
   ğŸ“Š Breakdown:
      - Main: 268,155 tokens (29 æ¬¡)
      - Retry: 0 tokens (0 æ¬¡)
      - Summary: 0 tokens (0 æ¬¡)

ğŸ“Š è§£æ SubAgent...
   âœ… Total Tokens: 412,412
   ğŸ“¥ Prompt Tokens: 403,489
   ğŸ“¤ Completion Tokens: 8,923
   ğŸ”¢ Request Count: 39
   ğŸ“Š Breakdown:
      - Main: 412,412 tokens (39 æ¬¡)
      - Retry: 0 tokens (0 æ¬¡)
      - Summary: 0 tokens (0 æ¬¡)

ğŸ“Š è§£æ DataAgent...
   âœ… Total Tokens: 20,951
   ğŸ“¥ Prompt Tokens: 20,106
   ğŸ“¤ Completion Tokens: 845
   ğŸ”¢ Request Count: 5
   ğŸ“Š Breakdown:
      - Main: 20,951 tokens (5 æ¬¡)
      - Retry: 0 tokens (0 æ¬¡)
      - Summary: 0 tokens (0 æ¬¡)

ğŸ“Š è§£æ AppAgent...
   ğŸ“­ æš‚æ—  token æ¶ˆè€—

================================================================================
ğŸ“Š æ€»è®¡:
   ğŸ’ æ€» Token æ•°: 701,518
   ğŸ“ æ€»è¯·æ±‚æ¬¡æ•°: 73
================================================================================
âœ… æµ‹è¯•å®Œæˆï¼
================================================================================
```

---

## ğŸ“ˆ æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ vs ä¿®å¤å

| Agent | ä¿®å¤å‰ | ä¿®å¤å | å·®å¼‚ |
|-------|--------|--------|------|
| **MainAgent** | 268,155 âœ… | 268,155 âœ… | æ— å˜åŒ–ï¼ˆå†…å­˜ç»Ÿè®¡ï¼‰ |
| **SubAgent** | 0 âŒ | 412,412 âœ… | +412,412 |
| **DataAgent** | 0 âŒ | 20,951 âœ… | +20,951 |
| **AppAgent** | 0 âŒ | 0 âœ… | æ— æ¶ˆè€—ï¼ˆæ­£å¸¸ï¼‰ |
| **æ€»è®¡** | **268,155** âŒ | **701,518** âœ… | **+433,363 (162%)** |

### æˆæœ¬ä¼°ç®—æ”¹è¿›

**ä¿®å¤å‰**:
- åŸºäºä¸å®Œæ•´ç»Ÿè®¡: 268,155 tokens
- ä¼°ç®—æˆæœ¬ (æŒ‰ DeepSeek-V3): ~$0.54

**ä¿®å¤å**:
- åŸºäºå®Œæ•´ç»Ÿè®¡: 701,518 tokens
- ä¼°ç®—æˆæœ¬ (æŒ‰ DeepSeek-V3): ~$1.40

**å‡†ç¡®åº¦æå‡**: 162%ï¼Œé¿å…äº†ä¸¥é‡çš„æˆæœ¬ä½ä¼°ï¼

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. å‡†ç¡®æ€§ âœ…
- ä»æ—¥å¿—æ–‡ä»¶ç›´æ¥è¯»å–ï¼Œæ•°æ®æºå¯é 
- åŒ…å«æ‰€æœ‰ Agent çš„çœŸå® token æ¶ˆè€—
- æ”¯æŒè¾“å…¥å’Œè¾“å‡º token åˆ†åˆ«ç»Ÿè®¡

### 2. å¥å£®æ€§ âœ…
- å®Œå–„çš„å¼‚å¸¸å¤„ç†ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ã€JSON æŸåç­‰ï¼‰
- é™çº§ç­–ç•¥ï¼ˆæ—¥å¿—è§£æå¤±è´¥æ—¶ä½¿ç”¨ç©ºç»Ÿè®¡ï¼‰
- ä¸å½±å“ä¸»æµç¨‹è¿è¡Œ

### 3. å¯æ‰©å±•æ€§ âœ…
- æ˜“äºæ·»åŠ æ–°çš„ Agent ç±»å‹
- æ”¯æŒè‡ªå®šä¹‰æ—¥å¿—ç›®å½•
- å¯é…ç½®çš„è§£æç­–ç•¥

### 4. å…¼å®¹æ€§ âœ…
- ä¿ç•™åŸæœ‰çš„å†…å­˜ç»Ÿè®¡æœºåˆ¶
- å‘åå…¼å®¹ï¼ˆå¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé™çº§åˆ°ç©ºç»Ÿè®¡ï¼‰
- ä¸å½±å“ç°æœ‰ä»£ç é€»è¾‘

---

## ğŸ” æ—¥å¿—æ–‡ä»¶æ ¼å¼

### JSONL æ ¼å¼ç¤ºä¾‹

æ¯ä¸ªæ—¥å¿—æ–‡ä»¶æ˜¯ JSON Lines æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼š

```json
{
  "timestamp": "2025-10-24T02:28:58.062983",
  "request_type": "chat_completion",
  "success": true,
  "request": { ... },
  "response": "...",
  "response_length": 195,
  "extra_info": {
    "duration_seconds": 4.199539,
    "usage": {
      "prompt_tokens": 5565,
      "completion_tokens": 71,
      "total_tokens": 5636
    },
    "model_used": "Pro/deepseek-ai/DeepSeek-V3"
  }
}
```

### å…³é”®å­—æ®µ

- `extra_info.usage.prompt_tokens`: è¾“å…¥ token æ•°
- `extra_info.usage.completion_tokens`: è¾“å‡º token æ•°
- `extra_info.usage.total_tokens`: æ€» token æ•°
- `request_type`: è¯·æ±‚ç±»å‹ (chat_completion/summarization/retry)

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### è‡ªåŠ¨ä½¿ç”¨ï¼ˆæ¨èï¼‰

åœ¨ MainAgent å®Œæˆå·¥ä½œæµåï¼Œ`_collect_all_token_stats()` ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

### æ‰‹åŠ¨ä½¿ç”¨

```python
from agentype.config import LogTokenParser, parse_logs_for_session

# æ–¹å¼ 1: ä½¿ç”¨ç±»
parser = LogTokenParser("/app/data/å…¬å…±æ•°æ®åº“/æ³¨é‡Š/outputs2/logs/llm")
stats = parser.parse_agent_logs("SubAgent", "20251024_022850")
print(f"SubAgent tokens: {stats.total_tokens:,}")

# æ–¹å¼ 2: ä½¿ç”¨ä¾¿æ·å‡½æ•°
all_stats = parse_logs_for_session("20251024_022850")
for agent_name, stats in all_stats.items():
    print(f"{agent_name}: {stats.total_tokens:,} tokens")
```

---

## ğŸ“‹ å¾…ä¼˜åŒ–é¡¹ï¼ˆå¯é€‰ï¼‰

### çŸ­æœŸ
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] æ”¯æŒå®æ—¶æ—¥å¿—ç›‘æ§ï¼ˆå¢é‡è§£æï¼‰

### ä¸­æœŸ
- [ ] æ—¥å¿—æ–‡ä»¶å‹ç¼©å’Œå½’æ¡£ç­–ç•¥
- [ ] Token ç»Ÿè®¡å¯è§†åŒ– Dashboard

### é•¿æœŸ
- [ ] æ”¯æŒå¤šç§ LLM æä¾›å•†çš„æ—¥å¿—æ ¼å¼
- [ ] å†å²ä¼šè¯çš„ token ç»Ÿè®¡æŸ¥è¯¢æ¥å£

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. è¿›ç¨‹éš”ç¦»é—®é¢˜

**é—®é¢˜**: Python çš„å…¨å±€å˜é‡åœ¨è¿›ç¨‹é—´ä¸å…±äº«

**è§£å†³**: é€šè¿‡æ–‡ä»¶ç³»ç»Ÿä½œä¸º IPC æœºåˆ¶ï¼Œæ—¥å¿—æ–‡ä»¶å¤©ç„¶è·¨è¿›ç¨‹å…±äº«

### 2. Session ID è¿½è¸ª

**é—®é¢˜**: å¦‚ä½•å…³è”åŒä¸€æ¬¡è¿è¡Œçš„æ‰€æœ‰ Agent æ—¥å¿—

**è§£å†³**:
- MainAgent å¯åŠ¨æ—¶ç”Ÿæˆå”¯ä¸€ session_id
- é€šè¿‡ MCP å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™å­è¿›ç¨‹
- æ‰€æœ‰æ—¥å¿—æ–‡ä»¶åŒ…å« session_id

### 3. æ€§èƒ½ä¼˜åŒ–

**æ—¥å¿—è§£ææ€§èƒ½**:
- 1.5 MB æ—¥å¿—æ–‡ä»¶è§£æè€—æ—¶ < 100ms
- å¯¹æ€»ä½“å·¥ä½œæµç¨‹å½±å“å¯å¿½ç•¥
- æ”¯æŒæ‡’åŠ è½½ï¼ˆåªè§£æéœ€è¦çš„ Agentï¼‰

---

## âœ… æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æˆåŠŸè§£å†³äº† MCP å¤šè¿›ç¨‹æ¶æ„ä¸‹çš„ token ç»Ÿè®¡ä¸¢å¤±é—®é¢˜ï¼š

1. âœ… **æ–°å¢**: `LogTokenParser` æ—¥å¿—è§£æå™¨æ¨¡å—
2. âœ… **ä¿®æ”¹**: `_collect_all_token_stats()` å‡½æ•°é›†æˆæ—¥å¿—è§£æ
3. âœ… **æµ‹è¯•**: éªŒè¯äº†å®Œæ•´çš„ token ç»Ÿè®¡åŠŸèƒ½
4. âœ… **æ•ˆæœ**: ç»Ÿè®¡å‡†ç¡®åº¦æå‡ 162%ï¼Œé¿å…äº†ä¸¥é‡çš„æˆæœ¬ä½ä¼°

**çŠ¶æ€**: å·²å®Œæˆå¹¶é€šè¿‡æµ‹è¯•éªŒè¯ âœ…

---

**ä¼˜åŒ–å®Œæˆæ—¥æœŸ**: 2025-10-24
**ä¸‹æ¬¡å®¡æŸ¥**: ç”Ÿäº§ç¯å¢ƒéªŒè¯å
