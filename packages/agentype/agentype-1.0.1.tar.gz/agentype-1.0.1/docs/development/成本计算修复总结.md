# æˆæœ¬è®¡ç®—ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä½¿ç”¨ DeepSeek Reasoner æ¨¡å‹æ—¶ï¼Œå‘ç°æˆæœ¬ç»Ÿè®¡ä¸å‡†ç¡®ï¼š

**ç”¨æˆ·çš„æµ‹è¯•ç»“æœ**ï¼š
```json
{
  "total": {
    "model_name": "deepseek-reasoner",
    "total_tokens": 364523,
    "prompt_tokens": 329170,
    "completion_tokens": 35353,
    "estimated_cost": 11.9963,
    "currency": "USD"
  }
}
```

**é—®é¢˜**ï¼šæˆæœ¬æ˜¾ç¤ºä¸º $11.9963 USDï¼Œä½†è¿™æ˜¯æŒ‰ç…§ GPT-4 å®šä»·è®¡ç®—çš„ï¼Œå®é™…åº”è¯¥æŒ‰ DeepSeek å®šä»·è®¡ç®—ã€‚

## ğŸ” é—®é¢˜æ ¹æº

ä»£ç å·²ç»æœ‰å®Œæ•´çš„å¤šè´§å¸ã€å¤šAPIå®šä»·æ”¯æŒç³»ç»Ÿï¼ˆ`PricingRegistry`ï¼‰ï¼Œå¹¶ä¸”å·²ç»é…ç½®äº† DeepSeek çš„æ­£ç¡®å®šä»·ï¼š

```python
# DeepSeek APIå®šä»·ï¼ˆäººæ°‘å¸è®¡ä»·ï¼Œç™¾ä¸‡tokensï¼‰
deepseek_pricing = {
    "deepseek-reasoner": ModelPricing(2.0, 3.0, "CNY", True),
    # è¾“å…¥: Â¥2.0/1M tokens, è¾“å‡º: Â¥3.0/1M tokens
}
```

ä½†åœ¨è°ƒç”¨æˆæœ¬è®¡ç®—æ–¹æ³•æ—¶ï¼Œ**å¿˜è®°ä¼ é€’ `api_base` å‚æ•°**ï¼Œå¯¼è‡´ç³»ç»Ÿå›é€€åˆ°é»˜è®¤çš„ GPT-4 å®šä»·ã€‚

### å…·ä½“é—®é¢˜ä½ç½®

1. **`_collect_all_token_stats()` æ–¹æ³•** (lines 1287-1295)
   - âŒ `self.token_stats.get_summary()` - æœªä¼ é€’ api_base
   - âŒ `stats.get_summary()` - æœªä¼ é€’ api_base
   - âŒ `total_stats.get_summary()` - æœªä¼ é€’ api_base
   - âŒ `generate_simple_report(total_stats)` - æœªä¼ é€’ api_base
   - âŒ `generate_detailed_report(...)` - æœªä¼ é€’ api_base

2. **`_display_current_token_stats()` æ–¹æ³•** (line 1339)
   - âœ… å·²ç»æ­£ç¡®å®ç°ï¼ˆä¼ é€’äº† api_baseï¼‰

## ğŸ’° æˆæœ¬å·®å¼‚åˆ†æ

### é”™è¯¯è®¡ç®—ï¼ˆæŒ‰ GPT-4 å®šä»·ï¼‰
```
è¾“å…¥: 329,170 tokens Ã— $0.03/1k = $9.8751
è¾“å‡º:  35,353 tokens Ã— $0.06/1k = $2.1212
æ€»è®¡: $11.9963 USD
```

### æ­£ç¡®è®¡ç®—ï¼ˆæŒ‰ DeepSeek å®šä»·ï¼‰
```
è¾“å…¥: 329,170 tokens Ã— Â¥2.0/1M = Â¥0.6583
è¾“å‡º:  35,353 tokens Ã— Â¥3.0/1M = Â¥0.1061
æ€»è®¡: Â¥0.7644 CNY â‰ˆ $0.11 USD
```

### å¯¹æ¯”ç»“æœ
- âŒ é”™è¯¯: $11.9963 USD
- âœ… æ­£ç¡®: Â¥0.7644 CNY (çº¦ $0.11 USD)
- **æˆæœ¬è¢«é«˜ä¼°äº†çº¦ 113 å€ï¼**
- å®é™…åªéœ€æ”¯ä»˜åŸæ¥æ˜¾ç¤ºæˆæœ¬çš„ **0.88%**

## ğŸ› ï¸ ä¿®å¤å†…å®¹

### 1. ä¿®å¤ `_collect_all_token_stats()` æ–¹æ³•

**ä½ç½®**: `main_react_agent.py:1283-1296`

**ä¿®æ”¹å‰**:
```python
# ç”ŸæˆæŠ¥å‘Š
simple_report = self.token_reporter.generate_simple_report(total_stats)
detailed_report = self.token_reporter.generate_detailed_report(total_stats, sub_agent_stats)

return {
    "main_agent": self.token_stats.get_summary(),
    "sub_agents": {name: stats.get_summary() for name, stats in sub_agent_stats.items()},
    "total": total_stats.get_summary(),
    "simple_report": simple_report,
    "detailed_report": detailed_report
}
```

**ä¿®æ”¹å**:
```python
# è·å– API åŸºç¡€ URL ç”¨äºæˆæœ¬è®¡ç®—
api_base = self.config.openai_api_base

# ç”ŸæˆæŠ¥å‘Šï¼ˆä¼ é€’ api_base ä»¥è·å–æ­£ç¡®çš„å®šä»·ï¼‰
simple_report = self.token_reporter.generate_simple_report(total_stats, api_base=api_base)
detailed_report = self.token_reporter.generate_detailed_report(total_stats, sub_agent_stats, api_base=api_base)

return {
    "main_agent": self.token_stats.get_summary(api_base=api_base),
    "sub_agents": {name: stats.get_summary(api_base=api_base) for name, stats in sub_agent_stats.items()},
    "total": total_stats.get_summary(api_base=api_base),
    "simple_report": simple_report,
    "detailed_report": detailed_report
}
```

### 2. ä¿®å¤å¼‚å¸¸å¤„ç†éƒ¨åˆ†

**ä½ç½®**: `main_react_agent.py:1301-1309`

**ä¿®æ”¹å‰**:
```python
simple_report = self.token_reporter.generate_simple_report(self.token_stats)
return {
    "main_agent": self.token_stats.get_summary(),
    "sub_agents": {},
    "total": self.token_stats.get_summary(),
    ...
}
```

**ä¿®æ”¹å**:
```python
api_base = self.config.openai_api_base
simple_report = self.token_reporter.generate_simple_report(self.token_stats, api_base=api_base)
return {
    "main_agent": self.token_stats.get_summary(api_base=api_base),
    "sub_agents": {},
    "total": self.token_stats.get_summary(api_base=api_base),
    ...
}
```

### 3. `_display_current_token_stats()` æ–¹æ³•

**ä½ç½®**: `main_react_agent.py:1338-1348`

âœ… æ­¤æ–¹æ³•å·²ç»æ­£ç¡®å®ç°ï¼ŒåŒ…å«ï¼š
- ä¼ é€’ `api_base` å‚æ•°
- è·å– `(cost, currency)` å…ƒç»„
- æ ¹æ®è´§å¸é€‰æ‹©æ­£ç¡®çš„ç¬¦å· (Â¥ æˆ– $)

```python
# ä¼ é€’ api_base ä»¥è·å–æ­£ç¡®çš„å®šä»·
cost, currency = temp_stats.get_estimated_cost(api_base=self.config.openai_api_base)

# æ ¹æ®è´§å¸å•ä½é€‰æ‹©ç¬¦å·
currency_symbol = "Â¥" if currency == "CNY" else "$"

# å•è¡Œæ ¼å¼è¾“å‡º
self._log_info(
    f"ğŸ“Š ç´¯è®¡ Token: {total_tokens:,} "
    f"(è¾“å…¥: {prompt_tokens:,} | è¾“å‡º: {completion_tokens:,}) "
    f"| æˆæœ¬: {currency_symbol}{cost:.4f}"
)
```

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•ç»“æœ

è¿è¡Œ `test_cost_calculation_standalone.py` æµ‹è¯•è„šæœ¬ï¼š

```
âœ… æµ‹è¯•ç”¨æˆ·å®é™…æ¡ˆä¾‹ï¼š
  - ä¸ä¼ é€’ api_base: $11.9963 USD (é”™è¯¯)
  - ä¼ é€’ api_base:    Â¥0.7644 CNY (æ­£ç¡®)
  - æˆæœ¬è¢«é«˜ä¼°äº†çº¦ 113 å€

âœ… æµ‹è¯•ä¸åŒ API å’Œæ¨¡å‹ï¼š
  - DeepSeek Reasoner:    Â¥0.5000 / 200k tokens
  - OpenAI GPT-4:         $9.0000 / 200k tokens
  - OpenAI GPT-3.5:       $0.3000 / 200k tokens

âœ… æµ‹è¯•è´§å¸ç¬¦å·æ˜¾ç¤ºï¼š
  - DeepSeek: ğŸ“Š ç´¯è®¡ Token: 55,000 (...) | æˆæœ¬: Â¥0.1150
  - GPT-4:    ğŸ“Š ç´¯è®¡ Token: 55,000 (...) | æˆæœ¬: $1.8000
```

æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼âœ“

## ğŸ“Š é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œä½¿ç”¨ DeepSeek Reasoner çš„æˆæœ¬æ˜¾ç¤ºå°†ä»ï¼š

**ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰**:
```json
{
  "estimated_cost": 11.9963,
  "currency": "USD"
}
```
```
ğŸ“Š Tokenæ¶ˆè€—: 364,523 tokens (ä¼°ç®—æˆæœ¬: $11.9963)
```

**ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰**:
```json
{
  "estimated_cost": 0.7644,
  "currency": "CNY"
}
```
```
ğŸ“Š Tokenæ¶ˆè€—: 364,523 tokens (ä¼°ç®—æˆæœ¬: Â¥0.7644)
```

å®æ—¶æ˜¾ç¤ºä¹Ÿä¼šæ­£ç¡®ï¼š
```
ğŸ“Š ç´¯è®¡ Token: 364,523 (è¾“å…¥: 329,170 | è¾“å‡º: 35,353) | æˆæœ¬: Â¥0.7644
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **`agentype/mainagent/agent/main_react_agent.py`**
   - ä¿®æ”¹ `_collect_all_token_stats()` æ–¹æ³• (lines 1283-1296)
   - ä¿®æ”¹å¼‚å¸¸å¤„ç†éƒ¨åˆ† (lines 1301-1309)
   - `_display_current_token_stats()` å·²æ­£ç¡®å®ç° (lines 1338-1348)

2. **æ–°å¢æµ‹è¯•æ–‡ä»¶**:
   - `test_cost_calculation_fix.py` - å®Œæ•´æµ‹è¯•ï¼ˆæœ‰é…ç½®ä¾èµ–ï¼‰
   - `test_cost_calculation_standalone.py` - ç‹¬ç«‹æµ‹è¯•ï¼ˆæ— é…ç½®ä¾èµ–ï¼‰âœ“
   - `æˆæœ¬è®¡ç®—ä¿®å¤æ€»ç»“.md` - æœ¬æ–‡æ¡£

## ğŸ¯ æ”¯æŒçš„å®šä»·é…ç½®

### DeepSeek API
- **URL**: `https://api.deepseek.com`
- **æ¨¡å‹**:
  - `deepseek-chat`: Â¥2.0/1M è¾“å…¥, Â¥3.0/1M è¾“å‡º
  - `deepseek-reasoner`: Â¥2.0/1M è¾“å…¥, Â¥3.0/1M è¾“å‡º
- **è´§å¸**: CNY (äººæ°‘å¸)

### SiliconFlow API
- **URL**: `https://api.siliconflow.cn/v1`
- **æ¨¡å‹**:
  - `Pro/deepseek-ai/DeepSeek-V3`: Â¥2.0/1M è¾“å…¥, Â¥8.0/1M è¾“å‡º
  - `Pro/deepseek-ai/DeepSeek-R1`: Â¥4.0/1M è¾“å…¥, Â¥16.0/1M è¾“å‡º
  - `deepseek-ai/DeepSeek-V3.2-Exp`: Â¥2.0/1M è¾“å…¥, Â¥3.0/1M è¾“å‡º
- **è´§å¸**: CNY (äººæ°‘å¸)

### OpenAI APIï¼ˆé»˜è®¤ï¼‰
- **URL**: `https://api.openai.com/v1` æˆ–æœªæŒ‡å®š
- **æ¨¡å‹**:
  - `gpt-4` / `gpt-4o`: $0.03/1k è¾“å…¥, $0.06/1k è¾“å‡º
  - `gpt-3.5` / `gpt-3.5-turbo`: $0.001/1k è¾“å…¥, $0.002/1k è¾“å‡º
- **è´§å¸**: USD (ç¾å…ƒ)

## ğŸ’¡ é‡è¦æç¤º

1. **å¿…é¡»ä¼ é€’ `api_base` å‚æ•°**æ‰èƒ½è·å¾—æ­£ç¡®çš„å®šä»·
2. ç³»ç»Ÿä¼šæ ¹æ® `api_base` è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„å®šä»·ç­–ç•¥
3. è´§å¸ç¬¦å·ä¼šæ ¹æ®å®šä»·è‡ªåŠ¨é€‰æ‹© (Â¥ æˆ– $)
4. å¦‚æœä¸ä¼ é€’ `api_base`ï¼Œå°†å›é€€åˆ°é»˜è®¤çš„ GPT-4 å®šä»·

## ğŸ”„ åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. âœ… ç¡®ä¿æ‰€æœ‰è°ƒç”¨ `get_summary()` å’Œ `get_estimated_cost()` çš„åœ°æ–¹éƒ½ä¼ é€’ `api_base`
2. âœ… åœ¨æ—¥å¿—å’ŒæŠ¥å‘Šä¸­æ­£ç¡®æ˜¾ç¤ºè´§å¸ç¬¦å·
3. å»ºè®®æ·»åŠ æ±‡ç‡è½¬æ¢åŠŸèƒ½ï¼ŒåŒæ—¶æ˜¾ç¤ºäººæ°‘å¸å’Œç¾å…ƒæˆæœ¬

### é•¿æœŸä¼˜åŒ–
1. è€ƒè™‘æ·»åŠ æˆæœ¬é¢„ç®—è­¦å‘ŠåŠŸèƒ½
2. æ·»åŠ æˆæœ¬è¶‹åŠ¿åˆ†æå’Œé¢„æµ‹
3. æ”¯æŒæ›´å¤šAPIå’Œæ¨¡å‹çš„å®šä»·
4. å®šæœŸæ›´æ–°å®šä»·æ•°æ®ï¼ˆAPIå®šä»·å¯èƒ½ä¼šå˜åŒ–ï¼‰

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†æˆæœ¬è®¡ç®—ä¸å‡†ç¡®çš„é—®é¢˜ï¼š

1. âœ… ä¿®å¤äº† `_collect_all_token_stats()` æ–¹æ³•ä¸­çš„ `api_base` å‚æ•°ä¼ é€’
2. âœ… éªŒè¯äº† `_display_current_token_stats()` æ–¹æ³•çš„æ­£ç¡®æ€§
3. âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæˆæœ¬è®¡ç®—å‡†ç¡®æ— è¯¯
4. âœ… æ”¯æŒå¤šè´§å¸æ˜¾ç¤ºï¼ˆCNY/USDï¼‰
5. âœ… è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„å®šä»·ç­–ç•¥

**ç”¨æˆ·çš„ DeepSeek Reasoner æˆæœ¬ç°åœ¨ä¼šæ­£ç¡®æ˜¾ç¤ºä¸º Â¥0.76 è€Œä¸æ˜¯ $12.00ï¼** ğŸ‰
