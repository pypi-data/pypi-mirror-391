# å¤šè´§å¸å®šä»·ç³»ç»Ÿå®ç°æ€»ç»“

## æ¦‚è¿°

å®ç°äº†æ ¹æ® API URL å’Œæ¨¡å‹åç§°è‡ªåŠ¨é€‰æ‹©æ­£ç¡®å®šä»·å’Œè´§å¸çš„ç³»ç»Ÿï¼Œæ”¯æŒäººæ°‘å¸å’Œç¾å…ƒä¸¤ç§è´§å¸æ˜¾ç¤ºã€‚

## å®ç°æ—¶é—´

2025å¹´ï¼ˆå…·ä½“æ—¥æœŸæ ¹æ®ç³»ç»Ÿæ—¶é—´ï¼‰

## éœ€æ±‚èƒŒæ™¯

åŸç³»ç»Ÿä»…æ”¯æŒç¾å…ƒè®¡ä»·ï¼ˆOpenAI å®šä»·ï¼‰ï¼Œæ— æ³•æ­£ç¡®å¤„ç† SiliconFlow å’Œ DeepSeek API çš„äººæ°‘å¸å®šä»·ã€‚éœ€è¦å®ç°ï¼š

1. æ”¯æŒå¤šä¸ª API çš„ä¸åŒå®šä»·ç­–ç•¥
2. æ ¹æ® API URL è‡ªåŠ¨é€‰æ‹©å®šä»·
3. æ ¹æ®æ¨¡å‹çš„å®é™…å®šä»·è´§å¸æ˜¾ç¤ºæˆæœ¬ï¼ˆäººæ°‘å¸ç”¨ Â¥ï¼Œç¾å…ƒç”¨ $ï¼‰

## æ”¯æŒçš„ API å’Œæ¨¡å‹

### 1. SiliconFlow API (`https://api.siliconflow.cn/v1`)

**è®¡ä»·å•ä½ï¼šäººæ°‘å¸/ç™¾ä¸‡tokens**

| æ¨¡å‹åç§° | è¾“å…¥ä»·æ ¼ (Â¥/M) | è¾“å‡ºä»·æ ¼ (Â¥/M) |
|---------|----------------|----------------|
| Pro/deepseek-ai/DeepSeek-V3 | 2.0 | 8.0 |
| Pro/deepseek-ai/DeepSeek-R1 | 4.0 | 16.0 |
| deepseek-ai/DeepSeek-R1 | 4.0 | 16.0 |
| deepseek-ai/DeepSeek-V3 | 2.0 | 8.0 |
| deepseek-ai/DeepSeek-V3.1-Terminus | 4.0 | 12.0 |
| Pro/deepseek-ai/DeepSeek-V3.1-Terminus | 4.0 | 12.0 |
| deepseek-ai/DeepSeek-V3.2-Exp | 2.0 | 3.0 |
| Pro/deepseek-ai/DeepSeek-V3.2-Exp | 2.0 | 3.0 |

### 2. DeepSeek API (`https://api.deepseek.com`)

**è®¡ä»·å•ä½ï¼šäººæ°‘å¸/ç™¾ä¸‡tokens**

| æ¨¡å‹åç§° | è¾“å…¥ä»·æ ¼ (Â¥/M) | è¾“å‡ºä»·æ ¼ (Â¥/M) |
|---------|----------------|----------------|
| deepseek-chat | 2.0 | 3.0 |
| deepseek-reasoner | 2.0 | 3.0 |

### 3. OpenAI å’Œé»˜è®¤å®šä»·

**è®¡ä»·å•ä½ï¼šç¾å…ƒ/åƒtokens**

| æ¨¡å‹åç§° | è¾“å…¥ä»·æ ¼ ($/1k) | è¾“å‡ºä»·æ ¼ ($/1k) |
|---------|-----------------|-----------------|
| gpt-4 / gpt-4o | 0.03 | 0.06 |
| gpt-3.5 / gpt-3.5-turbo | 0.001 | 0.002 |

## å®ç°å†…å®¹

### 1. æ–°å¢ç±»å’Œæ•°æ®ç»“æ„ (`token_statistics.py`)

#### `ModelPricing` æ•°æ®ç±»

```python
@dataclass
class ModelPricing:
    """æ¨¡å‹å®šä»·ä¿¡æ¯"""
    prompt_price: float  # è¾“å…¥tokenä»·æ ¼
    completion_price: float  # è¾“å‡ºtokenä»·æ ¼
    currency: str  # è´§å¸å•ä½ï¼š'CNY' æˆ– 'USD'
    price_per_million: bool = True  # True: ç™¾ä¸‡tokensè®¡ä»·ï¼ŒFalse: åƒtokensè®¡ä»·
```

#### `PricingRegistry` ç±»

- ç®¡ç†æ‰€æœ‰ API çš„æ¨¡å‹å®šä»·ä¿¡æ¯
- æ ¹æ® `api_base` å’Œ `model_name` æŸ¥è¯¢å¯¹åº”å®šä»·
- æä¾›æˆæœ¬è®¡ç®—åŠŸèƒ½

**æ ¸å¿ƒæ–¹æ³•**ï¼š

- `get_pricing(model_name, api_base)` - è·å–æ¨¡å‹å®šä»·ä¿¡æ¯
- `calculate_cost(prompt_tokens, completion_tokens, model_name, api_base)` - è®¡ç®—æˆæœ¬å¹¶è¿”å› `(æˆæœ¬, è´§å¸)` å…ƒç»„

### 2. ä¿®æ”¹çš„æ–¹æ³•

#### `TokenStatistics.get_estimated_cost()`

**ä¿®æ”¹å‰**ï¼š
```python
def get_estimated_cost(self, model_pricing=None) -> float:
    # è¿”å›å•ä¸€çš„ç¾å…ƒæˆæœ¬
    return cost
```

**ä¿®æ”¹å**ï¼š
```python
def get_estimated_cost(self, model_pricing=None, api_base=None) -> Tuple[float, str]:
    # è¿”å› (æˆæœ¬, è´§å¸å•ä½) å…ƒç»„
    return (cost, currency)
```

#### `TokenStatistics.get_summary()`

- æ–°å¢ `api_base` å‚æ•°
- è¿”å›ç»“æœä¸­å¢åŠ  `currency` å­—æ®µ
- ä¿ç•™ `estimated_cost_usd` ä»¥å‘åå…¼å®¹

#### `TokenReporter.generate_simple_report()` å’Œ `generate_detailed_report()`

- æ–°å¢ `api_base` å‚æ•°
- æ ¹æ®è´§å¸ç±»å‹é€‰æ‹©æ˜¾ç¤ºç¬¦å·ï¼ˆÂ¥ æˆ– $ï¼‰

#### `MainReactAgent._display_current_token_stats()`

**ä¿®æ”¹å‰**ï¼š
```python
cost = temp_stats.get_estimated_cost()
self._log_info(f"... | æˆæœ¬: {cost:.4f}")
```

**ä¿®æ”¹å**ï¼š
```python
cost, currency = temp_stats.get_estimated_cost(api_base=self.config.openai_api_base)
currency_symbol = "Â¥" if currency == "CNY" else "$"
self._log_info(f"... | æˆæœ¬: {currency_symbol}{cost:.4f}")
```

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`agentype/config/token_statistics.py`** (çº¦ 126 è¡Œæ–°å¢ä»£ç )
   - æ–°å¢ `ModelPricing` ç±»
   - æ–°å¢ `PricingRegistry` ç±»
   - ä¿®æ”¹ `TokenStatistics.get_estimated_cost()` æ–¹æ³•
   - ä¿®æ”¹ `TokenStatistics.get_summary()` æ–¹æ³•
   - ä¿®æ”¹ `TokenReporter` çš„ä¸¤ä¸ªæŠ¥å‘Šç”Ÿæˆæ–¹æ³•

2. **`agentype/mainagent/agent/main_react_agent.py`** (ç¬¬ 1314-1318 è¡Œ)
   - ä¿®æ”¹ `_display_current_token_stats()` æ–¹æ³•

### æ–°å¢çš„æ–‡ä»¶

1. **`test_pricing_standalone.py`** - ç‹¬ç«‹æµ‹è¯•è„šæœ¬ï¼ˆ290 è¡Œï¼‰
   - ä¸ä¾èµ–é…ç½®æ–‡ä»¶
   - æµ‹è¯•æ‰€æœ‰å®šä»·åœºæ™¯
   - éªŒè¯æˆæœ¬è®¡ç®—æ­£ç¡®æ€§

## æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

### æµ‹è¯•è¦†ç›–

- âœ… SiliconFlow API æ‰€æœ‰ 8 ä¸ªæ¨¡å‹å®šä»·æ­£ç¡®
- âœ… DeepSeek API ä¸¤ä¸ªæ¨¡å‹å®šä»·æ­£ç¡®
- âœ… OpenAI é»˜è®¤å®šä»·æ­£ç¡®
- âœ… æˆæœ¬è®¡ç®—å‡†ç¡®ï¼ˆç™¾ä¸‡tokenså’Œåƒtokensä¸¤ç§å•ä½ï¼‰
- âœ… è´§å¸ç¬¦å·æ˜¾ç¤ºæ­£ç¡®
- âœ… æ˜¾ç¤ºæ ¼å¼ç¬¦åˆé¢„æœŸ

### ç¤ºä¾‹è¾“å‡º

```
ğŸ“Š ç´¯è®¡ Token: 550,000 (è¾“å…¥: 500,000 | è¾“å‡º: 50,000) | æˆæœ¬: Â¥1.4000
ğŸ“Š ç´¯è®¡ Token: 330,000 (è¾“å…¥: 300,000 | è¾“å‡º: 30,000) | æˆæœ¬: Â¥0.6900
ğŸ“Š ç´¯è®¡ Token: 110,000 (è¾“å…¥: 100,000 | è¾“å‡º: 10,000) | æˆæœ¬: $3.6000
```

## å‘åå…¼å®¹æ€§

âœ… å®Œå…¨å‘åå…¼å®¹

1. `get_estimated_cost()` ä»æ”¯æŒ `model_pricing` å‚æ•°ï¼ˆå·²æ ‡è®°ä¸ºåºŸå¼ƒï¼‰
2. `get_summary()` è¿”å›çš„å­—å…¸ä»åŒ…å« `estimated_cost_usd` å­—æ®µï¼ˆå½“è´§å¸ä¸ºç¾å…ƒæ—¶ï¼‰
3. æœªæŒ‡å®š `api_base` æ—¶ä½¿ç”¨ OpenAI é»˜è®¤å®šä»·

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä»£ç ä¸­ä½¿ç”¨

```python
from agentype.config.token_statistics import TokenStatistics

# åˆ›å»ºç»Ÿè®¡å¯¹è±¡
stats = TokenStatistics(
    prompt_tokens=1_000_000,
    completion_tokens=100_000,
    total_tokens=1_100_000,
    model_name="deepseek-ai/DeepSeek-V3"
)

# è·å–æˆæœ¬ï¼ˆäººæ°‘å¸ï¼‰
cost, currency = stats.get_estimated_cost(api_base="https://api.siliconflow.cn/v1")
# è¿”å›: (2.8, "CNY")

# æ˜¾ç¤º
currency_symbol = "Â¥" if currency == "CNY" else "$"
print(f"æˆæœ¬: {currency_symbol}{cost:.4f}")
# è¾“å‡º: æˆæœ¬: Â¥2.8000
```

## æ‰©å±•æ€§

ç³»ç»Ÿè®¾è®¡æ˜“äºæ‰©å±•ï¼Œæ·»åŠ æ–° API æˆ–æ–°æ¨¡å‹åªéœ€ä¿®æ”¹ `PricingRegistry._setup_default_pricing()` æ–¹æ³•ï¼š

```python
# æ·»åŠ æ–°çš„ API
new_api_pricing = {
    "model-name": ModelPricing(input_price, output_price, "CNY", True),
}
self._pricing_map["https://new-api.example.com/v1"] = new_api_pricing
```

## æ³¨æ„äº‹é¡¹

1. **è´§å¸å•ä½è¯†åˆ«**ï¼šé€šè¿‡ API URL å®Œå…¨åŒ¹é…è¯†åˆ«ï¼ˆç›®å‰ä¸æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
2. **é»˜è®¤å®šä»·**ï¼šæœªçŸ¥ API æˆ–æ¨¡å‹ä¼šä½¿ç”¨ GPT-4 çš„ç¾å…ƒå®šä»·ä½œä¸ºé»˜è®¤å€¼
3. **ä»·æ ¼ç²¾åº¦**ï¼šæˆæœ¬è®¡ç®—ä¿ç•™ 4 ä½å°æ•°
4. **æ˜¾ç¤ºæ ¼å¼**ï¼šç»Ÿä¸€ä½¿ç”¨å•è¡Œæ ¼å¼ï¼Œä¾¿äºæ—¥å¿—æŸ¥çœ‹

## æœªæ¥ä¼˜åŒ–å»ºè®®

1. **é…ç½®æ–‡ä»¶åŒ–**ï¼šå°†å®šä»·ä¿¡æ¯ç§»åˆ°é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿æ›´æ–°
2. **å®æ—¶ä»·æ ¼**ï¼šæ”¯æŒä» API è·å–æœ€æ–°å®šä»·
3. **æ±‡ç‡è½¬æ¢**ï¼šæ”¯æŒä¸åŒè´§å¸ä¹‹é—´çš„è½¬æ¢æ˜¾ç¤º
4. **ä»·æ ¼é¢„è­¦**ï¼šå½“æˆæœ¬è¶…è¿‡é˜ˆå€¼æ—¶å‘å‡ºæé†’
5. **ç»Ÿè®¡åˆ†æ**ï¼šæŒ‰è´§å¸ç±»å‹åˆ†åˆ«ç»Ÿè®¡å’Œå±•ç¤º

## æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸåœ°å°†å•ä¸€ç¾å…ƒå®šä»·ç³»ç»Ÿå‡çº§ä¸ºæ”¯æŒå¤šè´§å¸ã€å¤š API çš„çµæ´»å®šä»·ç³»ç»Ÿï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå®Œå…¨å‘åå…¼å®¹ï¼Œå¯ä»¥ç«‹å³æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚
