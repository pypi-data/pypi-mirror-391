[tox]
envlist = py38, py39, py310, py311, py312
skip_missing_interpreters = true
isolated_build = true

# Use a shared build environment to speed up repeated wheel builds across envs
wheel_build_env = .pkg

[testenv]
description = Build the Rust extension with maturin and run the Python test suite
deps =
    maturin>=1.9.6
    pytest>=7.0
    numpy>=1.20.0
    pillow>=9.0.0
setenv =
    RUST_BACKTRACE=1
    PYTHONDONTWRITEBYTECODE=1
    # Uncomment to force a specific rust toolchain
    # RUSTUP_TOOLCHAIN=stable
passenv =
    CARGO_HOME
    RUSTUP_HOME
    # Allow proxy vars and CI indicators
    HTTP_PROXY
    HTTPS_PROXY
    NO_PROXY
    CI
commands =
    # Editable build so incremental Rust changes are picked up quickly
    maturin develop --locked
    pytest -q

[testenv:coverage]
description = Run tests with coverage (Python-only; Rust coverage requires extra tooling)
deps =
    maturin>=1.9.6
    pytest>=7.0
    pytest-cov>=4.0.0
    numpy>=1.20.0
    pillow>=9.0.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    # ADDED --cov-report=xml to generate the required file for the badge script
    pytest --cov=eo_processor --cov-report=term-missing --cov-report=xml --cov-fail-under=80


[testenv:lint]
description = Static analysis (Python). Add Rust clippy separately in CI if desired.
deps =
    ruff>=0.4.0
    mypy>=1.8.0
    numpy>=1.20.0
    pillow>=9.0.0
commands =
    ruff check python/eo_processor
    mypy python/eo_processor

# Optional: define a clippy env if rust toolchain is available
[testenv:clippy]
skip_install = true
allowlist_externals = cargo
deps =
    maturin>=1.9.6
commands =
    cargo clippy --all-targets -- -D warnings

[pytest]
addopts = -q
testpaths = tests

# Ruff configuration can live here if not already elsewhere
[tool.ruff]
extend-exclude = ["target", ".venv"]
line-length = 100
