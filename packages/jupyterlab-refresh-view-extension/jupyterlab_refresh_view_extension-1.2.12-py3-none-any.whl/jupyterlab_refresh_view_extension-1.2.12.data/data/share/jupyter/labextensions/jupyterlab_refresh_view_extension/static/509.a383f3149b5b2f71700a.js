"use strict";(self.webpackChunkjupyterlab_refresh_view_extension=self.webpackChunkjupyterlab_refresh_view_extension||[]).push([[509],{509:(e,o,t)=>{t.r(o),t.d(o,{default:()=>c});var r=t(986),n=t(249),l=t(138),s=t(560);const i={id:"jupyterlab_refresh_view_extension:plugin",description:"A JupyterLab to allow context menu option to refresh markdown or notebook",autoStart:!0,requires:[l.IDocumentManager],optional:[r.ICommandPalette,n.IFileBrowserFactory,s.ISettingRegistry],activate:(e,o,t,r,n)=>{console.log("JupyterLab extension jupyterlab_refresh_view_extension is activated!");let l={notebookScrollRestoration:!0,markdownScrollRestoration:!0,notebookTimeout:5e3,markdownTimeout:3e3};n&&n.load(i.id).then(e=>{l.notebookScrollRestoration=e.get("notebookScrollRestoration").composite,l.markdownScrollRestoration=e.get("markdownScrollRestoration").composite,l.notebookTimeout=e.get("notebookTimeout").composite,l.markdownTimeout=e.get("markdownTimeout").composite,e.changed.connect(()=>{l.notebookScrollRestoration=e.get("notebookScrollRestoration").composite,l.markdownScrollRestoration=e.get("markdownScrollRestoration").composite,l.notebookTimeout=e.get("notebookTimeout").composite,l.markdownTimeout=e.get("markdownTimeout").composite})}).catch(e=>{console.error("[SETTINGS] Failed to load settings:",e)});const{commands:s}=e,c="jupyterlab_refresh_view:refresh";s.addCommand(c,{label:"Refresh View",caption:"Refresh the current document view without scrolling",execute:async()=>{const t=e.shell.currentWidget;if(!t)return;const r=o.contextForWidget(t);if(!r)return;const n=t.node.querySelector(".jp-WindowedPanel-outer")||t.node.querySelector(".jp-RenderedMarkdown")||t.node.querySelector(".jp-FileEditor");let s=0,i=0,c=-1,a=0;if(n){s=n.scrollTop,i=n.scrollLeft;const e=Array.from(t.node.querySelectorAll(".jp-Cell"));if(e.length>0){const o=n.getBoundingClientRect();for(let t=0;t<e.length;t++){const r=e[t].getBoundingClientRect(),n=r.top-o.top;if(n>=-r.height&&n<=o.height){c=t,a=n;break}}}}try{await r.revert();const e=c>=0;if(n&&(e&&l.notebookScrollRestoration||!e&&l.markdownScrollRestoration&&s>0)){const o=()=>{if(e){const e=Array.from(t.node.querySelectorAll(".jp-Cell"));if(c<e.length){const o=e[c],t=n.getBoundingClientRect(),r=o.getBoundingClientRect().top-t.top;return n.scrollTop+=r-a,n.scrollLeft=i,!0}return!1}return n.scrollTop=s,n.scrollLeft=i,!1};o();let r=0,d=0,m=n.scrollHeight,u=n.scrollTop;const p=null!==t.node.querySelector(".jp-RenderedMarkdown pre code.language-mermaid"),h=Array.from(t.node.querySelectorAll(".jp-RenderedMarkdown img")),g=h.length>0;let f=0;const k=h.length,w=(e,o)=>()=>{f++,f>=k&&(d=0)};h.forEach((e,o)=>{const t=w(e,o);e.addEventListener("load",t,{once:!0}),e.addEventListener("error",t,{once:!0}),e.complete&&0!==e.naturalHeight&&t()});const v=e?l.notebookTimeout:l.markdownTimeout,b=Math.floor(v/100),T=g||p?5:3,S=setInterval(()=>{const t=n.scrollHeight,c=n.scrollTop,a=o(),p=Math.abs(c-u)<1,h=Math.abs(t-m)<1,g=a?n.scrollTop:s;if(Math.abs(c-g)<1&&p&&h){if(d++,d>=T){if(clearInterval(S),!e&&l.markdownScrollRestoration){let e=0;const o=Math.floor(l.markdownTimeout/100);let t=!1;const r=()=>{t=!0};n.addEventListener("wheel",r,{once:!0,passive:!0}),n.addEventListener("touchstart",r,{once:!0,passive:!0});const c=setInterval(()=>{if(t)return clearInterval(c),n.removeEventListener("wheel",r),void n.removeEventListener("touchstart",r);const l=n.scrollTop;Math.abs(l-s)>1&&(n.scrollTop=s,n.scrollLeft=i),e++,e>=o&&(clearInterval(c),n.removeEventListener("wheel",r),n.removeEventListener("touchstart",r))},100)}return}}else d=0;u=c,m=t,r++,r>=b&&(clearInterval(S),setTimeout(()=>{console.log(`[SNAPSHOT-3s] scrollTop=${n.scrollTop}px, height=${n.scrollHeight}px, drift=${Math.abs(n.scrollTop-s).toFixed(2)}px`)},3e3))},100)}}catch(e){console.error("Failed to refresh document:",e)}},isEnabled:()=>{const t=e.shell.currentWidget;return!!t&&void 0!==o.contextForWidget(t)}}),t&&t.addItem({command:c,category:"File Operations"}),e.contextMenu.addItem({command:c,selector:".jp-Document",rank:0}),console.log("Context menu items registered for refresh view extension")}},c=i}}]);