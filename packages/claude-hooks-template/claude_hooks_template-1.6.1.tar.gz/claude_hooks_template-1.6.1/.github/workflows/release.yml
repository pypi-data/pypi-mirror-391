name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

jobs:
  create-release-tag:
    # Only run on main branch pushes (not tags)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.bump.outputs.tag }}
      bumped: ${{ steps.bump.outputs.bumped }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history and tags

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Analyze commits and create version tag
      id: bump
      run: |
        uv python install 3.11
        uv run python scripts/bump_version.py | tee bump_output.txt

        # Parse output
        VERSION=$(grep "^version=" bump_output.txt | cut -d'=' -f2)
        BUMPED=$(grep "^bumped=" bump_output.txt | cut -d'=' -f2)
        TAG=$(grep "^tag=" bump_output.txt | cut -d'=' -f2)

        echo "version=$VERSION"
        echo "bumped=$BUMPED"
        echo "tag=$TAG"

        # Set outputs for next job
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "bumped=$BUMPED" >> $GITHUB_OUTPUT

        # Only push tag if a bump occurred
        if [ "$BUMPED" = "true" ]; then
          echo "Pushing tag $TAG"
          git push origin $TAG
        else
          echo "No version bump needed, skipping tag creation"
        fi

  build-and-publish:
    runs-on: ubuntu-latest
    needs: [create-release-tag]
    # Only run if automated tag was created
    if: needs.create-release-tag.outputs.bumped == 'true'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Inject static version into pyproject.toml
      run: |
        # Extract version from tag (strip 'v' prefix)
        VERSION="${{ needs.create-release-tag.outputs.tag }}"
        VERSION="${VERSION#v}"
        echo "Injecting static version: $VERSION"

        # Replace dynamic version with static version
        sed -i 's/^dynamic = \["version"\]/version = "'$VERSION'"/' pyproject.toml

        # Remove hatch-vcs configuration section
        sed -i '/^\[tool\.hatch\.version\]/,/^$/d' pyproject.toml

        # Verify the changes
        echo "Modified pyproject.toml [project] section:"
        grep -A 3 '^\[project\]' pyproject.toml | head -5

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Build package
      run: |
        uv python install 3.11
        uv build

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.create-release-tag.outputs.tag }}
        files: dist/*
        generate_release_notes: true
