"""Initialize CDD structure in projects."""

import os
import shutil
import subprocess
from pathlib import Path
from typing import List, Tuple

from rich.console import Console

console = Console()

# Dangerous system paths that should never be initialized
DANGEROUS_PATHS = [
    "/",
    "/usr",
    "/etc",
    "/bin",
    "/sbin",
    "/var",
    "/sys",
    "/proc",
    "/boot",
]


class InitializationError(Exception):
    """Raised when initialization cannot proceed."""

    pass


def is_dangerous_path(path: Path) -> bool:
    """Check if path is a dangerous system directory.

    Args:
        path: Path to check

    Returns:
        True if path is dangerous, False otherwise
    """
    resolved = path.resolve()

    # Check if it's a dangerous system path
    if str(resolved) in DANGEROUS_PATHS:
        return True

    # Check if it's home directory
    home = Path.home()
    if resolved == home:
        return True

    return False


def get_git_root(path: Path) -> Path | None:
    """Try to find git repository root.

    Args:
        path: Starting path to search from

    Returns:
        Git root path if found, None otherwise
    """
    try:
        result = subprocess.run(
            ["git", "rev-parse", "--show-toplevel"],
            cwd=path,
            capture_output=True,
            text=True,
            check=True,
        )
        return Path(result.stdout.strip())
    except (subprocess.CalledProcessError, FileNotFoundError):
        return None


def validate_path(path: Path) -> Path:
    """Validate and resolve target path.

    Args:
        path: Target path for initialization

    Returns:
        Resolved absolute path

    Raises:
        InitializationError: If path is invalid or dangerous
    """
    # Resolve to absolute path
    resolved = path.resolve()

    # Check if dangerous
    if is_dangerous_path(resolved):
        raise InitializationError(
            f"Refusing to initialize in system directory: {resolved}"
        )

    # Check write permissions if directory exists
    if resolved.exists() and not os.access(resolved, os.W_OK):
        raise InitializationError(f"No write permission for directory: {resolved}")

    return resolved


def check_existing_structure(base_path: Path) -> Tuple[bool, List[str]]:
    """Check if CDD structure already exists.

    Args:
        base_path: Base directory to check

    Returns:
        Tuple of (has_structure, existing_items)
        where has_structure is True if any CDD items exist,
        and existing_items is list of existing paths
    """
    existing = []

    # Check for CDD directories
    cdd_items = [
        "specs",
        "specs/tickets",
        "docs",
        "docs/features",
        "docs/guides",
        ".cdd",
        ".cdd/templates",
    ]

    for item in cdd_items:
        if (base_path / item).exists():
            existing.append(item)

    # Check for key files (both CDD.md and CLAUDE.md)
    key_files = [
        "CDD.md",
        "CLAUDE.md",
    ]

    for file in key_files:
        if (base_path / file).exists():
            existing.append(file)

    return len(existing) > 0, existing


def create_directory_structure(base_path: Path) -> List[str]:
    """Create CDD directory structure.

    Args:
        base_path: Base directory for structure

    Returns:
        List of created directories
    """
    directories = [
        "specs/tickets",
        "docs/features",
        "docs/guides",
        ".cdd/templates",
    ]

    created = []
    for dir_path in directories:
        full_path = base_path / dir_path
        if not full_path.exists():
            full_path.mkdir(parents=True, exist_ok=True)
            created.append(dir_path)

            # Create .gitkeep for empty directories
            if dir_path in ["specs/tickets", "docs/features", "docs/guides"]:
                gitkeep = full_path / ".gitkeep"
                gitkeep.touch()

    return created


def create_config_file(target_path: Path, language: str):
    """Create .cdd/config.yaml with language preference.

    Args:
        target_path: Project root path
        language: Language code ('en' or 'pt-br')
    """
    config_dir = target_path / ".cdd"
    config_file = config_dir / "config.yaml"

    config_content = f"""# CDD Framework Configuration
# Generated by: cdd-agent init

# Language preference
# Supported values: en (more languages in future versions)
language: {language}

# Config schema version (for future migrations)
version: 1
"""

    config_file.write_text(config_content, encoding="utf-8")


def install_templates(base_path: Path, language: str = "en") -> List[str]:
    """Install templates from package to .cdd/templates/.

    Args:
        base_path: Project root path
        language: Language code (default: 'en')

    Returns:
        List of installed template filenames
    """
    # Get source templates directory from package
    package_dir = Path(__file__).parent
    source_templates = package_dir / "templates" / language

    if not source_templates.exists():
        raise InitializationError(f"Templates not found for language: {language}")

    # Target: .cdd/templates/
    target_templates = base_path / ".cdd" / "templates"
    target_templates.mkdir(parents=True, exist_ok=True)

    installed = []

    # Copy all template files
    for template_file in source_templates.glob("*"):
        if template_file.is_file():
            target_file = target_templates / template_file.name
            shutil.copy2(template_file, target_file)
            installed.append(f".cdd/templates/{template_file.name}")

    return installed


def prompt_yes_no(question: str, default: bool = True) -> bool:
    """Prompt user for yes/no answer.

    Args:
        question: Question to ask
        default: Default answer if user presses Enter

    Returns:
        True for yes, False for no
    """
    default_str = "Y/n" if default else "y/N"

    while True:
        response = console.input(f"{question} [{default_str}]: ").strip().lower()

        if not response:
            return default

        if response in ("y", "yes"):
            return True
        elif response in ("n", "no"):
            return False
        else:
            console.print("[yellow]Please answer 'y' or 'n'[/yellow]")


def generate_cdd_md(base_path: Path, force: bool = False) -> Tuple[bool, bool]:
    """Generate CDD.md from constitution template.

    If CLAUDE.md exists, ask user if content should be migrated.

    Args:
        base_path: Base directory for project
        force: Whether to overwrite existing file

    Returns:
        Tuple of (created, migrated)
        - created: True if CDD.md was created
        - migrated: True if content was migrated from CLAUDE.md
    """
    cdd_md_path = base_path / "CDD.md"
    claude_md_path = base_path / "CLAUDE.md"

    # Case 1: CDD.md already exists
    if cdd_md_path.exists() and not force:
        return (False, False)  # Skip, already have CDD.md

    # Case 2: CLAUDE.md exists (Claude Code project)
    if claude_md_path.exists():
        console.print("[yellow]üìÑ Found existing CLAUDE.md[/yellow]")

        # Auto-migrate if force flag is set, otherwise prompt
        if force:
            migrate = True
            console.print("[dim]Auto-migrating (--force mode)[/dim]")
        else:
            migrate = prompt_yes_no(
                "Migrate content from CLAUDE.md to CDD.md?", default=True
            )

        if migrate:
            # Copy content from CLAUDE.md to CDD.md
            content = claude_md_path.read_text()
            cdd_md_path.write_text(content)
            console.print("‚úÖ Content migrated from CLAUDE.md ‚Üí CDD.md")
            console.print("üí° You can now delete CLAUDE.md if desired")
            return (True, True)  # Created via migration
        else:
            # User said no - create from template
            pass  # Fall through to template creation

    # Case 3: Neither exists - create from template
    template_path = base_path / ".cdd" / "templates" / "constitution-template.md"

    if template_path.exists():
        shutil.copy2(template_path, cdd_md_path)
        return (True, False)  # Created from template

    return (False, False)


def initialize_project(path: str, force: bool = False) -> dict:
    """Initialize CDD structure in a project.

    Creates:
    - CDD.md (project constitution)
    - specs/tickets/ (temporary work)
    - docs/features/ (living documentation)
    - docs/guides/ (user guides)
    - .cdd/templates/ (internal templates)
    - .cdd/config.yaml (language configuration)

    Args:
        path: Target directory path
        force: Whether to overwrite existing files

    Returns:
        Dictionary with initialization results:
        {
            "path": Path,                    # Absolute path where initialized
            "created_dirs": List[str],       # Directories created
            "installed_templates": List[str],# Template files installed
            "cdd_md_created": bool,          # Whether CDD.md was created
            "cdd_md_migrated": bool,         # Whether migrated from CLAUDE.md
            "existing_structure": bool,      # Whether partial structure existed
            "language": str                  # Language used ("en")
        }

    Raises:
        InitializationError: If initialization fails
    """
    target_path = Path(path)

    # Validate path
    try:
        target_path = validate_path(target_path)
    except InitializationError as e:
        raise e

    # Create directory if it doesn't exist
    if not target_path.exists():
        target_path.mkdir(parents=True, exist_ok=True)

    # Try to use git root if we're in a git repo
    git_root = get_git_root(target_path)
    if git_root and git_root != target_path:
        console.print(
            f"[blue]‚ÑπÔ∏è  Detected git repository. " f"Using git root: {git_root}[/blue]"
        )
        target_path = git_root

    # Check for existing structure
    has_existing, existing_items = check_existing_structure(target_path)

    if has_existing and not force:
        console.print(
            "[yellow]‚ö†Ô∏è  CDD structure partially exists. "
            "Creating missing items only.[/yellow]"
        )

    # Language: English-only for v0.2.0
    language = "en"

    # Create directory structure
    created_dirs = create_directory_structure(target_path)

    # Create config file with language
    create_config_file(target_path, language)

    # Install templates
    installed_templates = install_templates(target_path, language)

    # Generate CDD.md (with CLAUDE.md migration support)
    cdd_md_created, cdd_md_migrated = generate_cdd_md(target_path, force)

    return {
        "path": target_path,
        "created_dirs": created_dirs,
        "installed_templates": installed_templates,
        "cdd_md_created": cdd_md_created,
        "cdd_md_migrated": cdd_md_migrated,
        "existing_structure": has_existing,
        "language": language,
    }
