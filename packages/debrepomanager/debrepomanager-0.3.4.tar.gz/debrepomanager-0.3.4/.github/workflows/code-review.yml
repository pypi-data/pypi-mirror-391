name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'setup.py'
      - 'pyproject.toml'

permissions:
  contents: read
  pull-requests: write

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: [self-hosted, ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run Black (formatting check)
        id: black
        continue-on-error: true
        run: |
          black --check debrepomanager/ tests/ > black_output.txt 2>&1 || true
          if [ -f black_output.txt ]; then
            echo "black_output<<EOF" >> $GITHUB_OUTPUT
            cat black_output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run flake8 (linting)
        id: flake8
        continue-on-error: true
        run: |
          flake8 debrepomanager/ tests/ --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' > flake8_output.txt 2>&1 || true
          if [ -f flake8_output.txt ]; then
            echo "flake8_output<<EOF" >> $GITHUB_OUTPUT
            cat flake8_output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run mypy (type checking)
        id: mypy
        continue-on-error: true
        run: |
          mypy debrepomanager/ > mypy_output.txt 2>&1 || true
          if [ -f mypy_output.txt ]; then
            echo "mypy_output<<EOF" >> $GITHUB_OUTPUT
            cat mypy_output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run tests with coverage
        id: pytest
        continue-on-error: true
        run: |
          pytest --cov=debrepomanager --cov-report=term-missing --cov-report=json > pytest_output.txt 2>&1 || true
          if [ -f pytest_output.txt ]; then
            echo "pytest_output<<EOF" >> $GITHUB_OUTPUT
            cat pytest_output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(f\"{data['totals']['percent_covered']:.1f}\")")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          fi

      - name: Check for trailing spaces
        id: trailing-spaces
        continue-on-error: true
        run: |
          echo "Checking for trailing spaces..."
          git diff --check HEAD^ HEAD -- '*.py' > trailing_output.txt 2>&1 || true
          if [ -s trailing_output.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "trailing_output<<EOF" >> $GITHUB_OUTPUT
            cat trailing_output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Post review comment
        uses: actions/github-script@v8
        with:
          script: |
            let comment = '## üîç Code Review Results\n\n';

            // Black
            const blackOutput = '${{ steps.black.outcome }}';
            if (blackOutput === 'failure') {
              comment += '### ‚ùå Black (Code Formatting)\n';
              comment += '**Fix**: Run `make format` or `black debrepomanager/ tests/`\n\n';
            } else {
              comment += '### ‚úÖ Black (Code Formatting) - Passed\n\n';
            }

            // Flake8
            const flake8Output = '${{ steps.flake8.outcome }}';
            if (flake8Output === 'failure') {
              comment += '### ‚ùå Flake8 (Linting)\n';
              comment += '**Fix**: Run `make lint` and fix reported issues\n\n';
            } else {
              comment += '### ‚úÖ Flake8 (Linting) - Passed\n\n';
            }

            // MyPy
            const mypyOutput = '${{ steps.mypy.outcome }}';
            if (mypyOutput === 'failure') {
              comment += '### ‚ùå MyPy (Type Checking)\n';
              comment += '**Fix**: Run `make type-check` and fix type errors\n\n';
            } else {
              comment += '### ‚úÖ MyPy (Type Checking) - Passed\n\n';
            }

            // Tests
            const pytestOutput = '${{ steps.pytest.outcome }}';
            const coverage = '${{ steps.pytest.outputs.coverage }}';
            if (pytestOutput === 'failure') {
              comment += '### ‚ùå Tests\n';
              comment += '**Fix**: Run `make test` and fix failing tests\n\n';
            } else {
              comment += '### ‚úÖ Tests - Passed\n';
              if (coverage) {
                const coverageNum = parseFloat(coverage);
                const coverageEmoji = coverageNum >= 85 ? 'üéâ' : coverageNum >= 80 ? '‚úÖ' : '‚ö†Ô∏è';
                comment += `${coverageEmoji} Coverage: ${coverage}%\n\n`;
              }
            }

            // Trailing spaces
            const trailingFound = '${{ steps.trailing-spaces.outputs.found }}';
            if (trailingFound === 'true') {
              comment += '### ‚ö†Ô∏è Trailing Spaces Found\n';
              comment += '**Fix**: Remove trailing spaces from Python files\n\n';
            }

            // Summary
            const allPassed = blackOutput === 'success' &&
                             flake8Output === 'success' &&
                             mypyOutput === 'success' &&
                             pytestOutput === 'success' &&
                             trailingFound === 'false';

            if (allPassed) {
              comment += '---\n## üéâ All checks passed! Ready for review.\n';
            } else {
              comment += '---\n## ‚ö†Ô∏è Some checks failed. Please fix the issues above.\n';
              comment += '\n**Quick fix commands**:\n';
              comment += '```bash\n';
              comment += 'make format      # Fix formatting\n';
              comment += 'make lint        # Check linting\n';
              comment += 'make type-check  # Check types\n';
              comment += 'make test        # Run tests\n';
              comment += 'make check-all   # Run all checks\n';
              comment += '```\n';
            }

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

            // Set job status
            if (!allPassed) {
              core.setFailed('Code quality checks failed');
            }

  security-scan:
    name: Security Scan
    runs-on: [self-hosted, ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Bandit (security linter)
        continue-on-error: true
        run: |
          pip install bandit[toml]
          bandit -r debrepomanager/ -f json -o bandit-report.json || true

      # Bandit report not uploaded as artifact - check logs for results
      # Minimizes storage usage on self-hosted runners

  # Dependency Review disabled for private repos without GitHub Advanced Security
  # Use Dependabot for automatic dependency updates instead
  # See .github/dependabot.yml
  # dependency-review:
  #   name: Dependency Review
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'pull_request'
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v5
  #
  #     - name: Dependency Review
  #       uses: actions/dependency-review-action@v4
  #       with:
  #         fail-on-severity: moderate



