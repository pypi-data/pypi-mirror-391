from dataflow.utils.log import Logger
from dataflow.module.context.web import filter,verify_token
from fastapi import Request
from fastapi.responses import JSONResponse
from dataflow.utils.utils import current_millsecond,date2str_yyyymmddhhmmsss,date_datetime_cn # noqa: F401
from dataflow.utils.web.asgi import get_remote_address,getRequestURLPath,getRequestHeader
from dataflow.module import Context,WebContext
from dataflow.utils.schedule import ScheduleContext

_logger = Logger('application.{{package_name}}')


@filter(path='/{{package_name}}/api,/{{package_name}}/api/**')
async def costtime_handler(request: Request, call_next):
    # ====== è¯·æ±‚é˜¶æ®µ ======
    start = current_millsecond()
    # å¯é€‰æ‹©ç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­å¾€åèµ°ï¼ˆç†”æ–­ã€IP é»‘åå•ï¼‰
    # if request.client.host in BLACKLIST:
    #     return JSONResponse({"msg": "blocked"}, 403)
    
    path = getRequestURLPath(WebContext.getRequest())
    _logger.INFO(f"ETCDV3æµ‹è¯•è¿‡æ»¤å™¨==[{request.url}][{path}]")
    if 'login' not in path:
        auth = getRequestHeader(request, 'authorization', None)
        if not auth:
            raise Context.ContextException("æ²¡æœ‰ç™»å½•ä¿¡æ¯ï¼Œè¯·å…ˆè¿›è¡Œç™»å½•")
        auth = auth.replace('Bearer ','')
        _logger.DEBUG(f'authorization = {auth}')
        
        try:
            user = verify_token(auth)
            _logger.DEBUG(f'username = {user}')
            WebContext.setRequestUserObject(user['username'])
        except Exception as e:
            _logger.DEBUG(f'verify_token={str(e)}')
            return JSONResponse(
                content={"msg": "ç”¨æˆ·ç™»å½•è¿‡æœŸ"},
                status_code=400,
                headers={               # â† è¿™é‡ŒåŠ ä»»æ„å¤´
                    "is-session-timeout": "1",
                    "is-application-exception": "1",
                },
            )

    # ====== ç»§ç»­å¾€åèµ°ï¼ˆè·¯ç”±ã€ä¸šåŠ¡ï¼‰ ======
    try:
        response = await call_next(request)
        # ====== å“åº”é˜¶æ®µ ======                
        # response.headers["test-Cost-ms"] = str(cost)
        return response    
    finally:
        cost = (current_millsecond() - start)
        ip = get_remote_address(request)
        _logger.INFO(f"ETCDV3æµ‹è¯•è¿‡æ»¤å™¨==[{request.url}][{ip}]{cost:.2f}ms")
        WebContext.resetRequestUserObject()


@Context.Configurationable(prefix='context.{{package_name}}')
def config_all(config):
    _logger.DEBUG(f'========={config}')
        
@ScheduleContext.on_Trigger(trigger=ScheduleContext.Event.CronTrigger(second='*/10'), args=[1,2,3], id='JOB_2')
@ScheduleContext.on_Trigger(trigger=ScheduleContext.Event.CronTrigger(second='*/30'), kwargs={'a':123}, id='JOB_1')
def _print_date_info(*args, **kwargs):
    _logger.DEBUG(f'å½“å‰æ—¶é—´==={date2str_yyyymmddhhmmsss(date_datetime_cn())} {args} {kwargs}')
    

# @Context.Event.on_started
# def print_start_test(context):
#     _logger.DEBUG(f'@Context.Event.on_start======================= å¯åŠ¨ç¨‹åº {context} ')
    

# @Context.Event.on_init
# def print_init_test(context, modules):
#     _logger.DEBUG(f'@Context.Event.on_init=======================  {context} {modules}')        
    
# @Context.Event.on_loaded
# def print_load_test(context, modules):
#     _logger.DEBUG(f'@Context.Event.on_loaded ======================= {context} {modules}')        
        

# @WebContext.Event.on_started
# def print_web_start_test(app):
#     _logger.DEBUG('@WebContext.Event.on_start======================= å¯åŠ¨ç¨‹åº')
    
# @WebContext.Event.on_loaded
# def print_web_load_test(app):
#     _logger.DEBUG(f'@WebContext.Event.on_loaded ======================= {app}')            

# @KafkaContext.ON_Consumer(inbound='server-1', subscribe='input_others')
# def on_consumer_1(err, msg):
#     if err:
#         _logger.DEBUG(f'================ âš ï¸ {err}')
#     else:
#         _logger.DEBUG(f'================ ğŸ’¬ {msg.value().decode()}')
    

# @KafkaContext.ON_Consumer(inbound='server-2', subscribe='input_cardata')
# def on_consumer_2(err, msg):
#     if err:
#         _logger.DEBUG(f'================ âš ï¸ {err}')
#     else:
#         _logger.DEBUG(f'================ ğŸ’¬ {msg.value().decode()}')
        

        
    