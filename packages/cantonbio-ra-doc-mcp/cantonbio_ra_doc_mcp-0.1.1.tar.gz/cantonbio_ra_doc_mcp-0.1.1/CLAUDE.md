# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

这是一个MCP（Model Context Protocol）服务器，用于辅助RA（注册部门）人员处理药品注册文档。系统主要功能包括：

1. 从Word文档中提取质量标准表格
2. 将质量标准表格填充到文档模板中
3. 从标准操作规程中提取和总结分析方法
4. 校验文档内容的一致性

目标文档包括质量标准文档和检验标准操作规程等药品注册相关文档。

## 开发命令

**安装依赖：**

```bash
uv sync --all-extras
```

**运行MCP服务器：**

```bash
uv run src.server fastmcp_quickstart stdio
```

**运行测试（采用TDD方法）：**

```bash
pytest
```

**运行测试并查看覆盖率：**

```bash
pytest --cov=src --cov-report=term-missing
```

## 系统架构

### MCP服务器架构

使用FastMCP框架构建MCP服务器（server.py），主要组成部分：

- **工具（Tools）**：通过 `@mcp.tool()`装饰器定义，供LLM调用的功能函数
- **资源（Resources）**：通过 `@mcp.resource()`装饰器定义，提供可访问的数据资源
- **提示（Prompts）**：通过 `@mcp.prompt()`装饰器定义，为LLM提供预设提示模板

### 已实现功能

- **质量标准表格提取**（extract_quality_standards.py）：
  - 从Word文档中定位并提取质量标准表格（通常在4.3节）
  - 保留上下标格式（使用Unicode字符映射）
  - 输出Markdown格式表格
- **表格填充器**：将Markdown格式表格填充到Word文档模板

### 待实现功能

- **方法总结器**：基于"人机料法环"原则提取和总结分析方法
  - 从《检测标准操作规程》文档中，提取出第4 部分"程序 Procedures"的内容
  - 根据以下内容模块和要求总结从上一步中提取出的内容，并输出markdown内容格式
    - 1.原理

      - 内容主要来源：4.1 实验原理
      - 要求：总结成200字以内的原理说明。
      - 文本风格例子：蛋白质分子中所含有的色氨酸、苯丙氨酸、二硫键等在280nm波长附近有最大吸收峰，其光吸收值与蛋白质浓度成正比。基于朗伯-比尔定律（Lambert-Beer Law），通过建立吸光度-光程的线性方程式而测得斜率k=ΔA/ΔL（A为光吸收值，L为光程），并由朗伯-比尔定律公式A=εLc（ε为消光系数）换算得到待测样品的浓度c。
    - 2.材料和设备

      - 内容主要来源：4.2 实验材料
      - 要求：分别列出使用的材料和设备，只需列出名称即可，无需列明品牌型号。无需包括待测试样品。
      - 文本风格例子：1.1 材料：比色皿、光纤棒。
        1.2 主要设备：可变光程紫外-可见分光光度计。
    - 3.操作步骤

      - 内容主要来源：4.4 操作步骤
      - 要求：归纳成200字内的操作说明。只保留关键动作，无需包括保留常规性的操作内容，如打印报告、实验设备清洁等。
      - 文本风格例子：取供试品上下颠倒混匀后，待测。启动可变光程紫外-可见分光光度计，选择预设了波长为280 nm和320 nm、消光系数为1.6000 mL/(mg•cm)、基线校正的方法，插入光纤棒， 取供试品溶液进行测定。
    - 4.试验成立标准

      - 内容主要来源：4.4.7 系统适用性评估
      - 要求：归纳成实验成功的前提条件，一般为具体的参数
      - 文本风格例子：4.1	线性相关系数R2应≥0.999
        4.2	每个供试品溶液重复三次蛋白含量的RSD应≤3.0%
        4.3	两个平行样间的蛋白含量RSD应≤3.0%
    - 5.结果计算

      - 内容主要来源：4.5 结果与计算
      - 要求：列出关键计算公式以及公式中的变量定义和解析
      - 文本风格例子：
        朗伯-比尔定律（Beer-Lambert law）：A=εL Conc.
        Slope=ΔA/ΔL
        Conc.=Slope/ε×10
        其中：
        Slope：吸光值与光程的线性回归斜率；
        A：吸光度值；
        L：光程，mm；
        Conc.：供试品浓度，mg/mL；
        ε：消光系数，CB1019蛋白的消光系数为1.6000 mL/(mg•cm)。
    - 6.合格标准

      - 内容来源：质量标准表格对应的检项接收标准
      - 文本风格例子：117.0~143.0 mg/mL。
- **文档校验器**：比对和校验源文档与目标文档之间的关键信息差异

### 关键技术挑战

1. **表格结构映射**：处理不同文档间的列名称、顺序和数量差异
2. **格式保持**：保持科学计数法、上下标、单位和特殊符号

   * 数值精度和有效数字
   * 科学单位和计数法
   * 上下标（如化学式）
   * 生物/化学专业术语
3. **SOP提取**：从标准操作规程中识别和提取关键操作步骤
4. **校验逻辑**：实现基于NLP的相似度比对，验证数据、设备和操作顺序

## 技术框架

- **编程语言**：Python 3.13+
- **依赖管理**：uv
- **MCP框架**：mcp[cli]>=1.15.0
- **文档处理**：python-docx

## 项目结构

```
ra-agent-mcp/
├── src/                      # 源代码目录
│   ├── __init__.py
│   ├── server.py            # FastMCP服务器主文件
│   └── extract_quality_standards.py  # 质量标准表格提取模块
├── tests/                   # 测试目录
│   ├── __init__.py
│   ├── conftest.py         # pytest配置和fixtures
│   └── test_extract_quality_standards.py  # 测试用例
├── doc/                    # 文档目录
├── pytest.ini              # pytest配置文件
├── pyproject.toml          # 项目配置和依赖管理
└── Requirement.md          # 详细需求规格说明书
```

## 开发要求

- **TDD方法**：先编写单元测试再实现功能（目标覆盖率≥90%）
- **代码规范**：遵循PEP 8规范，使用类型提示
- **文档注释**：每个方法需要详细的代码注释
- **测试要求**：所有功能方法必须有单元测试用例
