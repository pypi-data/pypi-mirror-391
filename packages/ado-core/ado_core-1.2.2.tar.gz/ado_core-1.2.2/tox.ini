[tox]
envlist: {py37,py38,py39,p310,p311,p312}-{deploy,test}-{pipfile,pipenv}-{intel,applesilicon}{,-extras,-optimizers}
#This is a hack to force pip to serialise installs
#i.e. install a set of packages before installing the next
#This happens particularly with numpy which MUST be installed
#for other package that depend on it to be installed
indexserver =
    DEV = https://pypi.python.org/simple
    OTH = https://pypi.python.org/simple

#Defaults for all environments
#Can make options conditional on a particular environment using $envname_part:
[testenv]
runner = uv-venv-lock-runner
install_command=
   uv pip install --no-progress --no-build-isolation {opts} {packages}
envdir=
    test: {env:TEST_VENV:toxenv}
    deploy: {env:DEPLOY_VENV:toxenv}
basepython= 
    py37: python3.7
    py38: python3.8
    py39: python3.9
    py310: python3.10
    py311: python3.11
    py312: python3.12
passenv=
    CI
setenv=
    LC_ALL=en_GB.UTF-8
    LOGLEVEL=DEBUG
    TESTCONTAINERS_RYUK_DISABLED=true
    RAY_TASK_MAX_RETRIES=0
deps =
    extras: -rdeploy/deps_learning.txt
    setuptools_scm
    wheel
    hatchling
    uv-dynamic-versioning
dependency_groups =
    dev
allowlist_externals=
    printenv
    ls
    pwd
    rm
    uv
    pip
commands=
    printenv
    uv pip list
    # Install sfttrainer actuator - used in some tests
    uv pip install --no-progress plugins/actuators/sfttrainer
    # Install the acid_test experiment from the examples
    uv pip install --no-progress examples/pfas-generative-models/custom_actuator_function/
    # Install the nevergrad_test_opt experiment from the examples
    uv pip install --no-progress examples/optimization_test_functions/custom_experiments/
    # Install the example actuator
    uv pip install --no-progress plugins/actuators/example_actuator
    # Install operators requires for tests
    uv pip install --no-progress plugins/operators/ray_tune
    uv pip install --no-progress plugins/operators/profile_space
    uv pip install --no-progress plugins/operators/anomalous_series
    uv pip list
    pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes tests/
    # Run the SFTTrainer tests
    pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes plugins/actuators/sfttrainer/ado_actuators/sfttrainer/tests/
    # Basic test of ray_tune
    ado get operator ray_tune
    ado template operation --operator-name=ray_tune
    # Basic test of random_walk
    ado get operator random_walk
    ado template operation --operator-name=random_walk
    # Test actuators have basic functionality
    uv pip install --no-progress plugins/actuators/vllm_performance
    ado get actuators vllm_performance --details
    ado describe experiment test-deployment-v1
    ado template space --from-experiment test-deployment-v1
    # Test run_experiment
    run_experiment examples/optimization_test_functions/point.yaml

