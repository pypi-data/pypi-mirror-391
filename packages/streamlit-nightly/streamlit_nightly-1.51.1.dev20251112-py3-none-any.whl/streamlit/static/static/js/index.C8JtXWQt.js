import{r as t,E as z,_ as L,L as Te,k as de,n as P,b5 as le,bt as ze,bl as Le,bk as De,s as d,j as o,x as Be,e as F,B as Ve,an as We,b as Me,bu as Ne,l as Oe,T as He,P as $e,W as je}from"./index.DYhXnGrd.js";import{u as _e}from"./useWaveformController.D54j7iaV.js";import{T as Xe,a as se}from"./Toolbar.Czis4jez.js";import{u as Ge,F as qe}from"./FormClearHelper.IrQMLaUB.js";import{c as Ke}from"./createDownloadLinkElement.ZaXNnPK4.js";import{F as Je,D as Qe}from"./FileDownload.esm.B4oR_X0U.js";var ue=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(z,L({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("g",{fill:"none"},t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24})),t.createElement("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),t.createElement("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"}))});ue.displayName="Mic";var pe=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(z,L({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("rect",{width:24,height:24,fill:"none"}),t.createElement("path",{d:"M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"}))});pe.displayName="Pause";var fe=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(z,L({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("rect",{width:24,height:24,fill:"none"}),t.createElement("path",{d:"M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18a1 1 0 000-1.69L9.54 5.98A.998.998 0 008 6.82z"}))});fe.displayName="PlayArrow";var ge=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(z,L({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M17.65 6.35a7.95 7.95 0 00-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 007.21-4.56c.32-.67-.16-1.44-.9-1.44-.37 0-.72.2-.88.53a5.994 5.994 0 01-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0112 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71l-.64.65z"}))});ge.displayName="Refresh";var me=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(z,L({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("g",{fill:"none"},t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24})),t.createElement("path",{fillRule:"evenodd",d:"M9 16h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1H9c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1zm3-14C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"}))});me.displayName="StopCircle";const Ye=(e,r)=>{const{enforceDownloadInNewTab:n=!1}=t.useContext(Te);return t.useCallback(()=>{if(!e)return;const i=Ke({enforceDownloadInNewTab:n,url:e,filename:r});i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)},[e,n,r])},$=({widgetMgr:e,id:r,formId:n,key:s,defaultValue:i})=>{t.useEffect(()=>{const c=e.getElementState(r,s);de(c)&&P(i)&&e.setElementState(r,s,i)},[e,r,s,i]);const[v,u]=t.useState(e.getElementState(r,s)??i),h=t.useCallback(c=>{e.setElementState(r,s,c),u(c)},[e,r,s]),b=t.useMemo(()=>({formId:n||""}),[n]),y=t.useCallback(()=>h(i),[i,h]);return Ge({element:b,widgetMgr:e,onFormCleared:y}),[v,h]},Ze=async({files:e,uploadClient:r,widgetMgr:n,widgetInfo:s,fragmentId:i,signal:v})=>{let u=[];try{u=await r.fetchFileURLs(e)}catch(c){return{successfulUploads:[],failedUploads:e.map(l=>({file:l,error:le(c)}))}}const h=ze(e,u),b=[],y=[];return await Promise.all(h.map(async([c,l])=>{if(!c||!l?.uploadUrl||!l.fileId)return{file:c,fileUrl:l,error:new Error("No upload URL found")};try{await r.uploadFile({id:l.fileId,formId:s.formId||""},l.uploadUrl,c,void 0,v),b.push({fileUrl:l,file:c})}catch(N){const p=le(N);y.push({file:c,error:p})}})),n.setFileUploaderStateValue(s,new Le({uploadedFileInfo:b.map(({file:c,fileUrl:l})=>new De({fileId:l.fileId,fileUrls:l,name:c.webkitRelativePath||c.name,size:c.size}))}),{fromUi:!0},i),{successfulUploads:b,failedUploads:y}},et=d("div",{target:"eedz4ni0"})(),ce=d("div",{target:"eedz4ni1"})(({theme:e,disabled:r})=>({height:e.sizes.largestElementHeight,width:"100%",background:e.colors.secondaryBg,borderRadius:e.radii.default,marginBottom:e.spacing.twoXS,display:"flex",alignItems:"center",position:"relative",paddingLeft:e.spacing.xs,paddingRight:e.spacing.sm,border:e.colors.widgetBorderColor?`${e.sizes.borderWidth} solid ${e.colors.widgetBorderColor}`:void 0,cursor:r?"not-allowed":"auto",overflow:"hidden"})),tt=d("div",{target:"eedz4ni2"})({flex:1}),rt=d("div",{target:"eedz4ni3"})(({show:e,theme:r})=>({display:e?"block":"none",position:"relative",height:r.sizes.largestElementHeight,paddingTop:r.spacing.threeXS,paddingBottom:r.spacing.threeXS,"& > div":{position:"absolute",top:0,left:0,width:"100%",height:"100%",display:"flex",alignItems:"center"}})),nt=d("span",{target:"eedz4ni4"})(({theme:e,isPlayingOrRecording:r,disabled:n})=>({margin:e.spacing.sm,fontFamily:e.fonts.monospace,color:n?e.colors.fadedText40:r?e.colors.bodyText:e.colors.fadedText60,backgroundColor:e.colors.secondaryBg,fontSize:e.fontSizes.sm})),he=d("div",{target:"eedz4ni5"})({width:"100%",textAlign:"center",overflow:"hidden"}),be=d("span",{target:"eedz4ni6"})(({theme:e})=>({color:e.colors.bodyText})),ot=d("a",{target:"eedz4ni7"})(({theme:e})=>({color:e.colors.link,textDecoration:e.linkUnderline?"underline":"none"})),at=d("div",{target:"eedz4ni8"})(({theme:e})=>({flex:1,height:e.sizes.largestElementHeight,display:"flex",justifyContent:"center",alignItems:"center"})),it=d("div",{target:"eedz4ni9"})(({theme:e})=>{const r="0.625em";return{opacity:.2,width:"100%",height:r,backgroundSize:r,backgroundImage:`radial-gradient(${e.colors.fadedText10} 40%, transparent 40%)`,backgroundRepeat:"repeat"}}),lt=d("span",{target:"eedz4ni10"})(({theme:e})=>({"& > button":{color:e.colors.primary,padding:e.spacing.threeXS},"& > button:hover, & > button:focus":{color:e.colors.redColor}})),st=d("span",{target:"eedz4ni11"})(({theme:e})=>({"& > button":{padding:e.spacing.threeXS,color:e.colors.fadedText60},"& > button:hover, & > button:focus":{color:e.colors.bodyText}})),ye=d("span",{target:"eedz4ni12"})(({theme:e})=>({"& > button":{padding:e.spacing.threeXS,color:e.colors.fadedText60},"& > button:hover, & > button:focus":{color:e.colors.bodyText}})),j=d("div",{target:"eedz4ni13"})(({theme:e})=>({display:"flex",justifyContent:"center",alignItems:"center",flexGrow:0,flexShrink:1,padding:e.spacing.xs,gap:e.spacing.twoXS,marginRight:e.spacing.twoXS})),ct=d("div",{target:"eedz4ni14"})(({theme:e})=>({marginLeft:e.spacing.sm})),T=({onClick:e,disabled:r,ariaLabel:n,iconContent:s})=>o(Me,{kind:Ve.BORDERLESS_ICON,onClick:e,disabled:r,"aria-label":n,containerWidth:!0,"data-testid":"stAudioInputActionButton",children:o(We,{content:s,size:"lg",color:"inherit"})}),dt=({disabled:e,stopRecording:r})=>o(lt,{children:o(T,{onClick:r,disabled:e,ariaLabel:"Stop recording",iconContent:me})}),ut=({disabled:e,isPlaying:r,onClickPlayPause:n})=>o(ye,{children:r?o(T,{onClick:n,disabled:e,ariaLabel:"Pause",iconContent:pe}):o(T,{onClick:n,disabled:e,ariaLabel:"Play",iconContent:fe})}),pt=({disabled:e,startRecording:r})=>o(st,{children:o(T,{onClick:r,disabled:e,ariaLabel:"Record",iconContent:ue})}),ft=({onClick:e})=>o(ye,{children:o(T,{disabled:!1,onClick:e,ariaLabel:"Reset",iconContent:ge})}),gt=({disabled:e,isRecording:r,isPlaying:n,isUploading:s,isError:i,recordingUrlExists:v,startRecording:u,stopRecording:h,onClickPlayPause:b,onClear:y})=>i?o(j,{children:o(ft,{onClick:y})}):s?o(j,{children:o(Be,{size:"base",iconValue:"spinner"})}):F(j,{children:[r?o(dt,{disabled:e,stopRecording:h}):o(pt,{disabled:e,startRecording:u}),v&&o(ut,{disabled:e,isPlaying:n,onClickPlayPause:b})]}),mt=t.memo(gt),ht=()=>o(he,{children:o(be,{children:"An error has occurred, please try again."})}),bt=t.memo(ht),R="00:00",E=e=>{const r=Math.floor(e/1e3),n=Math.floor(r/60),s=Math.floor(n/60),i=r%60,v=n%60,u=i.toString().padStart(2,"0"),h=v.toString().padStart(2,"0"),b=s.toString().padStart(2,"0");return n<60?`${h}:${u}`:`${b}:${h}:${u}`},yt=()=>F(he,{children:[o(be,{children:"This app would like to use your microphone."})," ",o(ot,{href:Ne,rel:"noopener noreferrer",target:"_blank",children:"Learn how to allow access."})]}),St=t.memo(yt),vt=()=>o(at,{children:o(it,{})}),wt=t.memo(vt),Ct=({element:e,uploadClient:r,widgetMgr:n,fragmentId:s,disabled:i})=>{const v=t.useRef(null),[u,h]=t.useState(!1),[b,y]=t.useState(!1),[c,l]=t.useState(!1),[N,p]=t.useState(R),[D,B]=$({widgetMgr:n,id:e.id,key:"deleteFileUrl",defaultValue:null}),[m,V]=$({widgetMgr:n,id:e.id,key:"recordingUrl",defaultValue:null}),[O,A]=$({widgetMgr:n,id:e.id,formId:e.formId,key:"recordingTime",defaultValue:R}),I=t.useRef(null),w=t.useRef(null),f=t.useRef(null),_=e.id,C=e.formId,Se=t.useCallback(async a=>{I.current&&I.current.abort();const S=new AbortController;I.current=S;try{if(y(!0),P(C)&&n.setFormsWithUploadsInProgress(new Set([C])),S.signal.aborted)return;let g;try{g=URL.createObjectURL(a),w.current&&w.current!==g&&URL.revokeObjectURL(w.current),w.current=g}catch{l(!0),y(!1),P(C)&&n.setFormsWithUploadsInProgress(new Set);return}if(S.signal.aborted){URL.revokeObjectURL(g),w.current=null;return}V(g);const Ue=new Date().toISOString().slice(0,16).replace(/:/g,"-"),Pe=new File([a],`${Ue}_audio.wav`,{type:a.type});try{const{successfulUploads:Fe,failedUploads:xe}=await Ze({files:[Pe],uploadClient:r,widgetMgr:n,widgetInfo:{id:_,formId:C},fragmentId:s,signal:S.signal});if(S.signal.aborted)return;if(xe.length>0){l(!0);return}l(!1);const ie=Fe[0];ie?.fileUrl?.deleteUrl&&B(ie.fileUrl.deleteUrl)}catch{S.signal.aborted||l(!0)}finally{P(C)&&n.setFormsWithUploadsInProgress(new Set),S.signal.aborted||y(!1)}}catch{S.signal.aborted||(l(!0),y(!1)),P(C)&&n.setFormsWithUploadsInProgress(new Set)}},[r,n,_,C,s,B,V]),W=t.useRef(null),X=_e({containerRef:v,sampleRate:e.sampleRate??void 0,events:{onPermissionDenied:()=>{h(!0)},onError:()=>{l(!0)},onRecordStart:()=>{A(R),p(R)},onRecordReady:()=>{const a=E(W.current?.playback.getDurationMs()??0);A(a),p(a)},onApprove:Se,onCancel:()=>{A(R),p(R)},onProgressMs:a=>{A(E(a))},onPlaybackPause:()=>{p(E(W.current?.playback.getCurrentTimeMs()??0))},onPlaybackFinish:()=>{p(E(W.current?.playback.getDurationMs()??0))}}});W.current=X;const{state:M,isPlaybackPlaying:U,start:G,stop:q,approve:K,cancel:J,playback:{play:Q,pause:Y,load:Z,getCurrentTimeMs:x,getDurationMs:ee}}=X,k=t.useCallback(async({updateWidgetManager:a,deleteFile:S})=>{const g=m;if(g&&w.current===g&&(URL.revokeObjectURL(g),w.current=null),f.current&&(cancelAnimationFrame(f.current),f.current=null),V(null),B(null),p(R),A(R),J(),a&&n.setFileUploaderStateValue(e,{},{fromUi:!0},s),S&&D)try{await r.deleteFile(D)}catch{}P(g)&&URL.revokeObjectURL(g)},[D,m,r,J,e,n,s,A,B,V]);t.useEffect(()=>{const a=()=>{U&&(p(E(x())),f.current=requestAnimationFrame(a))};return U?f.current=requestAnimationFrame(a):f.current&&(cancelAnimationFrame(f.current),f.current=null),()=>{f.current&&(cancelAnimationFrame(f.current),f.current=null)}},[U,x]),t.useEffect(()=>{if(!m)return;let a=!1;return p(O),(async()=>{try{if(await Z(m),a)return;const g=ee();g>0&&p(E(g))}catch{a||l(!0)}})(),()=>{a=!0}},[m,O,Z,ee]),t.useEffect(()=>{if(de(C))return;const a=new qe;return a.manageFormClearListener(n,C,()=>{k({updateWidgetManager:!0,deleteFile:!1})}),()=>a.disconnect()},[C,k,n]),t.useEffect(()=>()=>{I.current&&(I.current.abort(),I.current=null),f.current&&(cancelAnimationFrame(f.current),f.current=null),w.current&&(URL.revokeObjectURL(w.current),w.current=null)},[]);const ve=t.useCallback(async()=>{try{if(U){const a=x();Y(),p(E(a))}else M==="idle"&&m&&(x()<=100&&p(R),await Q())}catch{l(!0)}},[U,x,Y,Q,m,M]),te=t.useCallback(async()=>{m&&await k({updateWidgetManager:!1,deleteFile:!0});try{p(R),await G()}catch{}},[k,m,G]),re=t.useCallback(async()=>{try{const{blob:a}=await q();await K(a)}catch{l(!0)}},[K,q]),ne=Ye(m,"recording.wav"),we=t.useCallback(()=>{te()},[te]),Ce=t.useCallback(()=>{re()},[re]),Re=t.useCallback(()=>{k({updateWidgetManager:!1,deleteFile:!0}),l(!1)},[k]),ke=t.useCallback(()=>{ne()},[ne]),Ee=t.useCallback(()=>{k({updateWidgetManager:!0,deleteFile:!0})},[k]),H=M==="recording",oe=U,Ae=H?O:N,ae=M==="idle"&&!u&&!m,Ie=u||ae||c;return F(et,{className:"stAudioInput","data-testid":"stAudioInput",children:[o(je,{label:e.label,disabled:i,labelVisibility:Oe(e.labelVisibility?.value),children:e.help&&o(ct,{children:o(He,{content:e.help,placement:$e.TOP})})}),F(ce,{disabled:i,children:[F(Xe,{isFullScreen:!1,disableFullscreenMode:!0,target:ce,children:[m&&o(se,{label:"Download as WAV",icon:Je,onClick:ke}),D&&o(se,{label:"Clear recording",icon:Qe,onClick:Ee})]}),o(mt,{isRecording:H,isPlaying:oe,isUploading:b,isError:c,recordingUrlExists:!!m,startRecording:we,stopRecording:Ce,onClickPlayPause:()=>void ve(),onClear:Re,disabled:i||u}),F(tt,{children:[c&&o(bt,{}),ae&&o(wt,{}),u&&o(St,{}),o(rt,{"data-testid":"stAudioInputWaveSurfer",ref:v,show:!Ie})]}),o(nt,{isPlayingOrRecording:H||oe,disabled:i,"data-testid":"stAudioInputWaveformTimeCode",children:Ae})]})]})},Pt=t.memo(Ct);export{Pt as default};
