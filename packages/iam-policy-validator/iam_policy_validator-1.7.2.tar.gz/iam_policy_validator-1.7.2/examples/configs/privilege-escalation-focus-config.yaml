# Privilege Escalation Detection Configuration
# Focused on detecting privilege escalation paths and IAM security issues
# See: docs/privilege-escalation.md

settings:
  fail_fast: false  # Report all escalation paths
  max_concurrent: 10
  enable_builtin_checks: true
  parallel_execution: true

  # AWS services configuration
  aws_services_dir: null
  cache_enabled: true
  cache_ttl_hours: 168

  # Fail on errors, critical, and high severity
  fail_on_severity:
    - error
    - critical
    - high

# AWS Validation - Focus on IAM-related checks
sid_uniqueness:
  enabled: true
policy_size:
  enabled: true
action_validation:
  enabled: true
condition_key_validation:
  enabled: true
condition_type_mismatch:
  enabled: true
set_operator_validation:
  enabled: true
mfa_condition_antipattern:
  enabled: true
  severity: high  # Upgrade - MFA defeats some privilege escalation
resource_validation:
  enabled: true
principal_validation:
  enabled: true
  severity: critical
policy_type_validation:
  enabled: true
action_resource_constraint:
  enabled: true
action_resource_matching:
  enabled: true

# Security checks - privilege escalation focus
wildcard_action:
  enabled: true
  severity: critical  # Upgrade - wildcards enable escalation
  message: "Wildcard actions enable privilege escalation"

wildcard_resource:
  enabled: true
  severity: high

full_wildcard:
  enabled: true
  severity: critical

service_wildcard:
  enabled: true
  severity: critical  # Upgrade - service wildcards are dangerous
  # No allowed services for privilege escalation detection
  allowed_services: []

# Sensitive actions - focus on privilege escalation category
sensitive_action:
  enabled: true
  severity: critical
  # ONLY check privilege escalation actions
  categories:
    - priv_esc
  # Override severity for priv_esc
  category_severities:
    priv_esc: critical
  # Custom message for privilege escalation
  message_single: "PRIVILEGE ESCALATION RISK: Action '{action}' can lead to privilege escalation without proper conditions"
  message_multiple: "PRIVILEGE ESCALATION RISK: Actions '{actions}' together can lead to privilege escalation"
  suggestion: |
    This action enables privilege escalation. Add strict IAM conditions:
    • Require MFA (aws:MultiFactorAuthPresent = true) - CRITICAL
    • Enforce permissions boundary (iam:PermissionsBoundary)
    • Limit by principal tags (aws:PrincipalTag/role = admin)
    • Restrict by IP or VPC (aws:SourceIp, aws:SourceVpc)
  example: |
    "Condition": {
      "StringEquals": {
        "aws:PrincipalTag/role": "security-admin",
        "iam:PermissionsBoundary": "arn:aws:iam::*:policy/MaxPermissions"
      },
      "Bool": {
        "aws:MultiFactorAuthPresent": "true"
      }
    }

  # Use all_of logic to detect dangerous action combinations
  sensitive_actions:
    # Classic privilege escalation paths
    - all_of:
        - "iam:CreateUser"
        - "iam:AttachUserPolicy"
    - all_of:
        - "iam:CreateRole"
        - "iam:AttachRolePolicy"
    - all_of:
        - "iam:PutUserPolicy"
        - "iam:CreateAccessKey"
    - all_of:
        - "iam:PassRole"
        - "lambda:CreateFunction"
    - all_of:
        - "iam:PassRole"
        - "ec2:RunInstances"
    - all_of:
        - "iam:CreatePolicyVersion"
        - "iam:SetDefaultPolicyVersion"

# Action condition enforcement - focus on IAM actions
action_condition_enforcement:
  enabled: true
  severity: critical

  action_condition_requirements:
    # iam:PassRole MUST have iam:PassedToService
    - actions:
        - "iam:PassRole"
      severity: critical
      required_conditions:
        - condition_key: "iam:PassedToService"
          description: "Restrict which AWS services can assume the passed role to prevent privilege escalation"
          example: |
            "Condition": {
              "StringEquals": {
                "iam:PassedToService": [
                  "lambda.amazonaws.com",
                  "ecs-tasks.amazonaws.com"
                ]
              }
            }

    # IAM write operations MUST have permissions boundary
    - actions:
        - "iam:CreateRole"
        - "iam:PutRolePolicy"
        - "iam:AttachRolePolicy"
        - "iam:CreateUser"
        - "iam:PutUserPolicy"
        - "iam:AttachUserPolicy"
        - "iam:CreatePolicyVersion"
      severity: critical
      required_conditions:
        all_of:
          - condition_key: "iam:PermissionsBoundary"
            description: "Require permissions boundary to limit maximum permissions"
          - condition_key: "aws:MultiFactorAuthPresent"
            expected_value: true
            description: "Require MFA for IAM write operations"

    # Detect privilege escalation action combinations at policy level
    - actions:
        all_of:
          - "iam:CreateUser"
          - "iam:AttachUserPolicy"
      severity: critical
      description: "PRIVILEGE ESCALATION: Can create user and attach AdministratorAccess policy"

    - actions:
        all_of:
          - "iam:PassRole"
          - "lambda:CreateFunction"
      severity: critical
      description: "PRIVILEGE ESCALATION: Can create Lambda with privileged role"

    - actions:
        all_of:
          - "iam:PassRole"
          - "ec2:RunInstances"
      severity: critical
      description: "PRIVILEGE ESCALATION: Can launch EC2 with privileged role"
