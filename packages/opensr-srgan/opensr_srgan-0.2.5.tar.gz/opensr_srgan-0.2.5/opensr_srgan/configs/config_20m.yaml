# ============================================================================ #
# ‚öôÔ∏è GENERAL CONFIGURATION FILE
# ---------------------------------------------------------------------------- #
# This file defines all key components for training and evaluating the SR model.
# Sections: Data, Model, Training, Architecture, Optimization, Scheduling, Logging
# ============================================================================ #


# ============================================================================ #
# üóÇÔ∏è DATA SETTINGS
# ---------------------------------------------------------------------------- #
Data:
  # Loader parameters
  train_batch_size: 24        # Batch size for training
  val_batch_size: 8           # Batch size for validation
  num_workers: 8              # Number of parallel workers for dataloader
  prefetch_factor: 4          # Samples prefetched per worker (2 is stable default)

  # Dataset configuration
  dataset_type: 'S2_6b'       # Choose dataset type: ['cv', 'SPOT6', 'S2_6b']
  normalization: 'normalise_10k'  # Normalization strategy for data processing


# ============================================================================ #
# üß† MODEL AND CHECKPOINT SETTINGS
# ---------------------------------------------------------------------------- #
Model:
  in_bands: 6                 # Number of input channels (e.g. RGB-NIR-SWIR etc.)
  continue_training: False    # Resume full training (PL checkpoint path or False)
  load_checkpoint: False      # Load weights only (path or False)


# ============================================================================ #
# üèãÔ∏è TRAINING CONFIGURATION
# ---------------------------------------------------------------------------- #
Training:
  # --- Hardware Setup
  device: "cuda"                # Runtime device backend: ['cuda', 'cpu']
  gpus: [2,3]                    # Number of GPUs to use, individually in list form, e.g. [0] or [0,2]
  # --- General Training Setup
  max_epochs: 9999            # Maximum number of training epochs
  val_check_interval: 1.0     # Validate once per epoch (float) or every N steps (int)
  limit_val_batches: 250      # Limit number of validation batches

  # --- Pretraining and adversarial setup ---
  pretrain_g_only: True        # Train generator only for initial phase
  g_pretrain_steps: 15000     # Number of generator-only warmup steps
  adv_loss_ramp_steps: 2500   # Gradual adversarial weight ramp steps
  label_smoothing: True        # Discriminator target smoothing (1.0 ‚Üí 0.9)

  EMA:
    enabled: False             # Maintain exponential moving average of generator weights
    decay: 0.999               # EMA decay factor (closer to 1.0 ‚Üí smoother updates)
    update_after_step: 0       # Delay EMA updates until this global step (0 = immediate)
    use_num_updates: True      # Use adaptive decay warmup based on number of updates

  Losses:
    # --- GAN term ---
    adv_loss_beta: 1e-3        # Final adversarial loss weight after ramp-up
    adv_loss_schedule: 'cosine'   # Adversarial weight ramp type: ['linear', 'cosine']

    # --- Content loss components (GeneratorContentLoss) ---
    l1_weight: 1.0             # L1 loss over all bands
    sam_weight: 0.05           # Spectral Angle Mapper loss
    perceptual_weight: 0.1     # Perceptual similarity term weight
    perceptual_metric: 'vgg'   # ['vgg', 'lpips'] - LPIPS requires pip install lpips
    tv_weight: 0.0             # Total Variation regularization (optional)

    # --- Metric evaluation settings ---
    max_val: 1.0               # Peak value assumed by PSNR/SSIM after metric preprocessing
    ssim_win: 11               # SSIM window size (must be odd integer)


# ============================================================================ #
# üß© ARCHITECTURAL PARAMETERS
# ---------------------------------------------------------------------------- #
Generator:
  model_type: 'SRResNet'       # Generator family: ['SRResNet', 'stochastic_gan', 'esrgan']
  block_type: 'rcab'           # SRResNet block variant: ['standard', 'res', 'rcab', 'rrdb', 'lka']
  large_kernel_size: 9         # Kernel for head and tail conv layers (SRResNet/stochastic)
  small_kernel_size: 3         # Kernel for intermediate blocks (SRResNet/stochastic)
  n_channels: 96               # Feature width (RRDB/ESRGAN uses this as trunk width)
  n_blocks: 32                 # Residual/attention blocks (ESRGAN: number of RRDB blocks)
  scaling_factor: 8            # Upscaling factor (e.g., 2√ó, 4√ó, 8√ó)
  growth_channels: 32          # ESRGAN-specific RRDB growth channels (ignored otherwise)
  res_scale: 0.2               # Residual scaling used by stochastic/ESRGAN variants

Discriminator:
  model_type: 'standard'       # Discriminator architecture selector ['standard', 'patchgan', 'esrgan']
  n_blocks: 8                  # Convolutional depth for SRGAN/PatchGAN (ignored by ESRGAN)
  base_channels: 64            # ESRGAN discriminator base feature width (ignored otherwise)
  linear_size: 1024            # Hidden dim of ESRGAN discriminator head (ignored otherwise)

# ============================================================================ #
# üßÆ OPTIMIZATION SETTINGS
# ---------------------------------------------------------------------------- #
Optimizers:
  optim_g_lr: 1e-4             # Learning rate for Generator
  optim_d_lr: 1e-6             # Learning rate for Discriminator
  gradient_clip_val: 1.0        # Gradient clipping value (0 disables clipping)
  betas: [0.0, 0.99]          # optional
  eps: 1.0e-7                 # optional
  weight_decay_g: 0.0         # optional
  weight_decay_d: 0.0         # optional



# ============================================================================ #
# üìâ SCHEDULERS AND EARLY STOPPING
# ---------------------------------------------------------------------------- #
Schedulers:
  g_warmup_steps: 2500         # Generator warmup duration in steps (0 disables warmup)
  g_warmup_type: 'cosine'      # Generator warmup curve: ['cosine', 'linear']
  metric_g: 'val_metrics/l1'      # Metric monitored for Generator LR scheduler
  metric_d: 'discriminator/adversarial_loss'     # Metric monitored for Discriminator LR scheduler
  patience_g: 50              # Patience (epochs) for Generator LR scheduler
  patience_d: 50              # Patience (epochs) for Discriminator LR scheduler
  factor_g: 0.5                # LR reduction factor for Generator
  factor_d: 0.5                # LR reduction factor for Discriminator
  verbose: True                # Enable scheduler logging output


# ============================================================================ #
# üßæ LOGGING SETTINGS
# ---------------------------------------------------------------------------- #
Logging:
  num_val_images: 5            # Number of validation images logged per epoch
  wandb:
    enabled: True              # Toggle Weights & Biases logging on/off
    entity: "opensr"      # W&B entity or team name
    project: "SRGAN_20m"        # W&B project name
